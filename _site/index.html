<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>黄天霸</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.">
    <meta name="keywords" content="your keywords, separated by commas" />
    <meta name="author" content="LastName FirstName">
    <link rel="canonical" href="https://github.com/jeromelachaud/freelancer-theme/">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">

    <!-- Custom CSS & Bootstrap Core CSS - Uses Bootswatch Flatly Theme: http://bootswatch.com/flatly/ -->
    <link rel="stylesheet" href="/style.css">

    <!-- Google verification -->
    

    <!-- Bing Verification -->
    

    <!-- Custom Fonts -->
    <link rel="stylesheet" href="/css/font-awesome/css/font-awesome.min.css">
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/css/font-awesome/css/rouge.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

    <body id="page-top" class="index">
       <!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#page-top">黄天霸</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <!-- 栏目添加: 添加新栏目需要在这里加模板   -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li class="hidden">
                        <a href="#page-top"></a>
                    </li>
<!--                    <li class="page-scroll">-->
<!--                        <a href="#portfolio">Portfolio</a>-->
<!--                    </li> -->
                    <li class="page-scroll">
                        <a href="#home">Home</a>
                    </li>
                    <li class="page-scroll">
                        <a href="#spring">Spring</a>
                    </li>
                    <li class="page-scroll">
                        <a href="#springboot">SpringBoot</a>
                    </li>
                    <li class="page-scroll">
                        <a href="#algorithm">Algorithm</a>
                    </li>
<!--                    <li class="page-scroll">-->
<!--                        <a href="#about">About</a>-->
<!--                    </li>-->
<!--                    <li class="page-scroll">-->
<!--                        <a href="#contact">Contact</a>-->
<!--                    </li>-->
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>
    <!-- Header -->
<header>
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <img class="img-responsive" src="img/profile.png" alt="profile-pic" />
        <div class="intro-text">
          <span class="name">黄天霸</span>
          <hr class="star-light" />
          <span class="skills">FUCK ALL</span>
        </div>
      </div>
    </div>
  </div>
</header>

    <!-- 栏目添加: 添加新栏目需要在这里加模板  这里需要将html删除 注释掉还是会显示 -->
    
    <!-- Home Page -->
    <section id="home">
        <div class="container portfolio-flex-grid">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h2>Home</h2>
                    <hr class="star-primary">
                </div>
            </div>
            <div class="portfolio-flex-row">
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000013" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>摩尔投票</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-vladislav-filippov-9001724.jpg" class="img-responsive" alt="摩尔投票">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-20000008" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>SpringBootApplication getBean方法解析:org.springframework.beans.factory.support.AbstractBeanFactory#getBean(java.lang.String, java.lang.Class<T>)</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-joaqu-9677214.jpg" class="img-responsive" alt="SpringBoot">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-20000007" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>SpringBootApplication Refresh方法解析:processConfigBeanDefinitions</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-maverick-coltman-3214311.jpg" class="img-responsive" alt="SpringBoot">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000012" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>平衡二叉查找树</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-jue-5806480.jpg" class="img-responsive" alt="BalancedBinaryTree">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-20000006" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>SpringBootApplication Run方法解析(四):refreshContext</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-rachel-claire-4577793.jpg" class="img-responsive" alt="SpringBoot">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-20000005" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>SpringBootApplication Run方法解析(三):prepareContext</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-pok-rie-136728.jpg" class="img-responsive" alt="SpringBoot">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-20000004" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>SpringBootApplication Run方法解析(二):createApplicationContext</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-anastasia-pavlova-8692301.jpg" class="img-responsive" alt="SpringBoot4">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-20000003" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>SpringBootApplication Run方法解析(一):prepareEnvironment</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-rachel-claire-5490361.jpg" class="img-responsive" alt="SpringBoot3">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-20000002" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>SpringBootApplication构造方法分析</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-irina-iriser-1122625.jpg" class="img-responsive" alt="SpringBoot2">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000010" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>二分查找</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-victoria-borodinova-9201864.jpg" class="img-responsive" alt="BinarySearch">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000011" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>二查叉找树</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-julia-volk-5273316.jpg" class="img-responsive" alt="BinarySearchTree">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000009" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>二叉树基本概念</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-karina-zhukovskaya-7260333.jpg" class="img-responsive" alt="binaryTree">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000008" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>基数排序</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-roman-odintsov-5327786.jpg" class="img-responsive" alt="radixSort">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000007" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>希尔排序</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-alena-beliaeva-8697338.jpg" class="img-responsive" alt="shellSort">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000006" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>归并排序</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-anete-lusina-5721167.jpg" class="img-responsive" alt="mergeSort">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000005" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>选择排序</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-8906527.jpg" class="img-responsive" alt="selectSort">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000004" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>插入排序</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-nick-wehrli-6524730.jpg" class="img-responsive" alt="insertSort">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000003" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>堆排序</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-valeriya-kobzar-8155476.jpg" class="img-responsive" alt="heapSort">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000002" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>快速排序</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-jo-jesus-4198220.jpg" class="img-responsive" alt="quickSort">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000001" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>冒泡排序</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-rachel-claire-4846299.jpg" class="img-responsive" alt="bubbleSort">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-20000001" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>SpringBootApplication注解分析</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-david-selbert-6468061.jpg" class="img-responsive" alt="SpringBoot1">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-9" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>spring</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-8802433.jpg" class="img-responsive" alt="image-alt">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-7" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>spring</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-luizclas-556666.jpg" class="img-responsive" alt="image-alt">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-1" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>Use this area of the page to describe your project. Lorem ipsum dolor sit amet, consectetur adipisicing elit. Mollitia neque assumenda ipsam nihil, molestias magnam, recusandae quos quis inventore quisquam velit asperiores, vitae? Reprehenderit soluta, eos quod consequuntur itaque. Nam.</p>

                                </div>
                            </div>
                            <img src="img/portfolio/cabin.png" class="img-responsive" alt="image-alt">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-2" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>Use this area of the page to describe your project. Lorem ipsum dolor sit amet, consectetur adipisicing elit. Mollitia neque assumenda ipsam nihil, molestias magnam, recusandae quos quis inventore quisquam velit asperiores, vitae? Reprehenderit soluta, eos quod consequuntur itaque. Nam.</p>

                                </div>
                            </div>
                            <img src="img/portfolio/cake.png" class="img-responsive" alt="image-alt">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-3" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>Use this area of the page to describe your project. Lorem ipsum dolor sit amet, consectetur adipisicing elit. Mollitia neque assumenda ipsam nihil, molestias magnam, recusandae quos quis inventore quisquam velit asperiores, vitae? Reprehenderit soluta, eos quod consequuntur itaque. Nam.</p>

                                </div>
                            </div>
                            <img src="img/portfolio/circus.png" class="img-responsive" alt="image-alt">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-4" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>Use this area of the page to describe your project. Lorem ipsum dolor sit amet, consectetur adipisicing elit. Mollitia neque assumenda ipsam nihil, molestias magnam, recusandae quos quis inventore quisquam velit asperiores, vitae? Reprehenderit soluta, eos quod consequuntur itaque. Nam.</p>

                                </div>
                            </div>
                            <img src="img/portfolio/game.png" class="img-responsive" alt="image-alt">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-6" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>Use this area of the page to describe your project. Lorem ipsum dolor sit amet, consectetur adipisicing elit. Mollitia neque assumenda ipsam nihil, molestias magnam, recusandae quos quis inventore quisquam velit asperiores, vitae? Reprehenderit soluta, eos quod consequuntur itaque. Nam.</p>

                                </div>
                            </div>
                            <img src="img/portfolio/submarine.png" class="img-responsive" alt="image-alt">

                        </a>
                    </div>
                
                    <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-5" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>Use this area of the page to describe your project. Lorem ipsum dolor sit amet, consectetur adipisicing elit. Mollitia neque assumenda ipsam nihil, molestias magnam, recusandae quos quis inventore quisquam velit asperiores, vitae? Reprehenderit soluta, eos quod consequuntur itaque. Nam.</p>

                                </div>
                            </div>
                            <img src="img/portfolio/safe.png" class="img-responsive" alt="image-alt">

                        </a>
                    </div>
                
            </div>
        </div>
    </section>
    <!-- 指定的栏目下的内容需要加上指定的标记为true使用 if标签  标志位添加在posts中的markdown中  还需要设置main.css中的样式-->
    <!-- Spring -->
    <section id="spring">
        <div class="container portfolio-flex-grid">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h2>Spring</h2>
                    <hr class="star-primary">
                </div>
            </div>
            <div class="portfolio-flex-row">
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-9" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>spring</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-8802433.jpg" class="img-responsive" alt="image-alt">
                        </a>
                    </div>
                    
                
                    
                <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-7" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>spring</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-luizclas-556666.jpg" class="img-responsive" alt="image-alt">
                        </a>
                    </div>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </div>
        </div>
    </section>
    
    <!-- Spring Boot -->
    <section id="springboot">
        <div class="container portfolio-flex-grid">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h2>Spring Boot</h2>
                    <hr class="star-primary">
                </div>
            </div>
            <div class="portfolio-flex-row">
                
                    
                
                    
                <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-20000008" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>SpringBootApplication getBean方法解析:org.springframework.beans.factory.support.AbstractBeanFactory#getBean(java.lang.String, java.lang.Class<T>)</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-joaqu-9677214.jpg" class="img-responsive" alt="SpringBoot">
                        </a>
                    </div>
                    
                
                    
                <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-20000007" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>SpringBootApplication Refresh方法解析:processConfigBeanDefinitions</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-maverick-coltman-3214311.jpg" class="img-responsive" alt="SpringBoot">
                        </a>
                    </div>
                    
                
                    
                
                    
                <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-20000006" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>SpringBootApplication Run方法解析(四):refreshContext</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-rachel-claire-4577793.jpg" class="img-responsive" alt="SpringBoot">
                        </a>
                    </div>
                    
                
                    
                <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-20000005" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>SpringBootApplication Run方法解析(三):prepareContext</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-pok-rie-136728.jpg" class="img-responsive" alt="SpringBoot">
                        </a>
                    </div>
                    
                
                    
                <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-20000004" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>SpringBootApplication Run方法解析(二):createApplicationContext</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-anastasia-pavlova-8692301.jpg" class="img-responsive" alt="SpringBoot4">
                        </a>
                    </div>
                    
                
                    
                <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-20000003" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>SpringBootApplication Run方法解析(一):prepareEnvironment</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-rachel-claire-5490361.jpg" class="img-responsive" alt="SpringBoot3">
                        </a>
                    </div>
                    
                
                    
                <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-20000002" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>SpringBootApplication构造方法分析</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-irina-iriser-1122625.jpg" class="img-responsive" alt="SpringBoot2">
                        </a>
                    </div>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-20000001" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>SpringBootApplication注解分析</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-david-selbert-6468061.jpg" class="img-responsive" alt="SpringBoot1">
                        </a>
                    </div>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </div>
        </div>
    </section>
    
    <!-- Spring Boot -->
    <section id="algorithm">
        <div class="container portfolio-flex-grid">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h2>算法与数据结构</h2>
                    <hr class="star-primary">
                </div>
            </div>
            <div class="portfolio-flex-row">
                
                    
                <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000013" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>摩尔投票</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-vladislav-filippov-9001724.jpg" class="img-responsive" alt="摩尔投票">
                        </a>
                    </div>
                    
                
                    
                
                    
                
                    
                <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000012" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>平衡二叉查找树</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-jue-5806480.jpg" class="img-responsive" alt="BalancedBinaryTree">
                        </a>
                    </div>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000010" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>二分查找</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-victoria-borodinova-9201864.jpg" class="img-responsive" alt="BinarySearch">
                        </a>
                    </div>
                    
                
                    
                <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000011" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>二查叉找树</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-julia-volk-5273316.jpg" class="img-responsive" alt="BinarySearchTree">
                        </a>
                    </div>
                    
                
                    
                <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000009" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>二叉树基本概念</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-karina-zhukovskaya-7260333.jpg" class="img-responsive" alt="binaryTree">
                        </a>
                    </div>
                    
                
                    
                <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000008" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>基数排序</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-roman-odintsov-5327786.jpg" class="img-responsive" alt="radixSort">
                        </a>
                    </div>
                    
                
                    
                <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000007" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>希尔排序</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-alena-beliaeva-8697338.jpg" class="img-responsive" alt="shellSort">
                        </a>
                    </div>
                    
                
                    
                <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000006" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>归并排序</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-anete-lusina-5721167.jpg" class="img-responsive" alt="mergeSort">
                        </a>
                    </div>
                    
                
                    
                <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000005" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>选择排序</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-8906527.jpg" class="img-responsive" alt="selectSort">
                        </a>
                    </div>
                    
                
                    
                <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000004" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>插入排序</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-nick-wehrli-6524730.jpg" class="img-responsive" alt="insertSort">
                        </a>
                    </div>
                    
                
                    
                <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000003" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>堆排序</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-valeriya-kobzar-8155476.jpg" class="img-responsive" alt="heapSort">
                        </a>
                    </div>
                    
                
                    
                <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000002" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>快速排序</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-jo-jesus-4198220.jpg" class="img-responsive" alt="quickSort">
                        </a>
                    </div>
                    
                
                    
                <div class="portfolio-flex-item portfolio-item">
                        <a href="#portfolioModal-10000001" class="portfolio-link" data-toggle="modal">
                            <div class="caption">
                                <div class="caption-content">
                                    <i class="fa fa-search-plus fa-3x"></i>
                                    <p>冒泡排序</p>

                                </div>
                            </div>
                            <img src="img/portfolio/pexels-rachel-claire-4846299.jpg" class="img-responsive" alt="bubbleSort">
                        </a>
                    </div>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </div>
        </div>
    </section>

        <!-- Footer -->
    <footer class="text-center">
        <div class="footer-above">
            <div class="container">
                <div class="row">
                    <div class="footer-col col-md-4">
                        <h3>China</h3>
                        <p>
                            
                                3481 Melrose Place <br>
		                    
                                Beverly Hills, CA 90210 <br>
		                    
                        </p>
                    </div>
                    <div class="footer-col col-md-4">
                        <h3>Around the Web</h3>
                        <ul class="list-inline">
                            
                            <li>
                                <a href="http://github.com/BiggerYellow" class="btn-social btn-outline"><i class="fa fa-fw fa-github"></i></a>
                            </li>
		                    
                        </ul>
                    </div>
                    <div class="footer-col col-md-4">
                        <h3>Credits</h3>
                        <p>Freelancer is a free to use, open source Bootstrap theme created by <a href="http://startbootstrap.com">Start Bootstrap</a>.</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-below">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        Copyright &copy; Hcc 2021
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scroll to Top Button (Only visible on small and extra-small screen sizes) -->
    <div class="scroll-top page-scroll visible-xs visible-sm">
        <a class="btn btn-primary" href="#page-top">
            <i class="fa fa-chevron-up"></i>
        </a>
    </div>

     <!-- Portfolio Modals -->
 
    <div class="portfolio-modal modal fade" id="portfolioModal-10000013" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2>MajorityVote</h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/pexels-vladislav-filippov-9001724.jpg" class="img-responsive img-centered" alt="摩尔投票">

                            
                                <h3>摩尔投票</h3>
                            
                            </div>

                            <p><h3 id="定义">定义</h3>
<hr />
<p><a href="https://www.cs.ou.edu/~rlpage/dmtools/mjrty.pdf">摩尔投票论文地址</a></p>
<hr />

<h3 id="力扣原题">力扣原题</h3>
<hr />
<p><a href="https://leetcode-cn.com/problems/find-majority-element-lcci/">面试题 17.10. 主要元素</a>
<a href="https://leetcode-cn.com/problems/majority-element-ii/">229. 求众数 II</a></p>
<hr />

<h3 id="遍历图解">遍历图解</h3>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/图片地址.jpg">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="图片描述" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/图片地址.jpg" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">图片描述</div>
    </a>
</center>

<h3 id="代码">代码</h3>
<blockquote>
  <p>java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">xxx</span>
</code></pre></div></div>

<blockquote>
  <p>时间复杂度:O() 
空间复杂度为:O(1)</p>
</blockquote>

<h3 id="扩展">扩展</h3>

<h3 id="其他语言">其他语言</h3>
<hr />
<blockquote>
  <p>C++</p>
</blockquote>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">xxx</span>
</code></pre></div></div>
<blockquote>
  <p>python3</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">xxx</span>
</code></pre></div></div>
<blockquote>
  <p>go</p>
</blockquote>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">xxx</span>
</code></pre></div></div>
</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">Tree</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">October 2021</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">algorithm</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-20000008" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2>SpringBoot启动源码解析(八)</h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/pexels-joaqu-9677214.jpg" class="img-responsive img-centered" alt="SpringBoot">

                            
                                <h3>SpringBootApplication getBean方法解析:org.springframework.beans.factory.support.AbstractBeanFactory#getBean(java.lang.String, java.lang.Class<T>)</h3>
                            
                            </div>

                            <p><h3 id="创建bean流程图">创建bean流程图</h3>
<hr />
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/GetBean流程图.jpg">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="GetBean流程图" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/GetBean流程图.jpg" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">GetBean流程图</div>
    </a>
</center>
<hr />

<h3 id="源码分析">源码分析</h3>
<hr />
<hr />

</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">SpringBoot</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">October 2021</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">SpringBoot</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-20000007" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2>SpringBoot启动源码解析(七)</h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/pexels-maverick-coltman-3214311.jpg" class="img-responsive img-centered" alt="SpringBoot">

                            
                                <h3>SpringBootApplication Refresh方法解析:processConfigBeanDefinitions</h3>
                            
                            </div>

                            <p><h3 id="方法入口">方法入口</h3>
<hr />
<p>调用路径:<br />
refresh() -&gt;<br />
invokeBeanFactoryPostProcessors(beanFactory) -&gt;<br />
invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors,registry) -&gt; <br />
ConfigurationClassPostProcessor.processConfigBeanDefinitions()</p>

<p>源码如下:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Build and validate a configuration model based on the registry of
 * {@link Configuration} classes.
 * 基于Configuration类的注册表构建和验证配置模型
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">processConfigBeanDefinitions</span><span class="o">(</span><span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//1.获取注册表中已注册的bean定义,并挑选出配置类候选(使用@Configuration注解的类)并加入到configCandidates中</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="n">configCandidates</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="n">candidateNames</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getBeanDefinitionNames</span><span class="o">();</span>

    <span class="c1">//从前面加载的候选者中找到被@Configuration修饰的类并把该类封装为BeanDefinitionHolder</span>
    <span class="c1">//主要是处理主函数类</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span> <span class="o">:</span> <span class="n">candidateNames</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">BeanDefinition</span> <span class="n">beanDef</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">beanDef</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">CONFIGURATION_CLASS_ATTRIBUTE</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Bean definition has already been processed as a configuration class: "</span> <span class="o">+</span> <span class="n">beanDef</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">checkConfigurationClassCandidate</span><span class="o">(</span><span class="n">beanDef</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">//将匹配的bean添加到配置候选者中</span>
            <span class="n">configCandidates</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">BeanDefinitionHolder</span><span class="o">(</span><span class="n">beanDef</span><span class="o">,</span> <span class="n">beanName</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// Return immediately if no @Configuration classes were found</span>
    <span class="c1">//如果没有发现@Configuration配置的类直接返回</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">configCandidates</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="c1">//2. 解析前置操作:根据@Order排序候选者、设置bean名称生成策略、设置Environment、最重要的就是创建ConfigurationClassParser解析器</span>
    <span class="c1">// Sort by previously determined @Order value, if applicable</span>
    <span class="c1">//如果适用的话,根据先前确定的@Order的值排序  order值越小优先级越高</span>
    <span class="n">configCandidates</span><span class="o">.</span><span class="na">sort</span><span class="o">((</span><span class="n">bd1</span><span class="o">,</span> <span class="n">bd2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">i1</span> <span class="o">=</span> <span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">getOrder</span><span class="o">(</span><span class="n">bd1</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">());</span>
        <span class="kt">int</span> <span class="n">i2</span> <span class="o">=</span> <span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">getOrder</span><span class="o">(</span><span class="n">bd2</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">());</span>
        <span class="k">return</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="n">i1</span><span class="o">,</span> <span class="n">i2</span><span class="o">);</span>
    <span class="o">});</span>

    <span class="c1">// Detect any custom bean name generation strategy supplied through the enclosing application context</span>
    <span class="c1">//检测 通过封闭应用上下文提供的任何自定义bean名称生成策略</span>
    <span class="nc">SingletonBeanRegistry</span> <span class="n">sbr</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">registry</span> <span class="k">instanceof</span> <span class="nc">SingletonBeanRegistry</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">sbr</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SingletonBeanRegistry</span><span class="o">)</span> <span class="n">registry</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">localBeanNameGeneratorSet</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">BeanNameGenerator</span> <span class="n">generator</span> <span class="o">=</span> <span class="o">(</span><span class="nc">BeanNameGenerator</span><span class="o">)</span> <span class="n">sbr</span><span class="o">.</span><span class="na">getSingleton</span><span class="o">(</span>
                    <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">CONFIGURATION_BEAN_NAME_GENERATOR</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">generator</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">componentScanBeanNameGenerator</span> <span class="o">=</span> <span class="n">generator</span><span class="o">;</span>
                <span class="k">this</span><span class="o">.</span><span class="na">importBeanNameGenerator</span> <span class="o">=</span> <span class="n">generator</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">environment</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">environment</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StandardEnvironment</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// Parse each @Configuration class</span>
    <span class="c1">//解析每一个@Configuration修饰的类</span>
    <span class="nc">ConfigurationClassParser</span> <span class="n">parser</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConfigurationClassParser</span><span class="o">(</span>
            <span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">problemReporter</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">,</span>
            <span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">componentScanBeanNameGenerator</span><span class="o">,</span> <span class="n">registry</span><span class="o">);</span>
    
    <span class="c1">//3. 通过ConfigurationClassParser的parse方法解析候选类 也就是主函数</span>
    <span class="c1">//3.1 首先通过parse方法进行解析主函数,这里就将所有的注解都解析的干干净净 具体逻辑稍后分析</span>
    <span class="c1">//3.1 解析完后进行验证,主要验证解析后配置类及其中的属性是否合法</span>
    <span class="c1">//3.3 此时已经将所有的配置类都解析好了,但是还有通过@Import或@Bean或@ImportedResources或ImportBeanDefinitionRegister的bean未注册,这步就是注册这些类的</span>
    <span class="c1">//3.4 最后就是筛选出所有已经真正解析过的配置类 若存在未解析的加入到candidates中继续进行解析</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="n">candidates</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="n">configCandidates</span><span class="o">);</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">ConfigurationClass</span><span class="o">&gt;</span> <span class="n">alreadyParsed</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;(</span><span class="n">configCandidates</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="k">do</span> <span class="o">{</span>
        <span class="c1">//使用ConfigurationClassParser解析每一个配置候选者</span>
        <span class="c1">//即解析主函数 主要作用是 解析每个注解</span>
        <span class="c1">//1.@PropertySource</span>
        <span class="c1">//2.@ComponentScan 根据注解的路径扫描所有需要加载的配置类  默认是扫描主类下的所有文件</span>
        <span class="c1">//3.@Import 根据@Import注解加载所有的导入类  最重要的是通过SpringBoot中的AutoConfigurationImportSelector来加载所有自动配置的类</span>
        <span class="c1">//4.@ImportResource</span>
        <span class="c1">//5.@Bean</span>
        <span class="c1">//6.default methods on interfaces</span>
        <span class="c1">//7.Process superclass</span>
        <span class="n">parser</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">candidates</span><span class="o">);</span>
        <span class="n">parser</span><span class="o">.</span><span class="na">validate</span><span class="o">();</span>

        <span class="c1">//4. 通过reader.loadBeanDefinitions方法注册导入的配置类自身、相关@Bean方法导入的类、@ImportResource导入的类和@Import导入的类的定义</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">ConfigurationClass</span><span class="o">&gt;</span> <span class="n">configClasses</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="n">parser</span><span class="o">.</span><span class="na">getConfigurationClasses</span><span class="o">());</span>
        <span class="n">configClasses</span><span class="o">.</span><span class="na">removeAll</span><span class="o">(</span><span class="n">alreadyParsed</span><span class="o">);</span>

        <span class="c1">// Read the model and create bean definitions based on its content</span>
        <span class="c1">//读取模型并根据其内容创建bean定义</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">reader</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConfigurationClassBeanDefinitionReader</span><span class="o">(</span>
                    <span class="n">registry</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">sourceExtractor</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">,</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">importBeanNameGenerator</span><span class="o">,</span> <span class="n">parser</span><span class="o">.</span><span class="na">getImportRegistry</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="c1">//将解析过的配置类中的一些属性注册为bean定义</span>
        <span class="k">this</span><span class="o">.</span><span class="na">reader</span><span class="o">.</span><span class="na">loadBeanDefinitions</span><span class="o">(</span><span class="n">configClasses</span><span class="o">);</span>
        <span class="c1">//alreadyParsed存放所有实例化过的配置类</span>
        <span class="n">alreadyParsed</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">configClasses</span><span class="o">);</span>

        <span class="n">candidates</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        
        <span class="c1">//5.最后检测后扫描到的配置类中是否有未扫描到的,存在则加入到candidates中继续解析</span>
        <span class="c1">//如果注册表中的bean定义数量 大于 之前 加载的候选类数量</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">registry</span><span class="o">.</span><span class="na">getBeanDefinitionCount</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">candidateNames</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//最新的候选配置类数组</span>
            <span class="nc">String</span><span class="o">[]</span> <span class="n">newCandidateNames</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getBeanDefinitionNames</span><span class="o">();</span>
            <span class="c1">//旧的候选配置类集合</span>
            <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">oldCandidateNames</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">candidateNames</span><span class="o">));</span>
            <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">alreadyParsedClasses</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
            <span class="c1">//添加到alreadyParsedClasses中</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">ConfigurationClass</span> <span class="n">configurationClass</span> <span class="o">:</span> <span class="n">alreadyParsed</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">alreadyParsedClasses</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">configurationClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getClassName</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="c1">//比较新旧候选类  只有不存在于旧的候选者集合 且 属于配置候选者 才添加到candidates</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">candidateName</span> <span class="o">:</span> <span class="n">newCandidateNames</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">oldCandidateNames</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">candidateName</span><span class="o">))</span> <span class="o">{</span>
                    <span class="nc">BeanDefinition</span> <span class="n">bd</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">(</span><span class="n">candidateName</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">checkConfigurationClassCandidate</span><span class="o">(</span><span class="n">bd</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                            <span class="o">!</span><span class="n">alreadyParsedClasses</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">bd</span><span class="o">.</span><span class="na">getBeanClassName</span><span class="o">()))</span> <span class="o">{</span>
                        <span class="n">candidates</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">BeanDefinitionHolder</span><span class="o">(</span><span class="n">bd</span><span class="o">,</span> <span class="n">candidateName</span><span class="o">));</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">candidateNames</span> <span class="o">=</span> <span class="n">newCandidateNames</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">while</span> <span class="o">(!</span><span class="n">candidates</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">());</span>

    <span class="c1">// Register the ImportRegistry as a bean in order to support ImportAware @Configuration classes</span>
    <span class="c1">//将ImportRegistry注册为一个bean 为了支持ImportAware的配置类</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">sbr</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sbr</span><span class="o">.</span><span class="na">containsSingleton</span><span class="o">(</span><span class="no">IMPORT_REGISTRY_BEAN_NAME</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">sbr</span><span class="o">.</span><span class="na">registerSingleton</span><span class="o">(</span><span class="no">IMPORT_REGISTRY_BEAN_NAME</span><span class="o">,</span> <span class="n">parser</span><span class="o">.</span><span class="na">getImportRegistry</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span> <span class="k">instanceof</span> <span class="nc">CachingMetadataReaderFactory</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Clear cache in externally provided MetadataReaderFactory; this is a no-op</span>
        <span class="c1">// for a shared cache since it'll be cleared by the ApplicationContext.</span>
        <span class="c1">//清除外部提供的MetadataReaderFactory中的缓存; 这是共享缓存的空操作,因为它将被ApplicationContext清除</span>
        <span class="o">((</span><span class="nc">CachingMetadataReaderFactory</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span><span class="o">).</span><span class="na">clearCache</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>由此可见 <strong>processConfigBeanDefinitions</strong> 主要分为五步:</p>
<ol>
  <li>获取注册表中已注册的bean定义,并挑选出配置类候选(使用@Configuration注解的类)并加入到configCandidates中</li>
  <li>解析前置操作:根据@Order排序候选者、设置bean名称生成策略、设置Environment、最重要的就是创建ConfigurationClassParser解析器</li>
  <li>通过ConfigurationClassParser的parse方法解析候选类 也就是主函数(核心逻辑),总结来说就是解析配置类上的所有注解属性并将这些bean添加到bean工厂中</li>
  <li>通过reader.loadBeanDefinitions方法加载所有的配置类,其中注册导入的配置类自身、相关@Bean方法导入的类、@ImportResource导入的类和@Import导入的类的定义</li>
  <li>最后检测后扫描到的配置类中是否有未扫描到的,存在则加入到candidates中继续解析</li>
</ol>

<hr />

<h3 id="processconfigbeandefinitions源码解析">processConfigBeanDefinitions源码解析</h3>
<hr />

<ol>
  <li>既然是要解析配置类,肯定要先找到符合条件的配置类,相关源码如下:
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Build and validate a configuration model based on the registry of
 * {@link Configuration} classes.
 * 基于Configuration类的注册表构建和验证配置模型
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">processConfigBeanDefinitions</span><span class="o">(</span><span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
 <span class="c1">//1.获取注册表中已注册的bean定义,并挑选出配置类候选(使用@Configuration注解的类)并加入到configCandidates中</span>
 <span class="nc">List</span><span class="o">&lt;</span><span class="nc">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="n">configCandidates</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
 <span class="nc">String</span><span class="o">[]</span> <span class="n">candidateNames</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getBeanDefinitionNames</span><span class="o">();</span>

 <span class="c1">//从前面加载的候选者中找到被@Configuration修饰的类并把该类封装为BeanDefinitionHolder</span>
 <span class="c1">//主要是处理主函数类</span>
 <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span> <span class="o">:</span> <span class="n">candidateNames</span><span class="o">)</span> <span class="o">{</span>
     <span class="nc">BeanDefinition</span> <span class="n">beanDef</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">beanDef</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">CONFIGURATION_CLASS_ATTRIBUTE</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
             <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Bean definition has already been processed as a configuration class: "</span> <span class="o">+</span> <span class="n">beanDef</span><span class="o">);</span>
         <span class="o">}</span>
     <span class="o">}</span>
     <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">checkConfigurationClassCandidate</span><span class="o">(</span><span class="n">beanDef</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span><span class="o">))</span> <span class="o">{</span>
         <span class="c1">//将匹配的bean添加到配置候选者中</span>
         <span class="n">configCandidates</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">BeanDefinitionHolder</span><span class="o">(</span><span class="n">beanDef</span><span class="o">,</span> <span class="n">beanName</span><span class="o">));</span>
     <span class="o">}</span>
 <span class="o">}</span>

 <span class="c1">// Return immediately if no @Configuration classes were found</span>
 <span class="c1">//如果没有发现@Configuration配置的类直接返回</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">configCandidates</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
     <span class="k">return</span><span class="o">;</span>
 <span class="o">}</span>
 <span class="o">...</span>
<span class="o">}</span>
</code></pre></div>    </div>
    <p>  遍历注册表中所有的bean定义,再通过 <strong>ConfigurationClassUtils.checkConfigurationClassCandidate</strong> 方法判断是否满足配置类条件.满足条件则加入到configCandidates中.最后若configCandidates为空则直接返回.<br />
  我们继续往看看这个检查配置类的方法做了什么:</p>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
        * Check whether the given bean definition is a candidate for a configuration class
        * (or a nested component class declared within a configuration/component class,
        * to be auto-registered as well), and mark it accordingly.
        * 检查给定的bean定义是否是配置类的候选者(或在配置/组件类中声明的嵌套组件类,也可以自动注册),并且相应的标记他
        * @param beanDef the bean definition to check
        * @param metadataReaderFactory the current factory in use by the caller
        * @return whether the candidate qualifies as (any kind of) configuration class
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">checkConfigurationClassCandidate</span><span class="o">(</span>
     <span class="nc">BeanDefinition</span> <span class="n">beanDef</span><span class="o">,</span> <span class="nc">MetadataReaderFactory</span> <span class="n">metadataReaderFactory</span><span class="o">)</span> <span class="o">{</span>

 <span class="nc">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">beanDef</span><span class="o">.</span><span class="na">getBeanClassName</span><span class="o">();</span>
 <span class="c1">//1.当前bean定义无类名 一般是内部类类名为null 不存在返回false</span>
 <span class="c1">//2.当前bean定义存在工厂方法名 存在则返回false</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">className</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">beanDef</span><span class="o">.</span><span class="na">getFactoryMethodName</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
     <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
 <span class="o">}</span>

 <span class="c1">//根据bean定义获取注解元数据</span>
 <span class="nc">AnnotationMetadata</span> <span class="n">metadata</span><span class="o">;</span>
 <span class="c1">//当前bean定义是否属于注解相关的bean定义</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">beanDef</span> <span class="k">instanceof</span> <span class="nc">AnnotatedBeanDefinition</span> <span class="o">&amp;&amp;</span>
         <span class="c1">//当前bean定义的类名是否与AnnotationMetadata的类名一致</span>
         <span class="n">className</span><span class="o">.</span><span class="na">equals</span><span class="o">(((</span><span class="nc">AnnotatedBeanDefinition</span><span class="o">)</span> <span class="n">beanDef</span><span class="o">).</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getClassName</span><span class="o">()))</span> <span class="o">{</span>
     <span class="c1">// Can reuse the pre-parsed metadata from the given BeanDefinition...</span>
     <span class="c1">// 可以重复使用来自给定bean定义的预解析元数据   主要获取启动类的元数据</span>
     <span class="n">metadata</span> <span class="o">=</span> <span class="o">((</span><span class="nc">AnnotatedBeanDefinition</span><span class="o">)</span> <span class="n">beanDef</span><span class="o">).</span><span class="na">getMetadata</span><span class="o">();</span>
 <span class="o">}</span>
 <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">beanDef</span> <span class="k">instanceof</span> <span class="nc">AbstractBeanDefinition</span> <span class="o">&amp;&amp;</span> <span class="o">((</span><span class="nc">AbstractBeanDefinition</span><span class="o">)</span> <span class="n">beanDef</span><span class="o">).</span><span class="na">hasBeanClass</span><span class="o">())</span> <span class="o">{</span>
     <span class="c1">// Check already loaded Class if present...</span>
     <span class="c1">//检查已加载的类 如果存在的话</span>
     <span class="c1">// since we possibly can't even load the class file for this Class.</span>
     <span class="c1">//因为我们甚至可能无法加载此类的类文件</span>
     <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">beanClass</span> <span class="o">=</span> <span class="o">((</span><span class="nc">AbstractBeanDefinition</span><span class="o">)</span> <span class="n">beanDef</span><span class="o">).</span><span class="na">getBeanClass</span><span class="o">();</span>
     <span class="k">if</span> <span class="o">(</span><span class="nc">BeanFactoryPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">beanClass</span><span class="o">)</span> <span class="o">||</span>
             <span class="nc">BeanPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">beanClass</span><span class="o">)</span> <span class="o">||</span>
             <span class="nc">AopInfrastructureBean</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">beanClass</span><span class="o">)</span> <span class="o">||</span>
             <span class="nc">EventListenerFactory</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">beanClass</span><span class="o">))</span> <span class="o">{</span>
         <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
     <span class="o">}</span>
     <span class="n">metadata</span> <span class="o">=</span> <span class="nc">AnnotationMetadata</span><span class="o">.</span><span class="na">introspect</span><span class="o">(</span><span class="n">beanClass</span><span class="o">);</span>
 <span class="o">}</span>
 <span class="k">else</span> <span class="o">{</span>
     <span class="k">try</span> <span class="o">{</span>
         <span class="nc">MetadataReader</span> <span class="n">metadataReader</span> <span class="o">=</span> <span class="n">metadataReaderFactory</span><span class="o">.</span><span class="na">getMetadataReader</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>
         <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadataReader</span><span class="o">.</span><span class="na">getAnnotationMetadata</span><span class="o">();</span>
     <span class="o">}</span>
     <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
             <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Could not find class file for introspecting configuration annotations: "</span> <span class="o">+</span>
                     <span class="n">className</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
         <span class="o">}</span>
         <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
     <span class="o">}</span>
 <span class="o">}</span>

 <span class="c1">//从元数据中获取Configuration注解的属性</span>
 <span class="c1">//若bean定义被@Configuration修饰 且 proxyBeanMethods不为false 则设置configurationClass属性为full</span>
 <span class="c1">//若bean定义被@Component、@ComponentScan、@Import、@ImportResource和@Bean修饰 则设置configurationClass属性为lite</span>
 <span class="c1">//否则表明没有被@Configuration修饰  直接返回false</span>
 <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">config</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="na">getAnnotationAttributes</span><span class="o">(</span><span class="nc">Configuration</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">config</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nc">Boolean</span><span class="o">.</span><span class="na">FALSE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"proxyBeanMethods"</span><span class="o">)))</span> <span class="o">{</span>
     <span class="n">beanDef</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="no">CONFIGURATION_CLASS_ATTRIBUTE</span><span class="o">,</span> <span class="no">CONFIGURATION_CLASS_FULL</span><span class="o">);</span>
 <span class="o">}</span>
 <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">config</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">isConfigurationCandidate</span><span class="o">(</span><span class="n">metadata</span><span class="o">))</span> <span class="o">{</span>
     <span class="n">beanDef</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="no">CONFIGURATION_CLASS_ATTRIBUTE</span><span class="o">,</span> <span class="no">CONFIGURATION_CLASS_LITE</span><span class="o">);</span>
 <span class="o">}</span>
 <span class="k">else</span> <span class="o">{</span>
     <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
 <span class="o">}</span>

 <span class="c1">// It's a full or lite configuration candidate... Let's determine the order value, if any.</span>
 <span class="c1">//他是完整或精简的配置候选  确认他的优先级值,如果有的话</span>
 <span class="nc">Integer</span> <span class="n">order</span> <span class="o">=</span> <span class="n">getOrder</span><span class="o">(</span><span class="n">metadata</span><span class="o">);</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">order</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">beanDef</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="no">ORDER_ATTRIBUTE</span><span class="o">,</span> <span class="n">order</span><span class="o">);</span>
 <span class="o">}</span>
 <span class="c1">//最后返回true  已经解析过配置 表明是被@Configuration修饰的类</span>
 <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div>    </div>
    <p>  第一步就是找到满足候选者添加的bean,首先保证该bean不存在bean名称且它的工厂方法名必须为空,即表明它是一个真正的类且不是工厂方法.<br />
  然后获取该bean定义的注解元数据,用处肯定就是获取 <strong>@Configuration</strong> 的配置了,在根据配置的 <strong>proxyBeanMethods</strong> 属性设置bean定义的 <strong>configurationClass</strong> 属性.若bean定义是被 <strong>@Configration</strong> 修饰的则该属性为 <strong>full</strong> ;若该属性是被 <strong>@Component、@ComponentScan、@Import、@ImportResource</strong> 修饰的则该属性为 <strong>lite</strong>.<br />
  若存在 <strong>@Order</strong> 属性则设置它的优先级,处理到此时说明该bean已经是候选配置类了,直接返回true.</p>
    <blockquote>
      <p>第一步的主要作用就是根据@Configuration的属性检查使用被@Configuration修饰,并设置相应的属性到bean定义中,满足条件则加入到configCandidates中.</p>
    </blockquote>
  </li>
  <li>第一步已经找到符合条件的配置类了,那么第二步就是为解析做准备:
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Build and validate a configuration model based on the registry of
 * {@link Configuration} classes.
 * 基于Configuration类的注册表构建和验证配置模型
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">processConfigBeanDefinitions</span><span class="o">(</span><span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
 <span class="o">...</span>
    
 <span class="c1">//2. 解析前置操作:根据@Order排序候选者、设置bean名称生成策略、设置Environment、最重要的就是创建ConfigurationClassParser解析器</span>
 <span class="c1">// Sort by previously determined @Order value, if applicable</span>
 <span class="c1">//如果适用的话,根据先前确定的@Order的值排序  order值越小优先级越高</span>
 <span class="n">configCandidates</span><span class="o">.</span><span class="na">sort</span><span class="o">((</span><span class="n">bd1</span><span class="o">,</span> <span class="n">bd2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
     <span class="kt">int</span> <span class="n">i1</span> <span class="o">=</span> <span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">getOrder</span><span class="o">(</span><span class="n">bd1</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">());</span>
     <span class="kt">int</span> <span class="n">i2</span> <span class="o">=</span> <span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">getOrder</span><span class="o">(</span><span class="n">bd2</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">());</span>
     <span class="k">return</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="n">i1</span><span class="o">,</span> <span class="n">i2</span><span class="o">);</span>
 <span class="o">});</span>

 <span class="c1">// Detect any custom bean name generation strategy supplied through the enclosing application context</span>
 <span class="c1">//检测 通过封闭应用上下文提供的任何自定义bean名称生成策略</span>
 <span class="nc">SingletonBeanRegistry</span> <span class="n">sbr</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">registry</span> <span class="k">instanceof</span> <span class="nc">SingletonBeanRegistry</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">sbr</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SingletonBeanRegistry</span><span class="o">)</span> <span class="n">registry</span><span class="o">;</span>
     <span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">localBeanNameGeneratorSet</span><span class="o">)</span> <span class="o">{</span>
         <span class="nc">BeanNameGenerator</span> <span class="n">generator</span> <span class="o">=</span> <span class="o">(</span><span class="nc">BeanNameGenerator</span><span class="o">)</span> <span class="n">sbr</span><span class="o">.</span><span class="na">getSingleton</span><span class="o">(</span>
                 <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">CONFIGURATION_BEAN_NAME_GENERATOR</span><span class="o">);</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">generator</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
             <span class="k">this</span><span class="o">.</span><span class="na">componentScanBeanNameGenerator</span> <span class="o">=</span> <span class="n">generator</span><span class="o">;</span>
             <span class="k">this</span><span class="o">.</span><span class="na">importBeanNameGenerator</span> <span class="o">=</span> <span class="n">generator</span><span class="o">;</span>
         <span class="o">}</span>
     <span class="o">}</span>
 <span class="o">}</span>

 <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">environment</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
     <span class="k">this</span><span class="o">.</span><span class="na">environment</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StandardEnvironment</span><span class="o">();</span>
 <span class="o">}</span>

 <span class="c1">// Parse each @Configuration class</span>
 <span class="c1">//解析每一个@Configuration修饰的类</span>
 <span class="nc">ConfigurationClassParser</span> <span class="n">parser</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConfigurationClassParser</span><span class="o">(</span>
         <span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">problemReporter</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">,</span>
         <span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">componentScanBeanNameGenerator</span><span class="o">,</span> <span class="n">registry</span><span class="o">);</span>
    
 <span class="o">...</span>
<span class="o">}</span>
</code></pre></div>    </div>
    <p>  由上可见,首先将configCandidates中的配置类根据 <strong>@Order</strong> 的值排序,然后设置bean名称生成器和环境,最后也是最重要的生成 <strong>ConfigurationClassParser</strong> 配置类解析器.</p>
    <blockquote>
      <p>第二步的主要作用就是在准备ConfigurationClassParser配置类解析器.</p>
    </blockquote>
  </li>
  <li>第三步就是最最重要的一步了,解析配置类:
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Build and validate a configuration model based on the registry of
 * {@link Configuration} classes.
 * 基于Configuration类的注册表构建和验证配置模型
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">processConfigBeanDefinitions</span><span class="o">(</span><span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
 <span class="o">...</span>
    
 <span class="c1">//3. 通过ConfigurationClassParser的parse方法解析候选类 也就是主函数</span>
 <span class="c1">//3.1 首先通过parse方法进行解析主函数,这里就将所有的注解都解析的干干净净 具体逻辑稍后分析</span>
 <span class="c1">//3.1 解析完后进行验证,主要验证解析后配置类及其中的属性是否合法</span>
 <span class="c1">//3.3 此时已经将所有的配置类都解析好了,但是还有通过@Import或@Bean或@ImportedResources或ImportBeanDefinitionRegister的bean未注册,这步就是注册这些类的</span>
 <span class="c1">//3.4 最后就是筛选出所有已经真正解析过的配置类 若存在未解析的加入到candidates中继续进行解析</span>
 <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="n">candidates</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="n">configCandidates</span><span class="o">);</span>
 <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">ConfigurationClass</span><span class="o">&gt;</span> <span class="n">alreadyParsed</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;(</span><span class="n">configCandidates</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
 <span class="k">do</span> <span class="o">{</span>
     <span class="c1">//使用ConfigurationClassParser解析每一个配置候选者</span>
     <span class="c1">//即解析主函数 主要作用是 解析每个注解</span>
     <span class="c1">//1.@PropertySource</span>
     <span class="c1">//2.@ComponentScan 根据注解的路径扫描所有需要加载的配置类  默认是扫描主类下的所有文件</span>
     <span class="c1">//3.@Import 根据@Import注解加载所有的导入类  最重要的是通过SpringBoot中的AutoConfigurationImportSelector来加载所有自动配置的类</span>
     <span class="c1">//4.@ImportResource</span>
     <span class="c1">//5.@Bean</span>
     <span class="c1">//6.default methods on interfaces</span>
     <span class="c1">//7.Process superclass</span>
     <span class="n">parser</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">candidates</span><span class="o">);</span>
     <span class="n">parser</span><span class="o">.</span><span class="na">validate</span><span class="o">();</span>

     <span class="o">...</span>
<span class="o">}</span>
</code></pre></div>    </div>
    <p>全部的解析动作都在 <strong>parser.parse()</strong> 中,我们继续往下看源码:</p>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">parse</span><span class="o">(</span><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="n">configCandidates</span><span class="o">)</span> <span class="o">{</span>
 <span class="c1">//1. 判断候选配置类定义属于哪种bean定义 执行相应的解析方法</span>
 <span class="k">for</span> <span class="o">(</span><span class="nc">BeanDefinitionHolder</span> <span class="n">holder</span> <span class="o">:</span> <span class="n">configCandidates</span><span class="o">)</span> <span class="o">{</span>
     <span class="nc">BeanDefinition</span> <span class="n">bd</span> <span class="o">=</span> <span class="n">holder</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">();</span>
     <span class="k">try</span> <span class="o">{</span>
         <span class="c1">//如果该bean定义是注解类型的bean定义 调用AnnotatedBeanDefinition中的parse方法</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">bd</span> <span class="k">instanceof</span> <span class="nc">AnnotatedBeanDefinition</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">parse</span><span class="o">(((</span><span class="nc">AnnotatedBeanDefinition</span><span class="o">)</span> <span class="n">bd</span><span class="o">).</span><span class="na">getMetadata</span><span class="o">(),</span> <span class="n">holder</span><span class="o">.</span><span class="na">getBeanName</span><span class="o">());</span>
         <span class="o">}</span>
         <span class="c1">//如果该bean定义是实现与AbstractBeanDefinition的注解 且该bean定义是否指定了一个bean类 是则调用AbstractBeanDefinition中的parse方法</span>
         <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">bd</span> <span class="k">instanceof</span> <span class="nc">AbstractBeanDefinition</span> <span class="o">&amp;&amp;</span> <span class="o">((</span><span class="nc">AbstractBeanDefinition</span><span class="o">)</span> <span class="n">bd</span><span class="o">).</span><span class="na">hasBeanClass</span><span class="o">())</span> <span class="o">{</span>
             <span class="n">parse</span><span class="o">(((</span><span class="nc">AbstractBeanDefinition</span><span class="o">)</span> <span class="n">bd</span><span class="o">).</span><span class="na">getBeanClass</span><span class="o">(),</span> <span class="n">holder</span><span class="o">.</span><span class="na">getBeanName</span><span class="o">());</span>
         <span class="o">}</span>
         <span class="k">else</span> <span class="o">{</span>
             <span class="n">parse</span><span class="o">(</span><span class="n">bd</span><span class="o">.</span><span class="na">getBeanClassName</span><span class="o">(),</span> <span class="n">holder</span><span class="o">.</span><span class="na">getBeanName</span><span class="o">());</span>
         <span class="o">}</span>
     <span class="o">}</span>
     <span class="k">catch</span> <span class="o">(</span><span class="nc">BeanDefinitionStoreException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
     <span class="o">}</span>
     <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span>
                 <span class="s">"Failed to parse configuration class ["</span> <span class="o">+</span> <span class="n">bd</span><span class="o">.</span><span class="na">getBeanClassName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
     <span class="o">}</span>
 <span class="o">}</span>

 <span class="c1">//2. 处理DeferredImportSelector的子类 主要要是AutoConfigurationImportSelector 用来加载所有的EnableAutoConfiguration的子类</span>
 <span class="k">this</span><span class="o">.</span><span class="na">deferredImportSelectorHandler</span><span class="o">.</span><span class="na">process</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div>    </div>
    <p>  可见解析分为两步,第一步根据bean定义的不同类型调用 <strong>parse()</strong> 方法进行解析配置类的所有注解,第二步就是调用 <strong>deferredImportSelectorHandler.process()</strong> 来处理 <strong>@Import</strong> 导入的自动配置类.详细解析流程见下.</p>
    <blockquote>
      <p>第三步的主要作用就是解析配置类,即找到通过@PropertySource、@ComponentScan、@Import、@ImportResource、@Bean指定的配置类</p>
    </blockquote>
  </li>
  <li>第四步通过 <strong>ConfigurationClassBeanDefinitionReader.loadBeanDefinitions</strong> 方法加载所有的配置类,源码如下:
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Read {@code configurationModel}, registering bean definitions
 * with the registry based on its contents.
 * 读取configurationModel,根据其内容向注册表注册bean定义
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">loadBeanDefinitions</span><span class="o">(</span><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">ConfigurationClass</span><span class="o">&gt;</span> <span class="n">configurationModel</span><span class="o">)</span> <span class="o">{</span>
 <span class="nc">TrackedConditionEvaluator</span> <span class="n">trackedConditionEvaluator</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TrackedConditionEvaluator</span><span class="o">();</span>
 <span class="k">for</span> <span class="o">(</span><span class="nc">ConfigurationClass</span> <span class="n">configClass</span> <span class="o">:</span> <span class="n">configurationModel</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">loadBeanDefinitionsForConfigurationClass</span><span class="o">(</span><span class="n">configClass</span><span class="o">,</span> <span class="n">trackedConditionEvaluator</span><span class="o">);</span>
 <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
    <p>  可见它遍历所有的配置类,调用 <strong>loadBeanDefinitionsForConfigurationClass</strong> 方法来进行加载,其源码如下:</p>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Read a particular {@link ConfigurationClass}, registering bean definitions
 * for the class itself and all of its {@link Bean} methods.
 * 读取特定的ConfigurationClass类,为类本身及其所有Bean方法注册bean定义
 */</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">loadBeanDefinitionsForConfigurationClass</span><span class="o">(</span>
     <span class="nc">ConfigurationClass</span> <span class="n">configClass</span><span class="o">,</span> <span class="nc">TrackedConditionEvaluator</span> <span class="n">trackedConditionEvaluator</span><span class="o">)</span> <span class="o">{</span>
 <span class="c1">//1.检验是否需要跳过 还是通过 @Conditional注解</span>
 <span class="c1">//若跳过则将当前配置类从注册中心和导入列表中移除</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">trackedConditionEvaluator</span><span class="o">.</span><span class="na">shouldSkip</span><span class="o">(</span><span class="n">configClass</span><span class="o">))</span> <span class="o">{</span>
     <span class="nc">String</span> <span class="n">beanName</span> <span class="o">=</span> <span class="n">configClass</span><span class="o">.</span><span class="na">getBeanName</span><span class="o">();</span>
     <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasLength</span><span class="o">(</span><span class="n">beanName</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">.</span><span class="na">containsBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">.</span><span class="na">removeBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
     <span class="o">}</span>
     <span class="k">this</span><span class="o">.</span><span class="na">importRegistry</span><span class="o">.</span><span class="na">removeImportingClass</span><span class="o">(</span><span class="n">configClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getClassName</span><span class="o">());</span>
     <span class="k">return</span><span class="o">;</span>
 <span class="o">}</span>
 <span class="c1">//2.判断该类是否由@Import导入的</span>
 <span class="c1">//是则将自身作为bean定义注册</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">configClass</span><span class="o">.</span><span class="na">isImported</span><span class="o">())</span> <span class="o">{</span>
     <span class="n">registerBeanDefinitionForImportedConfigurationClass</span><span class="o">(</span><span class="n">configClass</span><span class="o">);</span>
 <span class="o">}</span>
 <span class="c1">//3.获取配置类的bean方法 来注册bean定义</span>
 <span class="k">for</span> <span class="o">(</span><span class="nc">BeanMethod</span> <span class="n">beanMethod</span> <span class="o">:</span> <span class="n">configClass</span><span class="o">.</span><span class="na">getBeanMethods</span><span class="o">())</span> <span class="o">{</span>
     <span class="n">loadBeanDefinitionsForBeanMethod</span><span class="o">(</span><span class="n">beanMethod</span><span class="o">);</span>
 <span class="o">}</span>
 <span class="c1">//4.从ImportedResources中注册bean定义</span>
 <span class="n">loadBeanDefinitionsFromImportedResources</span><span class="o">(</span><span class="n">configClass</span><span class="o">.</span><span class="na">getImportedResources</span><span class="o">());</span>
 <span class="c1">//5.从ImportBeanDefinitionRegister中注册bean定义 主要是针对AutoConfigurationPackages.Registrar.class</span>
 <span class="n">loadBeanDefinitionsFromRegistrars</span><span class="o">(</span><span class="n">configClass</span><span class="o">.</span><span class="na">getImportBeanDefinitionRegistrars</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div>    </div>
    <p>  可见 <strong>loadBeanDefinitionsForConfigurationClass</strong> 可以分为五步:<br />
4.1 第一步前置检查,通过 <strong>@Conditional</strong> 配置检查该配置类是否需要跳过,若需要跳过则从注册中心和导入列表中移除该配置类<br />
4.2 第二步判断该配置类是否通过 <strong>@Import</strong> 导入的,若是,则将配置类自身作为bean定义注册. <strong>registerBeanDefinitionForImportedConfigurationClass</strong> 源码如下:</p>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Register the {@link Configuration} class itself as a bean definition.
 * 注册Configuration类自身作为bean定义
 */</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">registerBeanDefinitionForImportedConfigurationClass</span><span class="o">(</span><span class="nc">ConfigurationClass</span> <span class="n">configClass</span><span class="o">)</span> <span class="o">{</span>
 <span class="nc">AnnotationMetadata</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">configClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">();</span>
 <span class="c1">//通过配置类的元数据创建通用配置注解类</span>
 <span class="nc">AnnotatedGenericBeanDefinition</span> <span class="n">configBeanDef</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotatedGenericBeanDefinition</span><span class="o">(</span><span class="n">metadata</span><span class="o">);</span>

 <span class="nc">ScopeMetadata</span> <span class="n">scopeMetadata</span> <span class="o">=</span> <span class="n">scopeMetadataResolver</span><span class="o">.</span><span class="na">resolveScopeMetadata</span><span class="o">(</span><span class="n">configBeanDef</span><span class="o">);</span>
 <span class="n">configBeanDef</span><span class="o">.</span><span class="na">setScope</span><span class="o">(</span><span class="n">scopeMetadata</span><span class="o">.</span><span class="na">getScopeName</span><span class="o">());</span>
 <span class="nc">String</span> <span class="n">configBeanName</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">importBeanNameGenerator</span><span class="o">.</span><span class="na">generateBeanName</span><span class="o">(</span><span class="n">configBeanDef</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">);</span>
 <span class="c1">//处理通用注解</span>
 <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">processCommonDefinitionAnnotations</span><span class="o">(</span><span class="n">configBeanDef</span><span class="o">,</span> <span class="n">metadata</span><span class="o">);</span>

 <span class="c1">//创建bean定义持有者 并注册到注册表中</span>
 <span class="nc">BeanDefinitionHolder</span> <span class="n">definitionHolder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BeanDefinitionHolder</span><span class="o">(</span><span class="n">configBeanDef</span><span class="o">,</span> <span class="n">configBeanName</span><span class="o">);</span>
 <span class="n">definitionHolder</span> <span class="o">=</span> <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">applyScopedProxyMode</span><span class="o">(</span><span class="n">scopeMetadata</span><span class="o">,</span> <span class="n">definitionHolder</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">);</span>
 <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="n">definitionHolder</span><span class="o">.</span><span class="na">getBeanName</span><span class="o">(),</span> <span class="n">definitionHolder</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">());</span>
 <span class="c1">//注册bean定义</span>
 <span class="n">configClass</span><span class="o">.</span><span class="na">setBeanName</span><span class="o">(</span><span class="n">configBeanName</span><span class="o">);</span>

 <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
     <span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Registered bean definition for imported class '"</span> <span class="o">+</span> <span class="n">configBeanName</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
 <span class="o">}</span>
 <span class="o">}</span>
</code></pre></div>    </div>
    <p>  这段代码就比较清楚了,将配置类封装为AnnotatedGenericBeanDefinition并设置其属性,最后将其注册到注册中心中.<br />
 4.3 第三步则是处理所有@Bean方法,相关源码如下:</p>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
        * Read the given {@link BeanMethod}, registering bean definitions
        * with the BeanDefinitionRegistry based on its contents.
        * 读取给定的bean方法,根据其内容向BeanDefinitionRegistry注册bean定义
 */</span>
<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"deprecation"</span><span class="o">)</span>  <span class="c1">// for RequiredAnnotationBeanPostProcessor.SKIP_REQUIRED_CHECK_ATTRIBUTE</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">loadBeanDefinitionsForBeanMethod</span><span class="o">(</span><span class="nc">BeanMethod</span> <span class="n">beanMethod</span><span class="o">)</span> <span class="o">{</span>
 <span class="nc">ConfigurationClass</span> <span class="n">configClass</span> <span class="o">=</span> <span class="n">beanMethod</span><span class="o">.</span><span class="na">getConfigurationClass</span><span class="o">();</span>
 <span class="nc">MethodMetadata</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">beanMethod</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">();</span>
 <span class="nc">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="na">getMethodName</span><span class="o">();</span>

 <span class="c1">// Do we need to mark the bean as skipped by its condition?</span>
 <span class="c1">//我们是否需要通过他的条件将这个bean标记为跳过</span>
 <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">conditionEvaluator</span><span class="o">.</span><span class="na">shouldSkip</span><span class="o">(</span><span class="n">metadata</span><span class="o">,</span> <span class="nc">ConfigurationPhase</span><span class="o">.</span><span class="na">REGISTER_BEAN</span><span class="o">))</span> <span class="o">{</span>
     <span class="n">configClass</span><span class="o">.</span><span class="na">skippedBeanMethods</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">methodName</span><span class="o">);</span>
     <span class="k">return</span><span class="o">;</span>
 <span class="o">}</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">configClass</span><span class="o">.</span><span class="na">skippedBeanMethods</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">methodName</span><span class="o">))</span> <span class="o">{</span>
     <span class="k">return</span><span class="o">;</span>
 <span class="o">}</span>

 <span class="nc">AnnotationAttributes</span> <span class="n">bean</span> <span class="o">=</span> <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">attributesFor</span><span class="o">(</span><span class="n">metadata</span><span class="o">,</span> <span class="nc">Bean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
 <span class="nc">Assert</span><span class="o">.</span><span class="na">state</span><span class="o">(</span><span class="n">bean</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">,</span> <span class="s">"No @Bean annotation attributes"</span><span class="o">);</span>

 <span class="c1">// Consider name and any aliases</span>
 <span class="c1">//考虑名称和任何别名</span>
 <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">names</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getStringArray</span><span class="o">(</span><span class="s">"name"</span><span class="o">)));</span>
 <span class="nc">String</span> <span class="n">beanName</span> <span class="o">=</span> <span class="o">(!</span><span class="n">names</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">?</span> <span class="n">names</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">:</span> <span class="n">methodName</span><span class="o">);</span>

 <span class="c1">// Register aliases even when overridden</span>
 <span class="c1">//即使被覆盖也注册别名</span>
 <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">alias</span> <span class="o">:</span> <span class="n">names</span><span class="o">)</span> <span class="o">{</span>
     <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">.</span><span class="na">registerAlias</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">alias</span><span class="o">);</span>
 <span class="o">}</span>

 <span class="c1">// Has this effectively been overridden before (e.g. via XML)?</span>
 <span class="c1">// 这之前是否有效的被注册</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">isOverriddenByExistingDefinition</span><span class="o">(</span><span class="n">beanMethod</span><span class="o">,</span> <span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">beanName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">beanMethod</span><span class="o">.</span><span class="na">getConfigurationClass</span><span class="o">().</span><span class="na">getBeanName</span><span class="o">()))</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span><span class="n">beanMethod</span><span class="o">.</span><span class="na">getConfigurationClass</span><span class="o">().</span><span class="na">getResource</span><span class="o">().</span><span class="na">getDescription</span><span class="o">(),</span>
                 <span class="n">beanName</span><span class="o">,</span> <span class="s">"Bean name derived from @Bean method '"</span> <span class="o">+</span> <span class="n">beanMethod</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getMethodName</span><span class="o">()</span> <span class="o">+</span>
                 <span class="s">"' clashes with bean name for containing configuration class; please make those names unique!"</span><span class="o">);</span>
     <span class="o">}</span>
     <span class="k">return</span><span class="o">;</span>
 <span class="o">}</span>

 <span class="nc">ConfigurationClassBeanDefinition</span> <span class="n">beanDef</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConfigurationClassBeanDefinition</span><span class="o">(</span><span class="n">configClass</span><span class="o">,</span> <span class="n">metadata</span><span class="o">);</span>
 <span class="n">beanDef</span><span class="o">.</span><span class="na">setResource</span><span class="o">(</span><span class="n">configClass</span><span class="o">.</span><span class="na">getResource</span><span class="o">());</span>
 <span class="n">beanDef</span><span class="o">.</span><span class="na">setSource</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">sourceExtractor</span><span class="o">.</span><span class="na">extractSource</span><span class="o">(</span><span class="n">metadata</span><span class="o">,</span> <span class="n">configClass</span><span class="o">.</span><span class="na">getResource</span><span class="o">()));</span>

 <span class="c1">//当前bean方法是否为静态方法</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">metadata</span><span class="o">.</span><span class="na">isStatic</span><span class="o">())</span> <span class="o">{</span>
     <span class="c1">// static @Bean method</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">configClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">()</span> <span class="k">instanceof</span> <span class="nc">StandardAnnotationMetadata</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">beanDef</span><span class="o">.</span><span class="na">setBeanClass</span><span class="o">(((</span><span class="nc">StandardAnnotationMetadata</span><span class="o">)</span> <span class="n">configClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">()).</span><span class="na">getIntrospectedClass</span><span class="o">());</span>
     <span class="o">}</span>
     <span class="k">else</span> <span class="o">{</span>
         <span class="n">beanDef</span><span class="o">.</span><span class="na">setBeanClassName</span><span class="o">(</span><span class="n">configClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getClassName</span><span class="o">());</span>
     <span class="o">}</span>
     <span class="n">beanDef</span><span class="o">.</span><span class="na">setUniqueFactoryMethodName</span><span class="o">(</span><span class="n">methodName</span><span class="o">);</span>
 <span class="o">}</span>
 <span class="k">else</span> <span class="o">{</span>
     <span class="c1">// instance @Bean method</span>
     <span class="n">beanDef</span><span class="o">.</span><span class="na">setFactoryBeanName</span><span class="o">(</span><span class="n">configClass</span><span class="o">.</span><span class="na">getBeanName</span><span class="o">());</span>
     <span class="n">beanDef</span><span class="o">.</span><span class="na">setUniqueFactoryMethodName</span><span class="o">(</span><span class="n">methodName</span><span class="o">);</span>
 <span class="o">}</span>

 <span class="k">if</span> <span class="o">(</span><span class="n">metadata</span> <span class="k">instanceof</span> <span class="nc">StandardMethodMetadata</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">beanDef</span><span class="o">.</span><span class="na">setResolvedFactoryMethod</span><span class="o">(((</span><span class="nc">StandardMethodMetadata</span><span class="o">)</span> <span class="n">metadata</span><span class="o">).</span><span class="na">getIntrospectedMethod</span><span class="o">());</span>
 <span class="o">}</span>

 <span class="n">beanDef</span><span class="o">.</span><span class="na">setAutowireMode</span><span class="o">(</span><span class="nc">AbstractBeanDefinition</span><span class="o">.</span><span class="na">AUTOWIRE_CONSTRUCTOR</span><span class="o">);</span>
 <span class="n">beanDef</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">beans</span><span class="o">.</span><span class="na">factory</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">RequiredAnnotationBeanPostProcessor</span><span class="o">.</span>
         <span class="no">SKIP_REQUIRED_CHECK_ATTRIBUTE</span><span class="o">,</span> <span class="nc">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">);</span>

 <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">processCommonDefinitionAnnotations</span><span class="o">(</span><span class="n">beanDef</span><span class="o">,</span> <span class="n">metadata</span><span class="o">);</span>

 <span class="c1">//设置bean的属性</span>
 <span class="nc">Autowire</span> <span class="n">autowire</span> <span class="o">=</span> <span class="n">bean</span><span class="o">.</span><span class="na">getEnum</span><span class="o">(</span><span class="s">"autowire"</span><span class="o">);</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">autowire</span><span class="o">.</span><span class="na">isAutowire</span><span class="o">())</span> <span class="o">{</span>
     <span class="n">beanDef</span><span class="o">.</span><span class="na">setAutowireMode</span><span class="o">(</span><span class="n">autowire</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>
 <span class="o">}</span>

 <span class="kt">boolean</span> <span class="n">autowireCandidate</span> <span class="o">=</span> <span class="n">bean</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">"autowireCandidate"</span><span class="o">);</span>
 <span class="k">if</span> <span class="o">(!</span><span class="n">autowireCandidate</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">beanDef</span><span class="o">.</span><span class="na">setAutowireCandidate</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
 <span class="o">}</span>

 <span class="nc">String</span> <span class="n">initMethodName</span> <span class="o">=</span> <span class="n">bean</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"initMethod"</span><span class="o">);</span>
 <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">initMethodName</span><span class="o">))</span> <span class="o">{</span>
     <span class="n">beanDef</span><span class="o">.</span><span class="na">setInitMethodName</span><span class="o">(</span><span class="n">initMethodName</span><span class="o">);</span>
 <span class="o">}</span>

 <span class="nc">String</span> <span class="n">destroyMethodName</span> <span class="o">=</span> <span class="n">bean</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"destroyMethod"</span><span class="o">);</span>
 <span class="n">beanDef</span><span class="o">.</span><span class="na">setDestroyMethodName</span><span class="o">(</span><span class="n">destroyMethodName</span><span class="o">);</span>

 <span class="c1">// Consider scoping</span>
 <span class="c1">//考虑范围</span>
 <span class="nc">ScopedProxyMode</span> <span class="n">proxyMode</span> <span class="o">=</span> <span class="nc">ScopedProxyMode</span><span class="o">.</span><span class="na">NO</span><span class="o">;</span>
 <span class="nc">AnnotationAttributes</span> <span class="n">attributes</span> <span class="o">=</span> <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">attributesFor</span><span class="o">(</span><span class="n">metadata</span><span class="o">,</span> <span class="nc">Scope</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">attributes</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">beanDef</span><span class="o">.</span><span class="na">setScope</span><span class="o">(</span><span class="n">attributes</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"value"</span><span class="o">));</span>
     <span class="n">proxyMode</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="na">getEnum</span><span class="o">(</span><span class="s">"proxyMode"</span><span class="o">);</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">proxyMode</span> <span class="o">==</span> <span class="nc">ScopedProxyMode</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">proxyMode</span> <span class="o">=</span> <span class="nc">ScopedProxyMode</span><span class="o">.</span><span class="na">NO</span><span class="o">;</span>
     <span class="o">}</span>
 <span class="o">}</span>

 <span class="c1">// Replace the original bean definition with the target one, if necessary</span>
 <span class="c1">//如果有必要 将原始bean替换为目标bean</span>
 <span class="nc">BeanDefinition</span> <span class="n">beanDefToRegister</span> <span class="o">=</span> <span class="n">beanDef</span><span class="o">;</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">proxyMode</span> <span class="o">!=</span> <span class="nc">ScopedProxyMode</span><span class="o">.</span><span class="na">NO</span><span class="o">)</span> <span class="o">{</span>
     <span class="nc">BeanDefinitionHolder</span> <span class="n">proxyDef</span> <span class="o">=</span> <span class="nc">ScopedProxyCreator</span><span class="o">.</span><span class="na">createScopedProxy</span><span class="o">(</span>
             <span class="k">new</span> <span class="nf">BeanDefinitionHolder</span><span class="o">(</span><span class="n">beanDef</span><span class="o">,</span> <span class="n">beanName</span><span class="o">),</span> <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">,</span>
             <span class="n">proxyMode</span> <span class="o">==</span> <span class="nc">ScopedProxyMode</span><span class="o">.</span><span class="na">TARGET_CLASS</span><span class="o">);</span>
     <span class="n">beanDefToRegister</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConfigurationClassBeanDefinition</span><span class="o">(</span>
             <span class="o">(</span><span class="nc">RootBeanDefinition</span><span class="o">)</span> <span class="n">proxyDef</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">(),</span> <span class="n">configClass</span><span class="o">,</span> <span class="n">metadata</span><span class="o">);</span>
 <span class="o">}</span>

 <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
     <span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Registering bean definition for @Bean method %s.%s()"</span><span class="o">,</span>
             <span class="n">configClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getClassName</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">));</span>
 <span class="o">}</span>
 <span class="c1">//注册bean定义</span>
 <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">beanDefToRegister</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>    </div>
    <p>  看到这么长的一堆代码,任谁都不想看,但其实这段代码的逻辑并不复杂,还是先检查bean方法是否需要跳过,不需要跳过在根据配置类和@Bean注解的元数据创建bean定义,最后再注册到注册中心去即可.<br />
 4.4 从@ImportSource中加载bean定义,相关源码如下:</p>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">loadBeanDefinitionsFromImportedResources</span><span class="o">(</span>
     <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">BeanDefinitionReader</span><span class="o">&gt;&gt;</span> <span class="n">importedResources</span><span class="o">)</span> <span class="o">{</span>

 <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;,</span> <span class="nc">BeanDefinitionReader</span><span class="o">&gt;</span> <span class="n">readerInstanceCache</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

 <span class="n">importedResources</span><span class="o">.</span><span class="na">forEach</span><span class="o">((</span><span class="n">resource</span><span class="o">,</span> <span class="n">readerClass</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
     <span class="c1">// Default reader selection necessary?</span>
     <span class="c1">//需要选择默认读取器  主要是groovy或 xml方式</span>
     <span class="k">if</span> <span class="o">(</span><span class="nc">BeanDefinitionReader</span><span class="o">.</span><span class="na">class</span> <span class="o">==</span> <span class="n">readerClass</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">endsWithIgnoreCase</span><span class="o">(</span><span class="n">resource</span><span class="o">,</span> <span class="s">".groovy"</span><span class="o">))</span> <span class="o">{</span>
             <span class="c1">// When clearly asking for Groovy, that's what they'll get...</span>
             <span class="n">readerClass</span> <span class="o">=</span> <span class="nc">GroovyBeanDefinitionReader</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
         <span class="o">}</span>
         <span class="k">else</span> <span class="o">{</span>
             <span class="c1">// Primarily ".xml" files but for any other extension as well</span>
             <span class="n">readerClass</span> <span class="o">=</span> <span class="nc">XmlBeanDefinitionReader</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
         <span class="o">}</span>
     <span class="o">}</span>

     <span class="c1">//从缓存中读取bean定义读取器   不存在先创建bean定义读取器 最后再加载bean定义</span>
     <span class="nc">BeanDefinitionReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="n">readerInstanceCache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">readerClass</span><span class="o">);</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">reader</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">try</span> <span class="o">{</span>
             <span class="c1">// Instantiate the specified BeanDefinitionReader</span>
             <span class="c1">//实例化指定的bean定义读取器</span>
             <span class="n">reader</span> <span class="o">=</span> <span class="n">readerClass</span><span class="o">.</span><span class="na">getConstructor</span><span class="o">(</span><span class="nc">BeanDefinitionRegistry</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">newInstance</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">);</span>
             <span class="c1">// Delegate the current ResourceLoader to it if possible</span>
             <span class="c1">//如果可能的话委托给当前资源加载器</span>
             <span class="k">if</span> <span class="o">(</span><span class="n">reader</span> <span class="k">instanceof</span> <span class="nc">AbstractBeanDefinitionReader</span><span class="o">)</span> <span class="o">{</span>
                 <span class="nc">AbstractBeanDefinitionReader</span> <span class="n">abdr</span> <span class="o">=</span> <span class="o">((</span><span class="nc">AbstractBeanDefinitionReader</span><span class="o">)</span> <span class="n">reader</span><span class="o">);</span>
                 <span class="n">abdr</span><span class="o">.</span><span class="na">setResourceLoader</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span><span class="o">);</span>
                 <span class="n">abdr</span><span class="o">.</span><span class="na">setEnvironment</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">);</span>
             <span class="o">}</span>
             <span class="n">readerInstanceCache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">readerClass</span><span class="o">,</span> <span class="n">reader</span><span class="o">);</span>
         <span class="o">}</span>
         <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
             <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span>
                     <span class="s">"Could not instantiate BeanDefinitionReader class ["</span> <span class="o">+</span> <span class="n">readerClass</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
         <span class="o">}</span>
     <span class="o">}</span>

     <span class="c1">// TODO SPR-6310: qualify relative path locations as done in AbstractContextLoader.modifyLocations</span>
     <span class="n">reader</span><span class="o">.</span><span class="na">loadBeanDefinitions</span><span class="o">(</span><span class="n">resource</span><span class="o">);</span>
 <span class="o">});</span>
<span class="o">}</span>
</code></pre></div>    </div>
    <p>  此注解用的不是很多,做了解即可.它的主要作用是通过BeanDefinitionReader去加载指定的配置文件中的属性.<br />
 4.5 从导入的ImportBeanDefinitionRegistrar的实现类中加载bean定义,这里我们主要针对的是 <strong>AutoConfigurationPackages.Registrar.class</strong> 类,源码如下:</p>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//通过注册表注册bean定义</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">loadBeanDefinitionsFromRegistrars</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">ImportBeanDefinitionRegistrar</span><span class="o">,</span> <span class="nc">AnnotationMetadata</span><span class="o">&gt;</span> <span class="n">registrars</span><span class="o">)</span> <span class="o">{</span>
 <span class="n">registrars</span><span class="o">.</span><span class="na">forEach</span><span class="o">((</span><span class="n">registrar</span><span class="o">,</span> <span class="n">metadata</span><span class="o">)</span> <span class="o">-&gt;</span>
         <span class="n">registrar</span><span class="o">.</span><span class="na">registerBeanDefinitions</span><span class="o">(</span><span class="n">metadata</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">importBeanNameGenerator</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div>    </div>
    <p>  它的主要作用是调用每个ImportBeanDefinitionRegistrar的实现类重写的registerBeanDefinitions方法,我们继续看下 <strong>AutoConfigurationPackages.Registrar.class</strong> 中重写的方法:</p>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerBeanDefinitions</span><span class="o">(</span><span class="nc">AnnotationMetadata</span> <span class="n">metadata</span><span class="o">,</span> <span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">register</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="k">new</span> <span class="nc">PackageImport</span><span class="o">(</span><span class="n">metadata</span><span class="o">).</span><span class="na">getPackageName</span><span class="o">());</span>
 <span class="o">}</span>
    
 <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">BEAN</span> <span class="o">=</span> <span class="nc">AutoConfigurationPackages</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
    
 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">,</span> <span class="nc">String</span><span class="o">...</span> <span class="n">packageNames</span><span class="o">)</span> <span class="o">{</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">registry</span><span class="o">.</span><span class="na">containsBeanDefinition</span><span class="o">(</span><span class="no">BEAN</span><span class="o">))</span> <span class="o">{</span>
         <span class="nc">BeanDefinition</span> <span class="n">beanDefinition</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">(</span><span class="no">BEAN</span><span class="o">);</span>
         <span class="nc">ConstructorArgumentValues</span> <span class="n">constructorArguments</span> <span class="o">=</span> <span class="n">beanDefinition</span><span class="o">.</span><span class="na">getConstructorArgumentValues</span><span class="o">();</span>
         <span class="n">constructorArguments</span><span class="o">.</span><span class="na">addIndexedArgumentValue</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">addBasePackages</span><span class="o">(</span><span class="n">constructorArguments</span><span class="o">,</span> <span class="n">packageNames</span><span class="o">));</span>
     <span class="o">}</span>
     <span class="k">else</span> <span class="o">{</span>
         <span class="nc">GenericBeanDefinition</span> <span class="n">beanDefinition</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GenericBeanDefinition</span><span class="o">();</span>
         <span class="n">beanDefinition</span><span class="o">.</span><span class="na">setBeanClass</span><span class="o">(</span><span class="nc">BasePackages</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
         <span class="n">beanDefinition</span><span class="o">.</span><span class="na">getConstructorArgumentValues</span><span class="o">().</span><span class="na">addIndexedArgumentValue</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">packageNames</span><span class="o">);</span>
         <span class="n">beanDefinition</span><span class="o">.</span><span class="na">setRole</span><span class="o">(</span><span class="nc">BeanDefinition</span><span class="o">.</span><span class="na">ROLE_INFRASTRUCTURE</span><span class="o">);</span>
         <span class="n">registry</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="no">BEAN</span><span class="o">,</span> <span class="n">beanDefinition</span><span class="o">);</span>
     <span class="o">}</span>
 <span class="o">}</span>
</code></pre></div>    </div>
    <p>  可见AutoConfigurationPackages.Registrar的作用就是注册AutoConfigurationPackages的bean定义.</p>
    <blockquote>
      <p>第四步就是将上一阶段找到的配置类进行加载,主要针对以下几个方面:配置类自身、@Bean注解导入的类、@ImportSource注解导入的类和@Import导入的ImportBeanDefinitionRegistrar的实现类</p>
    </blockquote>
  </li>
  <li>第五步检查是否所有的配置类都已经解析过了,解析完直接结束,源码如下:
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Build and validate a configuration model based on the registry of
 * {@link Configuration} classes.
 * 基于Configuration类的注册表构建和验证配置模型
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">processConfigBeanDefinitions</span><span class="o">(</span><span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
     <span class="o">...</span>
        
     <span class="c1">//5.最后检测后扫描到的配置类中是否有未扫描到的,存在则加入到candidates中继续解析</span>
     <span class="c1">//如果注册表中的bean定义数量 大于 之前 加载的候选类数量</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">registry</span><span class="o">.</span><span class="na">getBeanDefinitionCount</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">candidateNames</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
         <span class="c1">//最新的候选配置类数组</span>
         <span class="nc">String</span><span class="o">[]</span> <span class="n">newCandidateNames</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getBeanDefinitionNames</span><span class="o">();</span>
         <span class="c1">//旧的候选配置类集合</span>
         <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">oldCandidateNames</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">candidateNames</span><span class="o">));</span>
         <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">alreadyParsedClasses</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
         <span class="c1">//添加到alreadyParsedClasses中</span>
         <span class="k">for</span> <span class="o">(</span><span class="nc">ConfigurationClass</span> <span class="n">configurationClass</span> <span class="o">:</span> <span class="n">alreadyParsed</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">alreadyParsedClasses</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">configurationClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getClassName</span><span class="o">());</span>
         <span class="o">}</span>
         <span class="c1">//比较新旧候选类  只有不存在于旧的候选者集合 且 属于配置候选者 才添加到candidates</span>
         <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">candidateName</span> <span class="o">:</span> <span class="n">newCandidateNames</span><span class="o">)</span> <span class="o">{</span>
             <span class="k">if</span> <span class="o">(!</span><span class="n">oldCandidateNames</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">candidateName</span><span class="o">))</span> <span class="o">{</span>
                 <span class="nc">BeanDefinition</span> <span class="n">bd</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">(</span><span class="n">candidateName</span><span class="o">);</span>
                 <span class="k">if</span> <span class="o">(</span><span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">checkConfigurationClassCandidate</span><span class="o">(</span><span class="n">bd</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                         <span class="o">!</span><span class="n">alreadyParsedClasses</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">bd</span><span class="o">.</span><span class="na">getBeanClassName</span><span class="o">()))</span> <span class="o">{</span>
                     <span class="n">candidates</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">BeanDefinitionHolder</span><span class="o">(</span><span class="n">bd</span><span class="o">,</span> <span class="n">candidateName</span><span class="o">));</span>
                 <span class="o">}</span>
             <span class="o">}</span>
         <span class="o">}</span>
         <span class="n">candidateNames</span> <span class="o">=</span> <span class="n">newCandidateNames</span><span class="o">;</span>
     <span class="o">}</span>
 <span class="o">}</span>
 <span class="k">while</span> <span class="o">(!</span><span class="n">candidates</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">());</span>

 <span class="c1">// Register the ImportRegistry as a bean in order to support ImportAware @Configuration classes</span>
 <span class="c1">//将ImportRegistry注册为一个bean 为了支持ImportAware的配置类</span>
 <span class="k">if</span> <span class="o">(</span><span class="n">sbr</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sbr</span><span class="o">.</span><span class="na">containsSingleton</span><span class="o">(</span><span class="no">IMPORT_REGISTRY_BEAN_NAME</span><span class="o">))</span> <span class="o">{</span>
     <span class="n">sbr</span><span class="o">.</span><span class="na">registerSingleton</span><span class="o">(</span><span class="no">IMPORT_REGISTRY_BEAN_NAME</span><span class="o">,</span> <span class="n">parser</span><span class="o">.</span><span class="na">getImportRegistry</span><span class="o">());</span>
 <span class="o">}</span>

 <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span> <span class="k">instanceof</span> <span class="nc">CachingMetadataReaderFactory</span><span class="o">)</span> <span class="o">{</span>
     <span class="c1">// Clear cache in externally provided MetadataReaderFactory; this is a no-op</span>
     <span class="c1">// for a shared cache since it'll be cleared by the ApplicationContext.</span>
     <span class="c1">//清除外部提供的MetadataReaderFactory中的缓存; 这是共享缓存的空操作,因为它将被ApplicationContext清除</span>
     <span class="o">((</span><span class="nc">CachingMetadataReaderFactory</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span><span class="o">).</span><span class="na">clearCache</span><span class="o">();</span>
 <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
    <p>  可见将注册中心中注册的bean定义同已经解析过配置类和之前的候选类做比较,只有满足配置类条件且同时不在已解析集合和候选者集合中时才需要继续解析.若最后candidates为空说明配置类解析完成.<br />
  最后注册ConfigurationClassPostProcessor的bean定义以及清除缓存.</p>
    <blockquote>
      <p>第五步最后检查是否还有漏掉的配置类,有则继续解析,没有则表明解析完成</p>
    </blockquote>
  </li>
</ol>

<hr />

<h3 id="configurationclassparserparsecandidates">ConfigurationClassParser.parse(candidates)</h3>
<hr />
<p>  我们先来看 <strong>parse</strong> 方法:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">parse</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">,</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="c1">//调用真正的解析方法</span>
    <span class="n">processConfigurationClass</span><span class="o">(</span><span class="k">new</span> <span class="nc">ConfigurationClass</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="n">beanName</span><span class="o">));</span>
<span class="o">}</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">processConfigurationClass</span><span class="o">(</span><span class="nc">ConfigurationClass</span> <span class="n">configClass</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="c1">//1. 判断是否被Conditional修饰 且 是否应该注册</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">conditionEvaluator</span><span class="o">.</span><span class="na">shouldSkip</span><span class="o">(</span><span class="n">configClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">(),</span> <span class="nc">ConfigurationPhase</span><span class="o">.</span><span class="na">PARSE_CONFIGURATION</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="c1">//2. 如果当前配置类已经被处理过 则继续判断是否是@Import导入的,是则合并并返回 不是则移除继续解析</span>
    <span class="nc">ConfigurationClass</span> <span class="n">existingClass</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">configurationClasses</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">configClass</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">existingClass</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">configClass</span><span class="o">.</span><span class="na">isImported</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">existingClass</span><span class="o">.</span><span class="na">isImported</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">existingClass</span><span class="o">.</span><span class="na">mergeImportedBy</span><span class="o">(</span><span class="n">configClass</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// Otherwise ignore new imported config class; existing non-imported class overrides it.</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// Explicit bean definition found, probably replacing an import.</span>
            <span class="c1">// Let's remove the old one and go with the new one.</span>
            <span class="k">this</span><span class="o">.</span><span class="na">configurationClasses</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">configClass</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">knownSuperclasses</span><span class="o">.</span><span class="na">values</span><span class="o">().</span><span class="na">removeIf</span><span class="o">(</span><span class="nl">configClass:</span><span class="o">:</span><span class="n">equals</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// Recursively process the configuration class and its superclass hierarchy.</span>
    <span class="c1">//3. 递归处理配置类及其超类层次结构</span>
    <span class="nc">SourceClass</span> <span class="n">sourceClass</span> <span class="o">=</span> <span class="n">asSourceClass</span><span class="o">(</span><span class="n">configClass</span><span class="o">);</span>
    <span class="k">do</span> <span class="o">{</span><span class="n">候选者实现了</span> <span class="nc">ImportSelector</span> <span class="n">接口</span>
        <span class="c1">//执行解析逻辑</span>
        <span class="n">sourceClass</span> <span class="o">=</span> <span class="n">doProcessConfigurationClass</span><span class="o">(</span><span class="n">configClass</span><span class="o">,</span> <span class="n">sourceClass</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">sourceClass</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>

    <span class="k">this</span><span class="o">.</span><span class="na">configurationClasses</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">configClass</span><span class="o">,</span> <span class="n">configClass</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  我们先来看下 <strong>processConfigurationClass</strong> 的逻辑:<br />
1.第一步先判断当前配置类是否应该跳过,判断的条件是什么呢,我们看下源码:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Determine if an item should be skipped based on {@code @Conditional} annotations.
 * 根据@Conditional注解确定是否应该跳过该项目
 * @param metadata the meta data
 * @param phase the phase of the call
 * @return if the item should be skipped
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">shouldSkip</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">AnnotatedTypeMetadata</span> <span class="n">metadata</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">ConfigurationPhase</span> <span class="n">phase</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//如果注解元数据为null返回false   或 注解元数据不为null且注解元数据未被Conditional修饰也返回false</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">metadata</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">metadata</span><span class="o">.</span><span class="na">isAnnotated</span><span class="o">(</span><span class="nc">Conditional</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//如果配置解析器为null</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">phase</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">metadata</span> <span class="k">instanceof</span> <span class="nc">AnnotationMetadata</span> <span class="o">&amp;&amp;</span>
                <span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">isConfigurationCandidate</span><span class="o">((</span><span class="nc">AnnotationMetadata</span><span class="o">)</span> <span class="n">metadata</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">shouldSkip</span><span class="o">(</span><span class="n">metadata</span><span class="o">,</span> <span class="nc">ConfigurationPhase</span><span class="o">.</span><span class="na">PARSE_CONFIGURATION</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nf">shouldSkip</span><span class="o">(</span><span class="n">metadata</span><span class="o">,</span> <span class="nc">ConfigurationPhase</span><span class="o">.</span><span class="na">REGISTER_BEAN</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Condition</span><span class="o">&gt;</span> <span class="n">conditions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="c1">//获取@Conditional的value值并存入conditions中</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">conditionClasses</span> <span class="o">:</span> <span class="n">getConditionClasses</span><span class="o">(</span><span class="n">metadata</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">conditionClass</span> <span class="o">:</span> <span class="n">conditionClasses</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Condition</span> <span class="n">condition</span> <span class="o">=</span> <span class="n">getCondition</span><span class="o">(</span><span class="n">conditionClass</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">());</span>
            <span class="n">conditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">condition</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nc">AnnotationAwareOrderComparator</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">conditions</span><span class="o">);</span>

    <span class="k">for</span> <span class="o">(</span><span class="nc">Condition</span> <span class="n">condition</span> <span class="o">:</span> <span class="n">conditions</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ConfigurationPhase</span> <span class="n">requiredPhase</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">condition</span> <span class="k">instanceof</span> <span class="nc">ConfigurationCondition</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">requiredPhase</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ConfigurationCondition</span><span class="o">)</span> <span class="n">condition</span><span class="o">).</span><span class="na">getConfigurationPhase</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">requiredPhase</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">requiredPhase</span> <span class="o">==</span> <span class="n">phase</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">condition</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">context</span><span class="o">,</span> <span class="n">metadata</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  看到 <strong>@Conditional</strong> 这个注解是不是就很熟悉了,就是根据 <strong>Conditional</strong> 的属性来判断是否需要跳过.<br />
2.第二步则是判断当前配置类使用已经解析过,如果是通过 <strong>@Import</strong> 导入的配置类则合并并返回,不是则移除配置类继续解析<br />
3.第三步就是获取配置类源信息并通过 <strong>doProcessConfigurationClass</strong> 来进行解析配置类,最后再将解析过的配置类添加到configurationClasses中<br />
  接下来我们着重来看看这个 <strong>doProcessConfigurationClass</strong> :</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kd">final</span> <span class="nc">SourceClass</span> <span class="nf">doProcessConfigurationClass</span><span class="o">(</span><span class="nc">ConfigurationClass</span> <span class="n">configClass</span><span class="o">,</span> <span class="nc">SourceClass</span> <span class="n">sourceClass</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="c1">//3.1 首先递归处理任何嵌套的成员类</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">configClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">isAnnotated</span><span class="o">(</span><span class="nc">Component</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
        <span class="c1">// Recursively process any member (nested) classes first</span>
        <span class="n">processMemberClasses</span><span class="o">(</span><span class="n">configClass</span><span class="o">,</span> <span class="n">sourceClass</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// Process any @PropertySource annotations</span>
    <span class="c1">//3.2 处理所有的@PropertySource注解</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">AnnotationAttributes</span> <span class="n">propertySource</span> <span class="o">:</span> <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">attributesForRepeatable</span><span class="o">(</span>
            <span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">(),</span> <span class="nc">PropertySources</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">PropertySource</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">environment</span> <span class="k">instanceof</span> <span class="nc">ConfigurableEnvironment</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">processPropertySource</span><span class="o">(</span><span class="n">propertySource</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Ignoring @PropertySource annotation on ["</span> <span class="o">+</span> <span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getClassName</span><span class="o">()</span> <span class="o">+</span>
                    <span class="s">"]. Reason: Environment must implement ConfigurableEnvironment"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// Process any @ComponentScan annotations</span>
    <span class="c1">//3.3 处理所有的@ComponentScan注解</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">AnnotationAttributes</span><span class="o">&gt;</span> <span class="n">componentScans</span> <span class="o">=</span> <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">attributesForRepeatable</span><span class="o">(</span>
            <span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">(),</span> <span class="nc">ComponentScans</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">ComponentScan</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="c1">//扫描到的ComponentScan不为空且 Conditonal修饰的注解条件不应该跳过</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">componentScans</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="k">this</span><span class="o">.</span><span class="na">conditionEvaluator</span><span class="o">.</span><span class="na">shouldSkip</span><span class="o">(</span><span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">(),</span> <span class="nc">ConfigurationPhase</span><span class="o">.</span><span class="na">REGISTER_BEAN</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">AnnotationAttributes</span> <span class="n">componentScan</span> <span class="o">:</span> <span class="n">componentScans</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// The config class is annotated with @ComponentScan -&gt; perform the scan immediately</span>
            <span class="c1">//使用@ComponentScans注解修饰的配置类  -&gt; 立即执行扫描</span>
            <span class="c1">//扫描到ComponectScan指定的类  默认classpath下的所有类且被@Component修饰的类</span>
            <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="n">scannedBeanDefinitions</span> <span class="o">=</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">componentScanParser</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">componentScan</span><span class="o">,</span> <span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getClassName</span><span class="o">());</span>
            <span class="c1">// Check the set of scanned definitions for any further config classes and parse recursively if needed</span>
            <span class="c1">// 检查任何其他配置类的扫描定义集合 并 在需要时递归解析</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">BeanDefinitionHolder</span> <span class="n">holder</span> <span class="o">:</span> <span class="n">scannedBeanDefinitions</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">BeanDefinition</span> <span class="n">bdCand</span> <span class="o">=</span> <span class="n">holder</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">().</span><span class="na">getOriginatingBeanDefinition</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">bdCand</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">bdCand</span> <span class="o">=</span> <span class="n">holder</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="c1">//检查通过ComponentScan扫描出来的类是否满足Configuration的候选 满足则进行类解析逻辑</span>
                <span class="k">if</span> <span class="o">(</span><span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">checkConfigurationClassCandidate</span><span class="o">(</span><span class="n">bdCand</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">parse</span><span class="o">(</span><span class="n">bdCand</span><span class="o">.</span><span class="na">getBeanClassName</span><span class="o">(),</span> <span class="n">holder</span><span class="o">.</span><span class="na">getBeanName</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// Process any @Import annotations</span>
    <span class="c1">//3.4 处理所有的@Import的注解</span>
    <span class="c1">//getImport方法目前在springboot启动中有以下几个值</span>
    <span class="c1">//1.org.springframework.boot.autoconfigure.AutoConfigurationImportSelector</span>
    <span class="c1">//2.org.springframework.boot.autoconfigure.AutoConfigurationPackages.Registrar</span>
    <span class="c1">//主要用于 处理所有使用@Import注解额类</span>
    <span class="n">processImports</span><span class="o">(</span><span class="n">configClass</span><span class="o">,</span> <span class="n">sourceClass</span><span class="o">,</span> <span class="n">getImports</span><span class="o">(</span><span class="n">sourceClass</span><span class="o">),</span> <span class="kc">true</span><span class="o">);</span>

    <span class="c1">// Process any @ImportResource annotations</span>
    <span class="c1">//3.5 处理所有存在的@ImportResource注解</span>
    <span class="nc">AnnotationAttributes</span> <span class="n">importResource</span> <span class="o">=</span>
            <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">attributesFor</span><span class="o">(</span><span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">(),</span> <span class="nc">ImportResource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">importResource</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span><span class="o">[]</span> <span class="n">resources</span> <span class="o">=</span> <span class="n">importResource</span><span class="o">.</span><span class="na">getStringArray</span><span class="o">(</span><span class="s">"locations"</span><span class="o">);</span>
        <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">BeanDefinitionReader</span><span class="o">&gt;</span> <span class="n">readerClass</span> <span class="o">=</span> <span class="n">importResource</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="s">"reader"</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">resource</span> <span class="o">:</span> <span class="n">resources</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">resolvedResource</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">.</span><span class="na">resolveRequiredPlaceholders</span><span class="o">(</span><span class="n">resource</span><span class="o">);</span>
            <span class="n">configClass</span><span class="o">.</span><span class="na">addImportedResource</span><span class="o">(</span><span class="n">resolvedResource</span><span class="o">,</span> <span class="n">readerClass</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// Process individual @Bean methods</span>
    <span class="c1">//3.6 处理所有独立的@Bean方法</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">MethodMetadata</span><span class="o">&gt;</span> <span class="n">beanMethods</span> <span class="o">=</span> <span class="n">retrieveBeanMethodMetadata</span><span class="o">(</span><span class="n">sourceClass</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">MethodMetadata</span> <span class="n">methodMetadata</span> <span class="o">:</span> <span class="n">beanMethods</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">configClass</span><span class="o">.</span><span class="na">addBeanMethod</span><span class="o">(</span><span class="k">new</span> <span class="nc">BeanMethod</span><span class="o">(</span><span class="n">methodMetadata</span><span class="o">,</span> <span class="n">configClass</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">// Process default methods on interfaces</span>
    <span class="c1">//3.7 处理接口上的默认方法</span>
    <span class="n">processInterfaces</span><span class="o">(</span><span class="n">configClass</span><span class="o">,</span> <span class="n">sourceClass</span><span class="o">);</span>

    <span class="c1">// Process superclass, if any</span>
    <span class="c1">//3.8 如果有的话处理父类</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">hasSuperClass</span><span class="o">())</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">superclass</span> <span class="o">=</span> <span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getSuperClassName</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">superclass</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">superclass</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"java"</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                <span class="o">!</span><span class="k">this</span><span class="o">.</span><span class="na">knownSuperclasses</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">superclass</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">knownSuperclasses</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">superclass</span><span class="o">,</span> <span class="n">configClass</span><span class="o">);</span>
            <span class="c1">// Superclass found, return its annotation metadata and recurse</span>
            <span class="k">return</span> <span class="n">sourceClass</span><span class="o">.</span><span class="na">getSuperClass</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// No superclass -&gt; processing is complete</span>
    <span class="c1">//没有父类的话 处理完成 返回null</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  可以看到 <strong>doProcessConfigurationClass</strong> 中解析了我们常见的注解,例如 <strong>@ComponentScan、@Import、@Bean</strong> 等等.下面我们一一看下是如何解析的:<br />
3.1 首先递归的解析嵌套类成员,源码如下:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Register member (nested) classes that happen to be configuration classes themselves.
 * 注册 恰好是配置类本身的成员嵌套类
 */</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">processMemberClasses</span><span class="o">(</span><span class="nc">ConfigurationClass</span> <span class="n">configClass</span><span class="o">,</span> <span class="nc">SourceClass</span> <span class="n">sourceClass</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="c1">//获取来源类的成员类</span>
    <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">SourceClass</span><span class="o">&gt;</span> <span class="n">memberClasses</span> <span class="o">=</span> <span class="n">sourceClass</span><span class="o">.</span><span class="na">getMemberClasses</span><span class="o">();</span>
    <span class="c1">//筛选出符合条件的成员类 执行processConfigurationClass解析逻辑</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">memberClasses</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">SourceClass</span><span class="o">&gt;</span> <span class="n">candidates</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">memberClasses</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">SourceClass</span> <span class="n">memberClass</span> <span class="o">:</span> <span class="n">memberClasses</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">isConfigurationCandidate</span><span class="o">(</span><span class="n">memberClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">())</span> <span class="o">&amp;&amp;</span>
                    <span class="o">!</span><span class="n">memberClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getClassName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">configClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getClassName</span><span class="o">()))</span> <span class="o">{</span>
                <span class="n">candidates</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">memberClass</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="nc">OrderComparator</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">candidates</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">SourceClass</span> <span class="n">candidate</span> <span class="o">:</span> <span class="n">candidates</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">importStack</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">configClass</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">problemReporter</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="k">new</span> <span class="nc">CircularImportProblem</span><span class="o">(</span><span class="n">configClass</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">importStack</span><span class="o">));</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">importStack</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">configClass</span><span class="o">);</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">processConfigurationClass</span><span class="o">(</span><span class="n">candidate</span><span class="o">.</span><span class="na">asConfigClass</span><span class="o">(</span><span class="n">configClass</span><span class="o">));</span>
                <span class="o">}</span>
                <span class="k">finally</span> <span class="o">{</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">importStack</span><span class="o">.</span><span class="na">pop</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  由上可见,首先先处理来源类中所有符合配置类条件的成员类,筛选出来后先将这些配置类进行解析.<br />
3.2 第二步解析 <strong>@PropertySources</strong> 注解:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kd">final</span> <span class="nc">SourceClass</span> <span class="nf">doProcessConfigurationClass</span><span class="o">(</span><span class="nc">ConfigurationClass</span> <span class="n">configClass</span><span class="o">,</span> <span class="nc">SourceClass</span> <span class="n">sourceClass</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="c1">// Process any @PropertySource annotations</span>
    <span class="c1">//3.2 处理所有的@PropertySource注解</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">AnnotationAttributes</span> <span class="n">propertySource</span> <span class="o">:</span> <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">attributesForRepeatable</span><span class="o">(</span>
            <span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">(),</span> <span class="nc">PropertySources</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">PropertySource</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">environment</span> <span class="k">instanceof</span> <span class="nc">ConfigurableEnvironment</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">processPropertySource</span><span class="o">(</span><span class="n">propertySource</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Ignoring @PropertySource annotation on ["</span> <span class="o">+</span> <span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getClassName</span><span class="o">()</span> <span class="o">+</span>
                    <span class="s">"]. Reason: Environment must implement ConfigurableEnvironment"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

   <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  其中 <strong>AnnotationConfigUtils.attributesForRepeatable</strong> 方法的作用是获取指定注解的所有属性,通过属性是否存在可以判断是否存在该注解.这里我们判断是否存在@PropertySource的属性,不存在则跳过,存在且当前环境属于ConfigurableEnvironment时才处理该注解.<br />
  相关源码如下:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Process the given &lt;code&gt;@PropertySource&lt;/code&gt; annotation metadata.
 * 处理给定的@PropertySource注解元数据
 * @param propertySource metadata for the &lt;code&gt;@PropertySource&lt;/code&gt; annotation found
 * @throws IOException if loading a property source failed
 */</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">processPropertySource</span><span class="o">(</span><span class="nc">AnnotationAttributes</span> <span class="n">propertySource</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">propertySource</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"name"</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasLength</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">name</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nc">String</span> <span class="n">encoding</span> <span class="o">=</span> <span class="n">propertySource</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"encoding"</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasLength</span><span class="o">(</span><span class="n">encoding</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="n">locations</span> <span class="o">=</span> <span class="n">propertySource</span><span class="o">.</span><span class="na">getStringArray</span><span class="o">(</span><span class="s">"value"</span><span class="o">);</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">isTrue</span><span class="o">(</span><span class="n">locations</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">,</span> <span class="s">"At least one @PropertySource(value) location is required"</span><span class="o">);</span>
    <span class="kt">boolean</span> <span class="n">ignoreResourceNotFound</span> <span class="o">=</span> <span class="n">propertySource</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">"ignoreResourceNotFound"</span><span class="o">);</span>

    <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">PropertySourceFactory</span><span class="o">&gt;</span> <span class="n">factoryClass</span> <span class="o">=</span> <span class="n">propertySource</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="s">"factory"</span><span class="o">);</span>
    <span class="nc">PropertySourceFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="o">(</span><span class="n">factoryClass</span> <span class="o">==</span> <span class="nc">PropertySourceFactory</span><span class="o">.</span><span class="na">class</span> <span class="o">?</span>
            <span class="no">DEFAULT_PROPERTY_SOURCE_FACTORY</span> <span class="o">:</span> <span class="nc">BeanUtils</span><span class="o">.</span><span class="na">instantiateClass</span><span class="o">(</span><span class="n">factoryClass</span><span class="o">));</span>

    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">location</span> <span class="o">:</span> <span class="n">locations</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">resolvedLocation</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">.</span><span class="na">resolveRequiredPlaceholders</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>
            <span class="nc">Resource</span> <span class="n">resource</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span><span class="o">.</span><span class="na">getResource</span><span class="o">(</span><span class="n">resolvedLocation</span><span class="o">);</span>
            <span class="n">addPropertySource</span><span class="o">(</span><span class="n">factory</span><span class="o">.</span><span class="na">createPropertySource</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="k">new</span> <span class="nc">EncodedResource</span><span class="o">(</span><span class="n">resource</span><span class="o">,</span> <span class="n">encoding</span><span class="o">)));</span>
        <span class="o">}</span>
        <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalArgumentException</span> <span class="o">|</span> <span class="nc">FileNotFoundException</span> <span class="o">|</span> <span class="nc">UnknownHostException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Placeholders not resolvable or resource not found when trying to open it</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">ignoreResourceNotFound</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isInfoEnabled</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Properties location ["</span> <span class="o">+</span> <span class="n">location</span> <span class="o">+</span> <span class="s">"] not resolvable: "</span> <span class="o">+</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  主要作用就是根据注解的各个属性获取并创建资源,存在则替换,不存在则新增.<br />
3.3 第三步解析 <strong>@ComponentScan</strong> 注解:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kd">final</span> <span class="nc">SourceClass</span> <span class="nf">doProcessConfigurationClass</span><span class="o">(</span><span class="nc">ConfigurationClass</span> <span class="n">configClass</span><span class="o">,</span> <span class="nc">SourceClass</span> <span class="n">sourceClass</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="c1">// Process any @ComponentScan annotations</span>
    <span class="c1">//3.3 处理所有的@ComponentScan注解</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">AnnotationAttributes</span><span class="o">&gt;</span> <span class="n">componentScans</span> <span class="o">=</span> <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">attributesForRepeatable</span><span class="o">(</span>
            <span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">(),</span> <span class="nc">ComponentScans</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">ComponentScan</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="c1">//扫描到的ComponentScan不为空且 Conditonal修饰的注解条件不应该跳过</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">componentScans</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="k">this</span><span class="o">.</span><span class="na">conditionEvaluator</span><span class="o">.</span><span class="na">shouldSkip</span><span class="o">(</span><span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">(),</span> <span class="nc">ConfigurationPhase</span><span class="o">.</span><span class="na">REGISTER_BEAN</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">AnnotationAttributes</span> <span class="n">componentScan</span> <span class="o">:</span> <span class="n">componentScans</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// The config class is annotated with @ComponentScan -&gt; perform the scan immediately</span>
            <span class="c1">//使用@ComponentScans注解修饰的配置类  -&gt; 立即执行扫描</span>
            <span class="c1">//扫描到ComponectScan指定的类  默认classpath下的所有类且被@Component修饰的类</span>
            <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="n">scannedBeanDefinitions</span> <span class="o">=</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">componentScanParser</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">componentScan</span><span class="o">,</span> <span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getClassName</span><span class="o">());</span>
            <span class="c1">// Check the set of scanned definitions for any further config classes and parse recursively if needed</span>
            <span class="c1">// 检查任何其他配置类的扫描定义集合 并 在需要时递归解析</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">BeanDefinitionHolder</span> <span class="n">holder</span> <span class="o">:</span> <span class="n">scannedBeanDefinitions</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">BeanDefinition</span> <span class="n">bdCand</span> <span class="o">=</span> <span class="n">holder</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">().</span><span class="na">getOriginatingBeanDefinition</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">bdCand</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">bdCand</span> <span class="o">=</span> <span class="n">holder</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="c1">//检查通过ComponentScan扫描出来的类是否满足Configuration的候选 满足则进行类解析逻辑</span>
                <span class="k">if</span> <span class="o">(</span><span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">checkConfigurationClassCandidate</span><span class="o">(</span><span class="n">bdCand</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">parse</span><span class="o">(</span><span class="n">bdCand</span><span class="o">.</span><span class="na">getBeanClassName</span><span class="o">(),</span> <span class="n">holder</span><span class="o">.</span><span class="na">getBeanName</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  可见通过是通过 <strong>AnnotationConfigUtils.attributesForRepeatable</strong> 方法获取到所有 <strong>@ComponentScan</strong> 注解的所有属性,然后根据该属性去扫描指定路径下的所有配置类,最近将所有满足条件的配置继续进行配置类解析.<br />
这里我们着重看下它是如何扫描指定包下的配置类的,它通过 <strong>componentScanParser</strong> 组件扫描器来进行扫描,源码如下:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//处理ComponectScan的所有的属性</span>
<span class="kd">public</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="nf">parse</span><span class="o">(</span><span class="nc">AnnotationAttributes</span> <span class="n">componentScan</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">declaringClass</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ClassPathBeanDefinitionScanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathBeanDefinitionScanner</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">,</span>
            <span class="n">componentScan</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">"useDefaultFilters"</span><span class="o">),</span> <span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span><span class="o">);</span>

    <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">BeanNameGenerator</span><span class="o">&gt;</span> <span class="n">generatorClass</span> <span class="o">=</span> <span class="n">componentScan</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="s">"nameGenerator"</span><span class="o">);</span>
    <span class="kt">boolean</span> <span class="n">useInheritedGenerator</span> <span class="o">=</span> <span class="o">(</span><span class="nc">BeanNameGenerator</span><span class="o">.</span><span class="na">class</span> <span class="o">==</span> <span class="n">generatorClass</span><span class="o">);</span>
    <span class="n">scanner</span><span class="o">.</span><span class="na">setBeanNameGenerator</span><span class="o">(</span><span class="n">useInheritedGenerator</span> <span class="o">?</span> <span class="k">this</span><span class="o">.</span><span class="na">beanNameGenerator</span> <span class="o">:</span>
            <span class="nc">BeanUtils</span><span class="o">.</span><span class="na">instantiateClass</span><span class="o">(</span><span class="n">generatorClass</span><span class="o">));</span>

    <span class="nc">ScopedProxyMode</span> <span class="n">scopedProxyMode</span> <span class="o">=</span> <span class="n">componentScan</span><span class="o">.</span><span class="na">getEnum</span><span class="o">(</span><span class="s">"scopedProxy"</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">scopedProxyMode</span> <span class="o">!=</span> <span class="nc">ScopedProxyMode</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">scanner</span><span class="o">.</span><span class="na">setScopedProxyMode</span><span class="o">(</span><span class="n">scopedProxyMode</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="o">{</span>
        <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">ScopeMetadataResolver</span><span class="o">&gt;</span> <span class="n">resolverClass</span> <span class="o">=</span> <span class="n">componentScan</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="s">"scopeResolver"</span><span class="o">);</span>
        <span class="n">scanner</span><span class="o">.</span><span class="na">setScopeMetadataResolver</span><span class="o">(</span><span class="nc">BeanUtils</span><span class="o">.</span><span class="na">instantiateClass</span><span class="o">(</span><span class="n">resolverClass</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="n">scanner</span><span class="o">.</span><span class="na">setResourcePattern</span><span class="o">(</span><span class="n">componentScan</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"resourcePattern"</span><span class="o">));</span>

    <span class="k">for</span> <span class="o">(</span><span class="nc">AnnotationAttributes</span> <span class="n">filter</span> <span class="o">:</span> <span class="n">componentScan</span><span class="o">.</span><span class="na">getAnnotationArray</span><span class="o">(</span><span class="s">"includeFilters"</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">TypeFilter</span> <span class="n">typeFilter</span> <span class="o">:</span> <span class="n">typeFiltersFor</span><span class="o">(</span><span class="n">filter</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">scanner</span><span class="o">.</span><span class="na">addIncludeFilter</span><span class="o">(</span><span class="n">typeFilter</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">AnnotationAttributes</span> <span class="n">filter</span> <span class="o">:</span> <span class="n">componentScan</span><span class="o">.</span><span class="na">getAnnotationArray</span><span class="o">(</span><span class="s">"excludeFilters"</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">TypeFilter</span> <span class="n">typeFilter</span> <span class="o">:</span> <span class="n">typeFiltersFor</span><span class="o">(</span><span class="n">filter</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">scanner</span><span class="o">.</span><span class="na">addExcludeFilter</span><span class="o">(</span><span class="n">typeFilter</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kt">boolean</span> <span class="n">lazyInit</span> <span class="o">=</span> <span class="n">componentScan</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">"lazyInit"</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">lazyInit</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">scanner</span><span class="o">.</span><span class="na">getBeanDefinitionDefaults</span><span class="o">().</span><span class="na">setLazyInit</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">basePackages</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;();</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="n">basePackagesArray</span> <span class="o">=</span> <span class="n">componentScan</span><span class="o">.</span><span class="na">getStringArray</span><span class="o">(</span><span class="s">"basePackages"</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">pkg</span> <span class="o">:</span> <span class="n">basePackagesArray</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span><span class="o">[]</span> <span class="n">tokenized</span> <span class="o">=</span> <span class="nc">StringUtils</span><span class="o">.</span><span class="na">tokenizeToStringArray</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">.</span><span class="na">resolvePlaceholders</span><span class="o">(</span><span class="n">pkg</span><span class="o">),</span>
                <span class="nc">ConfigurableApplicationContext</span><span class="o">.</span><span class="na">CONFIG_LOCATION_DELIMITERS</span><span class="o">);</span>
        <span class="nc">Collections</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">basePackages</span><span class="o">,</span> <span class="n">tokenized</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//若没有指定basePackageClasses,会取主函数的包名,即扫描主函数所在包下的所有类</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">:</span> <span class="n">componentScan</span><span class="o">.</span><span class="na">getClassArray</span><span class="o">(</span><span class="s">"basePackageClasses"</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">basePackages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">ClassUtils</span><span class="o">.</span><span class="na">getPackageName</span><span class="o">(</span><span class="n">clazz</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">basePackages</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">basePackages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">ClassUtils</span><span class="o">.</span><span class="na">getPackageName</span><span class="o">(</span><span class="n">declaringClass</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="n">scanner</span><span class="o">.</span><span class="na">addExcludeFilter</span><span class="o">(</span><span class="k">new</span> <span class="nc">AbstractTypeHierarchyTraversingFilter</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">matchClassName</span><span class="o">(</span><span class="nc">String</span> <span class="n">className</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">declaringClass</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">});</span>
    <span class="c1">//扫描basePackages指定目录下的类  默认扫描classpath下的路径</span>
    <span class="k">return</span> <span class="n">scanner</span><span class="o">.</span><span class="na">doScan</span><span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">toStringArray</span><span class="o">(</span><span class="n">basePackages</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  可见扫描器一开始都在填充 <strong>@ComponentScan</strong> 的属性,这里需要注意的就是 <strong>basePackageClasses</strong> 属性,即指定扫描的路径,若未指定则会扫描主函数所在的包.<br />
  属性封装完成后,即执行扫描,源码如下:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Perform a scan within the specified base packages,
 * returning the registered bean definitions.
 * &lt;p&gt;This method does &lt;i&gt;not&lt;/i&gt; register an annotation config processor
 * but rather leaves this up to the caller.
 * 在指定的包中执行扫描，返回注册的bean定义。
 * 这个方法不注册一个注解配置处理器，而是把这个留给调用者
 * @param basePackages the packages to check for annotated classes
 * @return set of beans registered if any for tooling registration purposes (never {@code null})
 */</span>
<span class="kd">protected</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="nf">doScan</span><span class="o">(</span><span class="nc">String</span><span class="o">...</span> <span class="n">basePackages</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">notEmpty</span><span class="o">(</span><span class="n">basePackages</span><span class="o">,</span> <span class="s">"At least one base package must be specified"</span><span class="o">);</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="n">beanDefinitions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;();</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">basePackage</span> <span class="o">:</span> <span class="n">basePackages</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//获取候选者组件</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">BeanDefinition</span><span class="o">&gt;</span> <span class="n">candidates</span> <span class="o">=</span> <span class="n">findCandidateComponents</span><span class="o">(</span><span class="n">basePackage</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">BeanDefinition</span> <span class="n">candidate</span> <span class="o">:</span> <span class="n">candidates</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//解析作用域元数据 获取@Scope 注解的属性</span>
            <span class="nc">ScopeMetadata</span> <span class="n">scopeMetadata</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">scopeMetadataResolver</span><span class="o">.</span><span class="na">resolveScopeMetadata</span><span class="o">(</span><span class="n">candidate</span><span class="o">);</span>
            <span class="n">candidate</span><span class="o">.</span><span class="na">setScope</span><span class="o">(</span><span class="n">scopeMetadata</span><span class="o">.</span><span class="na">getScopeName</span><span class="o">());</span>
            <span class="c1">//生成bean的名字</span>
            <span class="nc">String</span> <span class="n">beanName</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">beanNameGenerator</span><span class="o">.</span><span class="na">generateBeanName</span><span class="o">(</span><span class="n">candidate</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">);</span>
            <span class="c1">//判断该候选者是否属于AbstractBeanDefinition 执行后置处理</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">candidate</span> <span class="k">instanceof</span> <span class="nc">AbstractBeanDefinition</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">postProcessBeanDefinition</span><span class="o">((</span><span class="nc">AbstractBeanDefinition</span><span class="o">)</span> <span class="n">candidate</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">//判断该候选者是否属于可注解的bean定义</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">candidate</span> <span class="k">instanceof</span> <span class="nc">AnnotatedBeanDefinition</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//处理通用的注解 例如:@Lazy、@Primary、@DependsOn、@Role、@Description</span>
                <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">processCommonDefinitionAnnotations</span><span class="o">((</span><span class="nc">AnnotatedBeanDefinition</span><span class="o">)</span> <span class="n">candidate</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">//检查候选者是否已经注册过</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">checkCandidate</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">candidate</span><span class="o">))</span> <span class="o">{</span>
                <span class="nc">BeanDefinitionHolder</span> <span class="n">definitionHolder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BeanDefinitionHolder</span><span class="o">(</span><span class="n">candidate</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
                <span class="c1">//根据代理模式创建代理类，没有则不创建</span>
                <span class="n">definitionHolder</span> <span class="o">=</span>
                        <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">applyScopedProxyMode</span><span class="o">(</span><span class="n">scopeMetadata</span><span class="o">,</span> <span class="n">definitionHolder</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">);</span>
                <span class="n">beanDefinitions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">definitionHolder</span><span class="o">);</span>
                <span class="c1">//将扫描出来的类注册到注册表中</span>
                <span class="n">registerBeanDefinition</span><span class="o">(</span><span class="n">definitionHolder</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">beanDefinitions</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  这里逻辑就比较清晰了,根据注解的属性扫描过滤出满足条件的配置类并注册到bean定义到注册表中.<br />
3.4 第四步解析 <strong>@Import</strong> 注解,看到这个注解是不是比较熟悉,在 <strong>@SpringBootApplication</strong> 注解中的 <strong>@EnableAutoConfiguration</strong> 中就包含两个 <strong>@Import</strong> 注解,就是在这里处理的,源码如下:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kd">final</span> <span class="nc">SourceClass</span> <span class="nf">doProcessConfigurationClass</span><span class="o">(</span><span class="nc">ConfigurationClass</span> <span class="n">configClass</span><span class="o">,</span> <span class="nc">SourceClass</span> <span class="n">sourceClass</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="c1">// Process any @Import annotations</span>
    <span class="c1">//3.4 处理所有的@Import的注解</span>
    <span class="c1">//getImport方法目前在springboot启动中有以下几个值</span>
    <span class="c1">//1.org.springframework.boot.autoconfigure.AutoConfigurationImportSelector</span>
    <span class="c1">//2.org.springframework.boot.autoconfigure.AutoConfigurationPackages.Registrar</span>
    <span class="c1">//主要用于 处理所有使用@Import注解额类</span>
    <span class="n">processImports</span><span class="o">(</span><span class="n">configClass</span><span class="o">,</span> <span class="n">sourceClass</span><span class="o">,</span> <span class="n">getImports</span><span class="o">(</span><span class="n">sourceClass</span><span class="o">),</span> <span class="kc">true</span><span class="o">);</span>

    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  由上可见,第四步可以拆分为两个方法, <strong>getImports()</strong> 和 <strong>processImports()</strong> ,顾名思义第一个方法肯定是获取所有的 <strong>@Import</strong> 注解,而第二个方法就是处理所有的 <strong>@Import</strong> 注解了.  <br />
  首先我们先来看下 <strong>getImports()</strong> 源码:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Returns {@code @Import} class, considering all meta-annotations.
 * 返回 @Import 的类 考虑所有的元注解
 * 即返回所有@Import注解的 value值所指向的类
 */</span>
<span class="kd">private</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">SourceClass</span><span class="o">&gt;</span> <span class="nf">getImports</span><span class="o">(</span><span class="nc">SourceClass</span> <span class="n">sourceClass</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">SourceClass</span><span class="o">&gt;</span> <span class="n">imports</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;();</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">SourceClass</span><span class="o">&gt;</span> <span class="n">visited</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;();</span>
    <span class="n">collectImports</span><span class="o">(</span><span class="n">sourceClass</span><span class="o">,</span> <span class="n">imports</span><span class="o">,</span> <span class="n">visited</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">imports</span><span class="o">;</span>
<span class="o">}</span>
<span class="cm">/**
 * Recursively collect all declared {@code @Import} values. Unlike most
 * meta-annotations it is valid to have several {@code @Import}s declared with
 * different values; the usual process of returning values from the first
 * meta-annotation on a class is not sufficient.
 * 递归收集所有声明的@import值.  不像所有的元注解 有几个声明为不同的值的@Import注解是合法的.
 * 从类的第一个元注解返回值 通常是不够的
 * &lt;p&gt;For example, it is common for a {@code @Configuration} class to declare direct
 * {@code @Import}s in addition to meta-imports originating from an {@code @Enable}
 * annotation.
 * 举个例子: 除了源自@Enable注解的元导入之外 @Configuration类直接声明@Import是很常见的
 * @param sourceClass the class to search
 * @param imports the imports collected so far
 * @param visited used to track visited classes to prevent infinite recursion
 * @throws IOException if there is any problem reading metadata from the named class
 */</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">collectImports</span><span class="o">(</span><span class="nc">SourceClass</span> <span class="n">sourceClass</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">SourceClass</span><span class="o">&gt;</span> <span class="n">imports</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">SourceClass</span><span class="o">&gt;</span> <span class="n">visited</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>

    <span class="c1">//递归获取到@Import注解  将该注解的值添加到imports中</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">visited</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">sourceClass</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">SourceClass</span> <span class="n">annotation</span> <span class="o">:</span> <span class="n">sourceClass</span><span class="o">.</span><span class="na">getAnnotations</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">annName</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getClassName</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">annName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">Import</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
                <span class="n">collectImports</span><span class="o">(</span><span class="n">annotation</span><span class="o">,</span> <span class="n">imports</span><span class="o">,</span> <span class="n">visited</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">imports</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">sourceClass</span><span class="o">.</span><span class="na">getAnnotationAttributes</span><span class="o">(</span><span class="nc">Import</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="s">"value"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  可见 <strong>collectImports()</strong> 通过递归的方法获取主函数中所有的 <strong>@Import</strong> 注解,并将对应的value值添加到结果集合中.这里其实就对应 <strong>org.springframework.boot.autoconfigure.AutoConfigurationImportSelector和org.springframework.boot.autoconfigure.AutoConfigurationPackages.Registrar</strong> 两个类.  <br />
  接着我们再来看看处理逻辑:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">processImports</span><span class="o">(</span><span class="nc">ConfigurationClass</span> <span class="n">configClass</span><span class="o">,</span> <span class="nc">SourceClass</span> <span class="n">currentSourceClass</span><span class="o">,</span>
        <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">SourceClass</span><span class="o">&gt;</span> <span class="n">importCandidates</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">checkForCircularImports</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//前置检查 </span>
    <span class="c1">//导入候选类为空</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">importCandidates</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//是否检查循环导入 且 当前配置类存在栈中</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">checkForCircularImports</span> <span class="o">&amp;&amp;</span> <span class="n">isChainedImportOnStack</span><span class="o">(</span><span class="n">configClass</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">problemReporter</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="k">new</span> <span class="nc">CircularImportProblem</span><span class="o">(</span><span class="n">configClass</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">importStack</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="o">{</span>
        <span class="c1">//将当前处理的配置类压栈</span>
        <span class="k">this</span><span class="o">.</span><span class="na">importStack</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">configClass</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">//遍历Import的候选类 通过getImports方法获取的候选类</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">SourceClass</span> <span class="n">candidate</span> <span class="o">:</span> <span class="n">importCandidates</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//当前候选者是否可指定为 ImportSelector类</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">candidate</span><span class="o">.</span><span class="na">isAssignable</span><span class="o">(</span><span class="nc">ImportSelector</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
                    <span class="c1">// Candidate class is an ImportSelector -&gt; delegate to it to determine imports</span>
                    <span class="c1">//候选类如果属于ImportSelector -&gt; 委托给他来确定导入</span>
                    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">candidateClass</span> <span class="o">=</span> <span class="n">candidate</span><span class="o">.</span><span class="na">loadClass</span><span class="o">();</span>
                    <span class="c1">//实例化ImportSelector</span>
                    <span class="nc">ImportSelector</span> <span class="n">selector</span> <span class="o">=</span> <span class="nc">ParserStrategyUtils</span><span class="o">.</span><span class="na">instantiateClass</span><span class="o">(</span><span class="n">candidateClass</span><span class="o">,</span> <span class="nc">ImportSelector</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                            <span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">);</span>
                    <span class="c1">//当前ImportSelector是否属于DeferredImportSelector  是则执行handle方法 将当前的配置和selector放入deferredImportSelectors中</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">selector</span> <span class="k">instanceof</span> <span class="nc">DeferredImportSelector</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">this</span><span class="o">.</span><span class="na">deferredImportSelectorHandler</span><span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="n">configClass</span><span class="o">,</span> <span class="o">(</span><span class="nc">DeferredImportSelector</span><span class="o">)</span> <span class="n">selector</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="k">else</span> <span class="o">{</span><span class="c1">//不属于直接继续执行 递归处理Import方法逻辑</span>
                        <span class="nc">String</span><span class="o">[]</span> <span class="n">importClassNames</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectImports</span><span class="o">(</span><span class="n">currentSourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">());</span>
                        <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">SourceClass</span><span class="o">&gt;</span> <span class="n">importSourceClasses</span> <span class="o">=</span> <span class="n">asSourceClasses</span><span class="o">(</span><span class="n">importClassNames</span><span class="o">);</span>
                        <span class="n">processImports</span><span class="o">(</span><span class="n">configClass</span><span class="o">,</span> <span class="n">currentSourceClass</span><span class="o">,</span> <span class="n">importSourceClasses</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="c1">//当前候选者是否可以指定为 ImportBeanDefinitionRegister类</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">candidate</span><span class="o">.</span><span class="na">isAssignable</span><span class="o">(</span><span class="nc">ImportBeanDefinitionRegistrar</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
                    <span class="c1">// Candidate class is an ImportBeanDefinitionRegistrar -&gt;</span>
                    <span class="c1">// delegate to it to register additional bean definitions</span>
                    <span class="c1">//候选类是 ImportBeanDefinitionRegistrar -&gt; 委托给他注册额外的bean定义</span>
                    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">candidateClass</span> <span class="o">=</span> <span class="n">candidate</span><span class="o">.</span><span class="na">loadClass</span><span class="o">();</span>
                    <span class="c1">//实例化ImportBeanDefinitionRegistrar类</span>
                    <span class="nc">ImportBeanDefinitionRegistrar</span> <span class="n">registrar</span> <span class="o">=</span>
                            <span class="nc">ParserStrategyUtils</span><span class="o">.</span><span class="na">instantiateClass</span><span class="o">(</span><span class="n">candidateClass</span><span class="o">,</span> <span class="nc">ImportBeanDefinitionRegistrar</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                                    <span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">);</span>
                    <span class="c1">//将实例化的类 添加到importBeanDefinitionRegistrars中</span>
                    <span class="n">configClass</span><span class="o">.</span><span class="na">addImportBeanDefinitionRegistrar</span><span class="o">(</span><span class="n">registrar</span><span class="o">,</span> <span class="n">currentSourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">());</span>
                <span class="o">}</span>
                <span class="k">else</span> <span class="o">{</span><span class="c1">//若以上两个类都不属于  走默认逻辑</span>
                    <span class="c1">// Candidate class not an ImportSelector or ImportBeanDefinitionRegistrar -&gt;</span>
                    <span class="c1">// process it as an @Configuration class</span>
                    <span class="c1">//候选者类既不是ImportSelector 或 ImportBeanDefinitionRegistrar -&gt;  把他当做@Configuration类来处理</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">importStack</span><span class="o">.</span><span class="na">registerImport</span><span class="o">(</span>
                            <span class="n">currentSourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">(),</span> <span class="n">candidate</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getClassName</span><span class="o">());</span>
                    <span class="c1">//执行@Configuration处理逻辑</span>
                    <span class="n">processConfigurationClass</span><span class="o">(</span><span class="n">candidate</span><span class="o">.</span><span class="na">asConfigClass</span><span class="o">(</span><span class="n">configClass</span><span class="o">));</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">catch</span> <span class="o">(</span><span class="nc">BeanDefinitionStoreException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span>
                    <span class="s">"Failed to process import candidates for configuration class ["</span> <span class="o">+</span>
                    <span class="n">configClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getClassName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">finally</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">importStack</span><span class="o">.</span><span class="na">pop</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>   <strong>processImports</strong> 首先肯定是基础的前置检查,然后就是将当前处理的配置类压栈,接着就是处理所有 <strong>@Import</strong> 导入的类,有以下三种情况:</p>
<ul>
  <li>候选者实现了 <strong>ImportSelector</strong> 接口:<br />
  候选者对应启动类中声明的 <strong>AutoConfigurationImportSelector.class</strong> 类,首先将此候选类实例化为 <strong>ImportSelector</strong> ,判断候选者是否实现了 <strong>DeferredImportSelector</strong> ,未实现则继续从源配置类的元注解中找到需要导入的配置类递归解析.  <br />
  我们着重来看下实现了 <strong>DeferredImportSelector</strong> 接口的实现逻辑,因为__AutoConfigurationImportSelector.class__ 类就实现了此接口.我们继续看下 <strong>handle</strong> 源码:</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">DeferredImportSelectorHolder</span><span class="o">&gt;</span> <span class="n">deferredImportSelectors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="cm">/**
 * Handle the specified {@link DeferredImportSelector}. If deferred import
 * selectors are being collected, this registers this instance to the list. If
 * they are being processed, the {@link DeferredImportSelector} is also processed
 * immediately according to its {@link DeferredImportSelector.Group}.
 * 处理指定的DeferredImportSelector. 如果正在收集导入器,则将此梳理注册到列表中.
 * 如果他们正在被处理,DeferredImportSelector 也会根据DeferredImportSelector.Group来立即处理他们
 * @param configClass the source configuration class
 * @param importSelector the selector to handle
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">ConfigurationClass</span> <span class="n">configClass</span><span class="o">,</span> <span class="nc">DeferredImportSelector</span> <span class="n">importSelector</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">DeferredImportSelectorHolder</span> <span class="n">holder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DeferredImportSelectorHolder</span><span class="o">(</span>
            <span class="n">configClass</span><span class="o">,</span> <span class="n">importSelector</span><span class="o">);</span>
    <span class="c1">//如果deferredImportSelectors为空 执行注册和处理逻辑  不为空则添加到deferredImportSelectors中</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">deferredImportSelectors</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">DeferredImportSelectorGroupingHandler</span> <span class="n">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DeferredImportSelectorGroupingHandler</span><span class="o">();</span>
        <span class="n">handler</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">holder</span><span class="o">);</span>
        <span class="n">handler</span><span class="o">.</span><span class="na">processGroupImports</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">deferredImportSelectors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">holder</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  因为 <strong>deferredImportSelectors</strong> 已经初始化过,所以直接将 <strong>DeferredImportSelectorHolder</strong> 添加到 <strong>deferredImportSelectors</strong> 中供后续加载自动配置类使用.</p>
<ul>
  <li>候选者实现了 <strong>ImportBeanDefinitionRegistrar</strong> 接口:<br />
  候选者对应启动类中声明的 <strong>AutoConfigurationPackages.Registrar.class</strong> 类,将此类实例化为 <strong>ImportBeanDefinitionRegistrar</strong> 并添加到配置类的 <strong>importBeanDefinitionRegistrars</strong> 集合中供后续使用.</li>
  <li>候选者未实现以上两个接口:<br />
  将候选者当做普通配置类调用 <strong>processConfigurationClass</strong> 方法递归解析.</li>
</ul>

<p>3.5 第五步,处理所有 <strong>@ImportResource</strong> 注解,相关源码如下:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kd">final</span> <span class="nc">SourceClass</span> <span class="nf">doProcessConfigurationClass</span><span class="o">(</span><span class="nc">ConfigurationClass</span> <span class="n">configClass</span><span class="o">,</span> <span class="nc">SourceClass</span> <span class="n">sourceClass</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="c1">// Process any @ImportResource annotations</span>
    <span class="c1">//3.5 处理所有存在的@ImportResource注解</span>
    <span class="nc">AnnotationAttributes</span> <span class="n">importResource</span> <span class="o">=</span>
            <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">attributesFor</span><span class="o">(</span><span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">(),</span> <span class="nc">ImportResource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">importResource</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span><span class="o">[]</span> <span class="n">resources</span> <span class="o">=</span> <span class="n">importResource</span><span class="o">.</span><span class="na">getStringArray</span><span class="o">(</span><span class="s">"locations"</span><span class="o">);</span>
        <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">BeanDefinitionReader</span><span class="o">&gt;</span> <span class="n">readerClass</span> <span class="o">=</span> <span class="n">importResource</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="s">"reader"</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">resource</span> <span class="o">:</span> <span class="n">resources</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">resolvedResource</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">.</span><span class="na">resolveRequiredPlaceholders</span><span class="o">(</span><span class="n">resource</span><span class="o">);</span>
            <span class="n">configClass</span><span class="o">.</span><span class="na">addImportedResource</span><span class="o">(</span><span class="n">resolvedResource</span><span class="o">,</span> <span class="n">readerClass</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  可见这段逻辑就相对简单一点了,获取 <strong>@ImportResource</strong> 的元数据,没有则直接跳过,有则继续获取 <strong>locations</strong> 属性获取需要读取的配置文件地址,然后将读取的配置文件资源加载到配置类中.  <br />
3.6 第六步,处理所有的 <strong>@Bean</strong> 注解:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kd">final</span> <span class="nc">SourceClass</span> <span class="nf">doProcessConfigurationClass</span><span class="o">(</span><span class="nc">ConfigurationClass</span> <span class="n">configClass</span><span class="o">,</span> <span class="nc">SourceClass</span> <span class="n">sourceClass</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="c1">// Process individual @Bean methods</span>
    <span class="c1">//3.6 处理所有独立的@Bean方法</span>
    <span class="c1">//3.6.1 检索源类中所有的@Bean方法</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">MethodMetadata</span><span class="o">&gt;</span> <span class="n">beanMethods</span> <span class="o">=</span> <span class="n">retrieveBeanMethodMetadata</span><span class="o">(</span><span class="n">sourceClass</span><span class="o">);</span>
    <span class="c1">//3.6.2 将方法封装成BeanMethod并添加到配置类中</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">MethodMetadata</span> <span class="n">methodMetadata</span> <span class="o">:</span> <span class="n">beanMethods</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">configClass</span><span class="o">.</span><span class="na">addBeanMethod</span><span class="o">(</span><span class="k">new</span> <span class="nc">BeanMethod</span><span class="o">(</span><span class="n">methodMetadata</span><span class="o">,</span> <span class="n">configClass</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  可见主要就分为两步,检索和添加.<br />
3.6.1 <strong>retrieveBeanMethodMetadata</strong> 的作用就是检索所有的 <strong>@Bean</strong> 方法,源码如下:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Retrieve the metadata for all &lt;code&gt;@Bean&lt;/code&gt; methods.
 * 检索所有@Bean方法的元数据
 */</span>
<span class="kd">private</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">MethodMetadata</span><span class="o">&gt;</span> <span class="nf">retrieveBeanMethodMetadata</span><span class="o">(</span><span class="nc">SourceClass</span> <span class="n">sourceClass</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//获取源类的元数据</span>
    <span class="nc">AnnotationMetadata</span> <span class="n">original</span> <span class="o">=</span> <span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">();</span>
    <span class="c1">//获取所有@bean注解的方法</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">MethodMetadata</span><span class="o">&gt;</span> <span class="n">beanMethods</span> <span class="o">=</span> <span class="n">original</span><span class="o">.</span><span class="na">getAnnotatedMethods</span><span class="o">(</span><span class="nc">Bean</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">beanMethods</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">original</span> <span class="k">instanceof</span> <span class="nc">StandardAnnotationMetadata</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Try reading the class file via ASM for deterministic declaration order...</span>
        <span class="c1">//尝试通过ASM读取类文件以获得确定性声明顺序</span>
        <span class="c1">// Unfortunately, the JVM's standard reflection returns methods in arbitrary</span>
        <span class="c1">// order, even between different runs of the same application on the same JVM.</span>
        <span class="c1">//不幸的是 JVM标准的反射以任意顺序返回方法,即使在同一jvm上同一应用程序的不同运行之间也是如此</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">AnnotationMetadata</span> <span class="n">asm</span> <span class="o">=</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span><span class="o">.</span><span class="na">getMetadataReader</span><span class="o">(</span><span class="n">original</span><span class="o">.</span><span class="na">getClassName</span><span class="o">()).</span><span class="na">getAnnotationMetadata</span><span class="o">();</span>
            <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">MethodMetadata</span><span class="o">&gt;</span> <span class="n">asmMethods</span> <span class="o">=</span> <span class="n">asm</span><span class="o">.</span><span class="na">getAnnotatedMethods</span><span class="o">(</span><span class="nc">Bean</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">asmMethods</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">beanMethods</span><span class="o">.</span><span class="na">size</span><span class="o">())</span> <span class="o">{</span>
                <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">MethodMetadata</span><span class="o">&gt;</span> <span class="n">selectedMethods</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="n">asmMethods</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">MethodMetadata</span> <span class="n">asmMethod</span> <span class="o">:</span> <span class="n">asmMethods</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">for</span> <span class="o">(</span><span class="nc">MethodMetadata</span> <span class="n">beanMethod</span> <span class="o">:</span> <span class="n">beanMethods</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">beanMethod</span><span class="o">.</span><span class="na">getMethodName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">asmMethod</span><span class="o">.</span><span class="na">getMethodName</span><span class="o">()))</span> <span class="o">{</span>
                            <span class="n">selectedMethods</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanMethod</span><span class="o">);</span>
                            <span class="k">break</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">selectedMethods</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="n">beanMethods</span><span class="o">.</span><span class="na">size</span><span class="o">())</span> <span class="o">{</span>
                    <span class="c1">// All reflection-detected methods found in ASM method set -&gt; proceed</span>
                    <span class="n">beanMethods</span> <span class="o">=</span> <span class="n">selectedMethods</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Failed to read class file via ASM for determining @Bean method order"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
            <span class="c1">// No worries, let's continue with the reflection metadata we started with...</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">beanMethods</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  可见就是从源类的元数据中获取所有的 <strong>@Bean</strong> 方法,并且当出现多个方法时需要根据ASM来确定方法的顺序.<br />
3.6.2 就是将3.6.1检索出来的所有的方法封装成 <strong>BeanMethod</strong> 并添加到配置类中<br />
3.7 第七步,处理源类实现的接口上的所有方法:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kd">final</span> <span class="nc">SourceClass</span> <span class="nf">doProcessConfigurationClass</span><span class="o">(</span><span class="nc">ConfigurationClass</span> <span class="n">configClass</span><span class="o">,</span> <span class="nc">SourceClass</span> <span class="n">sourceClass</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="c1">// Process default methods on interfaces</span>
    <span class="c1">//3.7 处理接口上的默认方法</span>
    <span class="n">processInterfaces</span><span class="o">(</span><span class="n">configClass</span><span class="o">,</span> <span class="n">sourceClass</span><span class="o">);</span>

    <span class="o">...</span>
<span class="o">}</span>

<span class="cm">/**
 * Register default methods on interfaces implemented by the configuration class.
 * 在配置类实现的接口上注册默认方法
 */</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">processInterfaces</span><span class="o">(</span><span class="nc">ConfigurationClass</span> <span class="n">configClass</span><span class="o">,</span> <span class="nc">SourceClass</span> <span class="n">sourceClass</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="c1">//遍历源类实现的所有接口</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">SourceClass</span> <span class="n">ifc</span> <span class="o">:</span> <span class="n">sourceClass</span><span class="o">.</span><span class="na">getInterfaces</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">//获取接口上的所有 @Bean方法</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">MethodMetadata</span><span class="o">&gt;</span> <span class="n">beanMethods</span> <span class="o">=</span> <span class="n">retrieveBeanMethodMetadata</span><span class="o">(</span><span class="n">ifc</span><span class="o">);</span>
        <span class="c1">//遍历所有的方法 将非抽象的方法封装为BeanMethod方法并添加到配置类中</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">MethodMetadata</span> <span class="n">methodMetadata</span> <span class="o">:</span> <span class="n">beanMethods</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">methodMetadata</span><span class="o">.</span><span class="na">isAbstract</span><span class="o">())</span> <span class="o">{</span>
                <span class="c1">// A default method or other concrete method on a Java 8+ interface...</span>
                <span class="c1">//java8接口上的默认方法或其他具体方法</span>
                <span class="n">configClass</span><span class="o">.</span><span class="na">addBeanMethod</span><span class="o">(</span><span class="k">new</span> <span class="nc">BeanMethod</span><span class="o">(</span><span class="n">methodMetadata</span><span class="o">,</span> <span class="n">configClass</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">//递归处理接口</span>
        <span class="n">processInterfaces</span><span class="o">(</span><span class="n">configClass</span><span class="o">,</span> <span class="n">ifc</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  根据3.6来看这个就很好理解了,3.6处理的是源类中的所有 <strong>@Bean</strong> 方法,而3.7处理的是所有接口上的 <strong>@Bean</strong> 方法,并通过递归的方式保证所有接口都处理完毕.<br />
3.8 第八步,处理父类:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kd">final</span> <span class="nc">SourceClass</span> <span class="nf">doProcessConfigurationClass</span><span class="o">(</span><span class="nc">ConfigurationClass</span> <span class="n">configClass</span><span class="o">,</span> <span class="nc">SourceClass</span> <span class="n">sourceClass</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="c1">// Process superclass, if any</span>
    <span class="c1">//3.8 如果有的话处理父类</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">hasSuperClass</span><span class="o">())</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">superclass</span> <span class="o">=</span> <span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getSuperClassName</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">superclass</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">superclass</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"java"</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
                <span class="o">!</span><span class="k">this</span><span class="o">.</span><span class="na">knownSuperclasses</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">superclass</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">knownSuperclasses</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">superclass</span><span class="o">,</span> <span class="n">configClass</span><span class="o">);</span>
            <span class="c1">// Superclass found, return its annotation metadata and recurse</span>
            <span class="k">return</span> <span class="n">sourceClass</span><span class="o">.</span><span class="na">getSuperClass</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// No superclass -&gt; processing is complete</span>
    <span class="c1">//没有父类的话 处理完成 返回null</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  其实到这一步,当前配置类的注解解析已经完成了,若配置类有父类的话直接将父类返回继续进行配置类解析,若没有直接返回null即可.</p>
<blockquote>
  <p>以上就是doProcessConfigurationClass的所有流程,即解析@Component、@PropertySource、@ComponentScan、@Import、@ImportResource、@Bean及其父类和实现的接口的所有注解.</p>
</blockquote>

<hr />

<h3 id="deferredimportselectorhandlerprocess">deferredImportSelectorHandler.process()</h3>
<hr />

<p>  ConfigurationClassParser.parse的第一步就是解析配置类,第二步即deferredImportSelectorHandler.process().
  首先抛出结论,主要是针对 <strong>AutoConfigurationImportSelector</strong> 用来加载所有的EnableAutoConfiguration的子类.<br />
  源码如下:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">DeferredImportSelectorHolder</span><span class="o">&gt;</span> <span class="n">deferredImports</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">deferredImportSelectors</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">deferredImportSelectors</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">deferredImports</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">DeferredImportSelectorGroupingHandler</span> <span class="n">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DeferredImportSelectorGroupingHandler</span><span class="o">();</span>
            <span class="n">deferredImports</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="no">DEFERRED_IMPORT_COMPARATOR</span><span class="o">);</span>
            <span class="c1">//1. 通过DeferredImportSelectorGroupingHandler注册AutoConfigurationGroup分组</span>
            <span class="n">deferredImports</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="nl">handler:</span><span class="o">:</span><span class="n">register</span><span class="o">);</span>
            <span class="c1">//2. 处理分组的导入配置</span>
            <span class="n">handler</span><span class="o">.</span><span class="na">processGroupImports</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">finally</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">deferredImportSelectors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  首先先看第一步:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="nc">DeferredImportSelectorHolder</span> <span class="n">deferredImport</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//获取当前DeferredImportSelector的分组</span>
    <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Group</span><span class="o">&gt;</span> <span class="n">group</span> <span class="o">=</span> <span class="n">deferredImport</span><span class="o">.</span><span class="na">getImportSelector</span><span class="o">().</span><span class="na">getImportGroup</span><span class="o">();</span>
    <span class="c1">//将此分组添加到grouping中</span>
    <span class="nc">DeferredImportSelectorGrouping</span> <span class="n">grouping</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">groupings</span><span class="o">.</span><span class="na">computeIfAbsent</span><span class="o">(</span>
            <span class="o">(</span><span class="n">group</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">group</span> <span class="o">:</span> <span class="n">deferredImport</span><span class="o">),</span>
            <span class="n">key</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">DeferredImportSelectorGrouping</span><span class="o">(</span><span class="n">createGroup</span><span class="o">(</span><span class="n">group</span><span class="o">)));</span>
    <span class="n">grouping</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">deferredImport</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">configurationClasses</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">deferredImport</span><span class="o">.</span><span class="na">getConfigurationClass</span><span class="o">().</span><span class="na">getMetadata</span><span class="o">(),</span>
            <span class="n">deferredImport</span><span class="o">.</span><span class="na">getConfigurationClass</span><span class="o">());</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Group</span><span class="o">&gt;</span> <span class="nf">getImportGroup</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nc">AutoConfigurationGroup</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
	<span class="o">}</span>
</code></pre></div></div>
<p>  可见第一步的作用就是获取 <strong>AutoConfigurationGroup</strong> 自动配置分组,为后续获取自动配置类做准备.<br />
  接下来看关键的 <strong>handler.processGroupImports()</strong> 处理逻辑:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">processGroupImports</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//groupings中就存放着我们上一步添加的AutoConfigurationGroup</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">DeferredImportSelectorGrouping</span> <span class="n">grouping</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">groupings</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">//根据getImports()获取所有的配置类  再通过处理Import配置类的方法processImports将每个EnableAutoConfiguration的实现类当做@Configuration解析</span>
            <span class="n">grouping</span><span class="o">.</span><span class="na">getImports</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">entry</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="nc">ConfigurationClass</span> <span class="n">configurationClass</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">configurationClasses</span><span class="o">.</span><span class="na">get</span><span class="o">(</span>
                        <span class="n">entry</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">());</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="c1">//将自动配置继续执行@Import的处理逻辑 默认都当做普通配置类解析</span>
                    <span class="n">processImports</span><span class="o">(</span><span class="n">configurationClass</span><span class="o">,</span> <span class="n">asSourceClass</span><span class="o">(</span><span class="n">configurationClass</span><span class="o">),</span>
                            <span class="n">asSourceClasses</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getImportClassName</span><span class="o">()),</span> <span class="kc">false</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">catch</span> <span class="o">(</span><span class="nc">BeanDefinitionStoreException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span>
                            <span class="s">"Failed to process import candidates for configuration class ["</span> <span class="o">+</span>
                                    <span class="n">configurationClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getClassName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>
<p>  可见此段逻辑为获取分组中的导入选择器,获取所有需要导入的配置类重新执行 <strong>processImports</strong> 逻辑,这里的配置类都会都默认的配置类解析逻辑.<br />
  我们继续看它是如何获取分组的导入配置类的:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Return the imports defined by the group.
 * 返回通过组定义的导入类
 * @return each import with its associated configuration class
 */</span>
<span class="kd">public</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">Group</span><span class="o">.</span><span class="na">Entry</span><span class="o">&gt;</span> <span class="nf">getImports</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">DeferredImportSelectorHolder</span> <span class="n">deferredImport</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">deferredImports</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//调用org.springframework.boot.autoconfigure.AutoConfigurationImportSelector.AutoConfigurationGroup#process 获取所有的EnableAutoConfiguration候选配置类</span>
        <span class="k">this</span><span class="o">.</span><span class="na">group</span><span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="n">deferredImport</span><span class="o">.</span><span class="na">getConfigurationClass</span><span class="o">().</span><span class="na">getMetadata</span><span class="o">(),</span>
                <span class="n">deferredImport</span><span class="o">.</span><span class="na">getImportSelector</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="c1">//返回满足条件的导入类</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">group</span><span class="o">.</span><span class="na">selectImports</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  此方法主要是 <strong>group.process</strong> 和 <strong>group.selectImports</strong> , <strong>group.process</strong> 的作用是通过SPI机制获取所有的EnableAutoConfiguration候选配置类,而 <strong>group.selectImports</strong> 就是筛选出满足条件的配置类.<br />
  继续看 <strong>group.process</strong> :</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="nc">AnnotationMetadata</span> <span class="n">annotationMetadata</span><span class="o">,</span> <span class="nc">DeferredImportSelector</span> <span class="n">deferredImportSelector</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">state</span><span class="o">(</span><span class="n">deferredImportSelector</span> <span class="k">instanceof</span> <span class="nc">AutoConfigurationImportSelector</span><span class="o">,</span>
            <span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Only %s implementations are supported, got %s"</span><span class="o">,</span>
                    <span class="nc">AutoConfigurationImportSelector</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span>
                    <span class="n">deferredImportSelector</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()));</span>
    <span class="c1">//通过SPI机制获取满足条件的EnableAutoConfiguration的实现类</span>
    <span class="nc">AutoConfigurationEntry</span> <span class="n">autoConfigurationEntry</span> <span class="o">=</span> <span class="o">((</span><span class="nc">AutoConfigurationImportSelector</span><span class="o">)</span> <span class="n">deferredImportSelector</span><span class="o">)</span>
            <span class="o">.</span><span class="na">getAutoConfigurationEntry</span><span class="o">(</span><span class="n">getAutoConfigurationMetadata</span><span class="o">(),</span> <span class="n">annotationMetadata</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">autoConfigurationEntries</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">autoConfigurationEntry</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">importClassName</span> <span class="o">:</span> <span class="n">autoConfigurationEntry</span><span class="o">.</span><span class="na">getConfigurations</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">entries</span><span class="o">.</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">importClassName</span><span class="o">,</span> <span class="n">annotationMetadata</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="cm">/**
 * Return the {@link AutoConfigurationEntry} based on the {@link AnnotationMetadata}
 * of the importing {@link Configuration @Configuration} class.
 * 根据导入的Configuration注解类的AnnotationMetadata返回AutoConfigurationEntry
 * @param autoConfigurationMetadata the auto-configuration metadata
 * @param annotationMetadata the annotation metadata of the configuration class
 * @return the auto-configurations that should be imported
 */</span>
<span class="kd">protected</span> <span class="nc">AutoConfigurationEntry</span> <span class="nf">getAutoConfigurationEntry</span><span class="o">(</span><span class="nc">AutoConfigurationMetadata</span> <span class="n">autoConfigurationMetadata</span><span class="o">,</span>
        <span class="nc">AnnotationMetadata</span> <span class="n">annotationMetadata</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//判断是否开启自动配置</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">isEnabled</span><span class="o">(</span><span class="n">annotationMetadata</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="no">EMPTY_ENTRY</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//获取@EnableAutoConfiguration注解的属性 即exclude和excludeName</span>
    <span class="nc">AnnotationAttributes</span> <span class="n">attributes</span> <span class="o">=</span> <span class="n">getAttributes</span><span class="o">(</span><span class="n">annotationMetadata</span><span class="o">);</span>
    <span class="c1">//通过SpringFactoriesLoader.loadFactoryNames#META-INF/spring.factories中查找所有的EnableAutoConfiguration候选配置类</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">configurations</span> <span class="o">=</span> <span class="n">getCandidateConfigurations</span><span class="o">(</span><span class="n">annotationMetadata</span><span class="o">,</span> <span class="n">attributes</span><span class="o">);</span>
    <span class="c1">//通过LinkedHashSet去重</span>
    <span class="n">configurations</span> <span class="o">=</span> <span class="n">removeDuplicates</span><span class="o">(</span><span class="n">configurations</span><span class="o">);</span>
    <span class="c1">//获取所有排除的包</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">exclusions</span> <span class="o">=</span> <span class="n">getExclusions</span><span class="o">(</span><span class="n">annotationMetadata</span><span class="o">,</span> <span class="n">attributes</span><span class="o">);</span>
    <span class="n">checkExcludedClasses</span><span class="o">(</span><span class="n">configurations</span><span class="o">,</span> <span class="n">exclusions</span><span class="o">);</span>
    <span class="n">configurations</span><span class="o">.</span><span class="na">removeAll</span><span class="o">(</span><span class="n">exclusions</span><span class="o">);</span>
    <span class="c1">//获取配置类过滤器 从META-INF/spring.factories中加载AutoConfigurationImportFilter的实现类</span>
    <span class="n">configurations</span> <span class="o">=</span> <span class="n">filter</span><span class="o">(</span><span class="n">configurations</span><span class="o">,</span> <span class="n">autoConfigurationMetadata</span><span class="o">);</span>
    <span class="c1">//处理自动配置导入事件</span>
    <span class="n">fireAutoConfigurationImportEvents</span><span class="o">(</span><span class="n">configurations</span><span class="o">,</span> <span class="n">exclusions</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">AutoConfigurationEntry</span><span class="o">(</span><span class="n">configurations</span><span class="o">,</span> <span class="n">exclusions</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">protected</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getCandidateConfigurations</span><span class="o">(</span><span class="nc">AnnotationMetadata</span> <span class="n">metadata</span><span class="o">,</span> <span class="nc">AnnotationAttributes</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//获取所有EnableAutoConfigurationde实现类名</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">configurations</span> <span class="o">=</span> <span class="nc">SpringFactoriesLoader</span><span class="o">.</span><span class="na">loadFactoryNames</span><span class="o">(</span><span class="n">getSpringFactoriesLoaderFactoryClass</span><span class="o">(),</span>
            <span class="n">getBeanClassLoader</span><span class="o">());</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">notEmpty</span><span class="o">(</span><span class="n">configurations</span><span class="o">,</span> <span class="s">"No auto configuration classes found in META-INF/spring.factories. If you "</span>
            <span class="o">+</span> <span class="s">"are using a custom packaging, make sure that file is correct."</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">configurations</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">protected</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">getSpringFactoriesLoaderFactoryClass</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">EnableAutoConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  由上述调用链就可以很清晰的看出 <strong>getAutoConfigurationEntry</strong> 通过SPI机制获取 <strong>EnableAutoConfiguration</strong> 的自动配置实现类.<br />
  再来看下 <strong>group.selectImports</strong> :</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">Entry</span><span class="o">&gt;</span> <span class="nf">selectImports</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">autoConfigurationEntries</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">//所有需要排除的配置</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">allExclusions</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">autoConfigurationEntries</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">AutoConfigurationEntry:</span><span class="o">:</span><span class="n">getExclusions</span><span class="o">).</span><span class="na">flatMap</span><span class="o">(</span><span class="nl">Collection:</span><span class="o">:</span><span class="n">stream</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toSet</span><span class="o">());</span>
        <span class="c1">//找到的所有配置</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">processedConfigurations</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">autoConfigurationEntries</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">AutoConfigurationEntry:</span><span class="o">:</span><span class="n">getConfigurations</span><span class="o">).</span><span class="na">flatMap</span><span class="o">(</span><span class="nl">Collection:</span><span class="o">:</span><span class="n">stream</span><span class="o">)</span>
                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toCollection</span><span class="o">(</span><span class="nl">LinkedHashSet:</span><span class="o">:</span><span class="k">new</span><span class="o">));</span>
        <span class="c1">//移除需要排除的</span>
        <span class="n">processedConfigurations</span><span class="o">.</span><span class="na">removeAll</span><span class="o">(</span><span class="n">allExclusions</span><span class="o">);</span>
        <span class="c1">//重新排序</span>
        <span class="k">return</span> <span class="nf">sortAutoConfigurations</span><span class="o">(</span><span class="n">processedConfigurations</span><span class="o">,</span> <span class="n">getAutoConfigurationMetadata</span><span class="o">()).</span><span class="na">stream</span><span class="o">()</span>
                <span class="o">.</span><span class="na">map</span><span class="o">((</span><span class="n">importClassName</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">Entry</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">entries</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">importClassName</span><span class="o">),</span> <span class="n">importClassName</span><span class="o">))</span>
                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
    <span class="o">}</span>
</code></pre></div></div>
<p>  以上步骤就很清晰了,移除所有指定的配置,并将实现剩下的配置重新排序返回.</p>
<blockquote>
  <p>可见deferredImportSelectorHandler.process()就是SpringBoot的自动配置功能,找到/META-INF/spring.factories中所有的EnableAutoConfiguration实现类,并解析这些配置类.</p>
</blockquote>

<hr />
</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">SpringBoot</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">October 2021</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">SpringBoot</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-10000012" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2>BalancedBinaryTree</h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/pexels-jue-5806480.jpg" class="img-responsive img-centered" alt="BalancedBinaryTree">

                            
                                <h3>平衡二叉查找树</h3>
                            
                            </div>

                            <p><h3 id="定义">定义</h3>
<hr />
<p>  因为二叉查找树在极端情况会退化成链表,导致查询的时间复杂度为O(n).因为平衡二叉查找树应运而生.<br />
  它是一种结构平衡的二查叉找树,即叶节点高度差的绝对值不超过1,并且左右两个子树都是一棵平衡二叉查找树.<br />
  它能在 __O(logn) __ 内完成插入、查找和删除操作.</p>
<hr />

<h3 id="2-3查找树">2-3查找树</h3>
<hr />
<p>  一棵2-3查找树或为一棵空树,或由以下节点组成:</p>
<ul>
  <li>2-节点:含有一个键(及其对应的值)和两条链接,左链接指向的2-3树中的键都小于该节点,右链接指向的2-3树中的键都大于该节点</li>
  <li>3-节点:含有两个键(及其对应的值)和三条链接,左链接指向的2-3树中的键都小于该节点,中链接指向的2-3树中的键都位于该节点的两个键之间,右链接指向的2-3树中的键都大于该节点 
  将指向一棵空树的链接称为空链接,一棵完美平衡的2-3查找树中的所有空链接到根节点的距离都应该相同,2-3查找树如下图:</li>
</ul>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/2-3 查找树示意图.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="2-3 查找树示意图" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/2-3 查找树示意图.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">2-3 查找树示意图</div>
    </a>
</center>

<p>1.查找<br />
  判断一个键是否在树中,我们先将它和根节点中的键比较.如果它和其中任意个相等,查找命中;否则我们就根据比较的结果找到指向相应区间的链接,并在其指向的子树中递归地继续查找,如果这是个空链接,查找未命中.具体查询过程如图:</p>

<center>  
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/2-3 树中的查找命中(左)和未命中(右).png">  
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="2-3 树中的查找命中(左)和未命中(右)" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/2-3 树中的查找命中(左)和未命中(右).png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">2-3 树中的查找命中(左)和未命中(右)</div>  
    </a>  
</center>

<p>2.向2-节点中插入新键<br />
  要在2-3树中插入一个新节点,可以和二叉查找树一样先进行一次未命中的查找,然后把新节点挂在树的底部,但是这样的话无法保持完美平衡性.<br />
  我们使用2-3树的主要原因就在于它能够在插入后继续保持平衡.如果未命中的查找结束于一个2-节点:我们只要把这个2-节点替换为一个3-节点,将要插入的键保存到其中即可(如下图);如果未命中的查找结束于一个3-节点,事情就麻烦一点.</p>

<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/向2- 结点中插入新的键.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="向2- 结点中插入新的键" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/向2- 结点中插入新的键.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">向2- 结点中插入新的键</div>
    </a>
</center>

<p>3.向一棵只含有一个3-节点的树中插入新键<br />
  假设我们需要向一棵只含有一个3-节点的树中插入一个新键.这棵树中有两个键,所以在它唯一的节点中已经没有可插入新键的空间了.<br />
  为了将新键插入,我们先临时将新键存入该节点中,使之成为一个4-节点.创建一个4-节点很方便,因为很容易将它转换为一棵由3个2-节点组成的2-3树,其中一个节点(根)含有中键,一个节点含有3个键中的最小者(和根节点的左链接相连),一个节点含有3个键中的最大者(和根节点的右链接相连).<br />
  这棵树既是一棵含有3个节点的二叉查找树,同时也是一棵完美平衡的2-3树,因为其中所有的空链接到根节点的距离都相等.插入前树的高度为0,插入后树的高度为1.它说明了树是如何生长的.如下图所示:</p>

<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/向一棵只含有一个3-结点的树中插入新键.png">  
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="向一棵只含有一个3-结点的树中插入新键" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/向一棵只含有一个3-结点的树中插入新键.png" />  
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">向一棵只含有一个3-结点的树中插入新键</div>  
    </a>  
</center>

<p>4.向一个父节点为2-节点的3-节点插入新键<br />
  假设未命中的查找结束于一个3-节点,而它的父节点是一个2-节点.在这种情况下我们需要在维持树的完美平衡的前提下为新键腾出空间.<br />
  我们先像刚才一样构造一个临时的4-节点并将其分解,但此时我们不会为中键创建一个新节点,而是将其移动至原来的父节点中.<br />
  你可以将这次转换看成将指向原3-节点的一条链接替换为新父节点中的原中键左右两边的两条链接,并分别指向两个新的2-节点.<br />
  根据我们的假设,父节点是有空间的:父节点是一个2-节点(一个键两条链接),插入之后变为了一个3-节点(两个键三条链接).<br />
  这次转换也并不影响2-3树的主要性质.树仍然是有序的,因为中键被移动到父节点中去了;树仍然是完美平衡的,插入后所有的空链接到根节点的距离仍然相同,过程如下图所示:</p>

<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/向一个父结点为2-结点的3-结点中插入新键.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="向一个父结点为2-结点的3-结点中插入新键" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/向一个父结点为2-结点的3-结点中插入新键.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">向一个父结点为2-结点的3-结点中插入新键</div>
    </a>
</center>

<p>5.向一个父节点为3-节点的3-节点中插入新键<br />
  现在假设未命中的查找结束于一个父节点为3-节点的节点.我们再次和刚才一样构造一个临时的4-节点并分解它,然后将它的中键插入它的父节点中.但父节点也是一个3-节点,因此我们再用和这个中键构造一个新的临时4-节点,然后在这节点上进行相同的变换,即分解这个父节点并将它的中键插入到它的父节点中.<br />
  我们就这样一直向上不断分解临时的4-节点并将中间插入到它的父节点中,直到遇到一个2-节点并将它替换为一个不需要继续分解的3-节点,或者是到达3-节点的根.过程如下图:</p>

<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/向一个父结点为3-结点的3-结点中插入新键.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="向一个父结点为3-结点的3-结点中插入新键" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/向一个父结点为3-结点的3-结点中插入新键.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">向一个父结点为3-结点的3-结点中插入新键</div>
    </a>
</center>

<p>6.分解根节点<br />
  如果从插入节点到根节点的路径上全都是3-节点,我们的根节点最终变成一个临时的4-节点.此时我们可以按照向一棵只有一个3-节点的树中插入新键的方法处理这个问题.我们将临时的4-节点分解为3个2-节点,使得树高加1,如下图所示:</p>

<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/分解根结点.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="分解根结点" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/分解根结点.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">分解根结点</div>
    </a>
</center>

<p>7.局部变换<br />
  将一个4-节点分解为一棵2-3树可能有6种情况,总结在下图.<br />
  这个4-节点可能是根节点,可能是一个2-节点的左子节点或右子节点,也可能是一个3-节点的左子节点、中子节点或者右子节点.<br />
  2-3树插入算法的根本在于这些变换都是局部的:除了相关的节点和链接之外不必修改或者检查树的其他部分.每次变换中,变更的链接数量不会超过一个很小的常数.需要特别指出的是,不光是在树的底部,树中的任何地方只要符合相应的模式,变换都可以进行.每个变换都会将4-节点中的一个键送入它的父节点中,并重构相应的链接而不必涉及树的其他部分.</p>

<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/在一棵2-3树中分解一个4-结点的情况汇总.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="在一棵2-3树中分解一个4-结点的情况汇总" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/在一棵2-3树中分解一个4-结点的情况汇总.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">在一棵2-3树中分解一个4-结点的情况汇总</div>
    </a>
</center>

<p>8.全局性质<br />
  这些局部变换不会影响树的全局有序性和平衡性:任意空链接到根节点的路径长度都是相等的.<br />
  下图所示的是当一个4-节点是一个3-节点的中子节点时的完整变换情况.如果在变换之前根节点到所有空链接的路径长度为h,那么变换之后该长度仍然为h.所有的变换都是这个性质,即使是将一个4-节点分解为两个2-节点并将其父节点由2-节点变为3-节点,或是由3-节点变为一个临时的4-节点也是如此.<br />
  当根节点被分解为3个2-节点时,所有空链接到根节点的路径长度才会加1.</p>

<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/4-结点的分解是一次局部变换,不会影响树的有序性和平衡性.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="4-结点的分解是一次局部变换,不会影响树的有序性和平衡性" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/4-结点的分解是一次局部变换,不会影响树的有序性和平衡性.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">4-结点的分解是一次局部变换,不会影响树的有序性和平衡性</div>
    </a>
</center>

<p>  和标准的二叉查找树由上向下生长不同,2-3树的生长是由下向上的.如下图所示:</p>

<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/2-3树的构造轨迹.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="2-3树的构造轨迹" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/2-3树的构造轨迹.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">2-3树的构造轨迹</div>
    </a>
</center>

<blockquote>
  <p>结论
在一棵大小为N的2-3树中,查找和插入操作访问的节点必然不超过lgN个</p>
</blockquote>

<hr />

<h3 id="红黑二叉查找树">红黑二叉查找树</h3>
<hr />
<p>1.替换3-节点<br />
  红黑二叉查找树背后的基本思想是用标准的二叉查找树(完全由2-节点构成)和一些额外的信息(替换3-节点)来表示2-3树.
我们将树中的链接分为两种类型:红链接将两个2-节点链接起来构成一个3-节点,黑链接则是2-3树中的普通链接.确切地说,我们将3-节点表示为由一条左斜的红色链接(两个2-节点其中之一是另一个左子节点)相连的两个2-节点,如下图所示.
这种表示法的一个优点是,无需修改就可以直接只用标准二叉查找树的get()方法.对于任意的2-3树,只要对节点进行转换,我们都可以立即派生出一颗对应的二叉查找树.将用这种方式表示2-3树的二叉查找树称为红黑二叉查找树.</p>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/由一条红色左链接相连的两个2-结点表示一个3-结点.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="由一条红色左链接相连的两个2-结点表示一个3-结点" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/由一条红色左链接相连的两个2-结点表示一个3-结点.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">由一条红色左链接相连的两个2-结点表示一个3-结点</div>
    </a>
</center>

<p>2.等价的定义<br />
  红黑树的另一种定义是含有红黑链接并满足下列条件的二叉查找树:</p>
<ul>
  <li>红链接均为左链接</li>
  <li>没有任何一个节点同时和两条红链接相连</li>
  <li>该树是完美黑色平衡的,即任意空链接到根节点的路径上的黑链接数量相同</li>
</ul>

<p>3.一一对应<br />
  如果我们将一棵红黑树的红链接画平,那么所有的空链接到根节点的距离都将使相同的.如下图所示.
如果将由红链接相连的节点合并,得到的就是一棵2-3树.相反,如果将一棵2-3树中的3-节点画做由红色左链接相连的两个2-节点,那么不会存在能够和两条红链接相连的节点,且树必然是完美黑色平衡的,因为黑链接即2-3树中的普通链接,根据定义这些链接必然是完美平衡的.</p>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/将红链接画平时,一棵红黑树就是一棵2-3树.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="将红链接画平时,一棵红黑树就是一棵2-3树" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/将红链接画平时,一棵红黑树就是一棵2-3树.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">将红链接画平时,一棵红黑树就是一棵2-3树</div>
    </a>
</center>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/红黑树和2-3树的一一对应关系.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="红黑树和2-3树的一一对应关系" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/红黑树和2-3树的一一对应关系.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">红黑树和2-3树的一一对应关系</div>
    </a>
</center>
<p>4.颜色表示<br />
  因为每个节点都只会有一条指向自己的链接(从它的父节点指向它),我们将链接的颜色保存在表示节点的Node数据类型的布尔变量color中.如果指向它的链接的颜色是红色的,那么该变量为true,黑色为false.约定空链接为黑色.
使用私有方法isRed()来测试一个节点和它的父节点之间的链接的颜色.当我们提到一个节点的颜色时,我们指的是指向该节点的链接的颜色,反之亦然.代码及图示如下:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="no">RED</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="no">BLACK</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">class</span> <span class="nc">Node</span><span class="o">{</span>
    <span class="nc">Key</span> <span class="n">key</span><span class="o">;</span>        <span class="c1">//键</span>
    <span class="nc">Value</span> <span class="n">value</span><span class="o">;</span>    <span class="c1">//相关联的值</span>
    <span class="nc">Node</span> <span class="n">left</span><span class="o">,</span><span class="n">right</span><span class="o">;</span><span class="c1">//左右子树</span>
    <span class="kt">int</span> <span class="no">N</span><span class="o">;</span>          <span class="c1">//这棵子树中的节点总数</span>
    <span class="kt">boolean</span> <span class="n">color</span><span class="o">;</span>  <span class="c1">//由其父节点指向它的链接的颜色</span>

    <span class="nc">Node</span><span class="o">(</span><span class="nc">Key</span> <span class="n">key</span><span class="o">,</span> <span class="nc">Value</span> <span class="n">val</span><span class="o">,</span> <span class="kt">int</span> <span class="no">N</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">color</span><span class="o">){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">key</span><span class="o">=</span><span class="n">key</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">val</span><span class="o">=</span><span class="n">val</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">N</span><span class="o">=</span><span class="no">N</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">color</span><span class="o">=</span><span class="n">color</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isRed</span><span class="o">(</span><span class="nc">Node</span> <span class="n">x</span><span class="o">){</span>
    <span class="k">if</span><span class="o">(</span><span class="n">x</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="na">color</span> <span class="o">==</span> <span class="no">RED</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/红黑树的结点表示.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="红黑树的结点表示" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/红黑树的结点表示.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">红黑树的结点表示</div>
    </a>
</center>

<p>5.旋转<br />
  在我们实现的某些操作中可能会出现红色右链接或者两条连续的红链接,但在操作完成前这些情况都会被小心地旋转并修复.旋转操作会改变红链接的指向.
首先,假设我们有一条红色的右链接需要被转化为左链接,如下图.这个操作叫做左旋转,它对应的方法接受一条并指向红黑树中的某个节点的链接作为参数.
假设被指向的节点的右链接是红色的,这个方法会对树进行必要的调整并返回一个指向包含同一组键的子树且左链接为红色的根节点的链接.
这个操作很容易理解:我们只是将用两个键中的较小者作为根节点变为较大者作为根节点.实现将一个红色左链接转换为一个红色右链接的一个右旋转的代码完全相同,只需要将left和right互换即可.</p>
<ul>
  <li>左旋转
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Node</span> <span class="nf">rotateLeft</span><span class="o">(</span><span class="nc">Node</span> <span class="n">h</span><span class="o">){</span>
  <span class="nc">Node</span> <span class="n">x</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="na">right</span><span class="o">;</span>
  <span class="n">h</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">left</span><span class="o">;</span>
  <span class="n">x</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">h</span><span class="o">;</span>
  <span class="n">x</span><span class="o">.</span><span class="na">color</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="na">color</span><span class="o">;</span>
  <span class="n">h</span><span class="o">.</span><span class="na">color</span> <span class="o">=</span> <span class="no">RED</span><span class="o">;</span>
  <span class="n">x</span><span class="o">.</span><span class="na">N</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="na">N</span><span class="o">;</span>
  <span class="n">h</span><span class="o">.</span><span class="na">N</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="n">size</span><span class="o">(</span><span class="n">h</span><span class="o">.</span><span class="na">left</span><span class="o">)+</span><span class="n">size</span><span class="o">(</span><span class="n">h</span><span class="o">.</span><span class="na">right</span><span class="o">);</span>
  <span class="k">return</span> <span class="n">x</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ul>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/左旋转h的右链接.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="左旋转h的右链接" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/左旋转h的右链接.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">左旋转h的右链接</div>
    </a>
</center>

<ul>
  <li>右旋转
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Node</span> <span class="nf">rotateRight</span><span class="o">(</span><span class="nc">Node</span> <span class="n">h</span><span class="o">){</span>
  <span class="nc">Node</span> <span class="n">x</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="na">left</span><span class="o">;</span>
  <span class="n">h</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">right</span><span class="o">;</span>
  <span class="n">x</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">h</span><span class="o">;</span>
  <span class="n">x</span><span class="o">.</span><span class="na">color</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="na">color</span><span class="o">;</span>
  <span class="n">h</span><span class="o">.</span><span class="na">color</span> <span class="o">=</span> <span class="no">RED</span><span class="o">;</span>
  <span class="n">x</span><span class="o">.</span><span class="na">N</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="na">N</span><span class="o">;</span>
  <span class="n">h</span><span class="o">.</span><span class="na">N</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="n">size</span><span class="o">(</span><span class="n">h</span><span class="o">.</span><span class="na">left</span><span class="o">)+</span><span class="n">size</span><span class="o">(</span><span class="n">h</span><span class="o">.</span><span class="na">right</span><span class="o">);</span>
  <span class="k">return</span> <span class="n">x</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ul>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/右旋转h的左链接.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="右旋转h的左链接" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/右旋转h的左链接.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">右旋转h的左链接</div>
    </a>
</center>

<p>6.在旋转后重置父节点的链接<br />
  无论坐旋转还是右旋转,旋转操作都会返回一条链接.我们总是会用rotateRight()或rotateLeft()的返回值重置父节点(或是根节点)中相应的链接.
返回的链接可能是左链接也可能是右链接,但是我们总会将它赋予父节点中的链接.这个链接可能是红色也可能黑色–rotateLeft()和rotateRight()都通过将x.color设为h.color保留它原来的颜色.
这可能会产生两条连续的红链接,但我们的算法会继续用旋转操作修正这种情况.<br />
  在插入新的键时,我们可以使用旋转操作帮助我们保证2-3树和红黑树之间的一一对应关系,因为旋转操作可以保证红黑树的两个重要性质:有序性和完美平衡性.
也就是说,我们在红黑树中进行旋转时无需为树的有序性或完美平衡性担心.下面我们继续看看如何使用旋转操作来保持红黑树的另外两个重要性质.</p>

<p>7.向单个2-节点中插入新键<br />
  一棵树只含有一个键的红黑树只含有一个2-节点.插入另一个键后,马上就需要将它们旋转.如果新键小于老键,只需要新增一个红色的节点即可,新的红黑树和单个3-节点完全等价.
如果新键大于老键,那么新增的红色节点将会产生一条红色的右链接.我们需要使用 <strong>root=rotateLeft(root)</strong> 将其旋转为红色左链接并修正根节点,插入操作才算完成.
两种情况的结果为一棵和单个3-节点等价的红黑树,其中含有两个键,一条红链接,树的黑链接高度为1,如下图所示:</p>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/向单个2-结点中插入一个新键.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="向单个2-结点中插入一个新键" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/向单个2-结点中插入一个新键.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">向单个2-结点中插入一个新键</div>
    </a>
</center>

<p>8.向树底部的2-节点插入新键<br />
  用和二叉树查找树相同的方式向一棵红黑树中插入一个新键会在树的底部新增一个节点(为了保证有序性),但总是用红链接将新节点和它的父节点相连.
如果它的父节点是一个2-节点,那么刚才讨论的两种处理方法仍然适用.如果指向新节点的是父节点的左链接,那么父节点就直接成为了一个3-节点;
如果指向新节点的是父节点的右链接,这就是一个错误的3-节点,但一次左旋转就能修正它,如下图所示:</p>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/向树底部的2-结点插入一个新键.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="向树底部的2-结点插入一个新键" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/向树底部的2-结点插入一个新键.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">向树底部的2-结点插入一个新键</div>
    </a>
</center>

<p>9.向一棵双键树(即一个3-节点)中插入新键<br />
  这种情况又可分为三种情况:新键小于树中的两个键,在两者之间,或是大于树中的两个键.每种情况都会产生一个同时链接到两条红链接的节点,而我们的目标就是修正这一点.</p>
<ul>
  <li>三者中最简单的情况就是新键大于原树中的两个键,因此它被链接到3-节点的右链接.此时树是平衡的,根节点为中间大小的键,它有两条红链接分别和较小和较大的节点相连.
如果我们将两条链接的颜色都由红变黑,那么我们就得到了一棵有三个节点组成,高度为2的平衡树.它正好能对应一棵2-3树,如下图左侧.其他两种情况最终也会转换为这种情况.</li>
  <li>如果新键小于原树中的两个键,它就会被链接到最左边的空链接,这种就产生了两条连续的红链接,如下图中间侧.此时我们只需要将上层的红链接右旋转即可得到第一种情况(中值键为根节点并和其他两个节点用红链接相连)</li>
  <li>如果新键介于原树中的两个键之间,这又会产生两条连续的红链接,一条红色左链接接一条红色右链接,如下图右侧.此时我们只需要将下层的红链接左旋转即可得到第二种情况(两条连续的红色链接)</li>
</ul>

<p>  总的来说,我们通过0次,1次和2次旋转以及颜色的变化得到了期望的结果.</p>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/向一棵双键树(即一个3-结点)中插入一个新键的三种情况.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="向一棵双键树(即一个3-结点)中插入一个新键的三种情况" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/向一棵双键树(即一个3-结点)中插入一个新键的三种情况.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">向一棵双键树(即一个3-结点)中插入一个新键的三种情况</div>
    </a>
</center>

<p>10.颜色转换<br />
  如下图,我们专门用一个方法 <strong>flipColors()</strong> 来转换一个节点的两个红色子节点的颜色.除了将子节点的颜色由红变黑之外,我们同时还要将父节点的颜色由黑变红.
这项操作最重重要的性质在于它和旋转操作一样是局部变换,不会影响整棵树的黑色平衡.</p>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/通过转换链接的颜色来分解4-结点.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="通过转换链接的颜色来分解4-结点" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/通过转换链接的颜色来分解4-结点.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">通过转换链接的颜色来分解4-结点</div>
    </a>
</center>

<p>11.根节点总是黑色<br />
  在第9种情况中,颜色转换会使根节点变为红色.严格的说,红色的根节点说明根节点是一个3-节点的一部分,但是实际情况并不是这样.因此我们在每次插入后都会将根节点设为黑色.注意,每当根节点由红变黑时树的黑链接高度就会加1.</p>

<p>12.向树底部的3-节点插入新键<br />
  现在假设我们需要在树的底部的一个3-节点下加入一个新节点.前面讨论的三种情况都会出现,如下图所示.指向新节点的链接可能是3-节点的右链接(此时我们只需要转换颜色即可),
或是左链接(此时我们需要进行右旋转然后再转换颜色),或是中链接(此时我们需要先左旋转下层链接然后右旋转上层链接,最后再转换颜色).颜色转换会使到中节点的链接变红,相当于将它送入了父节点.这意味着在父节点中继续插入一个新键,我们也会用相同的办法解决这个问题.</p>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/向树底部的3-结点插入一个新键.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="向树底部的3-结点插入一个新键" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/向树底部的3-结点插入一个新键.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">向树底部的3-结点插入一个新键</div>
    </a>
</center>

<p>13.将红链接在树中向上传递<br />
  2-3树中的插入算法需要我们分解3-节点,将中间键插入父节点,如此这般直到遇到一个2-节点或是根节点.我们所考虑过的所有情况都是为了达成这个目标:
每次必要的旋转之后我们都会进行颜色转换,这使得中节点变红.在父节点看来,处理这样一个红色节点的方式和处理一个新插入的红色节点完全相同,即继续把红链接转移到中节点上去.
下图中总结的三种情况显示了在红黑树中实现2-3树的插入算法的关键操作所需的步骤:要在一个3-节点下插入新键,先创建一个临时的4-节点,将其分解并将红链接由中间键传递给它的父节点.重复这个过程,我们就能将红链接在树中向上传递,直至遇到一个2-节点或者根节点.<br />
  总之,只要谨慎地使用左旋转、右旋转和颜色转换这三种简单的操作,我们就能保证插入操作后红黑树和2-3树的一一对应关系.在沿着插入点到根节点的路上向上移动时在所经过的每个节点中顺序完成以下操作,我们就能完成插入操作:</p>
<ul>
  <li>如果右子节点是红色的而左子节点是黑色的,进行左旋转</li>
  <li>如果左子节点是红色的且它的左子节点也是红色的,进行右旋转</li>
  <li>如果左右子节点均为红色,进行颜色转换</li>
</ul>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/红黑树中红链接向上传递.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="红黑树中红链接向上传递" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/红黑树中红链接向上传递.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">红黑树中红链接向上传递</div>
    </a>
</center>

<p>14.实现<br />
  因为保持树的平衡性所需的操作是由下向上在每个经过的节点中进行的,将它们植入我们已有的实现中十分简单:只需要在递归调用之后完成这些操作即可.算法如下所示:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReaBlackBST</span><span class="o">&lt;</span><span class="nc">Key</span> <span class="kd">extends</span> <span class="nc">Comparable</span><span class="o">&lt;</span><span class="nc">Key</span><span class="o">&gt;&gt;,</span> <span class="nc">Value</span><span class="o">&gt;</span>
<span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Node</span> <span class="n">root</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">Node</span> <span class="c1">//含有color变量的Node对象</span>
    
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isRed</span><span class="o">(</span><span class="nc">Node</span> <span class="n">h</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Node</span> <span class="nf">rotateLeft</span><span class="o">(</span><span class="nc">Node</span> <span class="n">h</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Node</span> <span class="nf">rotateRight</span><span class="o">(</span><span class="nc">Node</span> <span class="n">h</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">flipColors</span><span class="o">(</span><span class="nc">Node</span> <span class="n">h</span><span class="o">)</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">put</span><span class="o">(</span><span class="nc">Key</span> <span class="n">key</span><span class="o">,</span> <span class="nc">Value</span> <span class="n">val</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="c1">//查找key,找到则更新其值,否则为它新建一个节点</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">put</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">val</span><span class="o">);</span>
        <span class="n">root</span><span class="o">.</span><span class="na">color</span> <span class="o">=</span> <span class="no">BLACK</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="nc">Node</span> <span class="nf">put</span><span class="o">(</span><span class="nc">Node</span> <span class="n">h</span><span class="o">,</span> <span class="nc">Key</span> <span class="n">key</span><span class="o">,</span> <span class="nc">Value</span> <span class="n">val</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">h</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">Node</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">val</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="no">RED</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kt">int</span> <span class="n">cmp</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">h</span><span class="o">.</span><span class="na">key</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">cmp</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">){</span>
            <span class="n">h</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">put</span><span class="o">(</span><span class="n">h</span><span class="o">.</span><span class="na">left</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">val</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">cmp</span><span class="o">&gt;</span><span class="mi">0</span><span class="o">){</span>
            <span class="n">h</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">put</span><span class="o">(</span><span class="n">h</span><span class="o">.</span><span class="na">right</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">val</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
            <span class="n">h</span><span class="o">.</span><span class="na">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span><span class="o">(</span><span class="n">isRed</span><span class="o">(</span><span class="n">h</span><span class="o">.</span><span class="na">right</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isRed</span><span class="o">(</span><span class="n">h</span><span class="o">.</span><span class="na">left</span><span class="o">)){</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">rotateLeft</span><span class="o">(</span><span class="n">h</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span><span class="o">(</span><span class="n">isRed</span><span class="o">(</span><span class="n">h</span><span class="o">.</span><span class="na">left</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">isRed</span><span class="o">(</span><span class="n">h</span><span class="o">.</span><span class="na">left</span><span class="o">.</span><span class="na">left</span><span class="o">)){</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">rotateRight</span><span class="o">(</span><span class="n">h</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span><span class="o">(</span><span class="n">isRed</span><span class="o">(</span><span class="n">h</span><span class="o">.</span><span class="na">left</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">isRed</span><span class="o">(</span><span class="n">h</span><span class="o">.</span><span class="na">right</span><span class="o">)){</span>
            <span class="n">flipColors</span><span class="o">(</span><span class="n">h</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">h</span><span class="o">.</span><span class="na">N</span> <span class="o">=</span> <span class="n">size</span><span class="o">(</span><span class="n">h</span><span class="o">.</span><span class="na">left</span><span class="o">)</span> <span class="o">+</span> <span class="n">size</span><span class="o">(</span><span class="n">h</span><span class="o">.</span><span class="na">right</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">h</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  除了递归调用后的三条if语句,红黑树中put()的递归实现和二叉查找树中put()的实现完全相同.它们在查找路径上保证了红黑树和2-3树的一一对应关系,
使得树的平衡性接近完美.第一条if语句会将任意含有红色右链接的3-节点(或临时的4-节点)向左旋转;第二条if语句会将临时的4-节点中两条连续红链接中的上层链接向右旋转;
第三条if语句会进行颜色转换并将红链接在树中向上传递.<br />
  下图给出了使用我们的标准索引测试用例进行测试的轨迹和用同一组键按升序构造一棵红黑树的测试轨迹.</p>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/红黑树的构造轨迹.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="红黑树的构造轨迹" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/balancedBinaryTree/红黑树的构造轨迹.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">红黑树的构造轨迹</div>
    </a>
</center>
<hr />

</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">Tree</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">Septemper 2021</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">algorithm</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-20000006" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2>SpringBoot启动源码解析(六)</h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/pexels-rachel-claire-4577793.jpg" class="img-responsive img-centered" alt="SpringBoot">

                            
                                <h3>SpringBootApplication Run方法解析(四):refreshContext</h3>
                            
                            </div>

                            <p><h3 id="run方法入口">Run方法入口</h3>
<hr />
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Run the Spring application, creating and refreshing a new
 * {@link ApplicationContext}.
 * 运行Spring应用，创建和刷新一个新的应用上下文
 * @param args the application arguments (usually passed from a Java main method)
 * @return a running {@link ApplicationContext}
 */</span>
<span class="kd">public</span> <span class="nc">ConfigurableApplicationContext</span> <span class="nf">run</span><span class="o">(</span><span class="nc">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//1.创建启动计时器</span>
    <span class="nc">StopWatch</span> <span class="n">stopWatch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StopWatch</span><span class="o">();</span>
    <span class="n">stopWatch</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="c1">//创建启动上下文并初始化相应的Bootstrapper 目前暂未使用</span>
    <span class="nc">ConfigurableApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">SpringBootExceptionReporter</span><span class="o">&gt;</span> <span class="n">exceptionReporters</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="c1">//设置系统的配置模式，一般用于服务端开发 默认为true</span>
    <span class="n">configureHeadlessProperty</span><span class="o">();</span>
    <span class="c1">//获取spring上下文启动监听者  从META-INF/spring.factories中获取SpringApplicationRunListener的实现类并加载</span>
    <span class="nc">SpringApplicationRunListeners</span> <span class="n">listeners</span> <span class="o">=</span> <span class="n">getRunListeners</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
    <span class="c1">//发布启动中事件</span>
    <span class="n">listeners</span><span class="o">.</span><span class="na">starting</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">//2.创建默认上下文参数</span>
        <span class="nc">ApplicationArguments</span> <span class="n">applicationArguments</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultApplicationArguments</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
        <span class="c1">//3.准备环境，将资源属性添加到环境中并与上下文绑定</span>
        <span class="nc">ConfigurableEnvironment</span> <span class="n">environment</span> <span class="o">=</span> <span class="n">prepareEnvironment</span><span class="o">(</span><span class="n">listeners</span><span class="o">,</span> <span class="n">applicationArguments</span><span class="o">);</span>
        <span class="c1">//设置spring.beaninfo.ignore中过滤的bean</span>
        <span class="n">configureIgnoreBeanInfo</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
        <span class="c1">//打印spring标记</span>
        <span class="nc">Banner</span> <span class="n">printedBanner</span> <span class="o">=</span> <span class="n">printBanner</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
        <span class="c1">//4.根据web应用类型创建指定的应用上下文</span>
        <span class="c1">//注意:这里反射创建AnnotationConfigServletWebServerApplicationContext时,构造中创建AnnotatedBeanDefinitionReader中的AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry)方法很重要</span>
        <span class="c1">//它将几个常见的BeanPostProcessor和BeanFactoryPostProcessor注册到注册表中  最重要的是internalConfigurationAnnotationProcessor来解析Configuration的配置类</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">createApplicationContext</span><span class="o">();</span>
        <span class="n">exceptionReporters</span> <span class="o">=</span> <span class="n">getSpringFactoriesInstances</span><span class="o">(</span><span class="nc">SpringBootExceptionReporter</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                <span class="k">new</span> <span class="nc">Class</span><span class="o">[]</span> <span class="o">{</span> <span class="nc">ConfigurableApplicationContext</span><span class="o">.</span><span class="na">class</span> <span class="o">},</span> <span class="n">context</span><span class="o">);</span>
        <span class="c1">//5.准备上下文</span>
        <span class="c1">//主要做了两件事:</span>
        <span class="c1">// 1.调用前面实例化的ApplicationContextInitializer的initialize方式初始化上下文</span>
        <span class="c1">// 2.在其中的load方法中将启动主函数bean定义注册到注册表中 beanDefinitionMap</span>
        <span class="n">prepareContext</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">environment</span><span class="o">,</span> <span class="n">listeners</span><span class="o">,</span> <span class="n">applicationArguments</span><span class="o">,</span> <span class="n">printedBanner</span><span class="o">);</span>
        <span class="c1">//6.刷新上下文</span>
        <span class="n">refreshContext</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
        <span class="n">afterRefresh</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">applicationArguments</span><span class="o">);</span>
        <span class="n">stopWatch</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">logStartupInfo</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">new</span> <span class="nf">StartupInfoLogger</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mainApplicationClass</span><span class="o">).</span><span class="na">logStarted</span><span class="o">(</span><span class="n">getApplicationLog</span><span class="o">(),</span> <span class="n">stopWatch</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">//监听者发布已启动事件</span>
        <span class="n">listeners</span><span class="o">.</span><span class="na">started</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
        <span class="c1">//7.调用所有的ApplicationRunner和CommandLineRunner的实现类</span>
        <span class="n">callRunners</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">applicationArguments</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">handleRunFailure</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">ex</span><span class="o">,</span> <span class="n">exceptionReporters</span><span class="o">,</span> <span class="n">listeners</span><span class="o">);</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">//监听者发布运行中事件</span>
        <span class="n">listeners</span><span class="o">.</span><span class="na">running</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">handleRunFailure</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">ex</span><span class="o">,</span> <span class="n">exceptionReporters</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">context</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<hr />
<h3 id="refreshcontext">refreshContext</h3>
<hr />
<p>  本篇我们一起分析下SpringBoot启动流程中最重要的一步 <strong>refreshContext</strong> ,字面意思就是刷新上下文,基本上这个完成后上下文就差不多可以使用了.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">refreshContext</span><span class="o">(</span><span class="nc">ConfigurableApplicationContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//刷新上下文, 调用AbstractApplicationContext的refresh方法</span>
    <span class="n">refresh</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="c1">//是否需要注册下线钩子 默认为true</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">registerShutdownHook</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">//执行AbstractApplicationContext的注册下线钩子方法</span>
            <span class="n">context</span><span class="o">.</span><span class="na">registerShutdownHook</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">catch</span> <span class="o">(</span><span class="nc">AccessControlException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Not allowed in some environments.</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="cm">/**
 * Refresh the underlying {@link ApplicationContext}.
 * 刷新潜在的上下文
 */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">refresh</span><span class="o">(</span><span class="nc">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">isInstanceOf</span><span class="o">(</span><span class="nc">AbstractApplicationContext</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">applicationContext</span><span class="o">);</span>
    <span class="o">((</span><span class="nc">AbstractApplicationContext</span><span class="o">)</span> <span class="n">applicationContext</span><span class="o">).</span><span class="na">refresh</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  由此可见,在SpringBoot中 <strong>refresh</strong> 的作用就是调用spring中真正的刷新上下文操作,并在刷新完成后注册上下文下线钩子.<br />
  接下来, 我们来真正看下在spring中的 <strong>refresh</strong> 方法源码:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/** Synchronization monitor for the "refresh" and "destroy". */</span>
<span class="c1">// 刷新和销毁的同步监视器</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">Object</span> <span class="n">startupShutdownMonitor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">refresh</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">BeansException</span><span class="o">,</span> <span class="nc">IllegalStateException</span> <span class="o">{</span>
    <span class="c1">//锁定当前监视器锁 保证只有一个</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">startupShutdownMonitor</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Prepare this context for refreshing.</span>
        <span class="c1">//1.为刷新准备上下文,主要是设置启动时间和激活标志位以及初始化一些其他的属性</span>
        <span class="n">prepareRefresh</span><span class="o">();</span>

        <span class="c1">// Tell the subclass to refresh the internal bean factory.</span>
        <span class="c1">//2.告诉子类刷新内部的bean工厂 主要为bean工厂设置serializationId 并返回该bean工厂</span>
        <span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">obtainFreshBeanFactory</span><span class="o">();</span>

        <span class="c1">// Prepare the bean factory for use in this context.</span>
        <span class="c1">//3.准备在此上下文中使用的bean工厂 详细解析见下方</span>
        <span class="n">prepareBeanFactory</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// Allows post-processing of the bean factory in context subclasses.</span>
            <span class="c1">// 4. 允许在上下文子类中对bean工厂进行后置处理 注册WebApplicationContextServletContextAwareProcessor后置处理器和注册request、session等特定web范围 </span>
            <span class="n">postProcessBeanFactory</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

            <span class="c1">// Invoke factory processors registered as beans in the context.</span>
            <span class="c1">// 非常核心 5.调用在上下文中注册为bean的工厂处理器 通过ConfigurationClassPostProcessor来解析所有的配置类</span>
            <span class="n">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

            <span class="c1">// Register bean processors that intercept bean creation.</span>
            <span class="c1">// 6.注册拦截bean创建的bean处理器</span>
            <span class="n">registerBeanPostProcessors</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

            <span class="c1">// Initialize message source for this context.</span>
            <span class="c1">// 7.为上下文初始化消息源</span>
            <span class="n">initMessageSource</span><span class="o">();</span>

            <span class="c1">// Initialize event multicaster for this context.</span>
            <span class="c1">// 8.为上下文初始化事件广播器</span>
            <span class="n">initApplicationEventMulticaster</span><span class="o">();</span>

            <span class="c1">// Initialize other special beans in specific context subclasses.</span>
            <span class="c1">// 9. 初始化在指定上下文子类中的其他特殊bean</span>
            <span class="c1">//主要是调用ServletWebServerApplicationContext重写的方法,初始化内置tomcat</span>
            <span class="n">onRefresh</span><span class="o">();</span>

            <span class="c1">// Check for listener beans and register them.</span>
            <span class="c1">//10. 检查监听器bean并注册他们</span>
            <span class="n">registerListeners</span><span class="o">();</span>

            <span class="c1">// Instantiate all remaining (non-lazy-init) singletons.</span>
            <span class="c1">// 11. 实例化所有剩下的非懒加载的单例</span>
            <span class="n">finishBeanFactoryInitialization</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

            <span class="c1">// Last step: publish corresponding event.</span>
            <span class="c1">// 12.最后一步发布相关事件</span>
            <span class="n">finishRefresh</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">catch</span> <span class="o">(</span><span class="nc">BeansException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isWarnEnabled</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Exception encountered during context initialization - "</span> <span class="o">+</span>
                        <span class="s">"cancelling refresh attempt: "</span> <span class="o">+</span> <span class="n">ex</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="c1">// Destroy already created singletons to avoid dangling resources.</span>
            <span class="n">destroyBeans</span><span class="o">();</span>

            <span class="c1">// Reset 'active' flag.</span>
            <span class="n">cancelRefresh</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>

            <span class="c1">// Propagate exception to caller.</span>
            <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">finally</span> <span class="o">{</span>
            <span class="c1">// Reset common introspection caches in Spring's core, since we</span>
            <span class="c1">// might not ever need metadata for singleton beans anymore...</span>
            <span class="n">resetCommonCaches</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p><strong>refresh</strong> 中的每一个方法都是非常重要的,那就可以大约分为十三步,我们一步步往下分析.</p>

<p>1.第一步准备上下文prepareRefresh,相关源码如下:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//调用AnnotationConfigServletWebServerApplicationContext重写的prepareRefresh</span>
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">prepareRefresh</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">scanner</span><span class="o">.</span><span class="na">clearCache</span><span class="o">();</span>
    <span class="c1">//调用父类AbstractApplicationContext的prepareRefresh方法</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">prepareRefresh</span><span class="o">();</span>
<span class="o">}</span>

<span class="cm">/**
 * Prepare this context for refreshing, setting its startup date and
 * active flag as well as performing any initialization of property sources.
 * 为刷新准备上下文, 设置它的开始时间和激活标志以及执行任何属性源的初始化
 */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">prepareRefresh</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// Switch to active.</span>
    <span class="k">this</span><span class="o">.</span><span class="na">startupDate</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">closed</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">active</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Refreshing "</span> <span class="o">+</span> <span class="k">this</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Refreshing "</span> <span class="o">+</span> <span class="n">getDisplayName</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// Initialize any placeholder property sources in the context environment.</span>
    <span class="c1">//在上下文环境中初始化任何占位符属性源  主要就重置 ServletContext和ServletConfig 默认为空 所以未进行处理</span>
    <span class="n">initPropertySources</span><span class="o">();</span>

    <span class="c1">// Validate that all properties marked as required are resolvable:</span>
    <span class="c1">// see ConfigurablePropertyResolver#setRequiredProperties</span>
    <span class="c1">//验证所有标记为必须的属性都是可解析的</span>
    <span class="n">getEnvironment</span><span class="o">().</span><span class="na">validateRequiredProperties</span><span class="o">();</span>

    <span class="c1">// Store pre-refresh ApplicationListeners...</span>
    <span class="c1">//初始化用于存储ApplicationListeners的集合 </span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">ealryApplicationListeners</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">earlyApplicationListeners</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="k">this</span><span class="o">.</span><span class="na">applicationListeners</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// Reset local application listeners to pre-refresh state.</span>
        <span class="k">this</span><span class="o">.</span><span class="na">applicationListeners</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">applicationListeners</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">earlyApplicationListeners</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// Allow for the collection of early ApplicationEvents,</span>
    <span class="c1">// to be published once the multicaster is available...</span>
    <span class="c1">// 初始化早期事件收集器   允许收集早期的ApplicationEvents, 一旦多播器可用就发布</span>
    <span class="k">this</span><span class="o">.</span><span class="na">earlyApplicationEvents</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;();</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  可见第一步主要就是设置了启动时间 <strong>startupDate</strong> 和启动标志 <strong>active=true</strong> , 初始化上下文中 <strong>ServletContext和ServletConfig</strong> 属性,最后并初始化存放早期应用监听者和应用事件的集合 <strong>earlyApplicationListeners、earlyApplicationEvents</strong> .</p>

<p>2.第二步obtainFreshBeanFactory,相关源码如下:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Tell the subclass to refresh the internal bean factory.
 * 告诉子类刷下内部bean工厂
 */</span>
<span class="kd">protected</span> <span class="nc">ConfigurableListableBeanFactory</span> <span class="nf">obtainFreshBeanFactory</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">//刷新bean工厂 即设置refreshed状态 并 设置bean工厂的序列化id</span>
    <span class="n">refreshBeanFactory</span><span class="o">();</span>
    <span class="c1">//返回持有的bean工厂</span>
    <span class="k">return</span> <span class="nf">getBeanFactory</span><span class="o">();</span>
<span class="o">}</span>

<span class="cm">/**
 * Do nothing: We hold a single internal BeanFactory and rely on callers
 * to register beans through our public methods (or the BeanFactory's).
 * 我们拥有一个内部bean工厂并依靠调用者通过我们的公共方法注册bean
 */</span>
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">refreshBeanFactory</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IllegalStateException</span> <span class="o">{</span>
    <span class="c1">//使用cas的方式设置 refreshed状态 只有原来为false才会设置成功 否则抛出非法状态异常</span>
    <span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">refreshed</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span>
                <span class="s">"GenericApplicationContext does not support multiple refresh attempts: just call 'refresh' once"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//为该bean工厂设置序列化id</span>
    <span class="k">this</span><span class="o">.</span><span class="na">beanFactory</span><span class="o">.</span><span class="na">setSerializationId</span><span class="o">(</span><span class="n">getId</span><span class="o">());</span>
<span class="o">}</span>

<span class="cm">/**
 * Specify an id for serialization purposes, allowing this BeanFactory to be
 * deserialized from this id back into the BeanFactory object, if needed.
 * 为序列化目的指定id,如果需要,运行将此bean工厂从这个id反序列化回bean工厂对象
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSerializationId</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">String</span> <span class="n">serializationId</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//如果序列化id不为空 则在serializableFactories中保存当前序列化id和bean工厂的对应关系</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">serializationId</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">serializableFactories</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">serializationId</span><span class="o">,</span> <span class="k">new</span> <span class="nc">WeakReference</span><span class="o">&lt;&gt;(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">serializationId</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">serializableFactories</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">serializationId</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//设置当前bean工厂的序列化id</span>
    <span class="k">this</span><span class="o">.</span><span class="na">serializationId</span> <span class="o">=</span> <span class="n">serializationId</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * Return the single internal BeanFactory held by this context
 * (as ConfigurableListableBeanFactory).
 * 返回上下文持有的内部单个bean工厂
 */</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="nc">ConfigurableListableBeanFactory</span> <span class="nf">getBeanFactory</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">beanFactory</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  由此可见,第二步的作用就是刷新上下文中的bean工厂,刷新主要包括通过CAS设置bean工厂中的refreshed状态为true,并设置bean工厂的序列化id <strong>serializationId</strong> ,此值为应用的名称,即 <strong>spring.application.name</strong> 指定的名称.<br />
  最后并返回刷新后的bean工厂即可.</p>

<p>3.第三步prepareBeanFactory相关源码如下:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Configure the factory's standard context characteristics,
 * such as the context's ClassLoader and post-processors.
 * 配置工厂的标准上下文特征,例如上下文的类加载和后置处理器
 */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">prepareBeanFactory</span><span class="o">(</span><span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Tell the internal bean factory to use the context's class loader etc.</span>
    <span class="c1">// 告诉内部bean工厂使用上下文的类加载器等 首先设置类加载器</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">setBeanClassLoader</span><span class="o">(</span><span class="n">getClassLoader</span><span class="o">());</span>
    <span class="c1">// 然后根据类加载器创建StandardBeanExpressionResolver 它的作用是解析#{}表达式通常配合@Value注解使用  #{}用于执行SpEL表达式,并将内容赋值给属性 @{}用于加载外部属性文件中的值 两者可以混合使用</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">setBeanExpressionResolver</span><span class="o">(</span><span class="k">new</span> <span class="nc">StandardBeanExpressionResolver</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getBeanClassLoader</span><span class="o">()));</span>
    <span class="c1">// 设置自定义property编辑注册器 主要是解析application.properties中的属性</span>
    <span class="c1">// 操作如下 https://blog.csdn.znet/qq_43414291/article/details/111226055</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">addPropertyEditorRegistrar</span><span class="o">(</span><span class="k">new</span> <span class="nc">ResourceEditorRegistrar</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">getEnvironment</span><span class="o">()));</span>

    <span class="c1">// Configure the bean factory with context callbacks.</span>
    <span class="c1">// 使用上下文回调设置bean工厂</span>
    <span class="c1">//在bean工厂中添加ApplicationContextAwareProcessor后置处理器  他的主要作用是在初始化bean之前 将所有实现了Aware相关接口的属性设置到bean中</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">addBeanPostProcessor</span><span class="o">(</span><span class="k">new</span> <span class="nc">ApplicationContextAwareProcessor</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="c1">//忽略指定接口的自动装配功能</span>
    <span class="c1">//主要目的:spring是懒加载,当类A中有属性B时,从容器中获取A对象时会判断属性B是否初始化,没有初始化的话会自动初始化B.</span>
	<span class="c1">//			然而有些情况是不希望初始化B的.例如B实现了BeanNameAware、BeanFactoryAware、BeanClassLoaderAware接口(该接口的作用是获取其在容器中的名称、容器、类加载器)</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">ignoreDependencyInterface</span><span class="o">(</span><span class="nc">EnvironmentAware</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">ignoreDependencyInterface</span><span class="o">(</span><span class="nc">EmbeddedValueResolverAware</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">ignoreDependencyInterface</span><span class="o">(</span><span class="nc">ResourceLoaderAware</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">ignoreDependencyInterface</span><span class="o">(</span><span class="nc">ApplicationEventPublisherAware</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">ignoreDependencyInterface</span><span class="o">(</span><span class="nc">MessageSourceAware</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">ignoreDependencyInterface</span><span class="o">(</span><span class="nc">ApplicationContextAware</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="c1">// BeanFactory interface not registered as resolvable type in a plain factory.</span>
    <span class="c1">// MessageSource registered (and found for autowiring) as a bean.</span>
    <span class="c1">//使用相应的自动装配值注册一个特殊的依赖类型,后面若需要自动装配该类型直接使用接口</span>
    <span class="c1">//registerResolvableDependency作用: 在spring自动装配的时候如果一个接口有多个实现类，并且都已经放到IOC中，那么自动装配会出现异常，spring不知道把哪个实现类注入进入。</span>
    <span class="c1">//									指定该类型接口，如果外部要注入该类型接口的对象，则会注入我们指定的对象，而不会去管其他接口实现类</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerResolvableDependency</span><span class="o">(</span><span class="nc">BeanFactory</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">);</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerResolvableDependency</span><span class="o">(</span><span class="nc">ResourceLoader</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerResolvableDependency</span><span class="o">(</span><span class="nc">ApplicationEventPublisher</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerResolvableDependency</span><span class="o">(</span><span class="nc">ApplicationContext</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>

    <span class="c1">// Register early post-processor for detecting inner beans as ApplicationListeners.</span>
    <span class="c1">//注册早期后置处理器 为了检测内部bean作为 ApplicationListener</span>
    <span class="c1">//ApplicationListenerDetector的作用就是检测所有实现了ApplicationListener接口的单例并添加到上下文中</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">addBeanPostProcessor</span><span class="o">(</span><span class="k">new</span> <span class="nc">ApplicationListenerDetector</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>

    <span class="c1">// Detect a LoadTimeWeaver and prepare for weaving, if found.</span>
    <span class="c1">//如果有的话, 检测LoadTimeWeaver并准备织入</span>
    <span class="c1">//判断bean工厂中是否包含loadTimeWeaver</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">containsBean</span><span class="o">(</span><span class="no">LOAD_TIME_WEAVER_BEAN_NAME</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">//如果包含的话注册LoadTimeWeaverAwareProcessor后置处理器</span>
        <span class="c1">//它的作用是 在bean初始化前 将默认的LoadTimeWeaver传递给实现了LoadTimeWeaverAware接口的bean</span>
        <span class="n">beanFactory</span><span class="o">.</span><span class="na">addBeanPostProcessor</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoadTimeWeaverAwareProcessor</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">));</span>
        <span class="c1">// Set a temporary ClassLoader for type matching.</span>
        <span class="c1">//设置临时类加载器进行类型匹配</span>
        <span class="n">beanFactory</span><span class="o">.</span><span class="na">setTempClassLoader</span><span class="o">(</span><span class="k">new</span> <span class="nc">ContextTypeMatchClassLoader</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getBeanClassLoader</span><span class="o">()));</span>
    <span class="o">}</span>

    <span class="c1">// Register default environment beans.</span>
    <span class="c1">//如果bean工厂中不包含 environment的bean 则向bean工厂注册它</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">containsLocalBean</span><span class="o">(</span><span class="no">ENVIRONMENT_BEAN_NAME</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerSingleton</span><span class="o">(</span><span class="no">ENVIRONMENT_BEAN_NAME</span><span class="o">,</span> <span class="n">getEnvironment</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="c1">//如果bean工厂中不包含 systemProperties的bean  直接向bean工厂注册它</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">containsLocalBean</span><span class="o">(</span><span class="no">SYSTEM_PROPERTIES_BEAN_NAME</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerSingleton</span><span class="o">(</span><span class="no">SYSTEM_PROPERTIES_BEAN_NAME</span><span class="o">,</span> <span class="n">getEnvironment</span><span class="o">().</span><span class="na">getSystemProperties</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="c1">//如果bean工厂中不包含systemEnvironment的bean  直接向bean工厂注册它</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">containsLocalBean</span><span class="o">(</span><span class="no">SYSTEM_ENVIRONMENT_BEAN_NAME</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerSingleton</span><span class="o">(</span><span class="no">SYSTEM_ENVIRONMENT_BEAN_NAME</span><span class="o">,</span> <span class="n">getEnvironment</span><span class="o">().</span><span class="na">getSystemEnvironment</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  可见第三步的作用就是设置bean工厂的通用功能.例如设置类加载器、设置 <strong>BeanExpressionResolver</strong> 用来解析 <strong>#{}</strong> 属性、设置 <strong>PropertyEditorRegistrar</strong> 来自定义解析 <strong>application.properties</strong> 中的值.<br />
添加 <strong>ApplicationContextAwareProcessor</strong> 后置处理器在bean初始化前设置实现所有相关Aware接口的属性同时要将这些Aware接口忽略防止进行自动装配, 既然有忽略那也就有注册,注册 <strong>BeanFactory、ResourceLoader、ApplicationEventPublisher、ApplicationContext</strong> 为已解析类型,当遇到这几种类型直接使用即可.<br />
  然后再检查bean工厂中是否有 <strong>LoadTimeWeaver</strong> 的bean,有则注册 <strong>LoadTimeWeaverAwareProcessor</strong> 后置处理器用来将默认的 <strong>LoadTimeWeaver</strong> 传递给实现了 <strong>LoadTimeWeaverAware</strong> 接口的bean并设置临时类加载器以进行类型匹配.<br />
  最后就是检测 <strong>environment、systemProperties、systemEnvironment</strong> 这三个bean是否存在,存在则进行注册.<br />
  以上步骤执行完后, 一个bean工厂也就可以准备使用了.</p>

<p>4.第四步postProcessBeanFactory相关源码如下:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//org.springframework.boot.web.servlet.context.AnnotationConfigServletWebServerApplicationContext#postProcessBeanFactory</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">postProcessBeanFactory</span><span class="o">(</span><span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//首先继续调用父类的postProcessBeanFactory方法继续处理bean工厂</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">postProcessBeanFactory</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>
    <span class="c1">//如果指定扫描路径则进行扫描 默认为null</span>
    <span class="k">if</span> <span class="o">(!</span><span class="nc">ObjectUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">basePackages</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">scanner</span><span class="o">.</span><span class="na">scan</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">basePackages</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//如果注解类不为空则进行注册该bean  默认为空</span>
    <span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">annotatedClasses</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">reader</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">ClassUtils</span><span class="o">.</span><span class="na">toClassArray</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">annotatedClasses</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  可见直接调用了父类的postProcessBeanFactory方法, AnnotationConfigServletWebServerApplicationContext的父类为ServletWebServerApplicationContext,那么继续看父类的代码:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">postProcessBeanFactory</span><span class="o">(</span><span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//注册WebApplicationContextServletContextAwareProcessor后置处理器</span>
    <span class="c1">//主要就是用来设置bean初始化之前设置servletContext和servletConfig</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">addBeanPostProcessor</span><span class="o">(</span><span class="k">new</span> <span class="nc">WebApplicationContextServletContextAwareProcessor</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="c1">//忽略ServletContextAware的自动装配功能</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">ignoreDependencyInterface</span><span class="o">(</span><span class="nc">ServletContextAware</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="c1">//注册web应用范围 默认注册request和session</span>
    <span class="n">registerWebApplicationScopes</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">registerWebApplicationScopes</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">//定义ExistingWebApplicationScopes 用来存储已经注册的范围</span>
    <span class="nc">ExistingWebApplicationScopes</span> <span class="n">existingScopes</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ExistingWebApplicationScopes</span><span class="o">(</span><span class="n">getBeanFactory</span><span class="o">());</span>
    <span class="c1">//注册默认的request、session范围</span>
    <span class="nc">WebApplicationContextUtils</span><span class="o">.</span><span class="na">registerWebApplicationScopes</span><span class="o">(</span><span class="n">getBeanFactory</span><span class="o">());</span>
    <span class="c1">//将注册的范围保存到ExistingWebApplicationScopes</span>
    <span class="n">existingScopes</span><span class="o">.</span><span class="na">restore</span><span class="o">();</span>
<span class="o">}</span>

<span class="cm">/**
 * Register web-specific scopes ("request", "session", "globalSession", "application")
 * with the given BeanFactory, as used by the WebApplicationContext.
 * 使用WebApplicationContext使用的给定bean工厂注册特定于web的范围"request", "session", "globalSession", "application" 
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">registerWebApplicationScopes</span><span class="o">(</span><span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">,</span>
        <span class="nd">@Nullable</span> <span class="nc">ServletContext</span> <span class="n">sc</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//注册request、session</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerScope</span><span class="o">(</span><span class="nc">WebApplicationContext</span><span class="o">.</span><span class="na">SCOPE_REQUEST</span><span class="o">,</span> <span class="k">new</span> <span class="nc">RequestScope</span><span class="o">());</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerScope</span><span class="o">(</span><span class="nc">WebApplicationContext</span><span class="o">.</span><span class="na">SCOPE_SESSION</span><span class="o">,</span> <span class="k">new</span> <span class="nc">SessionScope</span><span class="o">());</span>
    <span class="c1">//如果ServletContext不为空 则注册 globalSession、application</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">sc</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ServletContextScope</span> <span class="n">appScope</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServletContextScope</span><span class="o">(</span><span class="n">sc</span><span class="o">);</span>
        <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerScope</span><span class="o">(</span><span class="nc">WebApplicationContext</span><span class="o">.</span><span class="na">SCOPE_APPLICATION</span><span class="o">,</span> <span class="n">appScope</span><span class="o">);</span>
        <span class="c1">// Register as ServletContext attribute, for ContextCleanupListener to detect it.</span>
        <span class="n">sc</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="nc">ServletContextScope</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">appScope</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//使用相应的自动装配值注册一个特殊的依赖类型,后面若需要自动装配该类型直接使用接口</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerResolvableDependency</span><span class="o">(</span><span class="nc">ServletRequest</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="nc">RequestObjectFactory</span><span class="o">());</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerResolvableDependency</span><span class="o">(</span><span class="nc">ServletResponse</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ResponseObjectFactory</span><span class="o">());</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerResolvableDependency</span><span class="o">(</span><span class="nc">HttpSession</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="nc">SessionObjectFactory</span><span class="o">());</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerResolvableDependency</span><span class="o">(</span><span class="nc">WebRequest</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="nc">WebRequestObjectFactory</span><span class="o">());</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">jsfPresent</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">FacesDependencyRegistrar</span><span class="o">.</span><span class="na">registerFacesDependencies</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  可见父类ServletWebServerApplicationContext的作用就是注册一个 <strong>WebApplicationContextServletContextAwareProcessor</strong> 后置处理器来在bean初始化之前设置 <strong>ServletContext和ServletConfig</strong> ,然后就是注册web指定的范围 <strong>request、session</strong> .
由此可见第四步主要就是后置处理Bean工厂,具体实现在ServletWebServerApplicationContext中,结论如上.</p>

<p>5.第五步invokeBeanFactoryPostProcessors,非常重要,个人认为核心逻辑都在这里,我们好好看看,相关源码如下:</p>

<p>  我们先抛出大体的结论,通过 <strong>invokeBeanFactoryPostProcessors</strong> 方法处理,此方法中处理 <strong>BeanDefinitionRegistryPostProcessor</strong> 和 <strong>BeanFactoryPostProcessor</strong> 两个后置处理器,<br />
其中 <strong>BeanDefinitionRegistryPostProcessor</strong> 中有一个 <strong>ConfigurationClassPostProcessor</strong> ,它的作用就是解析所有的 <strong>@Configuration</strong> 修饰的类,也就是主函数,并在解析的过程中通过 <strong>@SpringBootApplication及其元注解</strong> 解析项目中指定包下的配置类.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Instantiate and invoke all registered BeanFactoryPostProcessor beans,
 * respecting explicit order if given.
 * 实例化且调用所有注册的bean工厂后置处理器bean,如果给定顺序的按显示顺序来
 * &lt;p&gt;Must be called before singleton instantiation.
 */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//真正调用bean工厂后置处理器的地方 解析所有的BeanDefinitionRegistryPostProcessor和BeanFactoryPostProcessor并按照PriorityOrdered、Ordered和默认 三种顺序执行</span>
    <span class="nc">PostProcessorRegistrationDelegate</span><span class="o">.</span><span class="na">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">,</span> <span class="n">getBeanFactoryPostProcessors</span><span class="o">());</span>

    <span class="c1">// Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime</span>
    <span class="c1">// (e.g. through an @Bean method registered by ConfigurationClassPostProcessor)</span>
    <span class="c1">//再次检测扫描是否包含LoadTimeWeaver  例如有可能通过ConfigurationClassPostProcessor类解析@Bean注解 注册 LoadTimeWeaver的bean</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getTempClassLoader</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">containsBean</span><span class="o">(</span><span class="no">LOAD_TIME_WEAVER_BEAN_NAME</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">beanFactory</span><span class="o">.</span><span class="na">addBeanPostProcessor</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoadTimeWeaverAwareProcessor</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">));</span>
        <span class="n">beanFactory</span><span class="o">.</span><span class="na">setTempClassLoader</span><span class="o">(</span><span class="k">new</span> <span class="nc">ContextTypeMatchClassLoader</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getBeanClassLoader</span><span class="o">()));</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">//解析所有的BeanDefinitionRegistryPostProcessor和BeanFactoryPostProcessor并按照PriorityOrdered、Ordered和默认 三种顺序执行</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">invokeBeanFactoryPostProcessors</span><span class="o">(</span>
        <span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">BeanFactoryPostProcessor</span><span class="o">&gt;</span> <span class="n">beanFactoryPostProcessors</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//入参beanFactoryPostProcessors有以下三个:</span>
    <span class="c1">//1.org.springframework.boot.autoconfigure.SharedMetadataReaderFactoryContextInitializer$CachingMetadataReaderFactoryPostProcessor</span>
    <span class="c1">//  实现BeanDefinitionRegistryPostProcessor,通过postProcessBeanDefinitionRegistry回调接口注册internalCachingMetadataReaderFactory用来缓存类的元数据,并将该属性metadataReaderFactory 添加到internalConfigurationAnnotationProcessor中</span>
    <span class="c1">//2.org.springframework.boot.context.ConfigurationWarningsApplicationContextInitializer$ConfigurationWarningsPostProcessor</span>
    <span class="c1">//  实现BeanDefinitionRegistryPostProcessor,通过postProcessBeanDefinitionRegistry回调接口来报告警告 不是特别重要</span>
    <span class="c1">//3.org.springframework.boot.context.config.ConfigFileApplicationListener$PropertySourceOrderingPostProcessor</span>
    <span class="c1">//  实现BeanFactoryPostProcessor,通过postProcessBeanFactory来找到environment中的defaultProperties,并将其添加到属性源末尾  通常defaultProperties为null 所以无需处理 </span>

    <span class="c1">// Invoke BeanDefinitionRegistryPostProcessors first, if any.</span>
    <span class="c1">//如果有的话首先调用BeanDefinitionRegistryPostProcessors  它的作用是在BeanFactoryPostProcessor生效前注册进一步的bean定义</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">processedBeans</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>

    <span class="c1">//BeanDefinitionRegistry是BeanFactoryPostProcessor的子类,所以我们肯定要先处理BeanDefinitionRegistry</span>
    <span class="c1">//前置处理逻辑</span>
    <span class="c1">//判断当前bean工厂是否属于BeanDefinitionRegistry  不属于直接调用注册在上下文中的BeanFactoryPostProcessor 否则继续处理</span>
    <span class="c1">//定义两个regularPostProcessors和registryProcessors分别存放两中后置处理器 肯定是要先执行子类BeanDefinitionRegistryPostProcessor</span>
    <span class="c1">//遍历上下文中的后置处理器 遇到BeanDefinitionRegistryPostProcessor直接执行postProcessBeanDefinitionRegistry回调并将其添加到registryProcessors集合中</span>
    <span class="c1">//                      遇到BeanFactoryPostProcessor则直接添加到regularPostProcessors集合中</span>
    <span class="c1">//接下来就是处理BeanDefinitionRegistryPostProcessor的正文了:</span>
    <span class="c1">//1. 首先从bean工厂已注册的bean定义中找到实现BeanDefinitionRegistryPostProcessor的bean  </span>
    <span class="c1">//   目前只有一个就是ConfigurationClassPostProcessor, 我们再仔细想想这个是不是很眼熟,它又是在何时注册为bean定义的, </span>
    <span class="c1">//   前面我们其实介绍过就是在创建AnnotationConfigServletWebServerApplicationContext上下文构造时的AnnotatedBeanDefinitionReader中的AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry)方法,它会注册ConfigurationClassPostProcessor的bean定义到上下文中</span>
    <span class="c1">//2. 既然找到了ConfigurationClassPostProcessor,判断它是否实现了PriorityOrdered,实现了的话则通过getBean方法实例化该bean,并添加到currentRegistryProcessors集合中 getBean方法也是Spring中非常重要的方法,后面我们再介绍</span>
    <span class="c1">//3. 实例化完指定bean后将currentRegistryProcessors进行排序并将已经集合中的所有元素添加到registryProcessors集合中</span>
    <span class="c1">//4. 最重要的一步 执行所有的BeanDefinitionRegistryPostProcessor后置处理器的postProcessBeanDefinitionRegistry, 这里主要是执行ConfigurationClassPostProcessor的回调, 它的主要作用就是解析主函数 逻辑是非常重要的 后面我们慢慢分析</span>
    <span class="c1">//5. 执行完之后将currentRegistryProcessors清空</span>
    <span class="c1">//6. 再次按照步骤1-5的顺序 将所有BeanDefinitionRegistryPostProcessor的bean按照Ordered和默认顺序进行处理即可  </span>
    <span class="c1">//7. 最后依次执行registryProcessors和regularPostProcessors中的所有后置处理器的postProcessBeanFactory方法</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">beanFactory</span> <span class="k">instanceof</span> <span class="nc">BeanDefinitionRegistry</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span> <span class="o">=</span> <span class="o">(</span><span class="nc">BeanDefinitionRegistry</span><span class="o">)</span> <span class="n">beanFactory</span><span class="o">;</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">BeanFactoryPostProcessor</span><span class="o">&gt;</span> <span class="n">regularPostProcessors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">BeanDefinitionRegistryPostProcessor</span><span class="o">&gt;</span> <span class="n">registryProcessors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

        <span class="c1">//预先执行上下文实例中注册的后置处理器</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">BeanFactoryPostProcessor</span> <span class="n">postProcessor</span> <span class="o">:</span> <span class="n">beanFactoryPostProcessors</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">postProcessor</span> <span class="k">instanceof</span> <span class="nc">BeanDefinitionRegistryPostProcessor</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">BeanDefinitionRegistryPostProcessor</span> <span class="n">registryProcessor</span> <span class="o">=</span>
                        <span class="o">(</span><span class="nc">BeanDefinitionRegistryPostProcessor</span><span class="o">)</span> <span class="n">postProcessor</span><span class="o">;</span>
                <span class="n">registryProcessor</span><span class="o">.</span><span class="na">postProcessBeanDefinitionRegistry</span><span class="o">(</span><span class="n">registry</span><span class="o">);</span>
                <span class="n">registryProcessors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">registryProcessor</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="n">regularPostProcessors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">postProcessor</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="c1">// Do not initialize FactoryBeans here: We need to leave all regular beans</span>
        <span class="c1">// uninitialized to let the bean factory post-processors apply to them!</span>
        <span class="c1">// Separate between BeanDefinitionRegistryPostProcessors that implement</span>
        <span class="c1">// PriorityOrdered, Ordered, and the rest.</span>
        <span class="c1">//这里不实例化化工厂bean: 我们需要让所有常规bean未初始化以便让bean工厂后置处理器应用他们</span>
        <span class="c1">//将实现PriorityOrdered、Ordered和其余部分的BeanDefinitionRegistryPostProcessors分开</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">BeanDefinitionRegistryPostProcessor</span><span class="o">&gt;</span> <span class="n">currentRegistryProcessors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

        <span class="c1">// First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.</span>
        <span class="c1">//首先调用实现了PriorityOrdered接口的BeanDefinitionRegistryPostProcessors</span>
        <span class="nc">String</span><span class="o">[]</span> <span class="n">postProcessorNames</span> <span class="o">=</span>
                <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBeanNamesForType</span><span class="o">(</span><span class="nc">BeanDefinitionRegistryPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">ppName</span> <span class="o">:</span> <span class="n">postProcessorNames</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">isTypeMatch</span><span class="o">(</span><span class="n">ppName</span><span class="o">,</span> <span class="nc">PriorityOrdered</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">currentRegistryProcessors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">ppName</span><span class="o">,</span> <span class="nc">BeanDefinitionRegistryPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
                <span class="n">processedBeans</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ppName</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">sortPostProcessors</span><span class="o">(</span><span class="n">currentRegistryProcessors</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">);</span>
        <span class="n">registryProcessors</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">currentRegistryProcessors</span><span class="o">);</span>
        <span class="n">invokeBeanDefinitionRegistryPostProcessors</span><span class="o">(</span><span class="n">currentRegistryProcessors</span><span class="o">,</span> <span class="n">registry</span><span class="o">);</span>
        <span class="n">currentRegistryProcessors</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>

        <span class="c1">// Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered.</span>
        <span class="c1">//接着调用实现了Ordered接口的BeanDefinitionRegistryPostProcessors</span>
        <span class="n">postProcessorNames</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBeanNamesForType</span><span class="o">(</span><span class="nc">BeanDefinitionRegistryPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">ppName</span> <span class="o">:</span> <span class="n">postProcessorNames</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">processedBeans</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">ppName</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">isTypeMatch</span><span class="o">(</span><span class="n">ppName</span><span class="o">,</span> <span class="nc">Ordered</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">currentRegistryProcessors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">ppName</span><span class="o">,</span> <span class="nc">BeanDefinitionRegistryPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
                <span class="n">processedBeans</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ppName</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">sortPostProcessors</span><span class="o">(</span><span class="n">currentRegistryProcessors</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">);</span>
        <span class="n">registryProcessors</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">currentRegistryProcessors</span><span class="o">);</span>
        <span class="n">invokeBeanDefinitionRegistryPostProcessors</span><span class="o">(</span><span class="n">currentRegistryProcessors</span><span class="o">,</span> <span class="n">registry</span><span class="o">);</span>
        <span class="n">currentRegistryProcessors</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>

        <span class="c1">// Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear.</span>
        <span class="c1">//最后调用剩下的BeanDefinitionRegistryPostProcessors直到没有</span>
        <span class="kt">boolean</span> <span class="n">reiterate</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">reiterate</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">reiterate</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="n">postProcessorNames</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBeanNamesForType</span><span class="o">(</span><span class="nc">BeanDefinitionRegistryPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">ppName</span> <span class="o">:</span> <span class="n">postProcessorNames</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">processedBeans</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">ppName</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">currentRegistryProcessors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">ppName</span><span class="o">,</span> <span class="nc">BeanDefinitionRegistryPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
                    <span class="n">processedBeans</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ppName</span><span class="o">);</span>
                    <span class="n">reiterate</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">sortPostProcessors</span><span class="o">(</span><span class="n">currentRegistryProcessors</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">);</span>
            <span class="n">registryProcessors</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">currentRegistryProcessors</span><span class="o">);</span>
            <span class="n">invokeBeanDefinitionRegistryPostProcessors</span><span class="o">(</span><span class="n">currentRegistryProcessors</span><span class="o">,</span> <span class="n">registry</span><span class="o">);</span>
            <span class="n">currentRegistryProcessors</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="c1">// Now, invoke the postProcessBeanFactory callback of all processors handled so far.</span>
        <span class="c1">//调用目前为止处理的所有后置处理器的 postProcessBeanFactory方法</span>
        <span class="n">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="n">registryProcessors</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">);</span>
        <span class="n">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="n">regularPostProcessors</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// Invoke factory processors registered with the context instance.</span>
        <span class="c1">// 调用通过上下文实例注册的工厂处理器</span>
        <span class="n">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="n">beanFactoryPostProcessors</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// Do not initialize FactoryBeans here: We need to leave all regular beans</span>
    <span class="c1">// uninitialized to let the bean factory post-processors apply to them!</span>
    <span class="c1">//这里不实例化工厂bean:我们需要让所有常规bean不实例化以便让bean工厂后置处理器应用他们</span>
    
    <span class="c1">//上下文中主要有这6个后置处理器:</span>
    <span class="c1">//1. org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span>
    <span class="c1">//   处理配置类 第一阶段以及处理过 无需再处理</span>
    <span class="c1">//2. org.springframework.context.event.internalEventListenerProcessor</span>
    <span class="c1">//   主要作用是设置实现EventListenerFactory接口的bean</span>
    <span class="c1">//3. propertySourcesPlaceholderConfigurer</span>
    <span class="c1">//   它的作用就是解析 ${} 占位符的值和@Value 在Environment和PropertySources中的值</span>
    <span class="c1">//4. org.springframework.boot.context.properties.ConfigurationPropertiesBeanDefinitionValidator</span>
    <span class="c1">//   主要作用是验证常规bean定义没有创建 ConstructorBinding的bean</span>
    <span class="c1">//5. preserveErrorControllerTargetClassPostProcessor</span>
    <span class="c1">//   创建ErrorController相关的bean定义并设置preserveTargetClass属性为true</span>
    <span class="c1">//6. emBeanDefinitionRegistrarPostProcessor</span>
    <span class="c1">//   主要是处理jpa相关属性  无需关心</span>

    <span class="c1">//这里就是处理BeanFactoryPostProcessor的逻辑,大致逻辑与处理BeanDefinitionRegistryPostProcessor类似</span>
    <span class="c1">//1. 首先从bean工厂的定义中找到实现BeanFactoryPostProcessor接口的所有bean定义</span>
    <span class="c1">//2. 接着定义三个集合 priorityOrderedPostProcessors、orderedPostProcessorNames、nonOrderedPostProcessorNames 分别存放实现了 PriorityOrdered、Ordered、默认顺序的bean</span>
    <span class="c1">//   这里需要注意 只有实现了PriorityOrdered的bean才会立即实例化</span>
    <span class="c1">//3. 首先还是先调用实现了PriorityOrdered接口的后置处理器的postProcessBeanFactory接口</span>
    <span class="c1">//4. 接着先获取所有实现了Ordered接口的后置处理器的bean,接着调用postProcessBeanFactory接口</span>
    <span class="c1">//5. 按步骤4处理剩下的后置处理器</span>
    <span class="c1">//6. 最后清空bean工厂中的元数据缓存</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="n">postProcessorNames</span> <span class="o">=</span>
            <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBeanNamesForType</span><span class="o">(</span><span class="nc">BeanFactoryPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>

    <span class="c1">// Separate between BeanFactoryPostProcessors that implement PriorityOrdered,</span>
    <span class="c1">// Ordered, and the rest.</span>
    <span class="c1">//将实现PriorityOrdered、Ordered和剩余部分的BeanFactoryPostProcessor分开</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">BeanFactoryPostProcessor</span><span class="o">&gt;</span> <span class="n">priorityOrderedPostProcessors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">orderedPostProcessorNames</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">nonOrderedPostProcessorNames</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">ppName</span> <span class="o">:</span> <span class="n">postProcessorNames</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">processedBeans</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">ppName</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// skip - already processed in first phase above</span>
            <span class="c1">//第一阶段处理过的直接跳过</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">isTypeMatch</span><span class="o">(</span><span class="n">ppName</span><span class="o">,</span> <span class="nc">PriorityOrdered</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">priorityOrderedPostProcessors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">ppName</span><span class="o">,</span> <span class="nc">BeanFactoryPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">isTypeMatch</span><span class="o">(</span><span class="n">ppName</span><span class="o">,</span> <span class="nc">Ordered</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">orderedPostProcessorNames</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ppName</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="n">nonOrderedPostProcessorNames</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ppName</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.</span>
    <span class="c1">//首先调用实现了PriorityOrdered接口的BeanFactoryPostProcessors</span>
    <span class="n">sortPostProcessors</span><span class="o">(</span><span class="n">priorityOrderedPostProcessors</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">);</span>
    <span class="n">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="n">priorityOrderedPostProcessors</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">);</span>

    <span class="c1">// Next, invoke the BeanFactoryPostProcessors that implement Ordered.</span>
    <span class="c1">//接着 调用实现了Ordered接口的BeanFactoryProcessors</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">BeanFactoryPostProcessor</span><span class="o">&gt;</span> <span class="n">orderedPostProcessors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">orderedPostProcessorNames</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">postProcessorName</span> <span class="o">:</span> <span class="n">orderedPostProcessorNames</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">orderedPostProcessors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">postProcessorName</span><span class="o">,</span> <span class="nc">BeanFactoryPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="n">sortPostProcessors</span><span class="o">(</span><span class="n">orderedPostProcessors</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">);</span>
    <span class="n">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="n">orderedPostProcessors</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">);</span>

    <span class="c1">// Finally, invoke all other BeanFactoryPostProcessors.</span>
    <span class="c1">//最后 调用所有剩下的BeanFactoryPostProcessor</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">BeanFactoryPostProcessor</span><span class="o">&gt;</span> <span class="n">nonOrderedPostProcessors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">nonOrderedPostProcessorNames</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">postProcessorName</span> <span class="o">:</span> <span class="n">nonOrderedPostProcessorNames</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">nonOrderedPostProcessors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">postProcessorName</span><span class="o">,</span> <span class="nc">BeanFactoryPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="n">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="n">nonOrderedPostProcessors</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">);</span>

    <span class="c1">// Clear cached merged bean definitions since the post-processors might have</span>
    <span class="c1">// modified the original metadata, e.g. replacing placeholders in values...</span>
    <span class="c1">//清除可能由于后置处理器修改原始元数据的缓存的合并bean定义</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">clearMetadataCache</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>
<p>我们就 <strong>invokeBeanFactoryPostProcessors</strong> 先总结一下:<br />
  看方法名,就是调用实现 <strong>BeanFactoryPostProcessor</strong> 接口的所有后置处理器,先看一下我们这里需要处理的后置处理器的类图,有些内部类不好合并就不展示了:</p>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/BeanFactoryPostProcessor.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="BeanFactoryPostProcessor类图" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/BeanFactoryPostProcessor.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">BeanFactoryPostProcessor类图</div>
    </a>
</center>
<p>  可见我们这里除了处理实现了BeanFactoryPostProcessor的后置处理器,还处理了实现BeanDefinitionRegistryPostProcessor的后置处理器,其实BeanDefinitionRegistryPostProcessor也是实现了BeanFactoryPostProcessor,从类图中可以看出.<br />
  那我们这里的逻辑就很清晰了,首先处理实现BeanDefinitionRegistryPostProcessor的后置处理器,通过postProcessBeanDefinitionRegistry回调方法,然后是处理实现了BeanFactoryPostProcessor的后置处理器,通过postProcessBeanFactory回调方法.每个后置处理器都有自己的逻辑,需具体分析.</p>

<blockquote>
  <p>invokeBeanFactoryPostProcessors小结</p>
</blockquote>

<p>前置处理逻辑:<br />
  判断当前bean工厂是否属于BeanDefinitionRegistry,不属于直接调用注册在上下文中的BeanFactoryPostProcessor,否则继续处理.<br />
  定义两个regularPostProcessors和registryProcessors分别存放两种后置处理器,肯定是要先执行子类BeanDefinitionRegistryPostProcessor
遍历上下文中的后置处理器,遇到BeanDefinitionRegistryPostProcessor直接执行postProcessBeanDefinitionRegistry回调并将其添加到registryProcessors集合中,遇到BeanFactoryPostProcessor则直接添加到regularPostProcessors集合中.  <br />
第一阶段处理BeanDefinitionRegistryPostProcessor:</p>
<ol>
  <li>首先从bean工厂已注册的bean定义中找到实现BeanDefinitionRegistryPostProcessor的bean<br />
目前只有一个就是ConfigurationClassPostProcessor, 我们再仔细想想这个是不是很眼熟,它又是在何时注册为bean定义的, 
前面我们其实介绍过就是在创建AnnotationConfigServletWebServerApplicationContext上下文构造时的AnnotatedBeanDefinitionReader中的AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry)方法,它会注册ConfigurationClassPostProcessor的bean定义到上下文中</li>
  <li>既然找到了ConfigurationClassPostProcessor,判断它是否实现了PriorityOrdered,实现了的话则通过getBean方法实例化该bean,并添加到currentRegistryProcessors集合中 getBean方法也是Spring中非常重要的方法,后面我们再介绍</li>
  <li>实例化完指定bean后将currentRegistryProcessors进行排序并将已经集合中的所有元素添加到registryProcessors集合中</li>
  <li>最重要的一步 执行所有的BeanDefinitionRegistryPostProcessor后置处理器的postProcessBeanDefinitionRegistry, 这里主要是执行ConfigurationClassPostProcessor的回调, 它的主要作用就是解析主函数 逻辑是非常重要的 后面我们慢慢分析</li>
  <li>执行完之后将currentRegistryProcessors清空</li>
  <li>再次按照步骤1-5的顺序 将所有BeanDefinitionRegistryPostProcessor的bean按照Ordered和默认顺序进行处理即可</li>
  <li>最后依次执行registryProcessors和regularPostProcessors中的所有后置处理器的postProcessBeanFactory方法</li>
</ol>

<p>第二阶段处理BeanFactoryPostProcessor,大致逻辑与处理BeanDefinitionRegistryPostProcessor类似:</p>
<ol>
  <li>首先从bean工厂的定义中找到实现BeanFactoryPostProcessor接口的所有bean定义</li>
  <li>接着定义三个集合 priorityOrderedPostProcessors、orderedPostProcessorNames、nonOrderedPostProcessorNames 分别存放实现了 PriorityOrdered、Ordered、默认顺序的bean
这里需要注意 只有实现了PriorityOrdered的bean才会立即实例化</li>
  <li>首先还是先调用实现了PriorityOrdered接口的后置处理器的postProcessBeanFactory接口</li>
  <li>接着先获取所有实现了Ordered接口的后置处理器的bean,接着调用postProcessBeanFactory接口</li>
  <li>按步骤4处理剩下的后置处理器</li>
  <li>最后清空bean工厂中的元数据缓存</li>
</ol>

<p>  下面我们来着重看下最重要的后置处理器 <strong>ConfigurationClassPostProcessor</strong> 它的作用是在启动时通过 <strong>postProcessBeanDefinitionRegistry</strong> 回调处理@Configuration修饰的类.
<strong>postProcessBeanDefinitionRegistry</strong> 回调源码如下:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Derive further bean definitions from the configuration classes in the registry.
 * 从在注册表中的配置类派生出进一步的bean定义
 */</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">postProcessBeanDefinitionRegistry</span><span class="o">(</span><span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//获取该注册表的哈希值 判断是否已经处理过 若处理过直接抛出异常 未处理则加入已注册集合registriesPostProcessed</span>
    <span class="kt">int</span> <span class="n">registryId</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">identityHashCode</span><span class="o">(</span><span class="n">registry</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">registriesPostProcessed</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">registryId</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span>
                <span class="s">"postProcessBeanDefinitionRegistry already called on this post-processor against "</span> <span class="o">+</span> <span class="n">registry</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">factoriesPostProcessed</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">registryId</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span>
                <span class="s">"postProcessBeanFactory already called on this post-processor against "</span> <span class="o">+</span> <span class="n">registry</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">this</span><span class="o">.</span><span class="na">registriesPostProcessed</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">registryId</span><span class="o">);</span>
    <span class="c1">//处理注册表中所有被@Configuration修饰的bean定义</span>
    <span class="n">processConfigBeanDefinitions</span><span class="o">(</span><span class="n">registry</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>
<p>可见回调中其实就做了两件事:</p>
<ol>
  <li>获取该注册表的hash值并判断是否处理过,若已处理则直接抛出异常,否则将此值添加到已注册结合registriesPostProcessed</li>
  <li>解析注册表中所有被@Configuration修饰的bean定义,这里就是配置类的最主要解析逻辑,解析见 <strong>SpringBoot启动源码解析(七)</strong></li>
</ol>

<p>6.第六步创建拦截bean创建的bean处理器,相关源码如下:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Instantiate and register all BeanPostProcessor beans,
 * respecting explicit order if given.
 * 实例化和注册所有的BeanPostProcessor的bean,如果给出,尊重明确的规则
 * &lt;p&gt;Must be called before any instantiation of application beans.
 * 必须在应用bean实例化之前被调用
 */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">registerBeanPostProcessors</span><span class="o">(</span><span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">PostProcessorRegistrationDelegate</span><span class="o">.</span><span class="na">registerBeanPostProcessors</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">//注册所有的BeanPostProcessor</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">registerBeanPostProcessors</span><span class="o">(</span>
        <span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">,</span> <span class="nc">AbstractApplicationContext</span> <span class="n">applicationContext</span><span class="o">)</span> <span class="o">{</span>

    <span class="c1">//1.获取所有的BeanPostProcessor的实现类</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="n">postProcessorNames</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBeanNamesForType</span><span class="o">(</span><span class="nc">BeanPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>

    <span class="c1">// Register BeanPostProcessorChecker that logs an info message when</span>
    <span class="c1">// a bean is created during BeanPostProcessor instantiation, i.e. when</span>
    <span class="c1">// a bean is not eligible for getting processed by all BeanPostProcessors.</span>
    <span class="c1">//2.注册BeanPostProcessorChecker,当bean在BeanPostProcessor实例化期间创建bean时记录信息</span>
    <span class="kt">int</span> <span class="n">beanProcessorTargetCount</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBeanPostProcessorCount</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">postProcessorNames</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">addBeanPostProcessor</span><span class="o">(</span><span class="k">new</span> <span class="nc">BeanPostProcessorChecker</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">,</span> <span class="n">beanProcessorTargetCount</span><span class="o">));</span>

    <span class="c1">// Separate between BeanPostProcessors that implement PriorityOrdered,</span>
    <span class="c1">// Ordered, and the rest.</span>
    <span class="c1">//3. 分开实现了PriorityOrdered、OrderedBeanPostProcessor和剩下的BeanPostProcessor</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">BeanPostProcessor</span><span class="o">&gt;</span> <span class="n">priorityOrderedPostProcessors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">BeanPostProcessor</span><span class="o">&gt;</span> <span class="n">internalPostProcessors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">orderedPostProcessorNames</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">nonOrderedPostProcessorNames</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="c1">//找出实现了PriorityOrdered、Ordered和剩下的接口 同时还有保存既实现了PriorityOrdered又属于MergedBeanDefinitionPostProcessor的类</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">ppName</span> <span class="o">:</span> <span class="n">postProcessorNames</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">isTypeMatch</span><span class="o">(</span><span class="n">ppName</span><span class="o">,</span> <span class="nc">PriorityOrdered</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">BeanPostProcessor</span> <span class="n">pp</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">ppName</span><span class="o">,</span> <span class="nc">BeanPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">priorityOrderedPostProcessors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">pp</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">pp</span> <span class="k">instanceof</span> <span class="nc">MergedBeanDefinitionPostProcessor</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">internalPostProcessors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">pp</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">isTypeMatch</span><span class="o">(</span><span class="n">ppName</span><span class="o">,</span> <span class="nc">Ordered</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">orderedPostProcessorNames</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ppName</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="n">nonOrderedPostProcessorNames</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ppName</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// First, register the BeanPostProcessors that implement PriorityOrdered.</span>
    <span class="c1">//4.首先注册实现了PriorityOrdered的BeanPostProcessor</span>
    <span class="n">sortPostProcessors</span><span class="o">(</span><span class="n">priorityOrderedPostProcessors</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">);</span>
    <span class="n">registerBeanPostProcessors</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">,</span> <span class="n">priorityOrderedPostProcessors</span><span class="o">);</span>

    <span class="c1">// Next, register the BeanPostProcessors that implement Ordered.</span>
    <span class="c1">//5.接下来 注册实现了ordered的BeanPostProcessor 同时记录属于MergedBeanDefinitionPostProcessor的类</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">BeanPostProcessor</span><span class="o">&gt;</span> <span class="n">orderedPostProcessors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">orderedPostProcessorNames</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">ppName</span> <span class="o">:</span> <span class="n">orderedPostProcessorNames</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">BeanPostProcessor</span> <span class="n">pp</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">ppName</span><span class="o">,</span> <span class="nc">BeanPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">orderedPostProcessors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">pp</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">pp</span> <span class="k">instanceof</span> <span class="nc">MergedBeanDefinitionPostProcessor</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">internalPostProcessors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">pp</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">sortPostProcessors</span><span class="o">(</span><span class="n">orderedPostProcessors</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">);</span>
    <span class="n">registerBeanPostProcessors</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">,</span> <span class="n">orderedPostProcessors</span><span class="o">);</span>

    <span class="c1">// Now, register all regular BeanPostProcessors.</span>
    <span class="c1">//6.最后注册所有常规的BeanPostProcessor 同时记录属于MergedBeanDefinitionPostProcessor的类</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">BeanPostProcessor</span><span class="o">&gt;</span> <span class="n">nonOrderedPostProcessors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">nonOrderedPostProcessorNames</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">ppName</span> <span class="o">:</span> <span class="n">nonOrderedPostProcessorNames</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">BeanPostProcessor</span> <span class="n">pp</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">ppName</span><span class="o">,</span> <span class="nc">BeanPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">nonOrderedPostProcessors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">pp</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">pp</span> <span class="k">instanceof</span> <span class="nc">MergedBeanDefinitionPostProcessor</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">internalPostProcessors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">pp</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">registerBeanPostProcessors</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">,</span> <span class="n">nonOrderedPostProcessors</span><span class="o">);</span>

    <span class="c1">// Finally, re-register all internal BeanPostProcessors.</span>
    <span class="c1">//7.最后重新注册所有内部的BeanPostProcessor 相当于后置处理器会移动到处理链的末尾</span>
    <span class="n">sortPostProcessors</span><span class="o">(</span><span class="n">internalPostProcessors</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">);</span>
    <span class="n">registerBeanPostProcessors</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">,</span> <span class="n">internalPostProcessors</span><span class="o">);</span>

    <span class="c1">// Re-register post-processor for detecting inner beans as ApplicationListeners,</span>
    <span class="c1">// moving it to the end of the processor chain (for picking up proxies etc).</span>
    <span class="c1">//8.重新注册后置处理器以将内部bean检测为ApplicationListeners,将其移动到处理器链的末尾</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">addBeanPostProcessor</span><span class="o">(</span><span class="k">new</span> <span class="nc">ApplicationListenerDetector</span><span class="o">(</span><span class="n">applicationContext</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  第六步注册bean后置处理器同第五步基本类似,总结如下:<br />
    6.1 首先找到bean工厂中所有BeanPostProcessor的实现类<br />
    6.2 首先统计原来bean工厂已注册的bean后置处理器的数量加上6.1找到的实现类数量并加上1,这个1对应BeanPostProcessorChecker,紧跟着就注册它,它的作用是当bean在BeanPostProcessor实例化期间创建bean时记录信息<br />
    6.3 根据实现了PriorityOrdered、Ordered和默认顺序的BeanPostProcessor进行分类,并同时找出既实现了MergedBeanDefinitionPostProcessor和PriorityOrdered的BeanPostProcessor<br />
    6.4 首先注册实现了PriorityOrdered的BeanPostProcessor<br />
    6.5 接下来注册实现了ordered的BeanPostProcessor,同时记录属于MergedBeanDefinitionPostProcessor的类<br />
    6.6 然后注册所有常规的BeanPostProcessor 同时记录属于MergedBeanDefinitionPostProcessor的类<br />
    6.7 后面重新注册所有实现了MergedBeanDefinitionPostProcessor的后置处理器,作用是这些后置处理器会移动到处理链的末尾<br />
    6.8 最后重新注册后置处理器以将内部bean检测为ApplicationListeners,将其移动到处理器链的末尾</p>

<p>7.为上下文初始化消息源,源码如下:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MESSAGE_SOURCE_BEAN_NAME</span> <span class="o">=</span> <span class="s">"messageSource"</span><span class="o">;</span>
<span class="cm">/**
 * Initialize the MessageSource.
 * 初始化消息源
 * Use parent's if none defined in this context.
 * 如果在上下文中没有定义则使用父类的
 */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initMessageSource</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">getBeanFactory</span><span class="o">();</span>
    <span class="c1">//判断当前bean工厂中是否包含messageSource的bean</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">containsLocalBean</span><span class="o">(</span><span class="no">MESSAGE_SOURCE_BEAN_NAME</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">messageSource</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="no">MESSAGE_SOURCE_BEAN_NAME</span><span class="o">,</span> <span class="nc">MessageSource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">// Make MessageSource aware of parent MessageSource.</span>
        <span class="c1">// 将父消息源设置到当前消息源中</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">parent</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">messageSource</span> <span class="k">instanceof</span> <span class="nc">HierarchicalMessageSource</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">HierarchicalMessageSource</span> <span class="n">hms</span> <span class="o">=</span> <span class="o">(</span><span class="nc">HierarchicalMessageSource</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">messageSource</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">hms</span><span class="o">.</span><span class="na">getParentMessageSource</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// Only set parent context as parent MessageSource if no parent MessageSource</span>
                <span class="c1">// registered already.</span>
                <span class="n">hms</span><span class="o">.</span><span class="na">setParentMessageSource</span><span class="o">(</span><span class="n">getInternalParentMessageSource</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Using MessageSource ["</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">messageSource</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="o">{</span>
        <span class="c1">//不存在则创建默认消息源并注册到bean工厂中</span>
        <span class="c1">// Use empty MessageSource to be able to accept getMessage calls.</span>
        <span class="c1">//使用空消息源来接受getMessage的调用</span>
        <span class="nc">DelegatingMessageSource</span> <span class="n">dms</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DelegatingMessageSource</span><span class="o">();</span>
        <span class="n">dms</span><span class="o">.</span><span class="na">setParentMessageSource</span><span class="o">(</span><span class="n">getInternalParentMessageSource</span><span class="o">());</span>
        <span class="k">this</span><span class="o">.</span><span class="na">messageSource</span> <span class="o">=</span> <span class="n">dms</span><span class="o">;</span>
        <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerSingleton</span><span class="o">(</span><span class="no">MESSAGE_SOURCE_BEAN_NAME</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">messageSource</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"No '"</span> <span class="o">+</span> <span class="no">MESSAGE_SOURCE_BEAN_NAME</span> <span class="o">+</span> <span class="s">"' bean, using ["</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">messageSource</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  代码比较清晰,查看bean工厂中是否包含messageSource的bean,存在则继续设置父类的消息源,不存在则创建默认消息源并注册到bean工厂中</p>

<p>8.为上下文初始化事件广播器,源码如下:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">APPLICATION_EVENT_MULTICASTER_BEAN_NAME</span> <span class="o">=</span> <span class="s">"applicationEventMulticaster"</span><span class="o">;</span>

<span class="cm">/**
 * Initialize the ApplicationEventMulticaster.
 * 初始化ApplicationEventMulticaster
 * Uses SimpleApplicationEventMulticaster if none defined in the context.
 * 如果在上下文中没有定义则使用SimpleApplicationEventMulticaster
 * @see org.springframework.context.event.SimpleApplicationEventMulticaster
 */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initApplicationEventMulticaster</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">getBeanFactory</span><span class="o">();</span>
    <span class="c1">//判断bean工厂中是否存在applicationEventMulticaster的bean</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">containsLocalBean</span><span class="o">(</span><span class="no">APPLICATION_EVENT_MULTICASTER_BEAN_NAME</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">//存在直接取出该bean赋值给applicationEventMulticaster</span>
        <span class="k">this</span><span class="o">.</span><span class="na">applicationEventMulticaster</span> <span class="o">=</span>
                <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="no">APPLICATION_EVENT_MULTICASTER_BEAN_NAME</span><span class="o">,</span> <span class="nc">ApplicationEventMulticaster</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Using ApplicationEventMulticaster ["</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">applicationEventMulticaster</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="o">{</span>
        <span class="c1">//不存在则创建SimpleApplicationEventMulticaster 并注册到bean工厂中</span>
        <span class="k">this</span><span class="o">.</span><span class="na">applicationEventMulticaster</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleApplicationEventMulticaster</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>
        <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerSingleton</span><span class="o">(</span><span class="no">APPLICATION_EVENT_MULTICASTER_BEAN_NAME</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">applicationEventMulticaster</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"No '"</span> <span class="o">+</span> <span class="no">APPLICATION_EVENT_MULTICASTER_BEAN_NAME</span> <span class="o">+</span> <span class="s">"' bean, using "</span> <span class="o">+</span>
                    <span class="s">"["</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">applicationEventMulticaster</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  可见逻辑和第七步类似,都是先判断上下文中是否存在applicationEventMulticaster,存在则直接赋值给applicationEventMulticaster,不存在则先进行初始化默认的广播器给applicationEventMulticaster,最后再向bean工厂注册这个广播器.</p>

<p>9.初始化特定上下文子类中的其他特殊bean,主要针对ServletWebServerApplicationContext上下文,源码如下:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onRefresh</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">//1.调用父类GenericWebApplicationContext的刷新方法 注册themeSource</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onRefresh</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">//2.创建tomcat服务</span>
        <span class="n">createWebServer</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationContextException</span><span class="o">(</span><span class="s">"Unable to start web server"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  可见此方法主要分为两步,第一步调用父类的刷新方法和第二步创建web服务,即tomcat.<br />
&amp;emsp 我们先来看看第一步主要做的了什么:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onRefresh</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">themeSource</span> <span class="o">=</span> <span class="nc">UiApplicationContextUtils</span><span class="o">.</span><span class="na">initThemeSource</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">THEME_SOURCE_BEAN_NAME</span> <span class="o">=</span> <span class="s">"themeSource"</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="nc">ThemeSource</span> <span class="nf">initThemeSource</span><span class="o">(</span><span class="nc">ApplicationContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//上文中是否包含主题来源</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">containsLocalBean</span><span class="o">(</span><span class="no">THEME_SOURCE_BEAN_NAME</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">//包含则获取获取该bean并判断是否需要谁知父类住主题来源并返回</span>
        <span class="nc">ThemeSource</span> <span class="n">themeSource</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="no">THEME_SOURCE_BEAN_NAME</span><span class="o">,</span> <span class="nc">ThemeSource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">// Make ThemeSource aware of parent ThemeSource.</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getParent</span><span class="o">()</span> <span class="k">instanceof</span> <span class="nc">ThemeSource</span> <span class="o">&amp;&amp;</span> <span class="n">themeSource</span> <span class="k">instanceof</span> <span class="nc">HierarchicalThemeSource</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">HierarchicalThemeSource</span> <span class="n">hts</span> <span class="o">=</span> <span class="o">(</span><span class="nc">HierarchicalThemeSource</span><span class="o">)</span> <span class="n">themeSource</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">hts</span><span class="o">.</span><span class="na">getParentThemeSource</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// Only set parent context as parent ThemeSource if no parent ThemeSource</span>
                <span class="c1">// registered already.</span>
                <span class="n">hts</span><span class="o">.</span><span class="na">setParentThemeSource</span><span class="o">((</span><span class="nc">ThemeSource</span><span class="o">)</span> <span class="n">context</span><span class="o">.</span><span class="na">getParent</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Using ThemeSource ["</span> <span class="o">+</span> <span class="n">themeSource</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">themeSource</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="o">{</span>
        <span class="c1">//不包含则初始化默认主题来源 并返回</span>
        <span class="c1">// Use default ThemeSource to be able to accept getTheme calls, either</span>
        <span class="c1">// delegating to parent context's default or to local ResourceBundleThemeSource.</span>
        <span class="nc">HierarchicalThemeSource</span> <span class="n">themeSource</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getParent</span><span class="o">()</span> <span class="k">instanceof</span> <span class="nc">ThemeSource</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">themeSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DelegatingThemeSource</span><span class="o">();</span>
            <span class="n">themeSource</span><span class="o">.</span><span class="na">setParentThemeSource</span><span class="o">((</span><span class="nc">ThemeSource</span><span class="o">)</span> <span class="n">context</span><span class="o">.</span><span class="na">getParent</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="n">themeSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ResourceBundleThemeSource</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Unable to locate ThemeSource with name '"</span> <span class="o">+</span> <span class="no">THEME_SOURCE_BEAN_NAME</span> <span class="o">+</span>
                    <span class="s">"': using default ["</span> <span class="o">+</span> <span class="n">themeSource</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">themeSource</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  看到这里就很好理解了,就是判断上下文中是否含有themeSource,有则对其父类进行设置,没有则进行初始化并返回.<br />
  我们再看第二步做了什么:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">createWebServer</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">WebServer</span> <span class="n">webServer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">webServer</span><span class="o">;</span>
    <span class="nc">ServletContext</span> <span class="n">servletContext</span> <span class="o">=</span> <span class="n">getServletContext</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">webServer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">servletContext</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//通过TomcatServletWebServerFactory创建tomcat服务</span>
        <span class="nc">ServletWebServerFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="n">getWebServerFactory</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">webServer</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getWebServer</span><span class="o">(</span><span class="n">getSelfInitializer</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">servletContext</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">getSelfInitializer</span><span class="o">().</span><span class="na">onStartup</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">catch</span> <span class="o">(</span><span class="nc">ServletException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationContextException</span><span class="o">(</span><span class="s">"Cannot initialize servlet context"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">initPropertySources</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  这里最重要的就是factory.getWebServer,通过TomcatServletWebServerFactory工厂创建tomcat服务.具体细节待分析,有兴趣可以自己看看.<br />
  第九步主要就是创建themeSource和创建并启动tomcat服务.</p>

<p>10.检查监听器并注册他们,相关源码如下:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Add beans that implement ApplicationListener as listeners.
 * 添加实现了ApplicationListener的bean作为监听者
 * Doesn't affect other listeners, which can be added without being beans.
 * 不影响其他监听器,可以不加bean
 */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">registerListeners</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// Register statically specified listeners first.</span>
    <span class="c1">//首先注册静态的指定的监听器</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">ApplicationListener</span><span class="o">&lt;?&gt;</span> <span class="n">listener</span> <span class="o">:</span> <span class="n">getApplicationListeners</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">getApplicationEventMulticaster</span><span class="o">().</span><span class="na">addApplicationListener</span><span class="o">(</span><span class="n">listener</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// Do not initialize FactoryBeans here: We need to leave all regular beans</span>
    <span class="c1">// uninitialized to let post-processors apply to them!</span>
    <span class="c1">//这里不用初始化工厂bean:我们需要让所有常规的bean不初始化 让 后置处理器应用他们</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="n">listenerBeanNames</span> <span class="o">=</span> <span class="n">getBeanNamesForType</span><span class="o">(</span><span class="nc">ApplicationListener</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">listenerBeanName</span> <span class="o">:</span> <span class="n">listenerBeanNames</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">getApplicationEventMulticaster</span><span class="o">().</span><span class="na">addApplicationListenerBean</span><span class="o">(</span><span class="n">listenerBeanName</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// Publish early application events now that we finally have a multicaster...</span>
    <span class="c1">// 发布 我们最终拥有广播器的早期事件</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">ApplicationEvent</span><span class="o">&gt;</span> <span class="n">earlyEventsToProcess</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">earlyApplicationEvents</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">earlyApplicationEvents</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">earlyEventsToProcess</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">ApplicationEvent</span> <span class="n">earlyEvent</span> <span class="o">:</span> <span class="n">earlyEventsToProcess</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">getApplicationEventMulticaster</span><span class="o">().</span><span class="na">multicastEvent</span><span class="o">(</span><span class="n">earlyEvent</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  这段代码比较容易理解,首先看下 <strong>getApplicationListeners())</strong> 就是获取在构造函数中获取的所有ApplicationListener子类并将他们加入到事件广播器中.
然后就是获取bean工厂中所有ApplicationListener类型的bean名称,并添加到事件广播器中.最后就是通过事件广播器发送早期事件,早期事件为空所以不做处理.</p>

<p>11.初始化剩下的所有非懒加载的单例,源码如下:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Finish the initialization of this context's bean factory,
 * initializing all remaining singleton beans.
 * 完成上下文bean工厂的初始化,初始化所有剩下的单例bean
 */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">finishBeanFactoryInitialization</span><span class="o">(</span><span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Initialize conversion service for this context.</span>
    <span class="c1">// 1.为上下文初始化转换服务</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">containsBean</span><span class="o">(</span><span class="no">CONVERSION_SERVICE_BEAN_NAME</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
            <span class="n">beanFactory</span><span class="o">.</span><span class="na">isTypeMatch</span><span class="o">(</span><span class="no">CONVERSION_SERVICE_BEAN_NAME</span><span class="o">,</span> <span class="nc">ConversionService</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">beanFactory</span><span class="o">.</span><span class="na">setConversionService</span><span class="o">(</span>
                <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="no">CONVERSION_SERVICE_BEAN_NAME</span><span class="o">,</span> <span class="nc">ConversionService</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">// Register a default embedded value resolver if no bean post-processor</span>
    <span class="c1">// (such as a PropertyPlaceholderConfigurer bean) registered any before:</span>
    <span class="c1">// at this point, primarily for resolution in annotation attribute values.</span>
    <span class="c1">//注册一个默认的内嵌值间解析器如果没有bean后置处理器注册过(像 PropertyPlaceholderConfigurer)</span>
    <span class="c1">//在此时, 主要用于注解属性值的解析</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">hasEmbeddedValueResolver</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">beanFactory</span><span class="o">.</span><span class="na">addEmbeddedValueResolver</span><span class="o">(</span><span class="n">strVal</span> <span class="o">-&gt;</span> <span class="n">getEnvironment</span><span class="o">().</span><span class="na">resolvePlaceholders</span><span class="o">(</span><span class="n">strVal</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">// Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.</span>
    <span class="c1">// 尽早初始化LoadTimeWeaverAware以允许尽早注册他们的转换器</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="n">weaverAwareNames</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBeanNamesForType</span><span class="o">(</span><span class="nc">LoadTimeWeaverAware</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">weaverAwareName</span> <span class="o">:</span> <span class="n">weaverAwareNames</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">getBean</span><span class="o">(</span><span class="n">weaverAwareName</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// Stop using the temporary ClassLoader for type matching.</span>
    <span class="c1">// 2.停止使用临时类加载器进行类型匹配</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">setTempClassLoader</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

    <span class="c1">// Allow for caching all bean definition metadata, not expecting further changes.</span>
    <span class="c1">//允许缓存所有的bean定义元数据,不希望有进一步的修改</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">freezeConfiguration</span><span class="o">();</span>

    <span class="c1">// Instantiate all remaining (non-lazy-init) singletons.</span>
    <span class="c1">// 3.初始化所有剩下 非懒加载的单例</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">preInstantiateSingletons</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  可见第十一步可以分为以下三步,首先是判断bean工厂中是否包含conversionService的bean,有则设置到bean工厂中;设置StringValueResolver为内置的解析器;初始化bean工厂中所有实现LoadTimeWeaverAware的bean,以上就是第一步所做的事,可以理解为前置检查.<br />
  第二步就是 <strong>setTempClassLoader和freezeConfiguration</strong> 看方法名称就可以明白了,主要就是停止使用临时类加载器并冻结已经加载好的beanDefinitionNames.<br />
  第三步就也是最重要的一步了,它就是初始化所有剩下的单例bean的关键所在.源码如下:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">preInstantiateSingletons</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Pre-instantiating singletons in "</span> <span class="o">+</span> <span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// Iterate over a copy to allow for init methods which in turn register new bean definitions.</span>
    <span class="c1">// 迭代一个副本以允许初始化方法依次注册新的bean定义</span>
    <span class="c1">// While this may not be part of the regular factory bootstrap, it does otherwise work fine.</span>
    <span class="c1">//尽管这可能不是常规工厂启动的一部分,但是他工作的很好</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">beanNames</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="k">this</span><span class="o">.</span><span class="na">beanDefinitionNames</span><span class="o">);</span>

    <span class="c1">// Trigger initialization of all non-lazy singleton beans...</span>
    <span class="c1">//触发所有的非单例bean的初始化</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span> <span class="o">:</span> <span class="n">beanNames</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">RootBeanDefinition</span> <span class="n">bd</span> <span class="o">=</span> <span class="n">getMergedLocalBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">bd</span><span class="o">.</span><span class="na">isAbstract</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">bd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bd</span><span class="o">.</span><span class="na">isLazyInit</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">isFactoryBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
                <span class="nc">Object</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">getBean</span><span class="o">(</span><span class="no">FACTORY_BEAN_PREFIX</span> <span class="o">+</span> <span class="n">beanName</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">bean</span> <span class="k">instanceof</span> <span class="nc">FactoryBean</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kd">final</span> <span class="nc">FactoryBean</span><span class="o">&lt;?&gt;</span> <span class="n">factory</span> <span class="o">=</span> <span class="o">(</span><span class="nc">FactoryBean</span><span class="o">&lt;?&gt;)</span> <span class="n">bean</span><span class="o">;</span>
                    <span class="kt">boolean</span> <span class="n">isEagerInit</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">factory</span> <span class="k">instanceof</span> <span class="nc">SmartFactoryBean</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">isEagerInit</span> <span class="o">=</span> <span class="nc">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">((</span><span class="nc">PrivilegedAction</span><span class="o">&lt;</span><span class="nc">Boolean</span><span class="o">&gt;)</span>
                                        <span class="o">((</span><span class="nc">SmartFactoryBean</span><span class="o">&lt;?&gt;)</span> <span class="n">factory</span><span class="o">)::</span><span class="n">isEagerInit</span><span class="o">,</span>
                                <span class="n">getAccessControlContext</span><span class="o">());</span>
                    <span class="o">}</span>
                    <span class="k">else</span> <span class="o">{</span>
                        <span class="n">isEagerInit</span> <span class="o">=</span> <span class="o">(</span><span class="n">factory</span> <span class="k">instanceof</span> <span class="nc">SmartFactoryBean</span> <span class="o">&amp;&amp;</span>
                                <span class="o">((</span><span class="nc">SmartFactoryBean</span><span class="o">&lt;?&gt;)</span> <span class="n">factory</span><span class="o">).</span><span class="na">isEagerInit</span><span class="o">());</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">isEagerInit</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">getBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="n">getBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// Trigger post-initialization callback for all applicable beans...</span>
    <span class="c1">//为所有的初始化bean触发初始化后回调</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span> <span class="o">:</span> <span class="n">beanNames</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Object</span> <span class="n">singletonInstance</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">singletonInstance</span> <span class="k">instanceof</span> <span class="nc">SmartInitializingSingleton</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">SmartInitializingSingleton</span> <span class="n">smartSingleton</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SmartInitializingSingleton</span><span class="o">)</span> <span class="n">singletonInstance</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">((</span><span class="nc">PrivilegedAction</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;)</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="n">smartSingleton</span><span class="o">.</span><span class="na">afterSingletonsInstantiated</span><span class="o">();</span>
                    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                <span class="o">},</span> <span class="n">getAccessControlContext</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="n">smartSingleton</span><span class="o">.</span><span class="na">afterSingletonsInstantiated</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  现在再看这个代码,逻辑一目了然,首先获取bean工厂中的所有beanNames,然后遍历这个beanNames,挑选出非抽象的且是单例且是非懒加载的调用 <strong>getBean()</strong> 进行初始化,最后找到所有实现了SmartInitializingSingleton接口触发初始化回调完成初始化.</p>

<p>12.最后一步发布相关事件,发布完成即应用启动成功,相关源码如下:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">finishRefresh</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">//1.调用父类AbstractApplicationContext的finishRefresh</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">finishRefresh</span><span class="o">();</span>
    <span class="c1">//2.启动tomcat服务并发布服务初始化完成事件</span>
    <span class="nc">WebServer</span> <span class="n">webServer</span> <span class="o">=</span> <span class="n">startWebServer</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">webServer</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">publishEvent</span><span class="o">(</span><span class="k">new</span> <span class="nc">ServletWebServerInitializedEvent</span><span class="o">(</span><span class="n">webServer</span><span class="o">,</span> <span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  可见最后一步可以分为两步,调用父类的完成刷新方法和启动tomcat服务并发布服务初始化完成事件.<br />
  我们先来看下父类的完成刷新做了什么:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Finish the refresh of this context, invoking the LifecycleProcessor's
 * onRefresh() method and publishing the
 * {@link org.springframework.context.event.ContextRefreshedEvent}.
 * 完成上下文的刷新,调用LifecycleProcessor的onRefresh方法 且 发布ContextRefreshedEvent事件
 */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">finishRefresh</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// Clear context-level resource caches (such as ASM metadata from scanning).</span>
    <span class="c1">//清除上下文级别的资源缓存</span>
    <span class="n">clearResourceCaches</span><span class="o">();</span>

    <span class="c1">// Initialize lifecycle processor for this context.</span>
    <span class="c1">//为上下文初始化生命周期处理器</span>
    <span class="n">initLifecycleProcessor</span><span class="o">();</span>

    <span class="c1">// Propagate refresh to lifecycle processor first.</span>
    <span class="c1">//首先将刷新传播到生命周期处理器中</span>
    <span class="n">getLifecycleProcessor</span><span class="o">().</span><span class="na">onRefresh</span><span class="o">();</span>

    <span class="c1">// Publish the final event.</span>
    <span class="c1">//发布最终完成事件</span>
    <span class="n">publishEvent</span><span class="o">(</span><span class="k">new</span> <span class="nc">ContextRefreshedEvent</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>

    <span class="c1">// Participate in LiveBeansView MBean, if active.</span>
    <span class="c1">// 如果激活的话 参与 LiveBeansView MBean</span>
    <span class="nc">LiveBeansView</span><span class="o">.</span><span class="na">registerApplicationContext</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>
<p>  主要就是清除上下文资源缓存,初始化生命周期处理器并刷新它,最后发布上下已刷新事件并尝试注册LiveBeansView.</p>

<hr />

<h3 id="refreshcontext总结">refreshContext总结</h3>
<hr />
<ol>
  <li>为刷新做准备,主要是设置启动状态及一些属性的初始化</li>
  <li>通知子类刷新内部bean工厂并返回,主要是设置bean工厂序列化id,即应用的上下文</li>
  <li>准备在此上下文中使用的bean工厂,主要设置bean工厂的通用功能</li>
  <li>允许在上下文子类中对bean工厂进行后置处理,主要是注册相关后置处理器及应用范围</li>
  <li>调用在上下文中注册为bean的工厂处理器,即所有实现的BeanDefinitionRegistryPostProcessor和BeanFactoryPostProcessor接口的后置处理器,首先解析实现了BeanDefinitionRegistryPostProcessor接口的postProcessBeanDefinitionRegistry方法.其次根据PriorityOrdered、Ordered和默认这三个顺序解析实现了BeanFactoryPostProcessor接口的postProcessBeanFactory方法.
这里最重要的要数实现了BeanDefinitionRegistryPostProcessor接口的ConfigurationClassPostProcessor类,它是解析SpringBoot启动类的关键.</li>
  <li>注册拦截bean创建的后置处理器,主要是找到实现了BeanPostProcessor接口的类初始化并注册</li>
  <li>初始化此上下文的消息源,初始化DelegatingMessageSource并注册messageSource到bean工厂中</li>
  <li>为上下文初始化事件多播器,初始化SimpleApplicationEventMulticaster并注册applicationEventMulticaster到bean工厂中</li>
  <li>初始化特定上下文子类中的其他特殊bean,初始化上下文中的themeSource和其内嵌的tomcat</li>
  <li>检查监听器bean并注册他们,将所有实现了ApplicationListener接口的bean注册到第八步创建的事件广播器中并尝试发布事件</li>
  <li>实例化所有剩余的非延迟初始化单例,设置bean工厂相关属性并冻结其bean名称,最后实例化所有剩余的非延迟单例</li>
  <li>完成此上下文的刷新,调用LifecycleProcessor的onRefresh()方法并发布上下文已刷新事件</li>
  <li>最后清除启动过程中的缓存
    <hr />
  </li>
</ol>

</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">SpringBoot</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">Septemper 2021</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">SpringBoot</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-20000005" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2>SpringBoot启动源码解析(五)</h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/pexels-pok-rie-136728.jpg" class="img-responsive img-centered" alt="SpringBoot">

                            
                                <h3>SpringBootApplication Run方法解析(三):prepareContext</h3>
                            
                            </div>

                            <p><h3 id="run方法入口">Run方法入口</h3>
<hr />
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Run the Spring application, creating and refreshing a new
 * {@link ApplicationContext}.
 * 运行Spring应用，创建和刷新一个新的应用上下文
 * @param args the application arguments (usually passed from a Java main method)
 * @return a running {@link ApplicationContext}
 */</span>
<span class="kd">public</span> <span class="nc">ConfigurableApplicationContext</span> <span class="nf">run</span><span class="o">(</span><span class="nc">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//1.创建启动计时器</span>
    <span class="nc">StopWatch</span> <span class="n">stopWatch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StopWatch</span><span class="o">();</span>
    <span class="n">stopWatch</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="c1">//创建启动上下文并初始化相应的Bootstrapper 目前暂未使用</span>
    <span class="nc">ConfigurableApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">SpringBootExceptionReporter</span><span class="o">&gt;</span> <span class="n">exceptionReporters</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="c1">//设置系统的配置模式，一般用于服务端开发 默认为true</span>
    <span class="n">configureHeadlessProperty</span><span class="o">();</span>
    <span class="c1">//获取spring上下文启动监听者  从META-INF/spring.factories中获取SpringApplicationRunListener的实现类并加载</span>
    <span class="nc">SpringApplicationRunListeners</span> <span class="n">listeners</span> <span class="o">=</span> <span class="n">getRunListeners</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
    <span class="c1">//发布启动中事件</span>
    <span class="n">listeners</span><span class="o">.</span><span class="na">starting</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">//2.创建默认上下文参数</span>
        <span class="nc">ApplicationArguments</span> <span class="n">applicationArguments</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultApplicationArguments</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
        <span class="c1">//3.准备环境，将资源属性添加到环境中并与上下文绑定</span>
        <span class="nc">ConfigurableEnvironment</span> <span class="n">environment</span> <span class="o">=</span> <span class="n">prepareEnvironment</span><span class="o">(</span><span class="n">listeners</span><span class="o">,</span> <span class="n">applicationArguments</span><span class="o">);</span>
        <span class="c1">//设置spring.beaninfo.ignore中过滤的bean</span>
        <span class="n">configureIgnoreBeanInfo</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
        <span class="c1">//打印spring标记</span>
        <span class="nc">Banner</span> <span class="n">printedBanner</span> <span class="o">=</span> <span class="n">printBanner</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
        <span class="c1">//4.根据web应用类型创建指定的应用上下文</span>
        <span class="c1">//注意:这里反射创建AnnotationConfigServletWebServerApplicationContext时,构造中创建AnnotatedBeanDefinitionReader中的AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry)方法很重要</span>
        <span class="c1">//它将几个常见的BeanPostProcessor和BeanFactoryPostProcessor注册到注册表中  最重要的是internalConfigurationAnnotationProcessor来解析Configuration的配置类</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">createApplicationContext</span><span class="o">();</span>
        <span class="n">exceptionReporters</span> <span class="o">=</span> <span class="n">getSpringFactoriesInstances</span><span class="o">(</span><span class="nc">SpringBootExceptionReporter</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                <span class="k">new</span> <span class="nc">Class</span><span class="o">[]</span> <span class="o">{</span> <span class="nc">ConfigurableApplicationContext</span><span class="o">.</span><span class="na">class</span> <span class="o">},</span> <span class="n">context</span><span class="o">);</span>
        <span class="c1">//5.准备上下文</span>
        <span class="c1">//主要做了两件事:</span>
        <span class="c1">// 1.调用前面实例化的ApplicationContextInitializer的initialize方式初始化上下文</span>
        <span class="c1">// 2.在其中的load方法中将启动主函数bean定义注册到注册表中 beanDefinitionMap</span>
        <span class="n">prepareContext</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">environment</span><span class="o">,</span> <span class="n">listeners</span><span class="o">,</span> <span class="n">applicationArguments</span><span class="o">,</span> <span class="n">printedBanner</span><span class="o">);</span>
        <span class="c1">//6.刷新上下文</span>
        <span class="n">refreshContext</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
        <span class="n">afterRefresh</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">applicationArguments</span><span class="o">);</span>
        <span class="n">stopWatch</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">logStartupInfo</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">new</span> <span class="nf">StartupInfoLogger</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mainApplicationClass</span><span class="o">).</span><span class="na">logStarted</span><span class="o">(</span><span class="n">getApplicationLog</span><span class="o">(),</span> <span class="n">stopWatch</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">//监听者发布已启动事件</span>
        <span class="n">listeners</span><span class="o">.</span><span class="na">started</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
        <span class="c1">//7.调用所有的ApplicationRunner和CommandLineRunner的实现类</span>
        <span class="n">callRunners</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">applicationArguments</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">handleRunFailure</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">ex</span><span class="o">,</span> <span class="n">exceptionReporters</span><span class="o">,</span> <span class="n">listeners</span><span class="o">);</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">//监听者发布运行中事件</span>
        <span class="n">listeners</span><span class="o">.</span><span class="na">running</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">handleRunFailure</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">ex</span><span class="o">,</span> <span class="n">exceptionReporters</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">context</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<hr />

<h3 id="preparecontext">prepareContext</h3>
<hr />
<p>本篇我们一起来看下 <strong>prepareContext</strong> 方法主要做了什么:<br />
第五步主要就是根据前面创建的 <strong>environment、listeners、applicationArguments、printedBanner</strong> 参数准备创建的上下文 <strong>context</strong> ,相关源码如下:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">prepareContext</span><span class="o">(</span><span class="nc">ConfigurableApplicationContext</span> <span class="n">context</span><span class="o">,</span> <span class="nc">ConfigurableEnvironment</span> <span class="n">environment</span><span class="o">,</span>
        <span class="nc">SpringApplicationRunListeners</span> <span class="n">listeners</span><span class="o">,</span> <span class="nc">ApplicationArguments</span> <span class="n">applicationArguments</span><span class="o">,</span> <span class="nc">Banner</span> <span class="n">printedBanner</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//5.1为上下文设置environment</span>
    <span class="n">context</span><span class="o">.</span><span class="na">setEnvironment</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
    <span class="c1">//处理任何相关的后置处理,主要是设置 beanNameGenerator、resourceLoader、addConversionService</span>
    <span class="n">postProcessApplicationContext</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="c1">//5.2应用所有在构造函数阶段初始化的ApplicationContextInitializer</span>
    <span class="n">applyInitializers</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="c1">//5.3发布环境已准备事件</span>
    <span class="n">listeners</span><span class="o">.</span><span class="na">contextPrepared</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="c1">//5.4打印启动信息</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">logStartupInfo</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logStartupInfo</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getParent</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">);</span>
        <span class="n">logStartupProfileInfo</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// Add boot specific singleton beans</span>
    <span class="c1">//向bean工厂中注册springApplicationArguments和springBootBanner 两个单例</span>
    <span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBeanFactory</span><span class="o">();</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerSingleton</span><span class="o">(</span><span class="s">"springApplicationArguments"</span><span class="o">,</span> <span class="n">applicationArguments</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">printedBanner</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerSingleton</span><span class="o">(</span><span class="s">"springBootBanner"</span><span class="o">,</span> <span class="n">printedBanner</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//设置是否允许bean定义被覆盖,默认为false</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">beanFactory</span> <span class="k">instanceof</span> <span class="nc">DefaultListableBeanFactory</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">((</span><span class="nc">DefaultListableBeanFactory</span><span class="o">)</span> <span class="n">beanFactory</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setAllowBeanDefinitionOverriding</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">allowBeanDefinitionOverriding</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//如果应用设置为懒加载则添加懒加载后置处理器, 默认为false不用添加</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">lazyInitialization</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">context</span><span class="o">.</span><span class="na">addBeanFactoryPostProcessor</span><span class="o">(</span><span class="k">new</span> <span class="nc">LazyInitializationBeanFactoryPostProcessor</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="c1">// Load the sources</span>
    <span class="c1">//5.5加载资源,这里其实就是换的启动函数,并将它注册为bean</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">sources</span> <span class="o">=</span> <span class="n">getAllSources</span><span class="o">();</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">notEmpty</span><span class="o">(</span><span class="n">sources</span><span class="o">,</span> <span class="s">"Sources must not be empty"</span><span class="o">);</span>
    <span class="n">load</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">sources</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">]));</span>
    <span class="c1">//5.6发布上下文已加载事件</span>
    <span class="n">listeners</span><span class="o">.</span><span class="na">contextLoaded</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>5.1 首先看第一步相关的源码</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Delegates given environment to underlying {@link AnnotatedBeanDefinitionReader} and
 * {@link ClassPathBeanDefinitionScanner} members.
 * 委托给定的环境给底层的AnnotatedBeanDefinitionReader和ClassPathBeanDefinitionScanner成员
 */</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEnvironment</span><span class="o">(</span><span class="nc">ConfigurableEnvironment</span> <span class="n">environment</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">setEnvironment</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">reader</span><span class="o">.</span><span class="na">setEnvironment</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">scanner</span><span class="o">.</span><span class="na">setEnvironment</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
<span class="o">}</span>

<span class="cm">/**
 * Apply any relevant post processing the {@link ApplicationContext}. Subclasses can
 * apply additional processing as required.
 * 应用相关的后处理应用上下文. 子类可以根据需要应用额外的处理
 */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">postProcessApplicationContext</span><span class="o">(</span><span class="nc">ConfigurableApplicationContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//如果应用中存在beanNameGenerator则注册internalConfigurationBeanNameGenerator bean定义</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">beanNameGenerator</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">context</span><span class="o">.</span><span class="na">getBeanFactory</span><span class="o">().</span><span class="na">registerSingleton</span><span class="o">(</span><span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">CONFIGURATION_BEAN_NAME_GENERATOR</span><span class="o">,</span>
                <span class="k">this</span><span class="o">.</span><span class="na">beanNameGenerator</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//如果存在资源加载器则设置到上下文中</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">context</span> <span class="k">instanceof</span> <span class="nc">GenericApplicationContext</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">((</span><span class="nc">GenericApplicationContext</span><span class="o">)</span> <span class="n">context</span><span class="o">).</span><span class="na">setResourceLoader</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">context</span> <span class="k">instanceof</span> <span class="nc">DefaultResourceLoader</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">((</span><span class="nc">DefaultResourceLoader</span><span class="o">)</span> <span class="n">context</span><span class="o">).</span><span class="na">setClassLoader</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">//如果addConversionService为true表明需要设置类型转换服务</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">addConversionService</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">context</span><span class="o">.</span><span class="na">getBeanFactory</span><span class="o">().</span><span class="na">setConversionService</span><span class="o">(</span><span class="nc">ApplicationConversionService</span><span class="o">.</span><span class="na">getSharedInstance</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>首先看 <strong>setEnvironment</strong> 方法,其中两个成员是不是很熟悉, 就是在初始化 <strong>AnnotationConfigServletWebServerApplicationContext</strong> 上下文时创建的成员类,那么本方法也比较通俗易懂了,无非就是设置环境信息.<br />
然后我们再看 <strong>postProcessApplicationContext</strong> ,它的主要作用就是设置了 <strong>ConversionService</strong> 服务.</p>

<p>5.2 第二步就是应用所有 <strong>ApplicationContextInitializer</strong> ,相关源码如下:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Apply any {@link ApplicationContextInitializer}s to the context before it is
 * refreshed.
 * 在应用刷新前应用所有ApplicationContextInitializer到上下文中
 */</span>
<span class="nd">@SuppressWarnings</span><span class="o">({</span> <span class="s">"rawtypes"</span><span class="o">,</span> <span class="s">"unchecked"</span> <span class="o">})</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">applyInitializers</span><span class="o">(</span><span class="nc">ConfigurableApplicationContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">ApplicationContextInitializer</span> <span class="n">initializer</span> <span class="o">:</span> <span class="n">getInitializers</span><span class="o">())</span> <span class="o">{</span>
        <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">requiredType</span> <span class="o">=</span> <span class="nc">GenericTypeResolver</span><span class="o">.</span><span class="na">resolveTypeArgument</span><span class="o">(</span><span class="n">initializer</span><span class="o">.</span><span class="na">getClass</span><span class="o">(),</span>
                <span class="nc">ApplicationContextInitializer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">Assert</span><span class="o">.</span><span class="na">isInstanceOf</span><span class="o">(</span><span class="n">requiredType</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="s">"Unable to call initializer."</span><span class="o">);</span>
        <span class="n">initializer</span><span class="o">.</span><span class="na">initialize</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>第二步就是在获取所有在 <strong>SpringApplication</strong> 构造函数中初始化的 <strong>ApplicationContextInitializer</strong> ,并执行他们各自实现的 <strong>initialize()</strong> 方法,如果我们自定义 <strong>ApplicationContextInitializer</strong> 的话,也是在此处执行我们的类.</p>

<p>5.3 第三步发布上下文准备完成事件</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">contextPrepared</span><span class="o">(</span><span class="nc">ConfigurableApplicationContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">SpringApplicationRunListener</span> <span class="n">listener</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">listeners</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">listener</span><span class="o">.</span><span class="na">contextPrepared</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>5.4 第四步主要是执行一些上下文的准备动作,打印日志以及注册相关bean定义等.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">logStartupInfo</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">logStartupInfo</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getParent</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">);</span>
    <span class="n">logStartupProfileInfo</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">// Add boot specific singleton beans</span>
<span class="c1">//向bean工厂中注册springApplicationArguments和springBootBanner 两个单例</span>
<span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBeanFactory</span><span class="o">();</span>
<span class="n">beanFactory</span><span class="o">.</span><span class="na">registerSingleton</span><span class="o">(</span><span class="s">"springApplicationArguments"</span><span class="o">,</span> <span class="n">applicationArguments</span><span class="o">);</span>
<span class="k">if</span> <span class="o">(</span><span class="n">printedBanner</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerSingleton</span><span class="o">(</span><span class="s">"springBootBanner"</span><span class="o">,</span> <span class="n">printedBanner</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">//设置是否允许bean定义被覆盖,默认为false</span>
<span class="k">if</span> <span class="o">(</span><span class="n">beanFactory</span> <span class="k">instanceof</span> <span class="nc">DefaultListableBeanFactory</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">((</span><span class="nc">DefaultListableBeanFactory</span><span class="o">)</span> <span class="n">beanFactory</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setAllowBeanDefinitionOverriding</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">allowBeanDefinitionOverriding</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">//如果应用设置为懒加载则添加懒加载后置处理器, 默认为false不用添加</span>
<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">lazyInitialization</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">context</span><span class="o">.</span><span class="na">addBeanFactoryPostProcessor</span><span class="o">(</span><span class="k">new</span> <span class="nc">LazyInitializationBeanFactoryPostProcessor</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div>
<p>主要就是向bean工厂中注册 <strong>springApplicationArguments、springBootBanner</strong> bean定义以及设置 <strong>allowBeanDefinitionOverriding</strong> 属性.</p>

<p>5.5 第五步是本章最重要的部分,即以主函数创建bean定义并注册到bean工厂中</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Load the sources</span>
<span class="c1">//5.5加载资源,这里其实就是换的启动函数,并将它注册为bean</span>
<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">sources</span> <span class="o">=</span> <span class="n">getAllSources</span><span class="o">();</span>
<span class="nc">Assert</span><span class="o">.</span><span class="na">notEmpty</span><span class="o">(</span><span class="n">sources</span><span class="o">,</span> <span class="s">"Sources must not be empty"</span><span class="o">);</span>
<span class="n">load</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">sources</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">]));</span>
</code></pre></div></div>

<p>第五步其实就分为两个方法,获取主函数 <strong>getAllSources</strong> 并加载该主函数 <strong>load</strong> . 
5.5.1 首先我们来看一下获取主函数 <strong>getAllSources</strong>:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Return an immutable set of all the sources that will be added to an
 * ApplicationContext when {@link #run(String...)} is called. This method combines any
 * primary sources specified in the constructor with any additional ones that have
 * been {@link #setSources(Set) explicitly set}.
 * 当调用run时, 返回将应用上下文的所有源的不可变集合. 
 * 此方法将构造函数中指定的任何主要来源与已显示设置的任何其他来源结合起来
 */</span>
<span class="kd">public</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">getAllSources</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">allSources</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;();</span>
    <span class="c1">//这个primarySources就是我们的主函数</span>
    <span class="k">if</span> <span class="o">(!</span><span class="nc">CollectionUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">primarySources</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">allSources</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">primarySources</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(!</span><span class="nc">CollectionUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">sources</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">allSources</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">sources</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">unmodifiableSet</span><span class="o">(</span><span class="n">allSources</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>
<p>该方法作用就是返回主函数的不可变集合.</p>

<p>5.5.2接下来我们再看看最核心的加载方法 <strong>load</strong> :</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Load beans into the application context.
 * 加载bean到应用上下文中
 */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">load</span><span class="o">(</span><span class="nc">ApplicationContext</span> <span class="n">context</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">sources</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Loading source "</span> <span class="o">+</span> <span class="nc">StringUtils</span><span class="o">.</span><span class="na">arrayToCommaDelimitedString</span><span class="o">(</span><span class="n">sources</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="c1">//根据主函数常创建BeanDefinitionLoader,BeanDefinitionLoader的作用是注册bean定义</span>
    <span class="nc">BeanDefinitionLoader</span> <span class="n">loader</span> <span class="o">=</span> <span class="n">createBeanDefinitionLoader</span><span class="o">(</span><span class="n">getBeanDefinitionRegistry</span><span class="o">(</span><span class="n">context</span><span class="o">),</span> <span class="n">sources</span><span class="o">);</span>
    <span class="c1">//设置loader相关的属性</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">beanNameGenerator</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">loader</span><span class="o">.</span><span class="na">setBeanNameGenerator</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">beanNameGenerator</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">loader</span><span class="o">.</span><span class="na">setResourceLoader</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">environment</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">loader</span><span class="o">.</span><span class="na">setEnvironment</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//注册bean定义</span>
    <span class="n">loader</span><span class="o">.</span><span class="na">load</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>
<p>可见load方法中又可以分为两步,根据主函数创建BeanDefinitionLoader和调用该BeanDefinitionLoader的load方法加载bean.<br />
先看创建BeanDefinitionLoader的方法:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Factory method used to create the {@link BeanDefinitionLoader}.
 * 创建BeanDefinitionLoader的工厂方法
 */</span>
<span class="kd">protected</span> <span class="nc">BeanDefinitionLoader</span> <span class="nf">createBeanDefinitionLoader</span><span class="o">(</span><span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">sources</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">BeanDefinitionLoader</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="n">sources</span><span class="o">);</span>
<span class="o">}</span>

<span class="cm">/**
 * Create a new {@link BeanDefinitionLoader} that will load beans into the specified
 * {@link BeanDefinitionRegistry}.
 * 创建一个新的BeanDefinitionLoader, 它将bean加载到指定的BeanDefinitionRegistry
 */</span>
<span class="nc">BeanDefinitionLoader</span><span class="o">(</span><span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">,</span> <span class="nc">Object</span><span class="o">...</span> <span class="n">sources</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="s">"Registry must not be null"</span><span class="o">);</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">notEmpty</span><span class="o">(</span><span class="n">sources</span><span class="o">,</span> <span class="s">"Sources must not be empty"</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">sources</span> <span class="o">=</span> <span class="n">sources</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">annotatedReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotatedBeanDefinitionReader</span><span class="o">(</span><span class="n">registry</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">xmlReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XmlBeanDefinitionReader</span><span class="o">(</span><span class="n">registry</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isGroovyPresent</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">groovyReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GroovyBeanDefinitionReader</span><span class="o">(</span><span class="n">registry</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">this</span><span class="o">.</span><span class="na">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathBeanDefinitionScanner</span><span class="o">(</span><span class="n">registry</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">scanner</span><span class="o">.</span><span class="na">addExcludeFilter</span><span class="o">(</span><span class="k">new</span> <span class="nc">ClassExcludeFilter</span><span class="o">(</span><span class="n">sources</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div></div>
<p>根据主函数和注册表进行创建BeanDefinitionLoader,并初始化AnnotatedBeanDefinitionReader和ClassPathBeanDefinitionScanner</p>

<p>最后我们来下最重要的load方法:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//加载主资源</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="nf">load</span><span class="o">(</span><span class="nc">Object</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="s">"Source must not be null"</span><span class="o">);</span>
    <span class="c1">//我们的主函数肯定是个类  所以走load类的方法</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">source</span> <span class="k">instanceof</span> <span class="nc">Class</span><span class="o">&lt;?&gt;)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">load</span><span class="o">((</span><span class="nc">Class</span><span class="o">&lt;?&gt;)</span> <span class="n">source</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="o">...</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Invalid source type "</span> <span class="o">+</span> <span class="n">source</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">int</span> <span class="nf">load</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//查看是否支持 groovy.lang.MetaClass 且 source是否为GroovyBeanDefinitionSource类或者是他的超类或接口</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isGroovyPresent</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="nc">GroovyBeanDefinitionSource</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">source</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">// Any GroovyLoaders added in beans{} DSL can contribute beans here</span>
        <span class="nc">GroovyBeanDefinitionSource</span> <span class="n">loader</span> <span class="o">=</span> <span class="nc">BeanUtils</span><span class="o">.</span><span class="na">instantiateClass</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="nc">GroovyBeanDefinitionSource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">load</span><span class="o">(</span><span class="n">loader</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//判断当前类是否被@Component修饰,如果是则注册该资源</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isComponent</span><span class="o">(</span><span class="n">source</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">annotatedReader</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isComponent</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// This has to be a bit of a guess. The only way to be sure that this type is</span>
    <span class="c1">// eligible is to make a bean definition out of it and try to instantiate it.</span>
    <span class="c1">//这不得不有点猜测, 确保此类型符合条件的唯一方法就是从中创建bean定义并尝试实例化他</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">MergedAnnotations</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="nc">SearchStrategy</span><span class="o">.</span><span class="na">TYPE_HIERARCHY</span><span class="o">).</span><span class="na">isPresent</span><span class="o">(</span><span class="nc">Component</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// Nested anonymous classes are not eligible for registration, nor are groovy</span>
    <span class="c1">// closures</span>
    <span class="c1">// 嵌套匿名类不符合注册条件, groovy闭包也不符合注册条件</span>
    <span class="k">return</span> <span class="o">!</span><span class="n">type</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">matches</span><span class="o">(</span><span class="s">".*\\$_.*closure.*"</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">type</span><span class="o">.</span><span class="na">isAnonymousClass</span><span class="o">()</span>
            <span class="o">&amp;&amp;</span> <span class="n">type</span><span class="o">.</span><span class="na">getConstructors</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">type</span><span class="o">.</span><span class="na">getConstructors</span><span class="o">().</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p>由上可见, <strong>doRegisterBean</strong> 之前都是进行类检测作用,主函数是否由 <strong>@Component</strong> 修饰,且它是否支持 <strong>groovy</strong> 语义.<br />
接下来我们继续看看它真正的 <strong>doRegisterBean</strong> 方法.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Register a bean from the given bean class, deriving its metadata from
 * class-declared annotations.
 * 从给定的bean类注册bean, 从类声明的注释中获取其元数据
 */</span>
<span class="kd">private</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">doRegisterBean</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">beanClass</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span>
        <span class="nd">@Nullable</span> <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">&gt;[]</span> <span class="n">qualifiers</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Supplier</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">supplier</span><span class="o">,</span>
        <span class="nd">@Nullable</span> <span class="nc">BeanDefinitionCustomizer</span><span class="o">[]</span> <span class="n">customizers</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//定义注解类型的bean定义,来看下它的构造方法:</span>
    <span class="c1">//所以它的主要作用就是解析指定类的所有注解</span>
    <span class="nc">AnnotatedGenericBeanDefinition</span> <span class="n">abd</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotatedGenericBeanDefinition</span><span class="o">(</span><span class="n">beanClass</span><span class="o">);</span>
    <span class="c1">//检查当前bean定义是包含@Conditional且是否满足条件</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">conditionEvaluator</span><span class="o">.</span><span class="na">shouldSkip</span><span class="o">(</span><span class="n">abd</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">()))</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">abd</span><span class="o">.</span><span class="na">setInstanceSupplier</span><span class="o">(</span><span class="n">supplier</span><span class="o">);</span>
    <span class="c1">//解析适用于abd的 ScopeMetadata 并设置到 bean定义中</span>
    <span class="nc">ScopeMetadata</span> <span class="n">scopeMetadata</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">scopeMetadataResolver</span><span class="o">.</span><span class="na">resolveScopeMetadata</span><span class="o">(</span><span class="n">abd</span><span class="o">);</span>
    <span class="n">abd</span><span class="o">.</span><span class="na">setScope</span><span class="o">(</span><span class="n">scopeMetadata</span><span class="o">.</span><span class="na">getScopeName</span><span class="o">());</span>
    <span class="c1">//生成bean名称</span>
    <span class="nc">String</span> <span class="n">beanName</span> <span class="o">=</span> <span class="o">(</span><span class="n">name</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">name</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">beanNameGenerator</span><span class="o">.</span><span class="na">generateBeanName</span><span class="o">(</span><span class="n">abd</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">));</span>

    <span class="c1">//处理通用bea注解 主要处理@Lazy, @Primary, @DependsOn, @Role, @Description等注解</span>
    <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">processCommonDefinitionAnnotations</span><span class="o">(</span><span class="n">abd</span><span class="o">);</span>
    <span class="c1">//存在以上注解则设置bean属性</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">qualifiers</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">&gt;</span> <span class="n">qualifier</span> <span class="o">:</span> <span class="n">qualifiers</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">Primary</span><span class="o">.</span><span class="na">class</span> <span class="o">==</span> <span class="n">qualifier</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">abd</span><span class="o">.</span><span class="na">setPrimary</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="nc">Lazy</span><span class="o">.</span><span class="na">class</span> <span class="o">==</span> <span class="n">qualifier</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">abd</span><span class="o">.</span><span class="na">setLazyInit</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="n">abd</span><span class="o">.</span><span class="na">addQualifier</span><span class="o">(</span><span class="k">new</span> <span class="nc">AutowireCandidateQualifier</span><span class="o">(</span><span class="n">qualifier</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">//是否有自定义器 自定义 bean定义</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">customizers</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">BeanDefinitionCustomizer</span> <span class="n">customizer</span> <span class="o">:</span> <span class="n">customizers</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">customizer</span><span class="o">.</span><span class="na">customize</span><span class="o">(</span><span class="n">abd</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">//创建该bean 定义持有器</span>
    <span class="nc">BeanDefinitionHolder</span> <span class="n">definitionHolder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BeanDefinitionHolder</span><span class="o">(</span><span class="n">abd</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
    <span class="c1">//设置当前bean定义的代理模式 根据proxyBeanMethods字段</span>
    <span class="n">definitionHolder</span> <span class="o">=</span> <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">applyScopedProxyMode</span><span class="o">(</span><span class="n">scopeMetadata</span><span class="o">,</span> <span class="n">definitionHolder</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">);</span>
    <span class="c1">//注册bean定义</span>
    <span class="nc">BeanDefinitionReaderUtils</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="n">definitionHolder</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">);</span>
<span class="o">}</span>

<span class="cm">/**
 * Create a new AnnotatedGenericBeanDefinition for the given bean class.
 * 为给定的类创建一个新的 AnnotatedGenericBeanDefinition
 */</span>
<span class="kd">public</span> <span class="nf">AnnotatedGenericBeanDefinition</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">beanClass</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">setBeanClass</span><span class="o">(</span><span class="n">beanClass</span><span class="o">);</span>
    <span class="c1">//核心就是这步,它将解析给定的类的所有注解</span>
    <span class="k">this</span><span class="o">.</span><span class="na">metadata</span> <span class="o">=</span> <span class="nc">AnnotationMetadata</span><span class="o">.</span><span class="na">introspect</span><span class="o">(</span><span class="n">beanClass</span><span class="o">);</span>
<span class="o">}</span>

<span class="cm">/**
 * Determine if an item should be skipped based on {@code @Conditional} annotations.
 * 根据 @Conditional注解确定是否应跳过项目
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">shouldSkip</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">AnnotatedTypeMetadata</span> <span class="n">metadata</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">ConfigurationPhase</span> <span class="n">phase</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//判断该类的元注解是否包含 @Conditional  不包含直接返回false</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">metadata</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">metadata</span><span class="o">.</span><span class="na">isAnnotated</span><span class="o">(</span><span class="nc">Conditional</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//当parse为null时, 尝试使用@Conditional解析@Configuration类 和 非@Configuration修饰的bean</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">phase</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">metadata</span> <span class="k">instanceof</span> <span class="nc">AnnotationMetadata</span> <span class="o">&amp;&amp;</span>
                <span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">isConfigurationCandidate</span><span class="o">((</span><span class="nc">AnnotationMetadata</span><span class="o">)</span> <span class="n">metadata</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">shouldSkip</span><span class="o">(</span><span class="n">metadata</span><span class="o">,</span> <span class="nc">ConfigurationPhase</span><span class="o">.</span><span class="na">PARSE_CONFIGURATION</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nf">shouldSkip</span><span class="o">(</span><span class="n">metadata</span><span class="o">,</span> <span class="nc">ConfigurationPhase</span><span class="o">.</span><span class="na">REGISTER_BEAN</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Condition</span><span class="o">&gt;</span> <span class="n">conditions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">conditionClasses</span> <span class="o">:</span> <span class="n">getConditionClasses</span><span class="o">(</span><span class="n">metadata</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">conditionClass</span> <span class="o">:</span> <span class="n">conditionClasses</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Condition</span> <span class="n">condition</span> <span class="o">=</span> <span class="n">getCondition</span><span class="o">(</span><span class="n">conditionClass</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">());</span>
            <span class="n">conditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">condition</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nc">AnnotationAwareOrderComparator</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">conditions</span><span class="o">);</span>

    <span class="k">for</span> <span class="o">(</span><span class="nc">Condition</span> <span class="n">condition</span> <span class="o">:</span> <span class="n">conditions</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ConfigurationPhase</span> <span class="n">requiredPhase</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">condition</span> <span class="k">instanceof</span> <span class="nc">ConfigurationCondition</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">requiredPhase</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ConfigurationCondition</span><span class="o">)</span> <span class="n">condition</span><span class="o">).</span><span class="na">getConfigurationPhase</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">requiredPhase</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">requiredPhase</span> <span class="o">==</span> <span class="n">phase</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">condition</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">context</span><span class="o">,</span> <span class="n">metadata</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">//处理通用bean定义注解 </span>
<span class="kd">static</span> <span class="kt">void</span> <span class="nf">processCommonDefinitionAnnotations</span><span class="o">(</span><span class="nc">AnnotatedBeanDefinition</span> <span class="n">abd</span><span class="o">,</span> <span class="nc">AnnotatedTypeMetadata</span> <span class="n">metadata</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//首先检查 @Lazy注解</span>
    <span class="nc">AnnotationAttributes</span> <span class="n">lazy</span> <span class="o">=</span> <span class="n">attributesFor</span><span class="o">(</span><span class="n">metadata</span><span class="o">,</span> <span class="nc">Lazy</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">lazy</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">abd</span><span class="o">.</span><span class="na">setLazyInit</span><span class="o">(</span><span class="n">lazy</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">"value"</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="c1">//判断当前bean定义的元注解中是否还有 @Lazy注解</span>
    <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">abd</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">()</span> <span class="o">!=</span> <span class="n">metadata</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">lazy</span> <span class="o">=</span> <span class="n">attributesFor</span><span class="o">(</span><span class="n">abd</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">(),</span> <span class="nc">Lazy</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">lazy</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">abd</span><span class="o">.</span><span class="na">setLazyInit</span><span class="o">(</span><span class="n">lazy</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">"value"</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">//元数据是否以 @Primary为注解</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">metadata</span><span class="o">.</span><span class="na">isAnnotated</span><span class="o">(</span><span class="nc">Primary</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
        <span class="n">abd</span><span class="o">.</span><span class="na">setPrimary</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//元数据是否以 @DependsOn为注解</span>
    <span class="nc">AnnotationAttributes</span> <span class="n">dependsOn</span> <span class="o">=</span> <span class="n">attributesFor</span><span class="o">(</span><span class="n">metadata</span><span class="o">,</span> <span class="nc">DependsOn</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">dependsOn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">abd</span><span class="o">.</span><span class="na">setDependsOn</span><span class="o">(</span><span class="n">dependsOn</span><span class="o">.</span><span class="na">getStringArray</span><span class="o">(</span><span class="s">"value"</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">//元数据是否以 @Role为注解</span>
    <span class="nc">AnnotationAttributes</span> <span class="n">role</span> <span class="o">=</span> <span class="n">attributesFor</span><span class="o">(</span><span class="n">metadata</span><span class="o">,</span> <span class="nc">Role</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">role</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">abd</span><span class="o">.</span><span class="na">setRole</span><span class="o">(</span><span class="n">role</span><span class="o">.</span><span class="na">getNumber</span><span class="o">(</span><span class="s">"value"</span><span class="o">).</span><span class="na">intValue</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="c1">//元数据是否以 @Description为注解</span>
    <span class="nc">AnnotationAttributes</span> <span class="n">description</span> <span class="o">=</span> <span class="n">attributesFor</span><span class="o">(</span><span class="n">metadata</span><span class="o">,</span> <span class="nc">Description</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">description</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">abd</span><span class="o">.</span><span class="na">setDescription</span><span class="o">(</span><span class="n">description</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"value"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>由此可见, <strong>doRegisterBean</strong> 的作用就是解析主函数的相关源注解,并将其作为bean定义注册到bean工厂中,以供后续进行真正解析这个类.</p>
<hr />

<h3 id="preparecontext总结">prepareContext总结</h3>
<hr />
<p>可以大约分为6步:</p>
<ol>
  <li>设置 <strong>environment</strong> 到上下文中,并执行相关的后置处理,设置类型装换服务</li>
  <li>应用在构造函数阶段实例化的所有 <strong>ApplicationContextInitializer</strong> 初始化器到上下文</li>
  <li>此时上下文已经准备就绪,发布 <strong>contextPrepared</strong> 事件</li>
  <li>打印启动信息,并注册 <strong>springApplicationArguments、springBootBanner</strong> bean定义,并设置上下文的是否允许bean定义覆盖属性 <strong>allowBeanDefinitionOverriding</strong></li>
  <li>第五步就是最重要的一步了,这里将进行对主函数注解的解析并校验,校验通过则注册到bean工厂中,供后面解析配置类处理</li>
  <li>最后一步就是发布上下文已加载事件
    <hr />
  </li>
</ol>

</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">SpringBoot</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">September 2021</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">SpringBoot</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-20000004" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2>SpringBoot启动源码解析(四)</h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/pexels-anastasia-pavlova-8692301.jpg" class="img-responsive img-centered" alt="SpringBoot4">

                            
                                <h3>SpringBootApplication Run方法解析(二):createApplicationContext</h3>
                            
                            </div>

                            <p><h3 id="run方法入口">Run方法入口</h3>
<hr />
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Run the Spring application, creating and refreshing a new
 * {@link ApplicationContext}.
 * 运行Spring应用，创建和刷新一个新的应用上下文
 * @param args the application arguments (usually passed from a Java main method)
 * @return a running {@link ApplicationContext}
 */</span>
<span class="kd">public</span> <span class="nc">ConfigurableApplicationContext</span> <span class="nf">run</span><span class="o">(</span><span class="nc">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//1.创建启动计时器</span>
    <span class="nc">StopWatch</span> <span class="n">stopWatch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StopWatch</span><span class="o">();</span>
    <span class="n">stopWatch</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="c1">//创建启动上下文并初始化相应的Bootstrapper 目前暂未使用</span>
    <span class="nc">ConfigurableApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">SpringBootExceptionReporter</span><span class="o">&gt;</span> <span class="n">exceptionReporters</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="c1">//设置系统的配置模式，一般用于服务端开发 默认为true</span>
    <span class="n">configureHeadlessProperty</span><span class="o">();</span>
    <span class="c1">//获取spring上下文启动监听者  从META-INF/spring.factories中获取SpringApplicationRunListener的实现类并加载</span>
    <span class="nc">SpringApplicationRunListeners</span> <span class="n">listeners</span> <span class="o">=</span> <span class="n">getRunListeners</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
    <span class="c1">//发布启动中事件</span>
    <span class="n">listeners</span><span class="o">.</span><span class="na">starting</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">//2.创建默认上下文参数</span>
        <span class="nc">ApplicationArguments</span> <span class="n">applicationArguments</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultApplicationArguments</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
        <span class="c1">//3.准备环境，将资源属性添加到环境中并与上下文绑定</span>
        <span class="nc">ConfigurableEnvironment</span> <span class="n">environment</span> <span class="o">=</span> <span class="n">prepareEnvironment</span><span class="o">(</span><span class="n">listeners</span><span class="o">,</span> <span class="n">applicationArguments</span><span class="o">);</span>
        <span class="c1">//设置spring.beaninfo.ignore中过滤的bean</span>
        <span class="n">configureIgnoreBeanInfo</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
        <span class="c1">//打印spring标记</span>
        <span class="nc">Banner</span> <span class="n">printedBanner</span> <span class="o">=</span> <span class="n">printBanner</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
        <span class="c1">//4.根据web应用类型创建指定的应用上下文</span>
        <span class="c1">//注意:这里反射创建AnnotationConfigServletWebServerApplicationContext时,构造中创建AnnotatedBeanDefinitionReader中的AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry)方法很重要</span>
        <span class="c1">//它将几个常见的BeanPostProcessor和BeanFactoryPostProcessor注册到注册表中  最重要的是internalConfigurationAnnotationProcessor来解析Configuration的配置类</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">createApplicationContext</span><span class="o">();</span>
        <span class="n">exceptionReporters</span> <span class="o">=</span> <span class="n">getSpringFactoriesInstances</span><span class="o">(</span><span class="nc">SpringBootExceptionReporter</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                <span class="k">new</span> <span class="nc">Class</span><span class="o">[]</span> <span class="o">{</span> <span class="nc">ConfigurableApplicationContext</span><span class="o">.</span><span class="na">class</span> <span class="o">},</span> <span class="n">context</span><span class="o">);</span>
        <span class="c1">//5.准备上下文</span>
        <span class="c1">//主要做了两件事:</span>
        <span class="c1">// 1.调用前面实例化的ApplicationContextInitializer的initialize方式初始化上下文</span>
        <span class="c1">// 2.在其中的load方法中将启动主函数bean定义注册到注册表中 beanDefinitionMap</span>
        <span class="n">prepareContext</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">environment</span><span class="o">,</span> <span class="n">listeners</span><span class="o">,</span> <span class="n">applicationArguments</span><span class="o">,</span> <span class="n">printedBanner</span><span class="o">);</span>
        <span class="c1">//6.刷新上下文</span>
        <span class="n">refreshContext</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
        <span class="n">afterRefresh</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">applicationArguments</span><span class="o">);</span>
        <span class="n">stopWatch</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">logStartupInfo</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">new</span> <span class="nf">StartupInfoLogger</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mainApplicationClass</span><span class="o">).</span><span class="na">logStarted</span><span class="o">(</span><span class="n">getApplicationLog</span><span class="o">(),</span> <span class="n">stopWatch</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">//监听者发布已启动事件</span>
        <span class="n">listeners</span><span class="o">.</span><span class="na">started</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
        <span class="c1">//7.调用所有的ApplicationRunner和CommandLineRunner的实现类</span>
        <span class="n">callRunners</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">applicationArguments</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">handleRunFailure</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">ex</span><span class="o">,</span> <span class="n">exceptionReporters</span><span class="o">,</span> <span class="n">listeners</span><span class="o">);</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">//监听者发布运行中事件</span>
        <span class="n">listeners</span><span class="o">.</span><span class="na">running</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">handleRunFailure</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">ex</span><span class="o">,</span> <span class="n">exceptionReporters</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">context</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<hr />

<h3 id="createapplicationcontext">createApplicationContext</h3>
<hr />
<p>本章我们主要看下createApplicationContext:
第四步就是通过反射创建 <strong>ApplicationContext</strong> ,相关源码如下:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * The class name of application context that will be used by default for non-web
 * environments.
 * 默认情况下将用于非web环境的应用程序上下文的类名
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">DEFAULT_CONTEXT_CLASS</span> <span class="o">=</span> <span class="s">"org.springframework.context."</span>
        <span class="o">+</span> <span class="s">"annotation.AnnotationConfigApplicationContext"</span><span class="o">;</span>

<span class="cm">/**
 * The class name of application context that will be used by default for web
 * environments.
 * 默认情况下将用于web环境的应用程序上下文的类名
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">DEFAULT_SERVLET_WEB_CONTEXT_CLASS</span> <span class="o">=</span> <span class="s">"org.springframework.boot."</span>
        <span class="o">+</span> <span class="s">"web.servlet.context.AnnotationConfigServletWebServerApplicationContext"</span><span class="o">;</span>

<span class="cm">/**
 * The class name of application context that will be used by default for reactive web
 * environments.
 * 默认情况下将用于reactive web环境的应用程序上下文的类名
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">DEFAULT_REACTIVE_WEB_CONTEXT_CLASS</span> <span class="o">=</span> <span class="s">"org.springframework."</span>
        <span class="o">+</span> <span class="s">"boot.web.reactive.context.AnnotationConfigReactiveWebServerApplicationContext"</span><span class="o">;</span>

<span class="cm">/**
 * Strategy method used to create the {@link ApplicationContext}. By default this
 * method will respect any explicitly set application context or application context
 * class before falling back to a suitable default.
 * 创建应用上下文使用的策略方法.默认情况下,此方法将在回退到合适的默认值之前尊重任何显示设置的应用程序上下文或类.
 */</span>
<span class="kd">protected</span> <span class="nc">ConfigurableApplicationContext</span> <span class="nf">createApplicationContext</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">contextClass</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">applicationContextClass</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">contextClass</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">switch</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">webApplicationType</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//通常我们的上下文默认是Servlet类型,实例化AnnotationConfigServletWebServerApplicationContext</span>
            <span class="k">case</span> <span class="nl">SERVLET:</span>
                <span class="n">contextClass</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="no">DEFAULT_SERVLET_WEB_CONTEXT_CLASS</span><span class="o">);</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="nl">REACTIVE:</span>
                <span class="n">contextClass</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="no">DEFAULT_REACTIVE_WEB_CONTEXT_CLASS</span><span class="o">);</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="n">contextClass</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="no">DEFAULT_CONTEXT_CLASS</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span>
                    <span class="s">"Unable create a default ApplicationContext, please specify an ApplicationContextClass"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">//真正的实例化位置</span>
    <span class="k">return</span> <span class="o">(</span><span class="nc">ConfigurableApplicationContext</span><span class="o">)</span> <span class="nc">BeanUtils</span><span class="o">.</span><span class="na">instantiateClass</span><span class="o">(</span><span class="n">contextClass</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>因为我们的应用类型为 <strong>SERVLET</strong> ,所以应该初始化 <strong>AnnotationConfigServletWebServerApplicationContext</strong> , 下面我们继续看下实例化 <strong>AnnotationConfigServletWebServerApplicationContext</strong> 的源码:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Create a new {@link AnnotationConfigServletWebServerApplicationContext} that needs
 * to be populated through {@link #register} calls and then manually
 * {@linkplain #refresh refreshed}.
 * 创建新的AnnotationConfigServletWebServerApplicationContext, 他需要通过通过register调用填充然后手动refreshed
 */</span>
<span class="kd">public</span> <span class="nf">AnnotationConfigServletWebServerApplicationContext</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotatedBeanDefinitionReader</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathBeanDefinitionScanner</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>我们首先来看下 <strong>AnnotationConfigServletWebServerApplicationContext</strong> 的作用:接受带有 <strong>@Configuration</strong> 、 <strong>@Component</strong> 和 <strong>inject</strong> 注解的类,可以指定类进行注册同样可以根据类路径扫描来注册.<br />
在它的无参构造中,它又创建了 <strong>AnnotatedBeanDefinitionReader</strong> 和 <strong>ClassPathBeanDefinitionScanner</strong> .<br />
其中 <strong>AnnotatedBeanDefinitionReader</strong> 的作用是以编程方式注册Bean类; <strong>ClassPathBeanDefinitionScanner</strong> 的作用是扫描类路径下所有以 <strong>@Component、@Repository、@Service、@Controller、ManagedBean、Named</strong> 等注解修饰的类,并注册相关的bean定义.</p>

<p>4.1 首先我们先看下 <strong>AnnotatedBeanDefinitionReader</strong> 的源码:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">AnnotatedBeanDefinitionReader</span><span class="o">(</span><span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="n">getOrCreateEnvironment</span><span class="o">(</span><span class="n">registry</span><span class="o">));</span>
<span class="o">}</span>

<span class="cm">/**
 * Create a new {@code AnnotatedBeanDefinitionReader} for the given registry,
 * using the given {@link Environment}.
 * 使用给定的注册表和环境创建AnnotatedBeanDefinitionReader
 */</span>
<span class="kd">public</span> <span class="nf">AnnotatedBeanDefinitionReader</span><span class="o">(</span><span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">,</span> <span class="nc">Environment</span> <span class="n">environment</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="s">"BeanDefinitionRegistry must not be null"</span><span class="o">);</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">environment</span><span class="o">,</span> <span class="s">"Environment must not be null"</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">registry</span> <span class="o">=</span> <span class="n">registry</span><span class="o">;</span>
    <span class="c1">//创建用于处理@Conditional注解的内部类</span>
    <span class="k">this</span><span class="o">.</span><span class="na">conditionEvaluator</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConditionEvaluator</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="n">environment</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="c1">//这里是最重要的地方,注册了多个后置处理器,供后面创建bean的时候调用</span>
    <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">registerAnnotationConfigProcessors</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>
<p>可见 <strong>AnnotatedBeanDefinitionReader</strong> 主构造中最重要的就是 <strong>AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry)</strong> 这个方法,我们继续往下看看:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * The bean name of the internally managed Configuration annotation processor.
 * 内部管理的配置注解处理器的bean名称
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span> <span class="o">=</span>
        <span class="s">"org.springframework.context.annotation.internalConfigurationAnnotationProcessor"</span><span class="o">;</span>

<span class="cm">/**
 * The bean name of the internally managed Autowired annotation processor.
 * 内部管理的自动注入注解处理器的bean名称
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span> <span class="o">=</span>
        <span class="s">"org.springframework.context.annotation.internalAutowiredAnnotationProcessor"</span><span class="o">;</span>

<span class="cm">/**
 * The bean name of the internally managed JSR-250 annotation processor.
 * 内部管理的JSR-250注解处理器的bean名称
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">COMMON_ANNOTATION_PROCESSOR_BEAN_NAME</span> <span class="o">=</span>
        <span class="s">"org.springframework.context.annotation.internalCommonAnnotationProcessor"</span><span class="o">;</span>

<span class="cm">/**
 * The bean name of the internally managed JPA annotation processor.
 * 内部处理的JPA注解处理器的bean名称
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME</span> <span class="o">=</span>
        <span class="s">"org.springframework.context.annotation.internalPersistenceAnnotationProcessor"</span><span class="o">;</span>

<span class="cm">/**
 * The bean name of the internally managed @EventListener annotation processor.
 * 内部处理的@EventListener注解处理器的bean名称
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">EVENT_LISTENER_PROCESSOR_BEAN_NAME</span> <span class="o">=</span>
        <span class="s">"org.springframework.context.event.internalEventListenerProcessor"</span><span class="o">;</span>

<span class="cm">/**
 * The bean name of the internally managed EventListenerFactory.
 * 内部处理的EventListenerFactory的bean名称
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">EVENT_LISTENER_FACTORY_BEAN_NAME</span> <span class="o">=</span>
        <span class="s">"org.springframework.context.event.internalEventListenerFactory"</span><span class="o">;</span>

<span class="cm">/**
 * Register all relevant annotation post processors in the given registry.
 * 在给定的注册表中注册所有相关注解的后置处理器
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="nf">registerAnnotationConfigProcessors</span><span class="o">(</span>
        <span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Object</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//获取最原始的bean工厂</span>
    <span class="nc">DefaultListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">unwrapDefaultListableBeanFactory</span><span class="o">(</span><span class="n">registry</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">beanFactory</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//设置AnnotationAwareOrderComparator,主要用于 @Order和@Priority的排序功能</span>
        <span class="k">if</span> <span class="o">(!(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getDependencyComparator</span><span class="o">()</span> <span class="k">instanceof</span> <span class="nc">AnnotationAwareOrderComparator</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">beanFactory</span><span class="o">.</span><span class="na">setDependencyComparator</span><span class="o">(</span><span class="nc">AnnotationAwareOrderComparator</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">//设置ContextAnnotationAutowireCandidateResolver,主要提供对限定符注解以及@Lazy注解的懒加载</span>
        <span class="k">if</span> <span class="o">(!(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getAutowireCandidateResolver</span><span class="o">()</span> <span class="k">instanceof</span> <span class="nc">ContextAnnotationAutowireCandidateResolver</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">beanFactory</span><span class="o">.</span><span class="na">setAutowireCandidateResolver</span><span class="o">(</span><span class="k">new</span> <span class="nc">ContextAnnotationAutowireCandidateResolver</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="n">beanDefs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="mi">8</span><span class="o">);</span>
    <span class="c1">//创建ConfigurationClassPostProcessor后置处理器bean定义,并注册到bean工厂中</span>
    <span class="c1">//ConfigurationClassPostProcessor的主要作用就是在启动时处理@Configuration修饰的类,其实就是我们的主函数对应的类</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">registry</span><span class="o">.</span><span class="na">containsBeanDefinition</span><span class="o">(</span><span class="no">CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="o">))</span> <span class="o">{</span>
        <span class="nc">RootBeanDefinition</span> <span class="n">def</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RootBeanDefinition</span><span class="o">(</span><span class="nc">ConfigurationClassPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">def</span><span class="o">.</span><span class="na">setSource</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
        <span class="n">beanDefs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">registerPostProcessor</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="n">def</span><span class="o">,</span> <span class="no">CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="c1">//创建AutowiredAnnotationBeanPostProcessor后置处理器Bean定义,并注册到bean工厂中</span>
    <span class="c1">//AutowiredAnnotationBeanPostProcessor的主要作用是自动装配注解的字段、set方法和任何配置方法,默认通过@Autowired和@Value</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">registry</span><span class="o">.</span><span class="na">containsBeanDefinition</span><span class="o">(</span><span class="no">AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="o">))</span> <span class="o">{</span>
        <span class="nc">RootBeanDefinition</span> <span class="n">def</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RootBeanDefinition</span><span class="o">(</span><span class="nc">AutowiredAnnotationBeanPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">def</span><span class="o">.</span><span class="na">setSource</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
        <span class="n">beanDefs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">registerPostProcessor</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="n">def</span><span class="o">,</span> <span class="no">AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">// Check for JSR-250 support, and if present add the CommonAnnotationBeanPostProcessor.</span>
    <span class="c1">//检查是否支持JSR-250,支持则创建CommonAnnotationBeanPostProcessor后置处理器并注册到bean工厂中</span>
    <span class="c1">//CommonAnnotationBeanPostProcessor的主要作用是支持开箱即用的java注解,主要是annotation中的注解,一般是@PostConstruct、@PreDestroy,最主要是@Resources</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">jsr250Present</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">registry</span><span class="o">.</span><span class="na">containsBeanDefinition</span><span class="o">(</span><span class="no">COMMON_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="o">))</span> <span class="o">{</span>
        <span class="nc">RootBeanDefinition</span> <span class="n">def</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RootBeanDefinition</span><span class="o">(</span><span class="nc">CommonAnnotationBeanPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">def</span><span class="o">.</span><span class="na">setSource</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
        <span class="n">beanDefs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">registerPostProcessor</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="n">def</span><span class="o">,</span> <span class="no">COMMON_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">// Check for JPA support, and if present add the PersistenceAnnotationBeanPostProcessor.</span>
    <span class="c1">//检查是否支持JPA,支持则创建PersistenceAnnotationBeanPostProcessor后置处理器并注册到bean工厂中</span>
    <span class="c1">//PersistenceAnnotationBeanPostProcessor的主要作用是为了注入相关EntityManagerFactory和EntityManager资源处理PersistenceUnit和PersistenceContext注解</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">jpaPresent</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">registry</span><span class="o">.</span><span class="na">containsBeanDefinition</span><span class="o">(</span><span class="no">PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="o">))</span> <span class="o">{</span>
        <span class="nc">RootBeanDefinition</span> <span class="n">def</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RootBeanDefinition</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">def</span><span class="o">.</span><span class="na">setBeanClass</span><span class="o">(</span><span class="nc">ClassUtils</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="no">PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME</span><span class="o">,</span>
                    <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">()));</span>
        <span class="o">}</span>
        <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span>
                    <span class="s">"Cannot load optional framework class: "</span> <span class="o">+</span> <span class="no">PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">def</span><span class="o">.</span><span class="na">setSource</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
        <span class="n">beanDefs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">registerPostProcessor</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="n">def</span><span class="o">,</span> <span class="no">PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">//创建EventListenerMethodProcessor后置处理器并注册到bean工厂中</span>
    <span class="c1">//EventListenerMethodProcessor的主要作用是作为单独的ApplicationListener实例,主要用于早期检索,避免对其处理器bean和他的EventListenerFactory委托者进行aop检查</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">registry</span><span class="o">.</span><span class="na">containsBeanDefinition</span><span class="o">(</span><span class="no">EVENT_LISTENER_PROCESSOR_BEAN_NAME</span><span class="o">))</span> <span class="o">{</span>
        <span class="nc">RootBeanDefinition</span> <span class="n">def</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RootBeanDefinition</span><span class="o">(</span><span class="nc">EventListenerMethodProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">def</span><span class="o">.</span><span class="na">setSource</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
        <span class="n">beanDefs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">registerPostProcessor</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="n">def</span><span class="o">,</span> <span class="no">EVENT_LISTENER_PROCESSOR_BEAN_NAME</span><span class="o">));</span>
    <span class="o">}</span>
    
    <span class="c1">//创建DefaultEventListenerFactory bean定义并注册到bean工厂</span>
    <span class="c1">//DefaultEventListenerFactory主要是为了常规的EventListener注解</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">registry</span><span class="o">.</span><span class="na">containsBeanDefinition</span><span class="o">(</span><span class="no">EVENT_LISTENER_FACTORY_BEAN_NAME</span><span class="o">))</span> <span class="o">{</span>
        <span class="nc">RootBeanDefinition</span> <span class="n">def</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RootBeanDefinition</span><span class="o">(</span><span class="nc">DefaultEventListenerFactory</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">def</span><span class="o">.</span><span class="na">setSource</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
        <span class="n">beanDefs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">registerPostProcessor</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="n">def</span><span class="o">,</span> <span class="no">EVENT_LISTENER_FACTORY_BEAN_NAME</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">beanDefs</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p>可见 <strong>AnnotatedBeanDefinitionReader</strong> 的作用就是注册了多个后置处理器.我们来看这几个后置处理器,先看他们的类图:</p>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/AnnotationConfigProcessors.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="AnnotationConfigProcessors" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/AnnotationConfigProcessors.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">AnnotationConfigProcessors</div>
    </a>
</center>

<p>其中最重要的就是 <strong>ConfigurationClassPostProcessor</strong> 从类图中也可以看到它继承的父类更多,其中最重要的父类就是 <strong>BeanDefinitionRegistryPostProcessor</strong> ,它就是处理主函数的核心,具体后面再介绍.<br />
我们一一介绍下这几个类的大概作用:</p>
<ul>
  <li>ConfigurationClassPostProcessor:最为重要,在启动时处理 <strong>@Configuration</strong> 修饰的类,主要就是我们启动时使用 <strong>@SpringBootApplication</strong> 修饰的主函数</li>
  <li>AutowiredAnnotationBeanPostProcessor:主要作用是通过 <strong>@Autowired、@Value</strong> 等注解自动装配字段、set方法和任何配置方法</li>
  <li>CommonAnnotationBeanPostProcessor:主要作用是支持开箱即用的方法,例如 <strong>@PostConstruct、@PreDestroy、@Resources</strong> 等</li>
  <li>PersistenceAnnotationBeanPostProcessor:主要作用是为了注入相关EntityManagerFactory和EntityManager资源处理PersistenceUnit和PersistenceContext注解</li>
  <li>EventListenerMethodProcessor:主要作用是作为单独的ApplicationListener实例,主要用于早期检索,避免对其处理器bean和他的EventListenerFactory委托者进行aop检查</li>
  <li>DefaultEventListenerFactory:主要是为了常规的EventListener注解</li>
</ul>

<blockquote>
  <p>综上所述: <strong>AnnotatedBeanDefinitionReader</strong> 的主要作用就是注册多个后置处理器到bean工厂中,为后面解析主函数做准备</p>
</blockquote>

<p>4.2 接下来我们再看下 <strong>ClassPathBeanDefinitionScanner</strong> 的源码:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Create a new {@code ClassPathBeanDefinitionScanner} for the given bean factory and
 * using the given {@link Environment} when evaluating bean definition profile metadata.
 * 为给定的bean工厂创建ClassPathBeanDefinitionScanner,并在评估bean定义配置元数据时使用给定的Environment
 */</span>
<span class="kd">public</span> <span class="nf">ClassPathBeanDefinitionScanner</span><span class="o">(</span><span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">useDefaultFilters</span><span class="o">,</span>
        <span class="nc">Environment</span> <span class="n">environment</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">ResourceLoader</span> <span class="n">resourceLoader</span><span class="o">)</span> <span class="o">{</span>

    <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="s">"BeanDefinitionRegistry must not be null"</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">registry</span> <span class="o">=</span> <span class="n">registry</span><span class="o">;</span>
    <span class="c1">//注册默认过滤器 主要是@Component、ManagedBean、Named</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">useDefaultFilters</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">registerDefaultFilters</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">//设置environment</span>
    <span class="n">setEnvironment</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
    <span class="c1">//设置类加载器</span>
    <span class="n">setResourceLoader</span><span class="o">(</span><span class="n">resourceLoader</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>
<p>我们先来看下 <strong>registerDefaultFilters()</strong> 方法具体做了什么:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Register the default filter for {@link Component @Component}.
 * &lt;p&gt;This will implicitly register all annotations that have the
 * {@link Component @Component} meta-annotation including the
 * {@link Repository @Repository}, {@link Service @Service}, and
 * {@link Controller @Controller} stereotype annotations.
 * &lt;p&gt;Also supports Java EE 6's {@link javax.annotation.ManagedBean} and
 * JSR-330's {@link javax.inject.Named} annotations, if available.
 * 为@Component注册默认过滤器.他可以注册所有隐式含有@Component元注解,包括@Repository、@Service、@Controller
 * 同时还可以支持 ManagedBean和Named
 */</span>
<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">registerDefaultFilters</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">includeFilters</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">AnnotationTypeFilter</span><span class="o">(</span><span class="nc">Component</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="nc">ClassLoader</span> <span class="n">cl</span> <span class="o">=</span> <span class="nc">ClassPathScanningCandidateComponentProvider</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">includeFilters</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">AnnotationTypeFilter</span><span class="o">(</span>
                <span class="o">((</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">&gt;)</span> <span class="nc">ClassUtils</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"javax.annotation.ManagedBean"</span><span class="o">,</span> <span class="n">cl</span><span class="o">)),</span> <span class="kc">false</span><span class="o">));</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"JSR-250 'javax.annotation.ManagedBean' found and supported for component scanning"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// JSR-250 1.1 API (as included in Java EE 6) not available - simply skip.</span>
    <span class="o">}</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">includeFilters</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">AnnotationTypeFilter</span><span class="o">(</span>
                <span class="o">((</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">&gt;)</span> <span class="nc">ClassUtils</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"javax.inject.Named"</span><span class="o">,</span> <span class="n">cl</span><span class="o">)),</span> <span class="kc">false</span><span class="o">));</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"JSR-330 'javax.inject.Named' annotation found and supported for component scanning"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// JSR-330 API not available - simply skip.</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>下面还有一个方法比较有意思,那就是 <strong>setResourceLoader(resourceLoader)</strong> 方法,乍一眼看上去它就是设置了资源加载器,并没有什么特别的作用,我们翻翻的源码看看:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Set the {@link ResourceLoader} to use for resource locations.
 * This will typically be a {@link ResourcePatternResolver} implementation.
 * &lt;p&gt;Default is a {@code PathMatchingResourcePatternResolver}, also capable of
 * resource pattern resolving through the {@code ResourcePatternResolver} interface.
 * 设置资源加载器以用于资源位置. 通常是ResourcePatternResolver的实现.
 */</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setResourceLoader</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">ResourceLoader</span> <span class="n">resourceLoader</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">resourcePatternResolver</span> <span class="o">=</span> <span class="nc">ResourcePatternUtils</span><span class="o">.</span><span class="na">getResourcePatternResolver</span><span class="o">(</span><span class="n">resourceLoader</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CachingMetadataReaderFactory</span><span class="o">(</span><span class="n">resourceLoader</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">componentsIndex</span> <span class="o">=</span> <span class="nc">CandidateComponentsIndexLoader</span><span class="o">.</span><span class="na">loadIndex</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">resourcePatternResolver</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">());</span>
<span class="o">}</span>

<span class="cm">/**
 * The location to look for components.
 * &lt;p&gt;Can be present in multiple JAR files.
 * 为了寻找组件的位置.可以出现在多个jar文件中
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">COMPONENTS_RESOURCE_LOCATION</span> <span class="o">=</span> <span class="s">"META-INF/spring.components"</span><span class="o">;</span>

<span class="cm">/**
 * Load and instantiate the {@link CandidateComponentsIndex} from
 * {@value #COMPONENTS_RESOURCE_LOCATION}, using the given class loader. If no
 * index is available, return {@code null}.
 * 使用给定的类加载器加载和实例化来自META-INF/spring.components的CandidateComponentsIndex.没有则返回null
 */</span>
<span class="nd">@Nullable</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">CandidateComponentsIndex</span> <span class="nf">loadIndex</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ClassLoader</span> <span class="n">classLoaderToUse</span> <span class="o">=</span> <span class="n">classLoader</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">classLoaderToUse</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">classLoaderToUse</span> <span class="o">=</span> <span class="nc">CandidateComponentsIndexLoader</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">//主要就是通过doLoadIndex这个方法 那这里我们其实也可以用于扩展</span>
    <span class="k">return</span> <span class="n">cache</span><span class="o">.</span><span class="na">computeIfAbsent</span><span class="o">(</span><span class="n">classLoaderToUse</span><span class="o">,</span> <span class="nl">CandidateComponentsIndexLoader:</span><span class="o">:</span><span class="n">doLoadIndex</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">//这段代码就比较好理解了,尝试从META-INF/spring.components中读取配置,没有则返回,有则加载指定位置的文件,同时返回候选者的数量</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="nc">CandidateComponentsIndex</span> <span class="nf">doLoadIndex</span><span class="o">(</span><span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">shouldIgnoreIndex</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Enumeration</span><span class="o">&lt;</span><span class="no">URL</span><span class="o">&gt;</span> <span class="n">urls</span> <span class="o">=</span> <span class="n">classLoader</span><span class="o">.</span><span class="na">getResources</span><span class="o">(</span><span class="no">COMPONENTS_RESOURCE_LOCATION</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">urls</span><span class="o">.</span><span class="na">hasMoreElements</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Properties</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">urls</span><span class="o">.</span><span class="na">hasMoreElements</span><span class="o">())</span> <span class="o">{</span>
            <span class="no">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="n">urls</span><span class="o">.</span><span class="na">nextElement</span><span class="o">();</span>
            <span class="nc">Properties</span> <span class="n">properties</span> <span class="o">=</span> <span class="nc">PropertiesLoaderUtils</span><span class="o">.</span><span class="na">loadProperties</span><span class="o">(</span><span class="k">new</span> <span class="nc">UrlResource</span><span class="o">(</span><span class="n">url</span><span class="o">));</span>
            <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">properties</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Loaded "</span> <span class="o">+</span> <span class="n">result</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="s">"] index(es)"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kt">int</span> <span class="n">totalCount</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">mapToInt</span><span class="o">(</span><span class="nl">Properties:</span><span class="o">:</span><span class="n">size</span><span class="o">).</span><span class="na">sum</span><span class="o">();</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">totalCount</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="k">new</span> <span class="nc">CandidateComponentsIndex</span><span class="o">(</span><span class="n">result</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Unable to load indexes from location ["</span> <span class="o">+</span>
                <span class="no">COMPONENTS_RESOURCE_LOCATION</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<blockquote>
  <p>综上所述: <strong>ClassPathBeanDefinitionScanner</strong> 的作用就是扫描所有类路径下所有被@Component、@Repository、@Service、@Controller以及ManagedBean和Named注解的类,并将它们注册为bean定义.</p>
</blockquote>

<hr />

<h3 id="createapplicationcontext总结">createApplicationContext总结</h3>
<blockquote>
  <p>第四步主要就是创建AnnotationConfigServletWebServerApplicationContext上下文,在构造AnnotationConfigServletWebServerApplicationContext的同时又创建用于注册所有bean的AnnotatedBeanDefinitionReader和扫描所有指定注解类的ClassPathBeanDefinitionScanner.
其中AnnotatedBeanDefinitionReader又注册了多个后置处理器为后续做准备,最重要的就是ConfigurationClassPostProcessor.</p>
</blockquote>

<h3 id="组件扫描扩展">组件扫描扩展</h3>
<hr />
<p>背景:虽然类路径扫描速度非常快,但是可以通过在编译时创建一个静态候选列表来提高应用程序的启动性能.</p>

<p>首先需要先添加maven</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">dependencies</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">spring</span><span class="o">-</span><span class="n">context</span><span class="o">-</span><span class="n">indexer</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span><span class="mf">5.1</span><span class="o">.</span><span class="mi">8</span><span class="o">.</span><span class="na">RELEASE</span><span class="o">&lt;/</span><span class="n">version</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">optional</span><span class="o">&gt;</span><span class="kc">true</span><span class="o">&lt;/</span><span class="n">optional</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">dependencies</span><span class="o">&gt;</span>
</code></pre></div></div>
<p>他的作用就是在编译过程中生成一个包含jar文件的META-INF/spring.components文件.此文件中就包含应用中所有以 <strong>@Component以及以@Component为元注解</strong> 的类.
如下图所示:</p>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/spring.components示例.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="spring.components示例" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/spring.components示例.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">spring.components示例</div>
    </a>
</center>

<p>那我们可以这样使用:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ConfigurableApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">DemoApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="c1">//"META-INF/spring.components"</span>
    <span class="nc">CandidateComponentsIndex</span> <span class="n">candidateComponentsIndex</span> <span class="o">=</span> <span class="nc">CandidateComponentsIndexLoader</span><span class="o">.</span><span class="na">loadIndex</span><span class="o">(</span><span class="nc">DemoApplication</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">());</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">nonNull</span><span class="o">(</span><span class="n">candidateComponentsIndex</span><span class="o">)){</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">candidates</span> <span class="o">=</span> <span class="n">candidateComponentsIndex</span><span class="o">.</span><span class="na">getCandidateTypes</span><span class="o">(</span><span class="s">"com.hcc.example"</span><span class="o">,</span> <span class="s">"org.springframework.stereotype.Component"</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="nl">candidate:</span><span class="n">candidates</span><span class="o">){</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">candidate</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"MyComponent"</span><span class="o">)){</span>
                <span class="nc">MyComponent</span> <span class="n">myComponent</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MyComponent</span><span class="o">)</span><span class="n">context</span><span class="o">.</span><span class="na">getBeanFactory</span><span class="o">().</span><span class="na">getBean</span><span class="o">(</span><span class="s">"myComponent"</span><span class="o">);</span>
                <span class="n">myComponent</span><span class="o">.</span><span class="na">test</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>具体如果扩展就可以根据我们的需要进行了.<br />
当在类路径上找到META-INF/Spring.components时,索引将自动启用.如果某个索引部分可用于某些库(或用例),但无法为整个应用程序生成,则可以通过将spring.index.ignore设置为true(作为系统属性或类路径根目录下的spring.properties文件)来回滚到常规类路径安排(就像根本没有索引一样).</p>
<hr />
</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">SpringBoot</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">Septemper 2021</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">SpringBoot</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-20000003" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2>SpringBoot启动源码解析(三)</h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/pexels-rachel-claire-5490361.jpg" class="img-responsive img-centered" alt="SpringBoot3">

                            
                                <h3>SpringBootApplication Run方法解析(一):prepareEnvironment</h3>
                            
                            </div>

                            <p><h3 id="run方法入口主要分析prepareenvironment">Run方法入口:主要分析prepareEnvironment</h3>
<hr />
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Run the Spring application, creating and refreshing a new
 * {@link ApplicationContext}.
 * 运行Spring应用，创建和刷新一个新的应用上下文
 * @param args the application arguments (usually passed from a Java main method)
 * @return a running {@link ApplicationContext}
 */</span>
<span class="kd">public</span> <span class="nc">ConfigurableApplicationContext</span> <span class="nf">run</span><span class="o">(</span><span class="nc">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//1.创建启动计时器</span>
    <span class="nc">StopWatch</span> <span class="n">stopWatch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StopWatch</span><span class="o">();</span>
    <span class="n">stopWatch</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="c1">//创建启动上下文并初始化相应的Bootstrapper 目前暂未使用</span>
    <span class="nc">ConfigurableApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">SpringBootExceptionReporter</span><span class="o">&gt;</span> <span class="n">exceptionReporters</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="c1">//设置系统的配置模式，一般用于服务端开发 默认为true</span>
    <span class="n">configureHeadlessProperty</span><span class="o">();</span>
    <span class="c1">//获取spring上下文启动监听者  从META-INF/spring.factories中获取SpringApplicationRunListener的实现类并加载</span>
    <span class="nc">SpringApplicationRunListeners</span> <span class="n">listeners</span> <span class="o">=</span> <span class="n">getRunListeners</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
    <span class="c1">//发布启动中事件</span>
    <span class="n">listeners</span><span class="o">.</span><span class="na">starting</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">//2.创建默认上下文参数</span>
        <span class="nc">ApplicationArguments</span> <span class="n">applicationArguments</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultApplicationArguments</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
        <span class="c1">//3.准备环境，将资源属性添加到环境中并与上下文绑定</span>
        <span class="nc">ConfigurableEnvironment</span> <span class="n">environment</span> <span class="o">=</span> <span class="n">prepareEnvironment</span><span class="o">(</span><span class="n">listeners</span><span class="o">,</span> <span class="n">applicationArguments</span><span class="o">);</span>
        <span class="c1">//设置spring.beaninfo.ignore中过滤的bean</span>
        <span class="n">configureIgnoreBeanInfo</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
        <span class="c1">//打印spring标记</span>
        <span class="nc">Banner</span> <span class="n">printedBanner</span> <span class="o">=</span> <span class="n">printBanner</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
        <span class="c1">//4.根据web应用类型创建指定的应用上下文</span>
        <span class="c1">//注意:这里反射创建AnnotationConfigServletWebServerApplicationContext时,构造中创建AnnotatedBeanDefinitionReader中的AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry)方法很重要</span>
        <span class="c1">//它将几个常见的BeanPostProcessor和BeanFactoryPostProcessor注册到注册表中  最重要的是internalConfigurationAnnotationProcessor来解析Configuration的配置类</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">createApplicationContext</span><span class="o">();</span>
        <span class="n">exceptionReporters</span> <span class="o">=</span> <span class="n">getSpringFactoriesInstances</span><span class="o">(</span><span class="nc">SpringBootExceptionReporter</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                <span class="k">new</span> <span class="nc">Class</span><span class="o">[]</span> <span class="o">{</span> <span class="nc">ConfigurableApplicationContext</span><span class="o">.</span><span class="na">class</span> <span class="o">},</span> <span class="n">context</span><span class="o">);</span>
        <span class="c1">//5.准备上下文</span>
        <span class="c1">//主要做了两件事:</span>
        <span class="c1">// 1.调用前面实例化的ApplicationContextInitializer的initialize方式初始化上下文</span>
        <span class="c1">// 2.在其中的load方法中将启动主函数bean定义注册到注册表中 beanDefinitionMap</span>
        <span class="n">prepareContext</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">environment</span><span class="o">,</span> <span class="n">listeners</span><span class="o">,</span> <span class="n">applicationArguments</span><span class="o">,</span> <span class="n">printedBanner</span><span class="o">);</span>
        <span class="c1">//6.刷新上下文</span>
        <span class="n">refreshContext</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
        <span class="n">afterRefresh</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">applicationArguments</span><span class="o">);</span>
        <span class="n">stopWatch</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">logStartupInfo</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">new</span> <span class="nf">StartupInfoLogger</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mainApplicationClass</span><span class="o">).</span><span class="na">logStarted</span><span class="o">(</span><span class="n">getApplicationLog</span><span class="o">(),</span> <span class="n">stopWatch</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">//监听者发布已启动事件</span>
        <span class="n">listeners</span><span class="o">.</span><span class="na">started</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
        <span class="c1">//7.调用所有的ApplicationRunner和CommandLineRunner的实现类</span>
        <span class="n">callRunners</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">applicationArguments</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">handleRunFailure</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">ex</span><span class="o">,</span> <span class="n">exceptionReporters</span><span class="o">,</span> <span class="n">listeners</span><span class="o">);</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">//监听者发布运行中事件</span>
        <span class="n">listeners</span><span class="o">.</span><span class="na">running</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">handleRunFailure</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">ex</span><span class="o">,</span> <span class="n">exceptionReporters</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">context</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p>本章我们主要分析 <strong>prepareEnvironment</strong> 及其之前的步骤.</p>
<ol>
  <li>第一步比较好理解,创建定时器统计启动时间,并获取的事件发布者 <strong>SpringApplicationRunListener</strong> 来发布启动过程中的各个事件,首先发布的就是 <strong>starting</strong> 事件.</li>
  <li>第二步创建应用参数,默认传入的是空集合</li>
  <li>第三步创建环境实例,首先看下 <strong>ConfigurableEnvironment</strong> 相关类图</li>
</ol>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/ConfigurableEnvironment.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="ConfigurableEnvironment" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/ConfigurableEnvironment.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">ConfigurableEnvironment</div>
    </a>
</center>

<ul>
  <li>PropertyResolver: 用于针对任何基础源解析属性的接口. 主要提供解析属性和获取属性的方法.</li>
  <li>ConfigurablePropertyResolver: 提供用于访问和自定义将属性值从一种类型转换为另一种类型时使用的ConversionService的设置.</li>
  <li>Environment: 应用中表明环境的接口,主要有两个属性: <strong>profile</strong> 和 <strong>properties</strong></li>
  <li>ConfigurableEnvironment: 继承自 <strong>ConfigurablePropertyResolver</strong> 和 <strong>Environment</strong> ,所以它提供了设置profile和操作底层属性的能力.</li>
  <li>StandardEnvironment: 继承自 <strong>AbstractEnvironment</strong> 不仅提供了 <strong>ConfigurableEnvironment</strong> 的能力还提供了设置 <strong>systemEnvironment</strong> 和 <strong>systemProperties</strong> 属性源的能力.</li>
  <li>StandardServletEnvironment: 主要用于 <strong>Servlet</strong> 应用的环境,默认基本都是它.</li>
  <li>StandardReactiveWebEnvironment: 主要用于 <strong>Reactive</strong> 应用的环境,SpringBoot中是空实现.</li>
</ul>

<p>相关类及其主要功能了解后,我们在回过头来看看这个 <strong>prepareEnvironment</strong> 方法:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="nc">ConfigurableEnvironment</span> <span class="nf">prepareEnvironment</span><span class="o">(</span><span class="nc">SpringApplicationRunListeners</span> <span class="n">listeners</span><span class="o">,</span>
        <span class="nc">ApplicationArguments</span> <span class="n">applicationArguments</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Create and configure the environment</span>
    <span class="c1">//3.1根据当前应用类型创建并且配置environment 通常是StandardServletEnvironment</span>
    <span class="nc">ConfigurableEnvironment</span> <span class="n">environment</span> <span class="o">=</span> <span class="n">getOrCreateEnvironment</span><span class="o">();</span>
    <span class="c1">//3.2为环境设置属性资源和配置文件</span>
    <span class="n">configureEnvironment</span><span class="o">(</span><span class="n">environment</span><span class="o">,</span> <span class="n">applicationArguments</span><span class="o">.</span><span class="na">getSourceArgs</span><span class="o">());</span>
    <span class="c1">//3.3将已有属性以key为 configurationProperties的形式添加到属性中</span>
    <span class="nc">ConfigurationPropertySources</span><span class="o">.</span><span class="na">attach</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
    <span class="c1">//3.4发布环境准备完成通知</span>
    <span class="n">listeners</span><span class="o">.</span><span class="na">environmentPrepared</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
    <span class="c1">//3.5将environmrnt绑定到应用中</span>
    <span class="n">bindToSpringApplication</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">isCustomEnvironment</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">environment</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">EnvironmentConverter</span><span class="o">(</span><span class="n">getClassLoader</span><span class="o">()).</span><span class="na">convertEnvironmentIfNecessary</span><span class="o">(</span><span class="n">environment</span><span class="o">,</span>
                <span class="n">deduceEnvironmentClass</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="c1">//3.6 再次将已有属性以key为 configurationProperties的形式添加到属性中</span>
    <span class="nc">ConfigurationPropertySources</span><span class="o">.</span><span class="na">attach</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">environment</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>3.1 首先是创建并获取环境实例,源码如下:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="nc">ConfigurableEnvironment</span> <span class="nf">getOrCreateEnvironment</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">environment</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">switch</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">webApplicationType</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nl">SERVLET:</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">StandardServletEnvironment</span><span class="o">();</span>
    <span class="k">case</span> <span class="nl">REACTIVE:</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">StandardReactiveWebEnvironment</span><span class="o">();</span>
    <span class="k">default</span><span class="o">:</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">StandardEnvironment</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>因为我们当前应用类型是 <strong>Servlet</strong> ,所以我们需要对应就是创建 <strong>StandardServletEnvironment</strong> 实例.我们继续看下对应的构造方法:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//因为 StandardServletEnvironment extends StandardEnvironment 且 StandardEnvironment extends AbstractEnvironment</span>
<span class="c1">//我们看下父类AbstractEnvironment的构造</span>
<span class="cm">/**
 * Create a new {@code Environment} instance, calling back to
 * {@link #customizePropertySources(MutablePropertySources)} during construction to
 * allow subclasses to contribute or manipulate {@link PropertySource} instances as
 * appropriate.
 * 创建一个新的Environment实例, 在构造期间回调customizePropertySources方法以允许子类根据需要贡献或操作 PropertySource实例
 */</span>
<span class="kd">public</span> <span class="nf">AbstractEnvironment</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">customizePropertySources</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">propertySources</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">//StandardServletEnvironment中重写的customizePropertySourcesf方法</span>
<span class="cm">/** Servlet context init parameters property source name: {@value}. */</span>
<span class="c1">//Servlet上下文初始化参数属性源名称</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SERVLET_CONTEXT_PROPERTY_SOURCE_NAME</span> <span class="o">=</span> <span class="s">"servletContextInitParams"</span><span class="o">;</span>

<span class="cm">/** Servlet config init parameters property source name: {@value}. */</span>
<span class="c1">//Serlet配置初始化参数属性源名称</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SERVLET_CONFIG_PROPERTY_SOURCE_NAME</span> <span class="o">=</span> <span class="s">"servletConfigInitParams"</span><span class="o">;</span>

<span class="cm">/** JNDI property source name: {@value}. */</span>
<span class="c1">//JNDI属性源名称</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">JNDI_PROPERTY_SOURCE_NAME</span> <span class="o">=</span> <span class="s">"jndiProperties"</span><span class="o">;</span>

<span class="cm">/**
 * Customize the set of property sources with those contributed by superclasses as
 * well as those appropriate for standard servlet-based environments:
 * 使用超类提供的属性源以及适用于基于servlet的标准环境的属性源自定义一组属性源:
 * &lt;ul&gt;
 * &lt;li&gt;{@value #SERVLET_CONFIG_PROPERTY_SOURCE_NAME}
 * &lt;li&gt;{@value #SERVLET_CONTEXT_PROPERTY_SOURCE_NAME}
 * &lt;li&gt;{@value #JNDI_PROPERTY_SOURCE_NAME}
 * &lt;/ul&gt;
 */</span>
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">customizePropertySources</span><span class="o">(</span><span class="nc">MutablePropertySources</span> <span class="n">propertySources</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">propertySources</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StubPropertySource</span><span class="o">(</span><span class="no">SERVLET_CONFIG_PROPERTY_SOURCE_NAME</span><span class="o">));</span>
    <span class="n">propertySources</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StubPropertySource</span><span class="o">(</span><span class="no">SERVLET_CONTEXT_PROPERTY_SOURCE_NAME</span><span class="o">));</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">JndiLocatorDelegate</span><span class="o">.</span><span class="na">isDefaultJndiEnvironmentAvailable</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">propertySources</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">JndiPropertySource</span><span class="o">(</span><span class="no">JNDI_PROPERTY_SOURCE_NAME</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">customizePropertySources</span><span class="o">(</span><span class="n">propertySources</span><span class="o">);</span>
<span class="o">}</span>


<span class="c1">//StandardEnvironment中重写的customizePropertySources方法</span>
<span class="cm">/** System environment property source name: {@value}. */</span>
<span class="c1">//系统环境属性源名称</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME</span> <span class="o">=</span> <span class="s">"systemEnvironment"</span><span class="o">;</span>

<span class="cm">/** JVM system properties property source name: {@value}. */</span>
<span class="c1">//JVM系统属性源名称</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SYSTEM_PROPERTIES_PROPERTY_SOURCE_NAME</span> <span class="o">=</span> <span class="s">"systemProperties"</span><span class="o">;</span>

<span class="cm">/**
 * Customize the set of property sources with those appropriate for any standard
 * Java environment:
 * 使用适用于任何java标准环境的自定义属性源集合
 * &lt;ul&gt;
 * &lt;li&gt;{@value #SYSTEM_PROPERTIES_PROPERTY_SOURCE_NAME}
 * &lt;li&gt;{@value #SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME}
 * &lt;/ul&gt;
 */</span>
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">customizePropertySources</span><span class="o">(</span><span class="nc">MutablePropertySources</span> <span class="n">propertySources</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">propertySources</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span>
            <span class="k">new</span> <span class="nf">PropertiesPropertySource</span><span class="o">(</span><span class="no">SYSTEM_PROPERTIES_PROPERTY_SOURCE_NAME</span><span class="o">,</span> <span class="n">getSystemProperties</span><span class="o">()));</span>
    <span class="n">propertySources</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span>
            <span class="k">new</span> <span class="nf">SystemEnvironmentPropertySource</span><span class="o">(</span><span class="no">SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME</span><span class="o">,</span> <span class="n">getSystemEnvironment</span><span class="o">()));</span>
<span class="o">}</span>
</code></pre></div></div>
<p>可见在创建 <strong>StandardServletEnvironment</strong> 实例时根据子类重写的 <strong>customizePropertySources</strong> 方法将 <strong>servletContextInitParams</strong> 、 <strong>servletConfigInitParams</strong> 、<strong>systemEnvironment</strong> 和 <strong>systemProperties</strong> 四种属性添加到环境实例中.</p>

<p>3.2 设置环境属性资源和配置文件,源码如下</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Template method delegating to
 * {@link #configurePropertySources(ConfigurableEnvironment, String[])} and
 * {@link #configureProfiles(ConfigurableEnvironment, String[])} in that order.
 * Override this method for complete control over Environment customization, or one of
 * the above for fine-grained control over property sources or profiles, respectively.
 * 按照configurePropertySources和configureProfiles的顺序委托给他们的模板方法.
 * 覆盖此方法以完全控制环境自定义,或上述方法之一以分别对属性源或配置文件进行细粒度控制
 */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configureEnvironment</span><span class="o">(</span><span class="nc">ConfigurableEnvironment</span> <span class="n">environment</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//添加类型装换服务</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">addConversionService</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//使用双层检查创建类型转换服务单例</span>
        <span class="nc">ConversionService</span> <span class="n">conversionService</span> <span class="o">=</span> <span class="nc">ApplicationConversionService</span><span class="o">.</span><span class="na">getSharedInstance</span><span class="o">();</span>
        <span class="n">environment</span><span class="o">.</span><span class="na">setConversionService</span><span class="o">((</span><span class="nc">ConfigurableConversionService</span><span class="o">)</span> <span class="n">conversionService</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//配置属性源</span>
    <span class="n">configurePropertySources</span><span class="o">(</span><span class="n">environment</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="c1">//配置配置文件</span>
    <span class="n">configureProfiles</span><span class="o">(</span><span class="n">environment</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
<span class="o">}</span>

<span class="cm">/**
 * Return a shared default application {@code ConversionService} instance, lazily
 * building it once needed.
 * 使用懒加载的方式创建并返回一个共享的默认应用转换实例
 * 双重检查锁
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">ConversionService</span> <span class="nf">getSharedInstance</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ApplicationConversionService</span> <span class="n">sharedInstance</span> <span class="o">=</span> <span class="nc">ApplicationConversionService</span><span class="o">.</span><span class="na">sharedInstance</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">sharedInstance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="nc">ApplicationConversionService</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">sharedInstance</span> <span class="o">=</span> <span class="nc">ApplicationConversionService</span><span class="o">.</span><span class="na">sharedInstance</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">sharedInstance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sharedInstance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ApplicationConversionService</span><span class="o">();</span>
                <span class="nc">ApplicationConversionService</span><span class="o">.</span><span class="na">sharedInstance</span> <span class="o">=</span> <span class="n">sharedInstance</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">sharedInstance</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * Add, remove or re-order any {@link PropertySource}s in this application's
 * environment.
 * 在应用环境中 添加、删除或重排序任何 PropertySources
 */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configurePropertySources</span><span class="o">(</span><span class="nc">ConfigurableEnvironment</span> <span class="n">environment</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//获取当前环境实例已有的属性源</span>
    <span class="nc">MutablePropertySources</span> <span class="n">sources</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">getPropertySources</span><span class="o">();</span>
    <span class="c1">//若存在defaultProperties且不为空则添加到当前环境实例中  默认为空 直接跳过</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">defaultProperties</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="o">.</span><span class="na">defaultProperties</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">sources</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">MapPropertySource</span><span class="o">(</span><span class="s">"defaultProperties"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">defaultProperties</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="c1">//是否打开添加命令行属性  且 存在输入的参数  默认无入参 直接跳过</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">addCommandLineProperties</span> <span class="o">&amp;&amp;</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="nc">CommandLinePropertySource</span><span class="o">.</span><span class="na">COMMAND_LINE_PROPERTY_SOURCE_NAME</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">sources</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">PropertySource</span><span class="o">&lt;?&gt;</span> <span class="n">source</span> <span class="o">=</span> <span class="n">sources</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
            <span class="nc">CompositePropertySource</span> <span class="n">composite</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CompositePropertySource</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
            <span class="n">composite</span><span class="o">.</span><span class="na">addPropertySource</span><span class="o">(</span>
                    <span class="k">new</span> <span class="nf">SimpleCommandLinePropertySource</span><span class="o">(</span><span class="s">"springApplicationCommandLineArgs"</span><span class="o">,</span> <span class="n">args</span><span class="o">));</span>
            <span class="n">composite</span><span class="o">.</span><span class="na">addPropertySource</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
            <span class="n">sources</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">composite</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="n">sources</span><span class="o">.</span><span class="na">addFirst</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleCommandLinePropertySource</span><span class="o">(</span><span class="n">args</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="cm">/**
 * Configure which profiles are active (or active by default) for this application
 * environment. Additional profiles may be activated during configuration file
 * processing via the {@code spring.profiles.active} property.
 * 为该应用程序配置哪些配置文件是活动的(默认是活动的).
 * 在配置文件处理期间可以通过spring.profiles.active属性来激活其他配置文件
 */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configureProfiles</span><span class="o">(</span><span class="nc">ConfigurableEnvironment</span> <span class="n">environment</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//默认additionalProfiles 为空</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">profiles</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="k">this</span><span class="o">.</span><span class="na">additionalProfiles</span><span class="o">);</span>
    <span class="n">profiles</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">environment</span><span class="o">.</span><span class="na">getActiveProfiles</span><span class="o">()));</span>
    <span class="n">environment</span><span class="o">.</span><span class="na">setActiveProfiles</span><span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">toStringArray</span><span class="o">(</span><span class="n">profiles</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div></div>
<p>由上可见,第二步主要就是为环境实例添加转换服务 <strong>conversionService</strong> 、检查是否需要配置默认属性源和是否需要根据命令行参数配置、设置profiles.</p>

<p>3.3 第三步的源码如下:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * The name of the {@link PropertySource} {@link #attach(Environment) adapter}.
 * 属性源适配器的名称
 */</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ATTACHED_PROPERTY_SOURCE_NAME</span> <span class="o">=</span> <span class="s">"configurationProperties"</span><span class="o">;</span>

<span class="cm">/**
 * Attach a {@link ConfigurationPropertySource} support to the specified
 * {@link Environment}. Adapts each {@link PropertySource} managed by the environment
 * to a {@link ConfigurationPropertySource} and allows classic
 * {@link PropertySourcesPropertyResolver} calls to resolve using
 * {@link ConfigurationPropertyName configuration property names}.
 * 将ConfigurationPropertySource支持附加到指定的环境中.
 * 使由环境管理的每个PropertySource适应ConfigurationPropertySource, 并允许经典的PropertySourcesPropertyResolver调用使用名称解析
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">attach</span><span class="o">(</span><span class="nc">Environment</span> <span class="n">environment</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">isInstanceOf</span><span class="o">(</span><span class="nc">ConfigurableEnvironment</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">environment</span><span class="o">);</span>
    <span class="c1">//判断当前环境实例中 是否存在configurationProperties属性源</span>
    <span class="c1">//若存在且环境中属性源不等于他本身,则清除configurationProperties属性源, 并将configurationProperties属性源再次添加到sources中</span>
    <span class="c1">//如果不存在的话直接直接将configurationProperties属性源添加到sources中</span>
    <span class="nc">MutablePropertySources</span> <span class="n">sources</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ConfigurableEnvironment</span><span class="o">)</span> <span class="n">environment</span><span class="o">).</span><span class="na">getPropertySources</span><span class="o">();</span>
    <span class="nc">PropertySource</span><span class="o">&lt;?&gt;</span> <span class="n">attached</span> <span class="o">=</span> <span class="n">sources</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="no">ATTACHED_PROPERTY_SOURCE_NAME</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">attached</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">attached</span><span class="o">.</span><span class="na">getSource</span><span class="o">()</span> <span class="o">!=</span> <span class="n">sources</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">sources</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="no">ATTACHED_PROPERTY_SOURCE_NAME</span><span class="o">);</span>
        <span class="n">attached</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">attached</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">sources</span><span class="o">.</span><span class="na">addFirst</span><span class="o">(</span><span class="k">new</span> <span class="nc">ConfigurationPropertySourcesPropertySource</span><span class="o">(</span><span class="no">ATTACHED_PROPERTY_SOURCE_NAME</span><span class="o">,</span>
                <span class="k">new</span> <span class="nf">SpringConfigurationPropertySources</span><span class="o">(</span><span class="n">sources</span><span class="o">)));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>由上可见,第三步的主要作用就是为 <strong>Environment</strong> 实例配置 <strong>configurationProperties</strong> 属性源,为后面的绑定到 <strong>SpringApplication</strong> 而准备.</p>

<p>3.4 第四步就是发布环境准备就绪事件,这里有个监听器比较重要: <strong>ConfigFileApplicationListener</strong> ,我们来看下源码</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//ConfigFileApplicationListener implements EnvironmentPostProcessor, SmartApplicationListener, Ordered {</span>
<span class="c1">//先看下它的类关系, 它实现自EnvironmentPostProcessor, 即它重写的postProcessEnvironment方法</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onApplicationEvent</span><span class="o">(</span><span class="nc">ApplicationEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//当前发布的事件属于ApplicationEnvironmentPreparedEvent 继续往下周</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">event</span> <span class="k">instanceof</span> <span class="nc">ApplicationEnvironmentPreparedEvent</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">onApplicationEnvironmentPreparedEvent</span><span class="o">((</span><span class="nc">ApplicationEnvironmentPreparedEvent</span><span class="o">)</span> <span class="n">event</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">event</span> <span class="k">instanceof</span> <span class="nc">ApplicationPreparedEvent</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">onApplicationPreparedEvent</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">//可见获取的是/META-INF/spring.factories中的所有EnvironmentPostProcessor的实现类, 所以此类ConfigFileApplicationListener也在其中</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">EnvironmentPostProcessor</span><span class="o">&gt;</span> <span class="nf">loadPostProcessors</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">SpringFactoriesLoader</span><span class="o">.</span><span class="na">loadFactories</span><span class="o">(</span><span class="nc">EnvironmentPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">());</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">onApplicationEnvironmentPreparedEvent</span><span class="o">(</span><span class="nc">ApplicationEnvironmentPreparedEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//这段就比较好理解了就是使用所有EnvironmentPostProcessor的后置处理器来处理环境实例</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">EnvironmentPostProcessor</span><span class="o">&gt;</span> <span class="n">postProcessors</span> <span class="o">=</span> <span class="n">loadPostProcessors</span><span class="o">();</span>
    <span class="n">postProcessors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="nc">AnnotationAwareOrderComparator</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">postProcessors</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">EnvironmentPostProcessor</span> <span class="n">postProcessor</span> <span class="o">:</span> <span class="n">postProcessors</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">postProcessor</span><span class="o">.</span><span class="na">postProcessEnvironment</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getEnvironment</span><span class="o">(),</span> <span class="n">event</span><span class="o">.</span><span class="na">getSpringApplication</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">//具体后置处理器逻辑 其中最重要的就是加载了application.properties属性源</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">postProcessEnvironment</span><span class="o">(</span><span class="nc">ConfigurableEnvironment</span> <span class="n">environment</span><span class="o">,</span> <span class="nc">SpringApplication</span> <span class="n">application</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">addPropertySources</span><span class="o">(</span><span class="n">environment</span><span class="o">,</span> <span class="n">application</span><span class="o">.</span><span class="na">getResourceLoader</span><span class="o">());</span>
<span class="o">}</span>

<span class="cm">/**
 * Add config file property sources to the specified environment.
 * 添加配置文件属性源到指定的环境实例中 其实这里就加载了random和applcation.properties两个属性源
 */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">addPropertySources</span><span class="o">(</span><span class="nc">ConfigurableEnvironment</span> <span class="n">environment</span><span class="o">,</span> <span class="nc">ResourceLoader</span> <span class="n">resourceLoader</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//添加random属性源</span>
    <span class="nc">RandomValuePropertySource</span><span class="o">.</span><span class="na">addToEnvironment</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
    <span class="c1">//创建Loader加载器并加载属性</span>
    <span class="k">new</span> <span class="nf">Loader</span><span class="o">(</span><span class="n">environment</span><span class="o">,</span> <span class="n">resourceLoader</span><span class="o">).</span><span class="na">load</span><span class="o">();</span>
<span class="o">}</span>

<span class="nc">Loader</span><span class="o">(</span><span class="nc">ConfigurableEnvironment</span> <span class="n">environment</span><span class="o">,</span> <span class="nc">ResourceLoader</span> <span class="n">resourceLoader</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">environment</span> <span class="o">=</span> <span class="n">environment</span><span class="o">;</span>
    <span class="c1">//创建属性解析器 解析 ${}</span>
    <span class="k">this</span><span class="o">.</span><span class="na">placeholdersResolver</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PropertySourcesPlaceholdersResolver</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span> <span class="o">=</span> <span class="o">(</span><span class="n">resourceLoader</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">resourceLoader</span> <span class="o">:</span> <span class="k">new</span> <span class="nc">DefaultResourceLoader</span><span class="o">();</span>
    <span class="c1">//这里最重要,加载/META-INF/spring.factories中的PropertySourceLoader的实现类</span>
    <span class="c1">//默认是org.springframework.boot.env.PropertiesPropertySourceLoader,org.springframework.boot.env.YamlPropertySourceLoader 其实就是我们应用种配置的 .properties和 .yml配置文件</span>
    <span class="k">this</span><span class="o">.</span><span class="na">propertySourceLoaders</span> <span class="o">=</span> <span class="nc">SpringFactoriesLoader</span><span class="o">.</span><span class="na">loadFactories</span><span class="o">(</span><span class="nc">PropertySourceLoader</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">());</span>
<span class="o">}</span>

<span class="c1">//再来看下真正的load方法</span>
<span class="kt">void</span> <span class="nf">load</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">FilteredPropertySource</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">,</span> <span class="no">DEFAULT_PROPERTIES</span><span class="o">,</span> <span class="no">LOAD_FILTERED_PROPERTY</span><span class="o">,</span>
            <span class="o">(</span><span class="n">defaultProperties</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">profiles</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedList</span><span class="o">&lt;&gt;();</span>
                <span class="k">this</span><span class="o">.</span><span class="na">processedProfiles</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedList</span><span class="o">&lt;&gt;();</span>
                <span class="k">this</span><span class="o">.</span><span class="na">activatedProfiles</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="k">this</span><span class="o">.</span><span class="na">loaded</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;&gt;();</span>
                <span class="c1">//初始化Profiles 默认初始化 active-profiles 和 spring.profiles.* 包含的所有profile</span>
                <span class="n">initializeProfiles</span><span class="o">();</span>
                <span class="c1">//解析所有的profiles 这里至少有两个 null和default</span>
                <span class="k">while</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">profiles</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nc">Profile</span> <span class="n">profile</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">profiles</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">isDefaultProfile</span><span class="o">(</span><span class="n">profile</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">addProfileToEnvironment</span><span class="o">(</span><span class="n">profile</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
                    <span class="o">}</span>
                    <span class="c1">//根据指定的profile加载资源 第一次解析null 第二次解析default</span>
                    <span class="n">load</span><span class="o">(</span><span class="n">profile</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">getPositiveProfileFilter</span><span class="o">,</span>
                            <span class="n">addToLoaded</span><span class="o">(</span><span class="nl">MutablePropertySources:</span><span class="o">:</span><span class="n">addLast</span><span class="o">,</span> <span class="kc">false</span><span class="o">));</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">processedProfiles</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">profile</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">load</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">getNegativeProfileFilter</span><span class="o">,</span> <span class="n">addToLoaded</span><span class="o">(</span><span class="nl">MutablePropertySources:</span><span class="o">:</span><span class="n">addFirst</span><span class="o">,</span> <span class="kc">true</span><span class="o">));</span>
                <span class="c1">//将加载过的资源添加到环境中</span>
                <span class="n">addLoadedPropertySources</span><span class="o">();</span>
                <span class="c1">//应用激活的profiles</span>
                <span class="n">applyActiveProfiles</span><span class="o">(</span><span class="n">defaultProperties</span><span class="o">);</span>
            <span class="o">});</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">load</span><span class="o">(</span><span class="nc">Profile</span> <span class="n">profile</span><span class="o">,</span> <span class="nc">DocumentFilterFactory</span> <span class="n">filterFactory</span><span class="o">,</span> <span class="nc">DocumentConsumer</span> <span class="n">consumer</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//getSearchLocations()是获取搜索路径,默认是这个四个classpath:/,classpath:/config/,file:./,file:./config/</span>
    <span class="n">getSearchLocations</span><span class="o">().</span><span class="na">forEach</span><span class="o">((</span><span class="n">location</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="c1">//判断是否文件夹</span>
        <span class="kt">boolean</span> <span class="n">isFolder</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">names</span> <span class="o">=</span> <span class="n">isFolder</span> <span class="o">?</span> <span class="n">getSearchNames</span><span class="o">()</span> <span class="o">:</span> <span class="no">NO_SEARCH_NAMES</span><span class="o">;</span>
        <span class="c1">//具体的加载动作</span>
        <span class="n">names</span><span class="o">.</span><span class="na">forEach</span><span class="o">((</span><span class="n">name</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">load</span><span class="o">(</span><span class="n">location</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">profile</span><span class="o">,</span> <span class="n">filterFactory</span><span class="o">,</span> <span class="n">consumer</span><span class="o">));</span>
    <span class="o">});</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">load</span><span class="o">(</span><span class="nc">String</span> <span class="n">location</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">Profile</span> <span class="n">profile</span><span class="o">,</span> <span class="nc">DocumentFilterFactory</span> <span class="n">filterFactory</span><span class="o">,</span>
            <span class="nc">DocumentConsumer</span> <span class="n">consumer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">PropertySourceLoader</span> <span class="n">loader</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">propertySourceLoaders</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">canLoadFileExtension</span><span class="o">(</span><span class="n">loader</span><span class="o">,</span> <span class="n">location</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">load</span><span class="o">(</span><span class="n">loader</span><span class="o">,</span> <span class="n">location</span><span class="o">,</span> <span class="n">profile</span><span class="o">,</span> <span class="n">filterFactory</span><span class="o">.</span><span class="na">getDocumentFilter</span><span class="o">(</span><span class="n">profile</span><span class="o">),</span> <span class="n">consumer</span><span class="o">);</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"File extension of config file location '"</span> <span class="o">+</span> <span class="n">location</span>
                    <span class="o">+</span> <span class="s">"' is not known to any PropertySourceLoader. If the location is meant to reference "</span>
                    <span class="o">+</span> <span class="s">"a directory, it must end in '/'"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">processed</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
        <span class="c1">//这里的propertySourceLoaders就是前面加载的 PropertiesPropertySourceLoader和YamlPropertySourceLoader两个解析器</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">PropertySourceLoader</span> <span class="n">loader</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">propertySourceLoaders</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//每个解析器都有自己的文件后缀并解析</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">fileExtension</span> <span class="o">:</span> <span class="n">loader</span><span class="o">.</span><span class="na">getFileExtensions</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">processed</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">fileExtension</span><span class="o">))</span> <span class="o">{</span>
                    <span class="c1">//获得具体路径后在解析成properties 下面就不继续往下看了</span>
                    <span class="n">loadForFileExtension</span><span class="o">(</span><span class="n">loader</span><span class="o">,</span> <span class="n">location</span> <span class="o">+</span> <span class="n">name</span><span class="o">,</span> <span class="s">"."</span> <span class="o">+</span> <span class="n">fileExtension</span><span class="o">,</span> <span class="n">profile</span><span class="o">,</span> <span class="n">filterFactory</span><span class="o">,</span>
                            <span class="n">consumer</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>
<p>可见第四步通过发布环境准备就绪事件,所有的监听器中,最终要的就是 <strong>ConfigFileApplicationListener</strong>,通过 <strong>ConfigFileApplicationListener</strong> 来执行所有环境相关的后置处理器, 他自己本身实现了 <strong>EnvironmentPostProcessor</strong> ,通过 <strong>postProcessEnvironment</strong> 来调用 <strong>addPropertySources</strong> 方法通过 <strong>Loader</strong> 来加载配置文件属性源.
在构造 <strong>Loader</strong> 中初始化 <strong>PropertySourceLoader</strong> 的两个实现类 <strong>PropertiesPropertySourceLoader</strong> 和 <strong>YamlPropertySourceLoader</strong> 来加载 <strong>“properties”,”xml”</strong> 和 <strong>“yml”,”yaml”__的配置文件,主要通过 __getFileExtensions()</strong> 方法指定的文件扩展名分别拼接默认路径 <strong>classpath:/,classpath:/config/,file:./,file:./config/</strong> ,找到存在的路径则进行解析属性.</p>

<p>3.5 第五步将环境绑定到当前应用中</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Bind the environment to the {@link SpringApplication}.
 * 将环境实例绑定到应用中
 */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">bindToSpringApplication</span><span class="o">(</span><span class="nc">ConfigurableEnvironment</span> <span class="n">environment</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">//首先看这个Binder.get(environment):根据给定环境实例创建Binder</span>
        <span class="nc">Binder</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">environment</span><span class="o">).</span><span class="na">bind</span><span class="o">(</span><span class="s">"spring.main"</span><span class="o">,</span> <span class="nc">Bindable</span><span class="o">.</span><span class="na">ofInstance</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Cannot bind to SpringApplication"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="nc">Binder</span> <span class="nf">get</span><span class="o">(</span><span class="nc">Environment</span> <span class="n">environment</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">get</span><span class="o">(</span><span class="n">environment</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="nc">Binder</span> <span class="nf">get</span><span class="o">(</span><span class="nc">Environment</span> <span class="n">environment</span><span class="o">,</span> <span class="nc">BindHandler</span> <span class="n">defaultBindHandler</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//获取前面通过attach附加到环境实例中的ConfigurationPropertySource</span>
    <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">ConfigurationPropertySource</span><span class="o">&gt;</span> <span class="n">sources</span> <span class="o">=</span> <span class="nc">ConfigurationPropertySources</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
    <span class="c1">//根据环境创建属性源占位符解析器 即解析 ${}</span>
    <span class="nc">PropertySourcesPlaceholdersResolver</span> <span class="n">placeholdersResolver</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PropertySourcesPlaceholdersResolver</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
    <span class="c1">//创建Binder</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">Binder</span><span class="o">(</span><span class="n">sources</span><span class="o">,</span> <span class="n">placeholdersResolver</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">defaultBindHandler</span><span class="o">);</span>
<span class="o">}</span>

<span class="cm">/**
 * Return a set of {@link ConfigurationPropertySource} instances that have previously
 * been {@link #attach(Environment) attached} to the {@link Environment}.
 * 返回之前通过attached附加到环境实例中的ConfigurationPropertySource集合
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">ConfigurationPropertySource</span><span class="o">&gt;</span> <span class="nf">get</span><span class="o">(</span><span class="nc">Environment</span> <span class="n">environment</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">isInstanceOf</span><span class="o">(</span><span class="nc">ConfigurableEnvironment</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">environment</span><span class="o">);</span>
    <span class="nc">MutablePropertySources</span> <span class="n">sources</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ConfigurableEnvironment</span><span class="o">)</span> <span class="n">environment</span><span class="o">).</span><span class="na">getPropertySources</span><span class="o">();</span>
    <span class="nc">ConfigurationPropertySourcesPropertySource</span> <span class="n">attached</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ConfigurationPropertySourcesPropertySource</span><span class="o">)</span> <span class="n">sources</span>
            <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="no">ATTACHED_PROPERTY_SOURCE_NAME</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">attached</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">from</span><span class="o">(</span><span class="n">sources</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">attached</span><span class="o">.</span><span class="na">getSource</span><span class="o">();</span>
<span class="o">}</span>

<span class="c1">//通过其中的PropertyPlaceholderHelper</span>
<span class="kd">public</span> <span class="nf">PropertySourcesPlaceholdersResolver</span><span class="o">(</span><span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">PropertySource</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">sources</span><span class="o">,</span> <span class="nc">PropertyPlaceholderHelper</span> <span class="n">helper</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">sources</span> <span class="o">=</span> <span class="n">sources</span><span class="o">;</span>
    <span class="c1">//创建PropertyPlaceholderHelper来解析 ${}</span>
    <span class="k">this</span><span class="o">.</span><span class="na">helper</span> <span class="o">=</span> <span class="o">(</span><span class="n">helper</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">helper</span> <span class="o">:</span> <span class="k">new</span> <span class="nc">PropertyPlaceholderHelper</span><span class="o">(</span><span class="nc">SystemPropertyUtils</span><span class="o">.</span><span class="na">PLACEHOLDER_PREFIX</span><span class="o">,</span>
            <span class="nc">SystemPropertyUtils</span><span class="o">.</span><span class="na">PLACEHOLDER_SUFFIX</span><span class="o">,</span> <span class="nc">SystemPropertyUtils</span><span class="o">.</span><span class="na">VALUE_SEPARATOR</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="o">}</span>

<span class="cm">/**
 * Create a new {@link Binder} instance for the specified sources.
 * 通过指定的资源中创建一个新的Binder实例
 */</span>
<span class="kd">public</span> <span class="nf">Binder</span><span class="o">(</span><span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">ConfigurationPropertySource</span><span class="o">&gt;</span> <span class="n">sources</span><span class="o">,</span> <span class="nc">PlaceholdersResolver</span> <span class="n">placeholdersResolver</span><span class="o">,</span>
        <span class="nc">ConversionService</span> <span class="n">conversionService</span><span class="o">,</span> <span class="nc">Consumer</span><span class="o">&lt;</span><span class="nc">PropertyEditorRegistry</span><span class="o">&gt;</span> <span class="n">propertyEditorInitializer</span><span class="o">,</span>
        <span class="nc">BindHandler</span> <span class="n">defaultBindHandler</span><span class="o">,</span> <span class="nc">BindConstructorProvider</span> <span class="n">constructorProvider</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">sources</span><span class="o">,</span> <span class="s">"Sources must not be null"</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">sources</span> <span class="o">=</span> <span class="n">sources</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">placeholdersResolver</span> <span class="o">=</span> <span class="o">(</span><span class="n">placeholdersResolver</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">placeholdersResolver</span> <span class="o">:</span> <span class="nc">PlaceholdersResolver</span><span class="o">.</span><span class="na">NONE</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">conversionService</span> <span class="o">=</span> <span class="o">(</span><span class="n">conversionService</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">conversionService</span>
            <span class="o">:</span> <span class="nc">ApplicationConversionService</span><span class="o">.</span><span class="na">getSharedInstance</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">propertyEditorInitializer</span> <span class="o">=</span> <span class="n">propertyEditorInitializer</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">defaultBindHandler</span> <span class="o">=</span> <span class="o">(</span><span class="n">defaultBindHandler</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">defaultBindHandler</span> <span class="o">:</span> <span class="nc">BindHandler</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">constructorProvider</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">constructorProvider</span> <span class="o">=</span> <span class="nc">BindConstructorProvider</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nc">ValueObjectBinder</span> <span class="n">valueObjectBinder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ValueObjectBinder</span><span class="o">(</span><span class="n">constructorProvider</span><span class="o">);</span>
    <span class="nc">JavaBeanBinder</span> <span class="n">javaBeanBinder</span> <span class="o">=</span> <span class="nc">JavaBeanBinder</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">dataObjectBinders</span> <span class="o">=</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">unmodifiableList</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">valueObjectBinder</span><span class="o">,</span> <span class="n">javaBeanBinder</span><span class="o">));</span>
<span class="o">}</span>

<span class="c1">//具体绑定代码不贴了,嵌套层数太深后期有时间在详细分析</span>
</code></pre></div></div>
<p>可见第五步就是使用3.3新加入的 <strong>configurationProperties</strong> 属性源和 <strong>${}</strong> 占位符解析器 <strong>PropertySourcesPlaceholdersResolver</strong> 来创建 <strong>Binder</strong> .
最后在通过 <strong>Binder</strong> 来将 <strong>“spring.main”</strong> 封装的 <strong>ConfigurationProperty</strong> 和主函数 <strong>SpringApplication</strong> 进行绑定.</p>

<p>3.6 最后一步是再次将已有属性以key为 configurationProperties的形式添加到属性中</p>
<hr />

<h3 id="prepareenvironment总结">prepareEnvironment总结</h3>
<blockquote>
  <p>prepareEnvironment的作用就是将创建 Environment实例,并将各种属性资源添加到Environment中其中包括configurationProperties、servletConfigInitParams、servletContextInitParams、systemProperties、systemEnvironment、以及最重要的applicationConfig: [classpath:/application.properties],最后在通过Environment创建Binder将”spring.main”的属性源与应用SpringApplicaiton进行绑定.</p>
</blockquote>

</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">SpringBoot</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">September 2021</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">SpringBoot</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-20000002" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2>SpringBoot启动源码解析(二)</h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/pexels-irina-iriser-1122625.jpg" class="img-responsive img-centered" alt="SpringBoot2">

                            
                                <h3>SpringBootApplication构造方法分析</h3>
                            
                            </div>

                            <p><h3 id="主函数入口">主函数入口</h3>
<hr />
<p>我们首先从主函数入口一步一步往下看.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//程序主函数</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">DemoApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
<span class="o">}</span>

<span class="cm">/**
 * Static helper that can be used to run a {@link SpringApplication} from the
 * specified source using default settings.
 * 用于在一个使用默认配置的指定资源中运行 SpringApplication 的静态工具类
 * @param primarySource the primary source to load
 * @param args the application arguments (usually passed from a Java main method)
 * @return the running {@link ApplicationContext}
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">ConfigurableApplicationContext</span> <span class="nf">run</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">primarySource</span><span class="o">,</span> <span class="nc">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">run</span><span class="o">(</span><span class="k">new</span> <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="o">{</span> <span class="n">primarySource</span> <span class="o">},</span> <span class="n">args</span><span class="o">);</span>
<span class="o">}</span>

<span class="cm">/**
 * Static helper that can be used to run a {@link SpringApplication} from the
 * specified sources using default settings and user supplied arguments.
 * @param primarySources the primary sources to load
 * @param args the application arguments (usually passed from a Java main method)
 * @return the running {@link ApplicationContext}
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">ConfigurableApplicationContext</span> <span class="nf">run</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">primarySources</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">SpringApplication</span><span class="o">(</span><span class="n">primarySources</span><span class="o">).</span><span class="na">run</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>核心就是 <strong>new SpringApplication(primarySources).run(args)</strong> 这一行.<br />
我们首先分析一下  <strong>new SpringApplication(primarySources)</strong>.</p>

<h3 id="new-springapplicationprimarysources主构造">new SpringApplication(primarySources)主构造</h3>
<hr />
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Create a new {@link SpringApplication} instance. The application context will load
 * beans from the specified primary sources (see {@link SpringApplication class-level}
 * documentation for details. The instance can be customized before calling
 * {@link #run(String...)}.
 * 创建一个SpringApplication实例. 应用上下文将从指定主函数中加载bean. (这个实例可以在调用run方法前自定义)
 * @param resourceLoader the resource loader to use
 * @param primarySources the primary bean sources
 * @see #run(Class, String[])
 * @see #setSources(Set)
 */</span>
<span class="nd">@SuppressWarnings</span><span class="o">({</span> <span class="s">"unchecked"</span><span class="o">,</span> <span class="s">"rawtypes"</span> <span class="o">})</span>
<span class="kd">public</span> <span class="nf">SpringApplication</span><span class="o">(</span><span class="nc">ResourceLoader</span> <span class="n">resourceLoader</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?&gt;...</span> <span class="n">primarySources</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//1.设置类加载器</span>
    <span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span> <span class="o">=</span> <span class="n">resourceLoader</span><span class="o">;</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">primarySources</span><span class="o">,</span> <span class="s">"PrimarySources must not be null"</span><span class="o">);</span>
    <span class="c1">//2.将主函数封装成集合设置到primarySources中 可以设置多个主类</span>
    <span class="k">this</span><span class="o">.</span><span class="na">primarySources</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">primarySources</span><span class="o">));</span>
    <span class="c1">//3.判断当前应用类型 通常使用的都是WebApplicationType.SERVLET</span>
    <span class="k">this</span><span class="o">.</span><span class="na">webApplicationType</span> <span class="o">=</span> <span class="nc">WebApplicationType</span><span class="o">.</span><span class="na">deduceFromClasspath</span><span class="o">();</span>
    <span class="c1">//4.获取并实例化所有的ApplicationContextInitializer实现 主要用于在上下文刷新前进行初始化上下文</span>
    <span class="n">setInitializers</span><span class="o">((</span><span class="nc">Collection</span><span class="o">)</span> <span class="n">getSpringFactoriesInstances</span><span class="o">(</span><span class="nc">ApplicationContextInitializer</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="c1">//5.获取并实例化所有的ApplicationListener实现 主要用于监听启动过程中发布的各种事件</span>
    <span class="n">setListeners</span><span class="o">((</span><span class="nc">Collection</span><span class="o">)</span> <span class="n">getSpringFactoriesInstances</span><span class="o">(</span><span class="nc">ApplicationListener</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="c1">//6.生成main对应主函数的类</span>
    <span class="k">this</span><span class="o">.</span><span class="na">mainApplicationClass</span> <span class="o">=</span> <span class="n">deduceMainApplicationClass</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>在SpringApplication构造函数中,最重要就是步骤4和步骤5,再看下这两步其实是一样的实现,只不过加载的类不同而已.<br />
我们再仔细看看这个方法到底做了什么事情:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">getSpringFactoriesInstances</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">parameterTypes</span><span class="o">,</span> <span class="nc">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ClassLoader</span> <span class="n">classLoader</span> <span class="o">=</span> <span class="n">getClassLoader</span><span class="o">();</span>
    <span class="c1">// Use names and ensure unique to protect against duplicates</span>
    <span class="c1">//获取指定类型的实现类名称集合</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">names</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="nc">SpringFactoriesLoader</span><span class="o">.</span><span class="na">loadFactoryNames</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">));</span>
    <span class="c1">//实例化上面找到的所有实现类</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">instances</span> <span class="o">=</span> <span class="n">createSpringFactoriesInstances</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">parameterTypes</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="n">names</span><span class="o">);</span>
    <span class="c1">//根据实例的order进行排序</span>
    <span class="nc">AnnotationAwareOrderComparator</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">instances</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">instances</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p>此方法主要做的就是找到指定类型的实现类并将这些类都进行实例化.我们再来看看它是如何找到这个类的.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Load the fully qualified class names of factory implementations of the
 * given type from {@value #FACTORIES_RESOURCE_LOCATION}, using the given
 * class loader.
 * 使用给定的类加载器,从 META-INF/spring.factories中加载给定类型的工厂实现的完全限定名
 * @param factoryType the interface or abstract class representing the factory
 * @param classLoader the ClassLoader to use for loading resources; can be
 * {@code null} to use the default
 * @throws IllegalArgumentException if an error occurs while loading factory names
 * @see #loadFactories
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">loadFactoryNames</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">factoryType</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">factoryTypeName</span> <span class="o">=</span> <span class="n">factoryType</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
    <span class="k">return</span> <span class="nf">loadSpringFactories</span><span class="o">(</span><span class="n">classLoader</span><span class="o">).</span><span class="na">getOrDefault</span><span class="o">(</span><span class="n">factoryTypeName</span><span class="o">,</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">());</span>
<span class="o">}</span>

<span class="cm">/**
 * The location to look for factories.
 * 用于查询工厂的位置
 * &lt;p&gt;Can be present in multiple JAR files.
 * 可以存在于多个jar文件中
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">FACTORIES_RESOURCE_LOCATION</span> <span class="o">=</span> <span class="s">"META-INF/spring.factories"</span><span class="o">;</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="nf">loadSpringFactories</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//首先尝试从缓存中读取,因为该方法执行结束后会将配置文件中所有的信息放到缓存中,如果缓存中有直接返回</span>
    <span class="nc">MultiValueMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">classLoader</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">//读取项目中所有存在 META-INF/spring.factories的URL</span>
        <span class="nc">Enumeration</span><span class="o">&lt;</span><span class="no">URL</span><span class="o">&gt;</span> <span class="n">urls</span> <span class="o">=</span> <span class="o">(</span><span class="n">classLoader</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span>
                <span class="n">classLoader</span><span class="o">.</span><span class="na">getResources</span><span class="o">(</span><span class="no">FACTORIES_RESOURCE_LOCATION</span><span class="o">)</span> <span class="o">:</span>
                <span class="nc">ClassLoader</span><span class="o">.</span><span class="na">getSystemResources</span><span class="o">(</span><span class="no">FACTORIES_RESOURCE_LOCATION</span><span class="o">));</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedMultiValueMap</span><span class="o">&lt;&gt;();</span>
        <span class="c1">//读取每一个URL并将属性以K-V的形式保存到Properties中, 再将所有属性保存在result中</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">urls</span><span class="o">.</span><span class="na">hasMoreElements</span><span class="o">())</span> <span class="o">{</span>
            <span class="no">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="n">urls</span><span class="o">.</span><span class="na">nextElement</span><span class="o">();</span>
            <span class="nc">UrlResource</span> <span class="n">resource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UrlResource</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>
            <span class="nc">Properties</span> <span class="n">properties</span> <span class="o">=</span> <span class="nc">PropertiesLoaderUtils</span><span class="o">.</span><span class="na">loadProperties</span><span class="o">(</span><span class="n">resource</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?,</span> <span class="o">?&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">properties</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">factoryTypeName</span> <span class="o">=</span> <span class="o">((</span><span class="nc">String</span><span class="o">)</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">()).</span><span class="na">trim</span><span class="o">();</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">factoryImplementationName</span> <span class="o">:</span> <span class="nc">StringUtils</span><span class="o">.</span><span class="na">commaDelimitedListToStringArray</span><span class="o">((</span><span class="nc">String</span><span class="o">)</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">()))</span> <span class="o">{</span>
                    <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">factoryTypeName</span><span class="o">,</span> <span class="n">factoryImplementationName</span><span class="o">.</span><span class="na">trim</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">//将result保存到缓存中</span>
        <span class="n">cache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">classLoader</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Unable to load factories from location ["</span> <span class="o">+</span>
                <span class="no">FACTORIES_RESOURCE_LOCATION</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>通过代码分析发现, <strong>loadSpringFactories</strong> 的主要作用就是读取所有 <strong>META-INF/spring.factories</strong> 中的所有配置信息并保存到缓存中, 并返回指定类型的集合.<br />
现在我们已经找到指定类的所有实现类了,接下来我们就应该实例化它们.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">createSpringFactoriesInstances</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">parameterTypes</span><span class="o">,</span>
        <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">names</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">instances</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">names</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">name</span> <span class="o">:</span> <span class="n">names</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">//加载每一个class类</span>
            <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">instanceClass</span> <span class="o">=</span> <span class="nc">ClassUtils</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
            <span class="nc">Assert</span><span class="o">.</span><span class="na">isAssignable</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">instanceClass</span><span class="o">);</span>
            <span class="nc">Constructor</span><span class="o">&lt;?&gt;</span> <span class="n">constructor</span> <span class="o">=</span> <span class="n">instanceClass</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">(</span><span class="n">parameterTypes</span><span class="o">);</span>
            <span class="c1">//使用反射构造该类实例 通常采用默认构造</span>
            <span class="no">T</span> <span class="n">instance</span> <span class="o">=</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="nc">BeanUtils</span><span class="o">.</span><span class="na">instantiateClass</span><span class="o">(</span><span class="n">constructor</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
            <span class="n">instances</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">instance</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Cannot instantiate "</span> <span class="o">+</span> <span class="n">type</span> <span class="o">+</span> <span class="s">" : "</span> <span class="o">+</span> <span class="n">name</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">instances</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>如果你经常使用反射的话,这段代码就比较容易理解了,无非就是使用反射创建类实例.</p>

<h3 id="总结">总结</h3>
<hr />
<p>由上可知,在 <strong>SpringApplication</strong> 构造中主要是做了设置主函数资源、判断当前应用类型和加载并实例化所有 <strong>ApplicationContextInitializer</strong> 和 <strong>ApplicationListener</strong> 的实现类.</p>
<hr />

<h3 id="扩展">扩展</h3>
<hr />
<p>主要就是针对 <strong>ApplicationListener</strong> 和 <strong>ApplicationContextInitializer</strong> 进行扩展.两者扩展类似,那我就以 <strong>ApplicationListener</strong> 为例.</p>

<p>1.第一步肯定是自己创建一个测试类 <strong>MyApplicationListener</strong> 实现 <strong>ApplicationListener</strong> ,这里需要注意下我们需要指定需要监听的事件类型,主要类图见下<br />
2.第二步就是实现需要重写的接口,在接口中添加自己的实现,我们就简单打一行日志</p>

<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/MyApplicationListener.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="MyApplicationListener" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/MyApplicationListener.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">MyApplicationListener</div>
    </a>
</center>

<p>3.第三步也就是最重要的一步,你想想我们现在已经自己新建了类,但是应用还是无法找你的类,那么我们就应该让应用扫描到新类,这样才能在调用的时候调用我们自己重写的方法.<br />
那么就需要我们在 <strong>resources</strong> 目录下新建 <strong>META-INF/spring.factories</strong> 文件,并在该文件中指定你的实现类,这样就能让应用加载到你的类</p>

<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/spring.factories.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="spring.factories" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/spring.factories.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">spring.factories</div>
    </a>
</center>

<hr />
<p><strong>ApplicationEvent</strong> 对应子类类图如下:</p>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/ApplicationEvent.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="ApplicationEvent" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/ApplicationEvent.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">ApplicationEvent</div>
    </a>
</center>

<h3 id="spi机制">SPI机制</h3>
<hr />
<h4 id="概念">概念</h4>
<hr />
<p>其实上面的加载过程就是SPI机制,SpringBoot加以改造了一下.<br />
SPI的全名为 Service Provider Interface, 目的是提供接口,让第三方提供自定义实现的服务功能.目前不少框架使用它来做服务的扩展.</p>
<hr />

<h4 id="实现">实现</h4>
<hr />
<p>1.自定义已经接口以及其实现类</p>

<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/spi基类.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="spi基类" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/spi基类.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">spi基类</div>
    </a>
</center>

<p>2.在 <strong>META-INF/services</strong> 目录中创建以接口全限定名命名的文件,文件内容为接口具体实现的全限定名</p>

<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/services.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="META-INF/services" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/services.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">META-INF/services</div>
    </a>
</center>

<p>3.使用 __ServiceLoader.load(Class<T>)__ 类动态加载目录下的实现类</T></p>

<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/main.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="main" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/main.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">main</div>
    </a>
</center>

<p>4.具体实现类必须有一个不带参数的构造方法</p>

<hr />

</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">SpringBoot</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">September 2021</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">SpringBoot</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-10000010" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2>BinarySearch</h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/pexels-victoria-borodinova-9201864.jpg" class="img-responsive img-centered" alt="BinarySearch">

                            
                                <h3>二分查找</h3>
                            
                            </div>

                            <p><h3 id="定义">定义</h3>
<hr />
<p>二分查找也称为折半查找,它是一种效率较高的查找方法.但是它要求是线性表必须采用顺序存储结构,而且表中的元素是有序的.</p>
<hr />

<h3 id="思路">思路</h3>
<hr />
<p>例如:查找 <strong>nums</strong> 有序数组中, <strong>target</strong> 在nums中的位置</p>
<ol>
  <li>首先定义左右指针 <strong>left=0</strong> 和 <strong>right=nums.length-1</strong></li>
  <li>遍历数组,退出条件为 <strong>left&lt;=right</strong></li>
  <li>找到中间位置 <strong>mid=left+(right-left)/2</strong> ,此时 <strong>nums[0…mid-1]</strong> 的值都小于 <strong>nums[mid]</strong> , <strong>nums[mid+1…len]</strong> 的值都大于 <strong>nums[mid]</strong></li>
  <li>比较中间位置的值 <strong>nums[mid]</strong> 和 <strong>target</strong> 的值,有三种情况:
    <ul>
      <li>若 <strong>nums[mid]=target</strong> ,直接返回 <strong>mid</strong></li>
      <li>若 <strong>nums[mid]&lt;target</strong> ,中间值小于目标值,那么接下来应该在区间 <strong>[mid+1,len]</strong> 中查找,即 <strong>left=mid+1</strong></li>
      <li>若 <strong>nums[mid]&gt;target</strong> ,中间值大于目标值,那么接下来应该在区间 <strong>[0,mid-1]</strong> 中查找,即 <strong>right=mid-1</strong></li>
    </ul>
  </li>
  <li>若按步骤4没有找到,说明数组中不存在等于 <strong>target</strong> 的索引
    <hr />
  </li>
</ol>

<h3 id="遍历图解">遍历图解</h3>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binarySearch/二分查找.jpg">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="二分查找" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binarySearch/二分查找.jpg" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">二分查找</div>
    </a>
</center>

<h3 id="代码">代码</h3>
<blockquote>
  <p>java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">binarySearch</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">array</span><span class="o">,</span> <span class="kt">int</span> <span class="n">target</span><span class="o">){</span>
    <span class="kt">int</span> <span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">right</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="na">length</span><span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">left</span> <span class="o">&lt;=</span> <span class="n">right</span><span class="o">){</span>
        <span class="kt">int</span> <span class="n">mid</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="o">(</span><span class="n">right</span><span class="o">-</span><span class="n">left</span><span class="o">)/</span><span class="mi">2</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">array</span><span class="o">[</span><span class="n">mid</span><span class="o">]</span> <span class="o">==</span> <span class="n">target</span><span class="o">){</span>
            <span class="k">return</span> <span class="n">mid</span><span class="o">;</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">array</span><span class="o">[</span><span class="n">mid</span><span class="o">]</span> <span class="o">&lt;</span> <span class="n">target</span><span class="o">){</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">array</span><span class="o">[</span><span class="n">mid</span><span class="o">]</span> <span class="o">&gt;</span> <span class="n">target</span><span class="o">){</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>时间复杂度:O(logn)<br />
空间复杂度为:O(1)</p>
</blockquote>

<h3 id="扩展">扩展</h3>
<hr />
<p>正常遇到的二分查找一般不会这么简单.我们还需要了解一些二分查找的扩展.<br />
例如给定的数组中有多个重复元素,那么我们如何找出给定 <strong>target</strong> 的最左或最右索引位置.<br />
整体逻辑同二分查找类似, 不同点在于:</p>
<ol>
  <li>退出循环条件, <strong>left&lt;right</strong></li>
  <li>当 <strong>nums[mid]&gt;target</strong> ,直接将 <strong>mid</strong> 赋值给 <strong>right</strong></li>
  <li>当 <strong>nums[mid]==target</strong> 时,有两种情况:
    <ul>
      <li>若取最左位置,则继续向左搜索,即限制右指针, <strong>right=mid</strong></li>
      <li>若取最右位置,则继续向右搜索,即限制左指针, <strong>left=mid+1</strong></li>
    </ul>
  </li>
</ol>

<blockquote>
  <p>java代码</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">binarySearchLeft</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">array</span><span class="o">,</span> <span class="kt">int</span> <span class="n">target</span><span class="o">){</span>
    <span class="kt">int</span> <span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">right</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">left</span> <span class="o">&lt;</span> <span class="n">right</span><span class="o">){</span>
        <span class="kt">int</span> <span class="n">mid</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="o">(</span><span class="n">right</span><span class="o">-</span><span class="n">left</span><span class="o">)/</span><span class="mi">2</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">array</span><span class="o">[</span><span class="n">mid</span><span class="o">]</span> <span class="o">==</span> <span class="n">target</span><span class="o">){</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">mid</span><span class="o">;</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">array</span><span class="o">[</span><span class="n">mid</span><span class="o">]</span> <span class="o">&lt;</span> <span class="n">target</span><span class="o">){</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">+</span><span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">array</span><span class="o">[</span><span class="n">mid</span><span class="o">]</span> <span class="o">&gt;</span> <span class="n">target</span><span class="o">){</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">mid</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">left</span> <span class="o">==</span> <span class="n">array</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="k">return</span> <span class="n">array</span><span class="o">[</span><span class="n">left</span><span class="o">]</span> <span class="o">==</span> <span class="n">target</span><span class="o">?</span> <span class="n">left</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">binarySearchRight</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">array</span><span class="o">,</span> <span class="kt">int</span> <span class="n">target</span><span class="o">){</span>
    <span class="kt">int</span> <span class="n">left</span> <span class="o">=</span><span class="mi">0</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">right</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">left</span><span class="o">&lt;</span><span class="n">right</span><span class="o">){</span>
        <span class="kt">int</span> <span class="n">mid</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="o">(</span><span class="n">right</span><span class="o">-</span><span class="n">left</span><span class="o">)/</span><span class="mi">2</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">array</span><span class="o">[</span><span class="n">mid</span><span class="o">]</span> <span class="o">==</span> <span class="n">target</span><span class="o">){</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">mid</span><span class="o">+</span><span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">array</span><span class="o">[</span><span class="n">mid</span><span class="o">]</span> <span class="o">&lt;</span> <span class="n">target</span><span class="o">){</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">mid</span><span class="o">+</span><span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">array</span><span class="o">[</span><span class="n">mid</span><span class="o">]</span> <span class="o">&gt;</span> <span class="n">target</span><span class="o">){</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">mid</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">left</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="k">return</span> <span class="n">array</span><span class="o">[</span><span class="n">left</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span> <span class="o">==</span> <span class="n">target</span><span class="o">?</span> <span class="n">left</span><span class="o">-</span><span class="mi">1</span><span class="o">:-</span><span class="mi">1</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="其他语言">其他语言</h3>
<hr />
<blockquote>
  <p>C++</p>
</blockquote>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">public:</span>
	<span class="kt">int</span> <span class="nf">binarySearch</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">nums</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">right</span> <span class="o">=</span> <span class="n">nums</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">left</span><span class="o">&lt;=</span><span class="n">right</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">mid</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="p">(</span><span class="n">right</span> <span class="o">-</span> <span class="n">left</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nums</span><span class="p">[</span><span class="n">mid</span><span class="p">]</span><span class="o">==</span><span class="n">target</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">return</span> <span class="n">mid</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nums</span><span class="p">[</span><span class="n">mid</span><span class="p">]</span><span class="o">&gt;</span><span class="n">target</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">right</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">left</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="err">}</span><span class="p">;</span>
</code></pre></div></div>
<blockquote>
  <p>python3</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">binarySearch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nums</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">target</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span><span class="nb">int</span><span class="p">:</span>
    <span class="n">left</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">right</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">while</span> <span class="n">left</span><span class="o">&lt;=</span><span class="n">right</span><span class="p">:</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="n">left</span><span class="o">+</span><span class="p">(</span><span class="n">right</span><span class="o">-</span><span class="n">left</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">nums</span><span class="p">[</span><span class="n">mid</span><span class="p">]</span><span class="o">==</span><span class="n">target</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mid</span>
        <span class="k">elif</span> <span class="n">nums</span><span class="p">[</span><span class="n">mid</span><span class="p">]</span><span class="o">&gt;</span><span class="n">target</span><span class="p">:</span>
            <span class="n">right</span><span class="o">=</span><span class="n">mid</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">left</span><span class="o">=</span><span class="n">mid</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
</code></pre></div></div>
<blockquote>
  <p>go</p>
</blockquote>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">binarySearch</span><span class="p">(</span><span class="n">nums</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">target</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="n">left</span><span class="o">:=</span><span class="m">0</span>
	<span class="n">right</span><span class="o">:=</span><span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span><span class="o">-</span><span class="m">1</span>
	<span class="k">for</span> <span class="n">left</span><span class="o">&lt;=</span><span class="n">right</span> <span class="p">{</span>
		<span class="n">mid</span> <span class="o">:=</span><span class="n">left</span><span class="o">+</span><span class="p">(</span><span class="n">right</span><span class="o">-</span><span class="n">left</span><span class="p">)</span><span class="o">/</span><span class="m">2</span>
		<span class="k">if</span> <span class="n">nums</span><span class="p">[</span><span class="n">mid</span><span class="p">]</span><span class="o">==</span><span class="n">target</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">mid</span>
		<span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="n">nums</span><span class="p">[</span><span class="n">mid</span><span class="p">]</span><span class="o">&gt;</span><span class="n">target</span> <span class="p">{</span>
			<span class="n">right</span> <span class="o">=</span> <span class="n">mid</span><span class="o">-</span><span class="m">1</span>
		<span class="p">}</span><span class="k">else</span> <span class="p">{</span>
			<span class="n">left</span> <span class="o">=</span> <span class="n">mid</span><span class="o">+</span><span class="m">1</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="m">1</span>
<span class="p">}</span>
</code></pre></div></div>
</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">Search</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">April 2021</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">algorithm</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-10000011" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2>BinarySearchTree</h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/pexels-julia-volk-5273316.jpg" class="img-responsive img-centered" alt="BinarySearchTree">

                            
                                <h3>二查叉找树</h3>
                            
                            </div>

                            <p><h3 id="定义">定义</h3>
<hr />
<p>二叉查找树(BinarySearchTree,简称BST)又称为二叉排序树(BinarySortTree).<br />
一棵二叉查找树是一棵二叉树,其中每个节点都含有一个 <strong>Comparable</strong> 的键(以及相关联的值)且每个节点的键都大于等于其左子树中的任意节点而小于右子树的任意节点.</p>
<hr />

<h3 id="基本实现">基本实现</h3>
<hr />
<ol>
  <li>
    <p>数据表示</p>

    <p>和链表一样,我们嵌套定义了一个所有类来表示二叉查找树上的一个节点.每个节点都含有一个键、一个值、一条左链接、一条右链接和一个节点计数器.左链接指向一棵由小于该节点的所有键组成的二叉树,右链接指向一棵由大于该节点的所有键组成的二叉查找树.变量 <strong>N</strong> 给出了以该节点为根的子树的节点总数.<br />
 一棵二叉查找树代表了一组键(及其相应的值)的集合,而同一个集合可以用多棵不同的二叉查找树表示.如果我们将一棵二叉查找树的所有键投影到一条直线上,保证一个节点的左子树中的键出现在它的左边,右子树中的键出现在它的右边,那么我们一定可以得到一条有序的键列.</p>
    <center>
     <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binarySearchTree/两棵能够表示同一组键的二叉查找树.png">
     <img style="border-radius: 0.3125em;
     box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="两棵能够表示同一组键的二叉查找树" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binarySearchTree/两棵能够表示同一组键的二叉查找树.png" />
     <div style="color:orange; border-bottom: 1px solid #d9d9d9;
     display: inline-block;
     color: #999;
     padding: 2px;">两棵能够表示同一组键的二叉查找树</div>
     </a>
 </center>
  </li>
  <li>
    <p>查找 <br />
 在二叉查找树中查找一个键的递归算法:如果树是空的,则查找未命中;如果被查找的键和根节点的键相等,则查找命中,否则我们就递归的在适当的子树中继续查找.如果被查找的键较小就选择左子树,较大则选择右子树.</p>

    <center>
     <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binarySearchTree/二叉查找树中的查找命中(左)和未命中(右).png">
     <img style="border-radius: 0.3125em;
     box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="二叉查找树中的查找命中(左)和未命中(右)" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binarySearchTree/二叉查找树中的查找命中(左)和未命中(右).png" />
     <div style="color:orange; border-bottom: 1px solid #d9d9d9;
     display: inline-block;
     color: #999;
     padding: 2px;">二叉查找树中的查找命中(左)和未命中(右)</div>
     </a>
 </center>
  </li>
  <li>
    <p>插入 <br />
 如果树是空的,就返回一个含有该键值对的新节点;如果被查找的键小于根节点的键,会继续在左子树中插入该键,否则在右子树中插入该键.</p>

    <center>
     <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binarySearchTree/二叉查找树的插入操作.png">
     <img style="border-radius: 0.3125em;
     box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="二叉查找树的插入操作" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binarySearchTree/二叉查找树的插入操作.png" />
     <div style="color:orange; border-bottom: 1px solid #d9d9d9;
     display: inline-block;
     color: #999;
     padding: 2px;">二叉查找树的插入操作</div>
     </a>
 </center>
  </li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BST</span><span class="o">&lt;</span><span class="nc">Key</span> <span class="kd">extends</span> <span class="nc">Comparable</span><span class="o">&lt;</span><span class="nc">Key</span><span class="o">&gt;,</span> <span class="nc">Value</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Node</span> <span class="n">root</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">Node</span><span class="o">{</span>
        <span class="kd">private</span> <span class="nc">Key</span> <span class="n">key</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">Value</span> <span class="n">value</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">Node</span> <span class="n">left</span><span class="o">,</span><span class="n">right</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="no">N</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Node</span><span class="o">(</span><span class="nc">Key</span> <span class="n">key</span><span class="o">,</span> <span class="nc">Value</span> <span class="n">value</span><span class="o">,</span> <span class="kt">int</span> <span class="no">N</span><span class="o">){</span>
            <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">value</span><span class="o">=</span><span class="n">value</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">N</span> <span class="o">=</span> <span class="no">N</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">(){</span>
        <span class="k">return</span> <span class="nf">size</span><span class="o">(</span><span class="n">root</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">(</span><span class="nc">Node</span> <span class="n">x</span><span class="o">){</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">x</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">else</span> <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="na">N</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Value</span> <span class="nf">get</span><span class="o">(</span><span class="nc">Key</span> <span class="n">key</span><span class="o">){</span>
        <span class="k">return</span> <span class="nf">get</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Value</span> <span class="nf">get</span><span class="o">(</span><span class="nc">Node</span> <span class="n">x</span><span class="o">,</span><span class="nc">Key</span> <span class="n">key</span><span class="o">){</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">x</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">cmp</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">key</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cmp</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">)</span> <span class="k">return</span> <span class="n">get</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">left</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">cmp</span><span class="o">&gt;</span><span class="mi">0</span><span class="o">)</span> <span class="k">return</span> <span class="n">get</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">right</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
        <span class="k">else</span> <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">put</span><span class="o">(</span><span class="nc">Key</span> <span class="n">key</span><span class="o">,</span> <span class="nc">Value</span> <span class="n">value</span><span class="o">){</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">put</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Node</span> <span class="nf">put</span><span class="o">(</span><span class="nc">Node</span> <span class="n">x</span><span class="o">,</span> <span class="nc">Key</span> <span class="n">key</span><span class="o">,</span> <span class="nc">Value</span> <span class="n">value</span><span class="o">){</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">x</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">cmp</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">key</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cmp</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">)</span> <span class="n">x</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">put</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">left</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">cmp</span><span class="o">&gt;</span><span class="mi">0</span><span class="o">)</span> <span class="n">x</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">put</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">right</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
        <span class="k">else</span> <span class="n">x</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="n">x</span><span class="o">.</span><span class="na">N</span> <span class="o">=</span> <span class="n">size</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">left</span><span class="o">)</span> <span class="o">+</span> <span class="n">size</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">right</span><span class="o">)</span> <span class="o">+</span><span class="mi">1</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<hr />
<h3 id="分析">分析</h3>
<hr />
<p>使用二叉查找树的算法运行时间取决于树的形状,而树的形状取决于键被插入的先后顺序.在最好的情况下,一棵含有 <strong>N</strong> 个节点的树是完全平衡的,每条空链接和根节点的距离都为 <strong>lgN</strong> .在最坏的情况下,搜索路径上可能有 <strong>N</strong> 个节点.</p>

<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binarySearchTree/二叉查找树的可能形状.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="二叉查找树的可能形状" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binarySearchTree/二叉查找树的可能形状.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">二叉查找树的可能形状</div>
    </a>
</center>
<hr />

<h3 id="有序性相关的方法与删除操作">有序性相关的方法与删除操作</h3>
<hr />
<p>二叉查找树得以广泛应用的一个重要原因就是它能够保持键的有序性,因此它可以作为实现有序符号表API中众多方法的基础.</p>

<ol>
  <li>
    <p>最大键和最小键<br />
 最小键:如果根节点的左链接为空,那么一棵二叉查找树中最小的键就是根节点;如果左链接非空,那么树中最小键就是左子树中的最小键.见下方min()方法的递归实现<br />
 最大键:如果根节点的右链接为空,那么一棵二叉查找树中最大的键就是根节点;如果右链接非空,那么树中最大键就是右子树中的最大键.见下方max()方法的递归实现</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kd">public</span> <span class="nc">Key</span> <span class="nf">min</span><span class="o">()</span>
 <span class="o">{</span>
     <span class="k">return</span> <span class="nf">min</span><span class="o">(</span><span class="n">root</span><span class="o">).</span><span class="na">key</span><span class="o">;</span>
 <span class="o">}</span>
    
 <span class="kd">private</span> <span class="nc">Node</span> <span class="nf">min</span><span class="o">(</span><span class="nc">Node</span> <span class="n">x</span><span class="o">)</span>
 <span class="o">{</span>
     <span class="k">if</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">left</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="n">x</span><span class="o">;</span>
     <span class="k">return</span> <span class="nf">min</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">left</span><span class="o">);</span>
 <span class="o">}</span>
    
 <span class="kd">public</span> <span class="nc">Key</span> <span class="nf">max</span><span class="o">()</span>
 <span class="o">{</span>
     <span class="k">return</span> <span class="nf">max</span><span class="o">(</span><span class="n">root</span><span class="o">).</span><span class="na">key</span><span class="o">;</span>
 <span class="o">}</span>
    
 <span class="kd">private</span> <span class="nc">Node</span> <span class="nf">max</span><span class="o">(</span><span class="nc">Node</span> <span class="n">x</span><span class="o">)</span>
 <span class="o">{</span>
     <span class="k">if</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">right</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="n">x</span><span class="o">;</span>
     <span class="k">return</span> <span class="nf">max</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">right</span><span class="o">);</span>
 <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>向上取整和向下取整<br />
 向下取整: 如果给定的键 <strong>key</strong> 小于二叉查找树的根节点的键,那么小于等于 <strong>key</strong> 的最大键 <strong>floor(key)</strong> 一定在根节点的左子树中;如果给定的键 <strong>key</strong> 大于二叉查找树的根节点,那么只有当根节点右子树中存在小于等于 <strong>key</strong> 的节点时,小于等于 <strong>key</strong> 的最大键才会出现在右子树中,否则根节点就是小于等于 <strong>key</strong> 的最大键.<br />
 向上取整: 将向下取整中的 左变为右(同时将小于变为大于)就能得到 <strong>ceiling()</strong> 的算法.</p>

    <center>
     <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binarySearchTree/向下取整图解.png">
     <img style="border-radius: 0.3125em;
     box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="向下取整图解" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binarySearchTree/向下取整图解.png" />
     <div style="color:orange; border-bottom: 1px solid #d9d9d9;
     display: inline-block;
     color: #999;
     padding: 2px;">向下取整图解</div>
     </a>
 </center>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kd">public</span> <span class="nc">Key</span> <span class="nf">floor</span><span class="o">(</span><span class="nc">Key</span> <span class="n">key</span><span class="o">)</span>
 <span class="o">{</span>
     <span class="nc">Node</span> <span class="n">x</span> <span class="o">=</span> <span class="n">floor</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">x</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
     <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="na">key</span><span class="o">;</span>
 <span class="o">}</span>
    
 <span class="kd">public</span> <span class="nc">Node</span> <span class="nf">floor</span><span class="o">(</span><span class="nc">Node</span> <span class="n">x</span><span class="o">,</span> <span class="nc">Key</span> <span class="n">key</span><span class="o">)</span>
 <span class="o">{</span>
     <span class="k">if</span><span class="o">(</span><span class="n">x</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
     <span class="kt">int</span> <span class="n">cmp</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">key</span><span class="o">);</span>
     <span class="k">if</span><span class="o">(</span><span class="n">cmp</span><span class="o">==</span><span class="mi">0</span><span class="o">)</span> <span class="k">return</span> <span class="n">x</span><span class="o">;</span>
     <span class="k">if</span><span class="o">(</span><span class="n">cmp</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">)</span> <span class="k">return</span> <span class="n">floot</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">left</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
     <span class="nc">Node</span> <span class="n">t</span> <span class="o">=</span> <span class="n">floot</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">right</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
     <span class="k">if</span><span class="o">(</span><span class="n">t</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
         <span class="k">return</span> <span class="n">t</span><span class="o">;</span>
     <span class="o">}</span><span class="k">else</span><span class="o">{</span>
         <span class="k">return</span> <span class="n">x</span><span class="o">;</span>
     <span class="o">}</span> 
 <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>选择操作<br />
 在二叉查找树的每个节点中维护的子树节点计数器变量N就是用来支持此操作的.<br />
 假设我们想找到排名为k的键(即树中正好有k个小于它的键).有如下三种情况:
    <ul>
      <li>如果左子树中的节点数t大于k,那么我们就继续递归在左子树中查找排名为k的键;</li>
      <li>如果t等于k,就返回根节点中的键;</li>
      <li>如果t小于k,就递归的在右子树中查找排名为 <strong>k-t-1</strong> 的键.</li>
    </ul>

    <center>
     <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binarySearchTree/二叉查找树中的select()操作.png">
     <img style="border-radius: 0.3125em;
     box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="二叉查找树中的select()操作" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binarySearchTree/二叉查找树中的select()操作.png" />
     <div style="color:orange; border-bottom: 1px solid #d9d9d9;
     display: inline-block;
     color: #999;
     padding: 2px;">二叉查找树中的select()操作</div>
     </a>
 </center>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kd">public</span> <span class="nc">Key</span> <span class="nf">select</span><span class="o">(</span><span class="kt">int</span> <span class="n">k</span><span class="o">){</span>
     <span class="k">return</span> <span class="nf">select</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">k</span><span class="o">).</span><span class="na">key</span><span class="o">;</span>
 <span class="o">}</span>
    
 <span class="kd">public</span> <span class="nc">Node</span> <span class="nf">select</span><span class="o">(</span><span class="nc">Node</span> <span class="n">x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">k</span><span class="o">){</span>
     <span class="k">if</span><span class="o">(</span><span class="n">x</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
     <span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="n">size</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">left</span><span class="o">);</span>
     <span class="k">if</span><span class="o">(</span><span class="n">t</span><span class="o">&gt;</span><span class="n">k</span><span class="o">)</span> <span class="k">return</span> <span class="n">select</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">left</span><span class="o">,</span> <span class="n">k</span><span class="o">);</span>
     <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">t</span><span class="o">&lt;</span><span class="n">k</span><span class="o">)</span> <span class="k">return</span> <span class="n">select</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">right</span><span class="o">,</span> <span class="n">k</span><span class="o">-</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="o">);</span>
     <span class="k">else</span> <span class="k">return</span> <span class="n">x</span><span class="o">;</span>
 <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>排名<br />
 rank()是select()的逆方法,它会返回给定键的排名.它的实现和select()类似.<br />
 如果给定的键和根节点的键相等,我们返回左子树中的节点总数t;<br />
 如果给定的键小于根节点,我们会返回该键在左子树中的排名;<br />
 如果给定的键大于根节点,我们会返回t+1(根节点)加上它在右子树中的排名.</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kd">public</span> <span class="kt">int</span> <span class="nf">rank</span><span class="o">(</span><span class="kt">int</span> <span class="n">k</span><span class="o">){</span>
     <span class="k">return</span> <span class="nf">rank</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">k</span><span class="o">);</span>
 <span class="o">}</span>
    
 <span class="kd">public</span> <span class="kt">int</span> <span class="nf">rank</span><span class="o">(</span><span class="nc">Node</span> <span class="n">x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">k</span><span class="o">){</span>
     <span class="k">if</span><span class="o">(</span><span class="n">x</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
     <span class="kt">int</span> <span class="n">cmp</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">key</span><span class="o">);</span>
     <span class="k">if</span><span class="o">(</span><span class="n">cmp</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">)</span> <span class="k">return</span> <span class="n">rank</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">left</span><span class="o">,</span> <span class="n">k</span><span class="o">);</span>
     <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">cmp</span> <span class="o">&gt;</span><span class="mi">0</span><span class="o">)</span> <span class="k">return</span> <span class="mi">1</span><span class="o">+</span><span class="n">size</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">left</span><span class="o">,</span> <span class="n">k</span><span class="o">)+</span><span class="n">rank</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">right</span><span class="o">,</span> <span class="n">k</span><span class="o">);</span>
     <span class="k">else</span> <span class="k">return</span> <span class="nf">size</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">left</span><span class="o">);</span>
 <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>删除最大键和删除最小键<br />
 我们要不断深入根节点的左子树直到遇到一个空链接,然后将指向该节点的连接指向该节点的右子树(只需要在递归调用中返回它的右链接即可).<br />
 此时已经没有任何链接指向要被删除的节点,因此它会被垃圾收集器清理掉.然后在更新它到根节点的路径上所有计数器的值.<br />
 deleteMax()方法的实现和deleteMin()完全类似.</p>

    <center>
     <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binarySearchTree/删除二叉查找树中的最小结点.png">
     <img style="border-radius: 0.3125em;
     box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="删除二叉查找树中的最小结点" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binarySearchTree/删除二叉查找树中的最小结点.png" />
     <div style="color:orange; border-bottom: 1px solid #d9d9d9;
     display: inline-block;
     color: #999;
     padding: 2px;">删除二叉查找树中的最小结点</div>
     </a>
 </center>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteMin</span><span class="o">(){</span>
     <span class="n">root</span> <span class="o">=</span> <span class="n">deleteMin</span><span class="o">(</span><span class="n">root</span><span class="o">);</span>
 <span class="o">}</span>

 <span class="kd">private</span> <span class="nc">Node</span> <span class="nf">deleteMin</span><span class="o">(</span><span class="nc">Node</span> <span class="n">x</span><span class="o">){</span>
     <span class="k">if</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">left</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="na">right</span><span class="o">;</span>
     <span class="n">x</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">deleteMin</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">left</span><span class="o">);</span>
     <span class="n">x</span><span class="o">.</span><span class="na">N</span> <span class="o">=</span> <span class="n">size</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">left</span><span class="o">)+</span><span class="n">size</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">right</span><span class="o">)+</span><span class="mi">1</span><span class="o">;</span>
     <span class="k">return</span> <span class="n">x</span><span class="o">;</span>
 <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>删除操作<br />
 我们可以用类似的方式删除任意只有一个子节点或者没有子节点的节点,但应该如何删除一个拥有两个子节点的节点呢?<br />
 删除之后我们要处理两棵子树,但被删除节点的父节点只有一条空出来的链接.<br />
 在删除节点x后用它的后继节点填补它的位置.因为x有一个右节点,因此它的后继节点就是其右子树的最小节点.这样的替换仍然能够保证树的有序性,因为x.key和它的后继节点的键之间不存在其他的键.<br />
 我们能够用4个简单的步骤完成将x替换为它的后继节点的任务.
    <ul>
      <li>将指向即将被删除的节点的链接保存为t</li>
      <li>将x指向它的后继节点 <strong>min(t.right)</strong></li>
      <li>将x的右链接(原本指向一棵所有节点都大于x.key的二叉查找树)指向 <strong>deleteMin(t.right)</strong> ,也就是在删除后所有节点仍然大于x.key的子二叉查找树</li>
      <li>将x的左链接(本为空)设为t.left(其下所有的键都小于被删除节点和它的后继节点)</li>
    </ul>

    <center>
     <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binarySearchTree/二叉查找树中的删除操作.png">
     <img style="border-radius: 0.3125em;
     box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="二叉查找树中的删除操作" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binarySearchTree/二叉查找树中的删除操作.png" />
     <div style="color:orange; border-bottom: 1px solid #d9d9d9;
     display: inline-block;
     color: #999;
     padding: 2px;">二叉查找树中的删除操作</div>
     </a>
 </center>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="nc">Key</span> <span class="n">key</span><span class="o">){</span>
     <span class="n">root</span> <span class="o">=</span> <span class="n">delete</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
 <span class="o">}</span>
    
 <span class="kd">private</span> <span class="nc">Node</span> <span class="nf">delete</span><span class="o">(</span><span class="nc">Node</span> <span class="n">x</span><span class="o">,</span> <span class="nc">Key</span> <span class="n">key</span><span class="o">){</span>
     <span class="k">if</span><span class="o">(</span><span class="n">x</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
     <span class="kt">int</span> <span class="n">cmp</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">key</span><span class="o">);</span>
     <span class="k">if</span><span class="o">(</span><span class="n">cmp</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">)</span> <span class="n">x</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">delete</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">left</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
     <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">cmp</span><span class="o">&gt;</span><span class="mi">0</span><span class="o">)</span> <span class="n">x</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">delete</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">right</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
     <span class="k">else</span><span class="o">{</span>
         <span class="k">if</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">right</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="na">left</span><span class="o">;</span>
         <span class="k">if</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">left</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="na">right</span><span class="o">;</span>
         <span class="nc">Node</span> <span class="n">t</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
         <span class="n">x</span> <span class="o">=</span> <span class="n">min</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">right</span><span class="o">);</span>
         <span class="n">x</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">deleteMin</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">right</span><span class="o">);</span>
         <span class="n">x</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">left</span><span class="o">;</span>
     <span class="o">}</span>
     <span class="n">x</span><span class="o">.</span><span class="na">N</span> <span class="o">=</span> <span class="n">size</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">left</span><span class="o">)+</span><span class="n">size</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">right</span><span class="o">)+</span><span class="mi">1</span><span class="o">;</span>
     <span class="k">return</span> <span class="n">x</span><span class="o">;</span>
 <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>范围查找</p>

    <p>首先需要一个遍历二叉查找树的基本方法,叫做中序遍历.即左-&gt;根-&gt;右。
 使用队列Queue,将所有落在给定范围内的键加入一个队列Queue并跳过那些不可能含有所查找键的子树.<br />
 为了确保以给定节点为根的子树中所有在指定范围内的键加入队列,我们会递归地查找根节点的左子树,然后查找根节点,然后递归地查找根节点的右子树.</p>

    <center>
     <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binarySearchTree/二叉查找树的范围查找.png">
     <img style="border-radius: 0.3125em;
     box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="二叉查找树的范围查找" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binarySearchTree/二叉查找树的范围查找.png" />
     <div style="color:orange; border-bottom: 1px solid #d9d9d9;
     display: inline-block;
     color: #999;
     padding: 2px;">二叉查找树的范围查找</div>
     </a>
 </center>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kd">public</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">Key</span><span class="o">&gt;</span> <span class="nf">keys</span><span class="o">(){</span>
     <span class="k">return</span> <span class="nf">keys</span><span class="o">(</span><span class="n">min</span><span class="o">(),</span> <span class="n">max</span><span class="o">());</span>
 <span class="o">}</span>
    
 <span class="kd">public</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">Key</span><span class="o">&gt;</span> <span class="nf">keys</span><span class="o">(</span><span class="nc">Key</span> <span class="n">lo</span><span class="o">,</span> <span class="nc">Key</span> <span class="n">hi</span><span class="o">){</span>
     <span class="nc">Queue</span><span class="o">&lt;</span><span class="nc">Key</span><span class="o">&gt;</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Queue</span><span class="o">&lt;</span><span class="nc">Key</span><span class="o">&gt;();</span>
     <span class="n">keys</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="n">queue</span><span class="o">,</span> <span class="n">lo</span><span class="o">,</span> <span class="n">hi</span><span class="o">);</span>
     <span class="k">return</span> <span class="n">queue</span><span class="o">;</span>
 <span class="o">}</span>
    
 <span class="kd">private</span> <span class="kt">void</span> <span class="nf">keys</span><span class="o">(</span><span class="nc">Node</span> <span class="n">x</span><span class="o">,</span> <span class="nc">Queue</span><span class="o">&lt;</span><span class="nc">Key</span><span class="o">&gt;</span> <span class="n">queue</span><span class="o">,</span> <span class="nc">Key</span> <span class="n">lo</span><span class="o">,</span> <span class="nc">Key</span> <span class="n">hi</span><span class="o">){</span>
     <span class="k">if</span><span class="o">(</span><span class="n">x</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span>
     <span class="kt">int</span> <span class="n">cmplo</span> <span class="o">=</span> <span class="n">lo</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">key</span><span class="o">);</span>
     <span class="kt">int</span> <span class="n">cmphi</span> <span class="o">=</span> <span class="n">hi</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">key</span><span class="o">);</span>
     <span class="k">if</span><span class="o">(</span><span class="n">cmp</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">)</span> <span class="n">keys</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">left</span><span class="o">,</span> <span class="n">queue</span><span class="o">,</span> <span class="n">lo</span><span class="o">,</span> <span class="n">hi</span><span class="o">);</span>
     <span class="k">if</span><span class="o">(</span><span class="n">cmplo</span><span class="o">&lt;=</span><span class="mi">0</span> <span class="o">&amp;&amp;</span><span class="n">cmphi</span><span class="o">&gt;=</span><span class="mi">0</span><span class="o">)</span> <span class="n">queue</span><span class="o">.</span><span class="na">enqueue</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">key</span><span class="o">);</span>
     <span class="k">if</span><span class="o">(</span><span class="n">cmphi</span><span class="o">&gt;</span><span class="mi">0</span><span class="o">)</span> <span class="n">keys</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">right</span><span class="o">,</span> <span class="n">queue</span><span class="o">,</span> <span class="n">lo</span><span class="o">,</span> <span class="n">hi</span><span class="o">);</span>
 <span class="o">}</span>
</code></pre></div>    </div>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   - - -
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="总结">总结</h3>
<hr />
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binarySearchTree/简单的符号表实现的成本总结.png">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="简单的符号表实现的成本总结" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binarySearchTree/简单的符号表实现的成本总结.png" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">简单的符号表实现的成本总结</div>
    </a>
</center>
<hr />
</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">Tree</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">September 2021</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">algorithm</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-10000009" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2>BinaryTree</h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/pexels-karina-zhukovskaya-7260333.jpg" class="img-responsive img-centered" alt="binaryTree">

                            
                                <h3>二叉树基本概念</h3>
                            
                            </div>

                            <p><h3 id="定义">定义</h3>
<hr />
<p>二叉树是指树中节点的度不大于2的有序树,他是一种最简单且最重要的树.二叉树的递归定义为:二叉树是一棵空树,或者是一棵由一个根节点和两棵互不相交的,分别称作根的左子树和右子树组成的非空树;左子树和右子树又同样都是二叉树.</p>
<hr />

<h3 id="相关术语">相关术语</h3>
<hr />
<ol>
  <li>节点:包含一个数据元素及若干指向子树分支的信息</li>
  <li>节点的度:一个节点拥有子树的数目称为节点的度</li>
  <li>叶子节点:也成为终端节点,没有子树的节点或者度为零的节点</li>
  <li>分支节点:也称为非终端节点,度不为零的节点称为非终端节点</li>
  <li>树的度:树中所有节点的度的最大值</li>
  <li>节点的层次:从根节点开始,假设根节点为第1层,根节点的子节点为第2层,以此类推,如果第一个节点位于第L层,则其子节点位于第L+1层</li>
  <li>树的深度:也称为树的高度,树中所有节点的层次最大值称为树的深度</li>
  <li>有序树:如果树中各棵树的次序是有先后次序的,则称该树为有序树</li>
  <li>无序树:如果树中各棵子树的次序没有先后次序,则称该树为无序树</li>
  <li>森林:由m(m&gt;=0)棵互不相交的树构成一片森林.如果把一棵非空的树的根节点删除,则该树就变成了一片森林,森林中的树由原来根节点的各棵子树构成</li>
</ol>

<hr />
<h3 id="常见的树类型">常见的树类型</h3>
<hr />
<ol>
  <li>满二叉树:如果一棵二叉树只有度为0的节点和度为2的节点,并且度为0的节点在同一层上,则这棵二叉树为满二叉树</li>
  <li>完全二叉树:深度为k,有n个节点的二叉树当且仅当其每一个节点都与深度为k的满二叉树中编号从1到n的节点一一对应时,称为完全二叉树</li>
</ol>

<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binaryTree/相关二叉树图解.jpg">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="相关二叉树图解" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binaryTree/相关二叉树图解.jpg" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">相关二叉树图解</div>
    </a>
</center>

<h3 id="二叉树性质">二叉树性质</h3>
<hr />
<ol>
  <li>二叉树的第 <strong>i</strong> 层上最多有 <strong>2^i-1</strong> (i&gt;=1)个节点</li>
  <li>深度为 <strong>h</strong> 的二叉树中至多含有 <strong>2^h -1</strong> 个节点</li>
  <li>若在任意一棵二叉树中,有 <strong>n0</strong> 个叶子节点,有 <strong>n2</strong> 个度为2的节点,则必有 <strong>n0=n2+1</strong></li>
  <li>具有 <strong>n</strong> 个节点的完全二叉树深为 <strong>log2x+1</strong></li>
  <li>若对一棵有 <strong>n</strong> 个节点的完全二叉树进行顺序编号(1&lt;=i&lt;=n),那么对于编号为 <strong>i</strong> (i&gt;=1)的节点:
    <ul>
      <li>当 <strong>i=1</strong> 时,该节点为根,它无双亲节点</li>
      <li>当 <strong>i&gt;1</strong> 时,该节点的双亲节点的编号为 <strong>i/2</strong></li>
      <li>若 <strong>2i&lt;=n</strong> ,则有编号为 <strong>2i</strong> 的左节点,否则没有左节点</li>
      <li>若 <strong>2i+1&lt;=n</strong> ,则有编号为 <strong>2i+1</strong> 的右节点,否则没有右节点</li>
    </ul>
  </li>
</ol>

<hr />

<h3 id="二叉树的存储方式">二叉树的存储方式</h3>
<hr />
<p>一般我们使用TreeNode对象来表示一个节点, <strong>val</strong> 代表该节点额值, <strong>left</strong> 代表该节点的左子节点, <strong>right</strong> 代表该节点的右子节点</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TreeNode</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">val</span><span class="o">;</span>
    <span class="nc">TreeNode</span> <span class="n">left</span><span class="o">;</span>
    <span class="nc">TreeNode</span> <span class="n">right</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="二叉树的遍历方式">二叉树的遍历方式</h3>
<hr />
<p>二叉树可以使用深度优先遍历(DFS)或广度优先遍历(BFS).<br />
深度优先遍历又可以分为先序遍历、中序遍历、后序遍历三种方式.每种方式只是访问节点的顺序不同.</p>
<ul>
  <li>先序遍历:根节点-&gt;左子节点-&gt;右子节点</li>
  <li>中序遍历:左子节点-&gt;根节点-&gt;右子节点</li>
  <li>后序遍历:左子节点-&gt;右子节点-&gt;根节点</li>
</ul>

<p>广度优先遍历又被称为层序遍历,即按照二叉树的每一层进行遍历</p>

<p><strong>特殊性质</strong> :二叉搜索树采用中序遍历,其实就是一个有序数组.</p>

<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binaryTree/二叉树的遍历.jpg">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="二叉树的遍历" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binaryTree/二叉树的遍历.jpg" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">二叉树的遍历</div>
    </a>
</center>

<h3 id="遍历图解">遍历图解</h3>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binaryTree/二叉树遍历图解.jpg">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="二叉树遍历图解" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/binaryTree/二叉树遍历图解.jpg" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">二叉树遍历图解</div>
    </a>
</center>

<h3 id="代码">代码</h3>
<blockquote>
  <p>java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">res</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">dfs</span><span class="o">(</span><span class="nc">TreeNode</span> <span class="n">node</span><span class="o">){</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">node</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
        <span class="c1">//1.先序遍历</span>
        <span class="n">res</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">node</span><span class="o">.</span><span class="na">val</span><span class="o">);</span>
        <span class="n">dfs</span><span class="o">(</span><span class="n">node</span><span class="o">.</span><span class="na">left</span><span class="o">);</span>
        <span class="c1">//2.中序遍历</span>
        <span class="n">res</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">node</span><span class="o">.</span><span class="na">val</span><span class="o">);</span>
        <span class="n">dfs</span><span class="o">(</span><span class="n">node</span><span class="o">.</span><span class="na">right</span><span class="o">);</span>
        <span class="c1">//3.后序遍历</span>
        <span class="n">res</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">node</span><span class="o">.</span><span class="na">val</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">bfs</span><span class="o">(</span><span class="nc">TreeNode</span> <span class="n">node</span><span class="o">){</span>
    <span class="nc">Queue</span><span class="o">&lt;</span><span class="nc">TreeNode</span><span class="o">&gt;</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedList</span><span class="o">&lt;&gt;();</span>
    <span class="n">queue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
    <span class="k">while</span> <span class="o">(!</span><span class="n">queue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()){</span>
        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
            <span class="nc">TreeNode</span> <span class="n">poll</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
            <span class="n">res</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">poll</span><span class="o">.</span><span class="na">val</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">poll</span><span class="o">.</span><span class="na">left</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                <span class="n">queue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">poll</span><span class="o">.</span><span class="na">left</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">poll</span><span class="o">.</span><span class="na">right</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                <span class="n">queue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">poll</span><span class="o">.</span><span class="na">right</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>DFS时间复杂度:O(logn)  BFS时间复杂度:O(n)<br />
空间复杂度都为:O(1)</p>
</blockquote>

<h3 id="其他语言">其他语言</h3>
<hr />
<blockquote>
  <p>C++</p>
</blockquote>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Solution</span> <span class="p">{</span>
<span class="nl">public:</span>

	<span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">sort</span><span class="p">(</span><span class="k">struct</span> <span class="nc">TreeNode</span><span class="o">*</span> <span class="n">node</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dfs</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="kt">void</span> <span class="n">dfs</span><span class="p">(</span><span class="n">TreeNode</span><span class="o">*</span> <span class="n">node</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="c1">//1.先序遍历</span>
			<span class="n">res</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="n">dfs</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">);</span>
			<span class="c1">//2.中序遍历</span>
			<span class="n">res</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="n">dfs</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">);</span>
			<span class="c1">//3.后序遍历</span>
			<span class="n">res</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">sortBFS</span><span class="p">(</span><span class="k">struct</span> <span class="nc">TreeNode</span><span class="o">*</span> <span class="n">node</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">queue</span><span class="o">&lt;</span><span class="n">TreeNode</span><span class="o">*&gt;</span> <span class="n">queue</span><span class="p">;</span>
		<span class="n">queue</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">queue</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">queue</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">TreeNode</span><span class="o">*</span> <span class="n">pop</span> <span class="o">=</span> <span class="n">queue</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
				<span class="n">queue</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
				<span class="n">res</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pop</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pop</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">queue</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">pop</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pop</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">queue</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">pop</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>
<blockquote>
  <p>python3</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Solution</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span><span class="n">TreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">dfs</span><span class="p">(</span><span class="n">node</span><span class="p">:</span><span class="n">TreeNode</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span><span class="p">:</span>
                <span class="c1">#1.先序遍历
</span>                <span class="c1">#res.append(node.val)
</span>                <span class="n">dfs</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">left</span><span class="p">)</span>
                <span class="c1">#2.中序遍历
</span>                <span class="n">res</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">val</span><span class="p">)</span>
                <span class="n">dfs</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">right</span><span class="p">)</span>
                <span class="c1">#3.后序遍历
</span>                <span class="c1">#res.append(node.val)
</span>        <span class="n">dfs</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">traverseBSF</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">node</span><span class="p">:</span><span class="n">TreeNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">queue</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">queue</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">res</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">val</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">temp</span><span class="p">.</span><span class="n">left</span><span class="p">:</span>
                    <span class="n">queue</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">left</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">temp</span><span class="p">.</span><span class="n">right</span><span class="p">:</span>
                    <span class="n">queue</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">right</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>
</code></pre></div></div>
<blockquote>
  <p>go</p>
</blockquote>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">traverse</span><span class="p">(</span><span class="n">node</span> <span class="o">*</span><span class="n">TreeNode</span><span class="p">)</span> <span class="p">[]</span><span class="kt">int</span> <span class="p">{</span>
	<span class="n">res</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{}</span>
	<span class="k">var</span> <span class="n">dfs</span> <span class="k">func</span><span class="p">(</span><span class="n">node</span> <span class="o">*</span><span class="n">TreeNode</span><span class="p">)</span>
	<span class="n">dfs</span> <span class="o">=</span> <span class="k">func</span><span class="p">(</span><span class="n">node</span> <span class="o">*</span><span class="n">TreeNode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="n">node</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="c">//1.先序遍历</span>
			<span class="n">res</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">Val</span><span class="p">)</span>
			<span class="n">dfs</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Left</span><span class="p">)</span>
			<span class="c">//2.中序遍历</span>
			<span class="n">res</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">Val</span><span class="p">)</span>
			<span class="n">dfs</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Right</span><span class="p">)</span>
			<span class="c">//3.后序遍历</span>
			<span class="n">res</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">Val</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dfs</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">res</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">BFS</span><span class="p">(</span><span class="n">node</span> <span class="o">*</span><span class="n">TreeNode</span><span class="p">)</span> <span class="p">[]</span><span class="kt">int</span> <span class="p">{</span>
	<span class="n">res</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>
	<span class="n">queue</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="n">TreeNode</span> <span class="p">,</span> <span class="m">0</span><span class="p">)</span>
	<span class="n">queue</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
	<span class="k">for</span> <span class="nb">len</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span><span class="o">!=</span><span class="m">0</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">:=</span> <span class="n">queue</span><span class="p">[</span><span class="m">0</span><span class="p">]</span>
		<span class="n">res</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">temp</span><span class="o">.</span><span class="n">Val</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">temp</span><span class="o">.</span><span class="n">Left</span><span class="o">!=</span><span class="no">nil</span> <span class="p">{</span>
			<span class="n">queue</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">temp</span><span class="o">.</span><span class="n">Left</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="n">temp</span><span class="o">.</span><span class="n">Right</span><span class="o">!=</span><span class="no">nil</span> <span class="p">{</span>
			<span class="n">queue</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">temp</span><span class="o">.</span><span class="n">Right</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="p">]</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">res</span>
<span class="p">}</span>
</code></pre></div></div>
</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">Sort</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">April 2021</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">algorithm</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-10000008" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2>RadixSort</h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/pexels-roman-odintsov-5327786.jpg" class="img-responsive img-centered" alt="radixSort">

                            
                                <h3>基数排序</h3>
                            
                            </div>

                            <p><h3 id="前置概念">前置概念</h3>
<hr />

<p>最高位优先(Most Significant Digit First)</p>
<ul>
  <li>简称MSD法,先按 <strong>k1</strong> 排序分组,同一组中记录,关键码 <strong>k1</strong> 相等,再对各组按 <strong>k2</strong> 排序分成子组,之后,对后面的关键码继续这样的排序分组,直到按最次位关键码 <strong>kd</strong> 对各子组排序后,再将各组连接起来,便得到一个有序序列.</li>
</ul>

<p>最低位优先(Least Significant Digit First)</p>
<ul>
  <li>简称LSD法,先从 <strong>kd</strong> 开始排序,再对 <strong>kd-1</strong> 进行排序,依次重复,直到对 <strong>k1</strong> 排序后便得到一个有序序列</li>
</ul>

<hr />

<h3 id="基本思想">基本思想</h3>
<hr />
<p>基数排序又称为桶排序(bucket sort).他是通过键值的部分信息,将要排序的元素分配到某些桶中,再从从小到大的桶中取出数据放回到原数组中,直到所有情况的桶都排序完成后,整个数组有序.</p>
<hr />

<h3 id="思路">思路</h3>
<hr />
<p>以最低位优先为例:</p>
<ol>
  <li>首先将给定的nums根据个位数的数值,将他们分配值编号0到9的桶中,使用temp来记录第 <strong>i</strong> 号桶内存放的nums元素,使用order来记录第 <strong>i</strong> 号桶内有多少个元素</li>
  <li>接着将temp中的元素按照桶从0到9的顺序在放回数组nums中,并记得重置对应的order值</li>
  <li>最后将位数不断上升,重复以上步骤,最高位处理完即数组有序
    <hr />
  </li>
</ol>

<h3 id="图解">图解</h3>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/radixSort/基数排序.jpg">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="基数排序" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/radixSort/基数排序.jpg" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">RadixSort</div>
    </a>
</center>

<h3 id="代码">代码</h3>
<blockquote>
  <p>java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">radixSort</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">,</span> <span class="kt">int</span> <span class="n">d</span><span class="o">){</span>
    <span class="c1">//每次排序使用的索引</span>
    <span class="kt">int</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
    <span class="c1">//表明取的第几位数</span>
    <span class="kt">int</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="o">;</span>
    <span class="c1">//表明当前正在排序第几位数</span>
    <span class="kt">int</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">nums</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>

    <span class="c1">//temp i存放0-9 j存放对应的值</span>
    <span class="c1">//例如 给定 nums[20] 那么 temp[0][1] = 20</span>
    <span class="kt">int</span><span class="o">[][]</span> <span class="n">temp</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">10</span><span class="o">][</span><span class="n">len</span><span class="o">];</span>
    <span class="c1">//存放0-9每个位置有多少个值 用于temp找到nums中的元素</span>
    <span class="kt">int</span><span class="o">[]</span> <span class="n">order</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">10</span><span class="o">];</span>

    <span class="c1">//m从1开始一直处理到d</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">m</span><span class="o">&lt;=</span><span class="n">d</span><span class="o">){</span>
        <span class="c1">//首轮遍历 填充temp和order</span>
        <span class="c1">//1. 首先先计算出最低位 lsd</span>
        <span class="c1">//2. 然后根据lsd的值将nums填充到temp指定的位置,并将order对应lsd位置加一</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">len</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
            <span class="kt">int</span> <span class="n">lsd</span> <span class="o">=</span> <span class="o">(</span><span class="n">nums</span><span class="o">[</span><span class="n">i</span><span class="o">]/</span><span class="n">n</span><span class="o">)%</span><span class="mi">10</span><span class="o">;</span>
            <span class="n">temp</span><span class="o">[</span><span class="n">lsd</span><span class="o">][</span><span class="n">order</span><span class="o">[</span><span class="n">lsd</span><span class="o">]++]</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
        <span class="o">}</span>

        <span class="c1">//经过第一轮遍历 我们已经按照lsd将数组赋值到 temp中, 接下来进行排序</span>
        <span class="c1">//因为数字最多就是9位,所以第二轮遍历就是从0-9</span>
        <span class="c1">//只要order[i]还存在元素,即order[i]!=0, 那么我们就要遍历order[i],从temp中取到对应值即temp[i][j],并赋值到原始数组nums中. 最后要把order[i]置为0即尾数为i的全都处理完毕</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">10</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">order</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">){</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">order</span><span class="o">[</span><span class="n">i</span><span class="o">];</span><span class="n">j</span><span class="o">++){</span>
                    <span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">++]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">j</span><span class="o">];</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">order</span><span class="o">[</span><span class="n">i</span><span class="o">]=</span><span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">//最后重置 k为0,即下次排序继续从0开始</span>
        <span class="c1">//n=n*10 表明取下一位数 个位-十位-百位</span>
        <span class="c1">//m+=1 表明处理到了第几位</span>
        <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
        <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="o">*</span><span class="mi">10</span><span class="o">;</span>
        <span class="n">m</span><span class="o">+=</span><span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>时间复杂度:O(NlogN)</p>

  <p>空间复杂度:O(1)</p>
</blockquote>

<h3 id="其他语言">其他语言</h3>
<hr />
<blockquote>
  <p>C++</p>
</blockquote>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Solution</span> <span class="p">{</span>
<span class="nl">public:</span>
	<span class="kt">void</span> <span class="n">radixSort</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">nums</span><span class="p">,</span> <span class="kt">int</span> <span class="n">d</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">nums</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
		<span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span> <span class="n">temp</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">len</span><span class="p">));</span>
		<span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">order</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">m</span><span class="o">&lt;=</span><span class="n">d</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="kt">int</span> <span class="n">lsd</span> <span class="o">=</span> <span class="p">(</span><span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span><span class="p">;</span>
				<span class="n">temp</span><span class="p">[</span><span class="n">lsd</span><span class="p">][</span><span class="n">order</span><span class="p">[</span><span class="n">lsd</span><span class="p">]</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> 
					<span class="p">{</span>
						<span class="n">nums</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">m</span><span class="o">++</span><span class="p">;</span>
			<span class="n">n</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>
<blockquote>
  <p>python3</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Solution</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">radixSort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nums</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">d</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span>
        <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">n</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">m</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">length</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
        <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span>

        <span class="k">while</span> <span class="n">m</span><span class="o">&lt;=</span><span class="n">d</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">length</span><span class="p">):</span>
                <span class="n">lsd</span>  <span class="o">=</span> <span class="p">(</span><span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">//</span><span class="n">n</span><span class="p">)</span><span class="o">%</span><span class="mi">10</span>
                <span class="n">temp</span><span class="p">[</span><span class="n">lsd</span><span class="p">][</span><span class="n">order</span><span class="p">[</span><span class="n">lsd</span><span class="p">]]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">order</span><span class="p">[</span><span class="n">lsd</span><span class="p">]</span><span class="o">+=</span><span class="mi">1</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                        <span class="n">nums</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                        <span class="n">k</span><span class="o">+=</span><span class="mi">1</span>
                <span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">k</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">m</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">n</span><span class="o">*=</span><span class="mi">10</span>
</code></pre></div></div>
<blockquote>
  <p>go</p>
</blockquote>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">radixSort</span><span class="p">(</span><span class="n">nums</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">d</span> <span class="kt">int</span><span class="p">)</span>  <span class="p">{</span>
	<span class="n">k</span> <span class="o">:=</span> <span class="m">0</span>
	<span class="n">n</span> <span class="o">:=</span> <span class="m">1</span>
	<span class="n">m</span> <span class="o">:=</span> <span class="m">1</span>
	<span class="nb">len</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
	<span class="n">temp</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([][]</span><span class="kt">int</span><span class="p">,</span> <span class="m">10</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">temp</span><span class="p">{</span>
		<span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nb">len</span><span class="p">)</span>
	<span class="p">}</span>
	
	<span class="n">order</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="m">10</span><span class="p">)</span>

	<span class="k">for</span> <span class="n">m</span><span class="o">&lt;=</span><span class="n">d</span> <span class="p">{</span>
		<span class="k">for</span> <span class="n">i</span><span class="o">:=</span><span class="m">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">;</span><span class="n">i</span><span class="o">++</span> <span class="p">{</span>
			<span class="n">lsd</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">)</span><span class="o">%</span><span class="m">10</span>
			<span class="n">temp</span><span class="p">[</span><span class="n">lsd</span><span class="p">][</span><span class="n">order</span><span class="p">[</span><span class="n">lsd</span><span class="p">]]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="n">order</span><span class="p">[</span><span class="n">lsd</span><span class="p">]</span><span class="o">++</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="n">i</span><span class="o">:=</span><span class="m">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="m">10</span><span class="p">;</span><span class="n">i</span><span class="o">++</span> <span class="p">{</span>
			<span class="k">if</span> <span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
				<span class="k">for</span> <span class="n">j</span><span class="o">:=</span><span class="m">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="n">j</span><span class="o">++</span> <span class="p">{</span>
					<span class="n">nums</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
					<span class="n">k</span><span class="o">++</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="m">0</span>
		<span class="p">}</span>
		<span class="n">m</span><span class="o">++</span>
		<span class="n">k</span><span class="o">=</span><span class="m">0</span>
		<span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="o">*</span><span class="m">10</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">Sort</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">April 2021</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">algorithm</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-10000007" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2>ShellSort</h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/pexels-alena-beliaeva-8697338.jpg" class="img-responsive img-centered" alt="shellSort">

                            
                                <h3>希尔排序</h3>
                            
                            </div>

                            <p><h3 id="缘由">缘由</h3>
<hr />

<p>对于大规模乱序数组插入排序很慢,因为它只会交换相邻的元素,因此元素只能一点点的从数组的一端移动到另一端.<br />
例如,如果主键最小的元素正好在数组的尽头,要将它挪到正确的位置就需要N-1次移动.<br />
希尔排序为了加速简单地改进了插入排序,交换不相邻的元素以对数组的局部进行排序并最终用插入排序将局域有序的数组排序.</p>

<hr />

<h3 id="基本思想">基本思想</h3>
<hr />
<p>使数组中任意间隔为h的元素都是有序的,这样的数组称为h有序数组.<br />
换句话说,一个h有序数组就是h个互相独立的有序数组编织在一起组成的一个数组,在进行排序时,如果h很大,我们就能将元素移动到很远的地方,为实现更小的h有序创造方便.<br />
用这种方法,对于任意以1结尾的h序列,我们都能够将数组排序.</p>
<hr />

<h3 id="思路">思路</h3>
<hr />
<p>对于每个h,用插入排序将h个子数组独立的排序.但因为子数组是相互独立的,一个更简单的方法是在h-子数组中将每个元素交换到比它大的元素之前去（将比它大的元素向右移动一格）.只需要在插入排序的代码中将移动元素的距离由1改为h即可.这样,希尔排序的实现就转化为了一个类似于插入排序但使用不同增量的过程.<br />
希尔排序更高效的原因是它权衡了子数组的规模和有序性.排序之初,各个子数组都很短,排序之后子数组都是部分有序的,这两种情况都很适合插入排序.子数组部分有序的程度取决于递增序列的选择.</p>
<hr />

<h3 id="如何选择递增序列">如何选择递增序列</h3>
<hr />
<p>算法的性能不仅取决于h,还取决于h之间的数学性质,比如他们的公因子等.这个需要视情况而定.</p>
<hr />

<h3 id="图解">图解</h3>
<hr />
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/shellSort/shellSort.jpg">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="希尔排序" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/shellSort/shellSort.jpg" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">ShellSort</div>
    </a>
</center>

<h4 id="代码">代码</h4>
<blockquote>
  <p>java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">shellSort</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">){</span>
    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">nums</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">factor</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">h</span><span class="o">=</span><span class="mi">1</span><span class="o">;</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">h</span><span class="o">&lt;</span><span class="n">len</span><span class="o">/</span><span class="n">factor</span><span class="o">){</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">*</span><span class="n">factor</span><span class="o">+</span><span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">h</span><span class="o">&gt;=</span><span class="mi">1</span><span class="o">){</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="n">h</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">len</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="n">i</span><span class="o">;</span><span class="n">j</span><span class="o">&gt;=</span><span class="n">h</span> <span class="o">&amp;&amp;</span> <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">]&lt;</span><span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">-</span><span class="n">h</span><span class="o">];</span><span class="n">j</span><span class="o">-=</span><span class="n">h</span><span class="o">){</span>
                <span class="n">swap</span><span class="o">(</span><span class="n">nums</span><span class="o">,</span> <span class="n">j</span><span class="o">,</span> <span class="n">j</span><span class="o">-</span><span class="n">h</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">h</span><span class="o">/=</span><span class="n">factor</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">swap</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">j</span><span class="o">){</span>
    <span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
    <span class="n">nums</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">];</span>
    <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>时间复杂度:O(n^3/2)</p>

  <p>空间复杂度:O(1)</p>
</blockquote>

<h3 id="其他语言">其他语言</h3>
<hr />
<blockquote>
  <p>C++</p>
</blockquote>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Solution</span> <span class="p">{</span>
<span class="nl">public:</span>
	<span class="kt">void</span> <span class="n">shellSort</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">nums</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">nums</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
		<span class="kt">int</span> <span class="n">factor</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">h</span><span class="o">&lt;</span><span class="n">len</span><span class="o">/</span><span class="n">factor</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">h</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">factor</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">h</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;=</span><span class="n">h</span><span class="p">;</span> <span class="n">j</span><span class="o">-=</span><span class="n">h</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">&lt;</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="n">h</span><span class="p">])</span>
					<span class="p">{</span>
						<span class="n">swap</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">h</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">h</span> <span class="o">/=</span> <span class="n">factor</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="kt">void</span> <span class="n">swap</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">nums</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="kt">int</span> <span class="n">j</span><span class="p">)</span> 
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>
<blockquote>
  <p>python3</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Solution</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">shellSort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nums</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">h</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">while</span> <span class="n">h</span><span class="o">&lt;</span><span class="n">length</span><span class="o">//</span><span class="n">factor</span><span class="p">:</span>
            <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="o">*</span><span class="n">factor</span><span class="o">+</span><span class="mi">1</span>

        <span class="k">while</span> <span class="n">h</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">h</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="n">h</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="p">.</span><span class="n">swap3</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="n">h</span><span class="p">)</span>
            <span class="n">h</span><span class="o">//=</span><span class="n">factor</span>


    <span class="k">def</span> <span class="nf">swap3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nums</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>
</code></pre></div></div>
<blockquote>
  <p>go</p>
</blockquote>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">shellSort</span><span class="p">(</span><span class="n">nums</span> <span class="p">[]</span><span class="kt">int</span><span class="p">){</span>
	<span class="nb">len</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
	<span class="n">factor</span><span class="o">:=</span><span class="m">2</span>
	<span class="n">h</span> <span class="o">:=</span><span class="m">1</span>
	<span class="k">for</span> <span class="n">h</span><span class="o">&lt;</span><span class="nb">len</span><span class="o">/</span><span class="n">factor</span> <span class="p">{</span>
		<span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">*</span><span class="n">factor</span><span class="o">+</span><span class="m">1</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="n">h</span><span class="o">&gt;=</span><span class="m">1</span> <span class="p">{</span>
		<span class="k">for</span> <span class="n">i</span><span class="o">:=</span><span class="n">h</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">;</span><span class="n">i</span><span class="o">++</span> <span class="p">{</span>
			<span class="k">for</span> <span class="n">j</span><span class="o">:=</span><span class="n">i</span><span class="p">;</span><span class="n">j</span><span class="o">&gt;=</span><span class="n">h</span> <span class="o">&amp;&amp;</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">&lt;</span><span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="n">h</span><span class="p">];</span><span class="n">j</span><span class="o">-=</span><span class="n">h</span> <span class="p">{</span>
				<span class="n">swap3</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="n">h</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">h</span><span class="o">/=</span><span class="n">factor</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">swap3</span><span class="p">(</span><span class="n">nums</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="kt">int</span><span class="p">)</span>  <span class="p">{</span>
	<span class="n">temp</span> <span class="o">:=</span> <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
	<span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
	<span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>
<span class="p">}</span>
</code></pre></div></div>
</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">Start Bootstrap</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">April 2021</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">algorithm</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-10000006" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2>MergeSort</h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/pexels-anete-lusina-5721167.jpg" class="img-responsive img-centered" alt="mergeSort">

                            
                                <h3>归并排序</h3>
                            
                            </div>

                            <p><h3 id="基本思想">基本思想</h3>
<hr />
<p>要将一个数组排序,可以先递归地将它分成两半分别排序,然后将结果归并起来.<br />
归并排序最吸引人的性质是它能够保证将任意长度为N的数组排序所需时间和 <strong>NlogN</strong> 成正比;它的主要缺点则是它所需的额外空间和 <strong>N</strong> 成正比.</p>
<hr />

<h3 id="原地归并的抽象方法">原地归并的抽象方法</h3>
<hr />
<p>实现的方法很简单,创建一个适当大小的数组然后将两个输入数组中的元素一个个从大到小放入这个数组中.<br />
之所以需要原地归并,是因为当用归并一个大数组排序时,我们需要进行很多次归并,因此在每次归并时都创建一个新数组来存储排序结果会大大增加空间复杂度.<br />
如果使用原地归并的方法,这样就可以先将前半部分排序,再将后半部分排序, 然后在数组中移动元素而不需要使用额外的空间.<br />
原地归并的方法签名为: <strong>merge(a, lo, mid, hi)</strong> ,它会将子数组 <strong>a[lo..mid]</strong> 和 <strong>a[mid+1..hi]</strong> 归并成一个有序的数组并将结果存放在 <strong>a[lo..hi]</strong> 中.</p>
<hr />

<h3 id="代码">代码</h3>
<blockquote>
  <p>java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">merge</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">,</span> <span class="kt">int</span> <span class="n">lo</span><span class="o">,</span> <span class="kt">int</span> <span class="n">mid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">hi</span><span class="o">){</span>
        <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="n">lo</span><span class="o">,</span> <span class="n">j</span><span class="o">=</span><span class="n">mid</span><span class="o">+</span><span class="mi">1</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">k</span><span class="o">=</span><span class="n">lo</span><span class="o">;</span><span class="n">k</span><span class="o">&lt;=</span><span class="n">hi</span><span class="o">;</span><span class="n">k</span><span class="o">++){</span>
            <span class="n">temp</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">];</span>
        <span class="o">}</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">k</span><span class="o">=</span><span class="n">lo</span><span class="o">;</span><span class="n">k</span><span class="o">&lt;=</span><span class="n">hi</span><span class="o">;</span><span class="n">k</span><span class="o">++){</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">i</span><span class="o">&gt;</span><span class="n">mid</span><span class="o">){</span>
                <span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">[</span><span class="n">j</span><span class="o">++];</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">j</span><span class="o">&gt;</span><span class="n">hi</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">[</span><span class="n">i</span><span class="o">++];</span>
            <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">temp</span><span class="o">[</span><span class="n">j</span><span class="o">]&lt;</span><span class="n">temp</span><span class="o">[</span><span class="n">i</span><span class="o">]){</span>
                <span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">[</span><span class="n">j</span><span class="o">++];</span>
            <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
                <span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">[</span><span class="n">i</span><span class="o">++];</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>

<h3 id="代码分析">代码分析</h3>
<hr />
<p>该方法先将所有数组复制到temp[]中,然后在归并回a[]中.<br />
方法在归并时(第二个for循环)进行了4个判断:</p>
<ol>
  <li>i&gt;mid:左半边用完(取右半边的元素)</li>
  <li>j&gt;hi:右半边用尽(取左半边的元素)</li>
  <li>temp[j]&lt;temp[i]:右半边的当前元素小于左半边的当前元素(取右半边的元素)</li>
  <li>temp[j]&gt;temp[i]:右半边的放弃元素大于左半边的当前元素(取左半边的元素)</li>
</ol>

<p>仔细观察如上规则,其实就是给你两个有序集合,要把这两个有序集合合并成一个有序集合,使用双指针的方式合并.</p>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/mergeSort/归并排序区间分布图.jpg">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="归并排序区间分布图" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/mergeSort/归并排序区间分布图.jpg" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">归并排序区间分布图</div>
    </a>
</center>

<h3 id="自顶向下的归并排序">自顶向下的归并排序</h3>
<hr />
<p>这是应用高效算法设计中分治思想的最典型的一个例子.</p>
<ol>
  <li>首先归并的排序每一个区间,保证区间大小为1的区间全都有序</li>
  <li>其次就是归并合并两个区间保证整个区间有序</li>
  <li>重复以上步骤即整个数组有序</li>
</ol>

<hr />

<h3 id="图解">图解</h3>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/mergeSort/归并排序.jpg">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="归并排序" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/mergeSort/归并排序.jpg" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">MergeSort</div>
    </a>
</center>

<h4 id="代码-1">代码</h4>
<blockquote>
  <p>java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">temp</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">mergeSort</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">){</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">nums</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
    <span class="n">sort</span><span class="o">(</span><span class="n">nums</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">nums</span><span class="o">.</span><span class="na">length</span><span class="o">-</span><span class="mi">1</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">sort</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">,</span> <span class="kt">int</span> <span class="n">lo</span><span class="o">,</span> <span class="kt">int</span> <span class="n">hi</span><span class="o">){</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">hi</span><span class="o">&lt;=</span><span class="n">lo</span><span class="o">){</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">int</span> <span class="n">mid</span> <span class="o">=</span> <span class="n">lo</span> <span class="o">+</span> <span class="o">(</span><span class="n">hi</span><span class="o">-</span><span class="n">lo</span><span class="o">)/</span><span class="mi">2</span><span class="o">;</span>
    <span class="n">sort</span><span class="o">(</span><span class="n">nums</span><span class="o">,</span> <span class="n">lo</span><span class="o">,</span> <span class="n">mid</span><span class="o">);</span>
    <span class="n">sort</span><span class="o">(</span><span class="n">nums</span><span class="o">,</span> <span class="n">mid</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span> <span class="n">hi</span><span class="o">);</span>
    <span class="n">merge</span><span class="o">(</span><span class="n">nums</span><span class="o">,</span> <span class="n">lo</span><span class="o">,</span> <span class="n">mid</span><span class="o">,</span> <span class="n">hi</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">merge</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">,</span> <span class="kt">int</span> <span class="n">lo</span><span class="o">,</span> <span class="kt">int</span> <span class="n">mid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">hi</span><span class="o">){</span>
    <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="n">lo</span><span class="o">,</span> <span class="n">j</span><span class="o">=</span><span class="n">mid</span><span class="o">+</span><span class="mi">1</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">k</span><span class="o">=</span><span class="n">lo</span><span class="o">;</span><span class="n">k</span><span class="o">&lt;=</span><span class="n">hi</span><span class="o">;</span><span class="n">k</span><span class="o">++){</span>
        <span class="n">temp</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">];</span>
    <span class="o">}</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">k</span><span class="o">=</span><span class="n">lo</span><span class="o">;</span><span class="n">k</span><span class="o">&lt;=</span><span class="n">hi</span><span class="o">;</span><span class="n">k</span><span class="o">++){</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">i</span><span class="o">&gt;</span><span class="n">mid</span><span class="o">){</span>
            <span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">[</span><span class="n">j</span><span class="o">++];</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">j</span><span class="o">&gt;</span><span class="n">hi</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">[</span><span class="n">i</span><span class="o">++];</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">temp</span><span class="o">[</span><span class="n">j</span><span class="o">]&lt;</span><span class="n">temp</span><span class="o">[</span><span class="n">i</span><span class="o">]){</span>
            <span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">[</span><span class="n">j</span><span class="o">++];</span>
        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
            <span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">[</span><span class="n">i</span><span class="o">++];</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>时间复杂度:O(NlogN)</p>

  <p>空间复杂度:O(1)</p>
</blockquote>

<h3 id="归并排序的缺点及改进方案">归并排序的缺点及改进方案</h3>
<hr />
<ul>
  <li>
    <p>缺点: 辅助数组所使用的额外空间和N的大小成正比.</p>
  </li>
  <li>
    <p>改进点</p>
    <ol>
      <li>对小规模子数组使用插入排序:用不同的方法处理小规模问题能改进大多数递归算法的性能,因为递归会使小规模问题中方法的调用过于频繁,所以改进对它们的处理方法就是改进整个算法.</li>
      <li>测试数组是否已经有序:可以添加一个判断条件,如果 <strong>a[mid]</strong> 小于等于 <strong>a[mid+1]</strong> ,我们就冉伟数组已经有序的并跳过merge()方法.</li>
      <li>不将元素复制到辅助数组:可以节省将数组元素复制到用于归并的辅助数组所用的时间(但空间不行).要做到这一点我们要调用两种排序方法,一种将数据从输入数组排序到辅助数组,一种将数据从辅助数组排序到输入数组.</li>
    </ol>
  </li>
</ul>

<hr />

<h3 id="自底向上的归并排序">自底向上的归并排序</h3>
<hr />
<p>同样是分治思想的典型应用.先归并那些微型数组,然后再成对归并得到的数组,如此这般,直到我们将整个数组归并在一起.这种实现方法比标准递归方法所需要的代码量更少.</p>
<ol>
  <li>首先进行的两两归并(把每个元素想象成一个大小为1的数组)</li>
  <li>然后是四四归并(将两个大小为2的数组归并成一个有4个元素的数组)</li>
  <li>然后是八八的归并,一直下去.</li>
  <li>在每一轮归并中,最后一次归并的第二个子数组可能比第一个子数组要小,如果不是的话所有的归并排序中两个数组大小应该都是一样的,而在下一轮中子数组的大小会翻倍.</li>
</ol>

<p>当数组长度为2的幂时,自顶向下和自底向上的归并排序所用的比较次数和数组访问次数正好相同,只是顺序不同.</p>
<hr />

<h3 id="代码-2">代码</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">temp</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">mergeSort</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">){</span>
    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">nums</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
    <span class="n">temp</span>  <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">len</span><span class="o">];</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">sz</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span><span class="n">sz</span><span class="o">&lt;</span><span class="n">len</span><span class="o">;</span><span class="n">sz</span> <span class="o">=</span> <span class="n">sz</span><span class="o">+</span><span class="n">sz</span><span class="o">){</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">lo</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">lo</span><span class="o">&lt;</span><span class="n">len</span><span class="o">-</span><span class="n">sz</span><span class="o">;</span><span class="n">lo</span> <span class="o">+=</span> <span class="n">sz</span><span class="o">+</span><span class="n">sz</span><span class="o">){</span>
            <span class="n">merge</span><span class="o">(</span><span class="n">nums</span><span class="o">,</span> <span class="n">lo</span><span class="o">,</span> <span class="n">lo</span><span class="o">+</span><span class="n">sz</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="nc">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">lo</span><span class="o">+</span><span class="n">sz</span><span class="o">+</span><span class="n">sz</span><span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">merge</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">,</span> <span class="kt">int</span> <span class="n">lo</span><span class="o">,</span> <span class="kt">int</span> <span class="n">mid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">hi</span><span class="o">){</span>
    <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="n">lo</span><span class="o">,</span> <span class="n">j</span><span class="o">=</span><span class="n">mid</span><span class="o">+</span><span class="mi">1</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">k</span><span class="o">=</span><span class="n">lo</span><span class="o">;</span><span class="n">k</span><span class="o">&lt;=</span><span class="n">hi</span><span class="o">;</span><span class="n">k</span><span class="o">++){</span>
        <span class="n">temp</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">];</span>
    <span class="o">}</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">k</span><span class="o">=</span><span class="n">lo</span><span class="o">;</span><span class="n">k</span><span class="o">&lt;=</span><span class="n">hi</span><span class="o">;</span><span class="n">k</span><span class="o">++){</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">i</span><span class="o">&gt;</span><span class="n">mid</span><span class="o">){</span>
            <span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">[</span><span class="n">j</span><span class="o">++];</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">j</span><span class="o">&gt;</span><span class="n">hi</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">[</span><span class="n">i</span><span class="o">++];</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">temp</span><span class="o">[</span><span class="n">j</span><span class="o">]&lt;</span><span class="n">temp</span><span class="o">[</span><span class="n">i</span><span class="o">]){</span>
            <span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">[</span><span class="n">j</span><span class="o">++];</span>
        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
            <span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">[</span><span class="n">i</span><span class="o">++];</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="代码分析-1">代码分析</h3>
<hr />
<p>仔细看下mergeSort方法,使用两个循环解决了自底向上归并.<br />
第一个循环的作用就是定义归并的子数组,不断递增到数组大小.</p>
<ul>
  <li>其中 <strong>sz</strong> 代表当前要归并的子数组大小,肯定要从1开始慢慢不断乘2扩大子数组,所以sz的大小一定是要小于len的,那递增条件就是不断乘2即 <strong>sz+sz</strong></li>
</ul>

<p>再看第二个循环,他的作用就是将nums中每间隔sz的数组归并排序.</p>
<ul>
  <li>其中 <strong>lo</strong> 代表起始位置,肯定是从 <strong>0</strong> 开始排序,因为排序每隔 <strong>sz</strong> 的区间,那么lo的最大长度就是 <strong>len-sz</strong> ,那最后的递增条件就很容易理解了,要间隔 <strong>2*sz</strong> 的区间嘛,肯定是加上 <strong>sz+sz</strong></li>
</ul>

<p>最后就是将两个有序的子区间合并成一个大的有序子区间, 起点肯定是 <strong>lo</strong> ,因为我们排序是 <strong>sz+sz</strong> 长度的子区间,那么这个子区间的中间节点肯定是 <strong>lo+sz-1</strong> ,那最后就剩下最后区间的末尾了,按理说应该是 <strong>lo+sz+sz-1</strong> ,但是因为不断递增可能会超过数组长度,所以要取 <strong>lo+sz+sz-1</strong> 和 <strong>len-1</strong> 的最小值.</p>
<hr />

<h3 id="自底向上轨迹图">自底向上轨迹图</h3>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/mergeSort/自底向上归并轨迹图.jpg">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="自底向上归并轨迹图" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/mergeSort/自底向上归并轨迹图.jpg" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">自底向上归并轨迹图</div>
    </a>
</center>

<h3 id="自顶向下归并其他语言">自顶向下归并其他语言</h3>
<hr />
<blockquote>
  <p>C++</p>
</blockquote>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Solution</span> <span class="p">{</span>
<span class="nl">public:</span>
	<span class="kt">void</span> <span class="n">mergeSort</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">nums</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">nums</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
		<span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">temp</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>
		<span class="n">sort</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="kt">void</span> <span class="n">sort</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">nums</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hi</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">temp</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hi</span><span class="o">&lt;=</span><span class="n">lo</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="kt">int</span> <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">+</span> <span class="n">lo</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">sort</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">sort</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">merge</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="kt">void</span> <span class="n">merge</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">nums</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hi</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">temp</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">lo</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="n">lo</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="n">hi</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">temp</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="n">lo</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="n">hi</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">mid</span><span class="p">)</span> 
			<span class="p">{</span>
				<span class="n">nums</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="o">&gt;</span><span class="n">hi</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">nums</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">&lt;</span><span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="p">{</span>
				<span class="n">nums</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">nums</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>
<blockquote>
  <p>python3</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">mergeSort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nums</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="n">nums</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">lo</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">hi</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">hi</span><span class="o">&lt;=</span><span class="n">lo</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="n">lo</span> <span class="o">+</span> <span class="p">(</span><span class="n">hi</span><span class="o">-</span><span class="n">lo</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">sort</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
        <span class="n">sort</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">mid</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">hi</span><span class="p">)</span>
        <span class="n">merge</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">hi</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">nums</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">lo</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">mid</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">hi</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">lo</span><span class="p">,</span> <span class="n">mid</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">temp</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="n">mid</span> <span class="p">:</span>
                <span class="n">nums</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">elif</span> <span class="n">j</span><span class="o">&gt;</span><span class="n">hi</span><span class="p">:</span>
                <span class="n">nums</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">elif</span> <span class="n">temp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">&lt;</span><span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">nums</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nums</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="n">sort</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>
<blockquote>
  <p>go</p>
</blockquote>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//自顶向下归并排序</span>
<span class="k">func</span> <span class="n">mergeSort</span><span class="p">(</span><span class="n">nums</span> <span class="p">[]</span><span class="kt">int</span><span class="p">){</span>
	<span class="n">temp</span> <span class="o">:=</span><span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">))</span>

	<span class="k">var</span> <span class="n">merge</span> <span class="k">func</span><span class="p">(</span><span class="n">nums</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">lo</span> <span class="kt">int</span><span class="p">,</span> <span class="n">mid</span> <span class="kt">int</span><span class="p">,</span> <span class="n">hi</span> <span class="kt">int</span><span class="p">)</span>
	<span class="n">merge</span> <span class="o">=</span> <span class="k">func</span><span class="p">(</span><span class="n">nums</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">lo</span> <span class="kt">int</span><span class="p">,</span> <span class="n">mid</span> <span class="kt">int</span><span class="p">,</span> <span class="n">hi</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span><span class="o">:=</span><span class="n">lo</span>
		<span class="n">j</span><span class="o">:=</span><span class="n">mid</span><span class="o">+</span><span class="m">1</span>
		<span class="k">for</span> <span class="n">k</span><span class="o">:=</span><span class="n">lo</span><span class="p">;</span><span class="n">k</span><span class="o">&lt;=</span><span class="n">hi</span><span class="p">;</span><span class="n">k</span><span class="o">++</span> <span class="p">{</span>
			<span class="n">temp</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="n">k</span><span class="o">:=</span><span class="n">lo</span><span class="p">;</span><span class="n">k</span><span class="o">&lt;=</span><span class="n">hi</span><span class="p">;</span><span class="n">k</span><span class="o">++</span><span class="p">{</span>
			<span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="n">mid</span> <span class="p">{</span>
				<span class="n">nums</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
				<span class="n">j</span><span class="o">++</span>
			<span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="n">j</span><span class="o">&gt;</span><span class="n">hi</span> <span class="p">{</span>
				<span class="n">nums</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
				<span class="n">i</span><span class="o">++</span>
			<span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="n">temp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">&lt;</span><span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">{</span>
				<span class="n">nums</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
				<span class="n">j</span><span class="o">++</span>
			<span class="p">}</span><span class="k">else</span> <span class="p">{</span>
				<span class="n">nums</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
				<span class="n">i</span><span class="o">++</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">var</span> <span class="n">sort</span> <span class="k">func</span><span class="p">(</span><span class="n">nums</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">lo</span> <span class="kt">int</span><span class="p">,</span> <span class="n">hi</span> <span class="kt">int</span><span class="p">)</span>
	<span class="n">sort</span> <span class="o">=</span> <span class="k">func</span><span class="p">(</span><span class="n">nums</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">lo</span> <span class="kt">int</span><span class="p">,</span> <span class="n">hi</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="n">hi</span><span class="o">&lt;=</span><span class="n">lo</span> <span class="p">{</span>
			<span class="k">return</span>
		<span class="p">}</span>
		<span class="n">mid</span> <span class="o">:=</span> <span class="n">lo</span><span class="o">+</span><span class="p">(</span><span class="n">hi</span><span class="o">-</span><span class="n">lo</span><span class="p">)</span><span class="o">/</span><span class="m">2</span>
		<span class="n">sort</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
		<span class="n">sort</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">mid</span><span class="o">+</span><span class="m">1</span><span class="p">,</span> <span class="n">hi</span><span class="p">)</span>
		<span class="n">merge</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">hi</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="n">sort</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span><span class="o">-</span><span class="m">1</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">Start Bootstrap</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">April 2021</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">algorithm</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-10000005" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2>SelectSort</h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/pexels-8906527.jpg" class="img-responsive img-centered" alt="selectSort">

                            
                                <h3>选择排序</h3>
                            
                            </div>

                            <p><h3 id="基本思想">基本思想</h3>
<hr />
<p>主要就是遍历数组,找到最小值和最前面的元素交换即可.</p>
<hr />

<h3 id="思路">思路</h3>
<hr />
<ol>
  <li>首先找到数组中最小的那个元素</li>
  <li>其次将它和数组的第一个元素交换位置(如果第一个元素就是最小元素那么它就和自己交换)</li>
  <li>再次在剩下的元素中找到最小的元素,将它与数组的第二个元素交换位置</li>
  <li>如此往复,直到整个数组有序
    <hr />
  </li>
</ol>

<h3 id="图解">图解</h3>
<hr />
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/selectSort/selectSort.jpg">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="选择排序" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/selectSort/selectSort.jpg" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">HeapSort</div>
    </a>
</center>

<h4 id="代码">代码</h4>
<blockquote>
  <p>java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">selectSort</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">){</span>
    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">nums</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">len</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
        <span class="kt">int</span> <span class="n">min</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">len</span><span class="o">;</span><span class="n">j</span><span class="o">++){</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">nums</span><span class="o">[</span><span class="n">min</span><span class="o">]</span> <span class="o">&gt;</span> <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">]){</span>
                <span class="n">min</span><span class="o">=</span><span class="n">j</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">swap</span><span class="o">(</span><span class="n">nums</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">min</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">swap</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">j</span><span class="o">){</span>
    <span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
    <span class="n">nums</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">];</span>
    <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>时间复杂度:O(n^2)</p>

  <p>空间复杂度:O(1)</p>
</blockquote>

<h3 id="其他语言">其他语言</h3>
<hr />
<blockquote>
  <p>C++</p>
</blockquote>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Solution</span> <span class="p">{</span>
<span class="nl">public:</span>
	<span class="kt">void</span> <span class="n">selectSort</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">nums</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">nums</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">min</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">nums</span><span class="p">[</span><span class="n">min</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
				<span class="p">{</span>
					<span class="n">min</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">swap</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="kt">void</span> <span class="n">swap</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">nums</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">j</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>
<blockquote>
  <p>python3</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Solution</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">selectSort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nums</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
            <span class="nb">min</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">nums</span><span class="p">[</span><span class="nb">min</span><span class="p">]</span><span class="o">&gt;</span><span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                    <span class="nb">min</span> <span class="o">=</span> <span class="n">j</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="nb">min</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">swap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nums</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">i</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">j</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>
</code></pre></div></div>
<blockquote>
  <p>go</p>
</blockquote>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">selectSort</span><span class="p">(</span><span class="n">nums</span> <span class="p">[]</span><span class="kt">int</span><span class="p">)</span>  <span class="p">{</span>
	<span class="nb">len</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">i</span><span class="o">:=</span><span class="m">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">;</span><span class="n">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="n">min</span><span class="o">:=</span><span class="n">i</span>
		<span class="k">for</span> <span class="n">j</span><span class="o">:=</span><span class="n">i</span><span class="o">+</span><span class="m">1</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">;</span><span class="n">j</span><span class="o">++</span> <span class="p">{</span>
			<span class="k">if</span> <span class="n">nums</span><span class="p">[</span><span class="n">min</span><span class="p">]</span><span class="o">&gt;</span><span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">{</span>
				<span class="n">min</span> <span class="o">=</span> <span class="n">j</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">swap1</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">swap1</span><span class="p">(</span><span class="n">nums</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">i</span> <span class="kt">int</span><span class="p">,</span> <span class="n">j</span> <span class="kt">int</span><span class="p">){</span>
	<span class="n">temp</span> <span class="o">:=</span> <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
	<span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
	<span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>
<span class="p">}</span>
</code></pre></div></div>
</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">Start Bootstrap</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">April 2021</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">algorithm</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-10000004" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2>InsertSort</h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/pexels-nick-wehrli-6524730.jpg" class="img-responsive img-centered" alt="insertSort">

                            
                                <h3>插入排序</h3>
                            
                            </div>

                            <p><h3 id="基本思想">基本思想</h3>
<hr />
<p>类似于我们打牌时,将每一张牌插入到其他已经有序的牌中的适当位置.<br />
为了要给插入的元素腾出空间,需要将其余所有元素在插入之前都向右移动一位.</p>
<hr />

<h3 id="思路">思路</h3>
<hr />
<ol>
  <li>首先从外层i=1开始遍历数组,保证前i个元素有序</li>
  <li>内层j从i向前遍历,同时比较相邻的两个数,将nums[i]插入到合适位置</li>
  <li>每次内循环保证前i个元素有序</li>
  <li>重复以上步骤直到外层遍历结束即数组有序
    <hr />
  </li>
</ol>

<h3 id="图解">图解</h3>
<hr />
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/insertSort/insertSort.jpg">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="插入排序" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/insertSort/insertSort.jpg" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">InsertSort</div>
    </a>
</center>

<h4 id="代码">代码</h4>
<blockquote>
  <p>java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">insertSort</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">){</span>
    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">nums</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">len</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="n">i</span><span class="o">;</span><span class="n">j</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">]&lt;</span><span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="o">];</span><span class="n">j</span><span class="o">--){</span>
            <span class="n">swap</span><span class="o">(</span><span class="n">nums</span><span class="o">,</span> <span class="n">j</span><span class="o">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">swap</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">j</span><span class="o">){</span>
    <span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
    <span class="n">nums</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">];</span>
    <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>时间复杂度:O(n^2)</p>

  <p>空间复杂度:O(1)</p>
</blockquote>

<h3 id="其他语言">其他语言</h3>
<hr />
<blockquote>
  <p>C++</p>
</blockquote>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Solution</span> <span class="p">{</span>
<span class="nl">public:</span>
	<span class="kt">void</span> <span class="n">insertSort</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">nums</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">nums</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">swap</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>
				
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="kt">void</span> <span class="n">swap</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">nums</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">j</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>
<blockquote>
  <p>python3</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Solution</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">insertSort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nums</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">&lt;</span><span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">swap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nums</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>
</code></pre></div></div>
<blockquote>
  <p>go</p>
</blockquote>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">insertSort</span><span class="p">(</span><span class="n">nums</span> <span class="p">[]</span><span class="kt">int</span><span class="p">)</span>  <span class="p">{</span>
	<span class="nb">len</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">i</span><span class="o">:=</span><span class="m">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">;</span><span class="n">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="k">for</span> <span class="n">j</span><span class="o">:=</span><span class="n">i</span><span class="p">;</span><span class="n">j</span><span class="o">&gt;</span><span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">&lt;</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="m">1</span><span class="p">];</span><span class="n">j</span><span class="o">--</span> <span class="p">{</span>
			<span class="n">swap2</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="m">1</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">swap2</span><span class="p">(</span><span class="n">nums</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="kt">int</span><span class="p">)</span>  <span class="p">{</span>
	<span class="n">temp</span> <span class="o">:=</span> <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
	<span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
	<span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>
<span class="p">}</span>
</code></pre></div></div>
</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">Start Bootstrap</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">April 2021</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">algorithm</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-10000003" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2>HeapSort</h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/pexels-valeriya-kobzar-8155476.jpg" class="img-responsive img-centered" alt="heapSort">

                            
                                <h3>堆排序</h3>
                            
                            </div>

                            <p><h3 id="前置概念">前置概念</h3>
<hr />
<p>完全二叉树:叶子节点只能出现在最下层或次下层,且最下层的叶子节点集中在树的左部.即除了最后一层其他层的节点个数都是满的而且最后一层的叶子节点必须靠左.</p>
<hr />
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/heapSort/完全二叉树.jpg">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="完全二叉树" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/heapSort/完全二叉树.jpg" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">完全二叉树</div>
    </a>
</center>

<h3 id="二叉堆">二叉堆</h3>
<hr />
<ol>
  <li>必须是完全二叉树</li>
  <li>二叉堆中的每一个节点,都必须大于等于(或小于等于)其子树中每个节点的值<br />
若每个节点大于等于子树中的每个节点,称之为大顶堆.
若每个节点小于等于子树中的每个节点,称之为小顶堆.
    <hr />
  </li>
</ol>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/heapSort/大小顶堆.jpg">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="大小顶堆" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/heapSort/大小顶堆.jpg" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">小顶堆/大顶堆</div>
    </a>
</center>

<p><br /></p>

<p>我们仔细观察下大顶堆和小顶堆,可以发现如果父节点的位置为0,其左子节点的位置1,右子节点的位置为2.<br />
大约可以猜到父节点和左右子节点的关系为:若父节点的位置为1,那么左子节点的位置为 <strong>2×i+1</strong> ,右子节点的位置为 <strong>2×i+2</strong> .可以带入到其他节点验证一下.该属性是二叉堆调整的关键.<br />
注意:我们这里索引是从0开始的,如果索引从1开始的话,那么左右子节点的位置即是 <strong>2×i</strong> 和 <strong>2×i+1</strong> .</p>
<hr />
<h3 id="二叉堆的基本操作">二叉堆的基本操作</h3>
<hr />
<blockquote>
  <p>上浮:由下至上的堆有序化</p>
</blockquote>

<p>如果堆的有序状态因为某个节点的变得比它的父节点更大而打破,那么我们就需要通过交换它和它的父节点来修复堆,直到这个节点向上移动遇到一个更大的节点.<br />
若这个节点位置为k,那他的父节点位置就是 <strong>k/2</strong>,不断和父节点比较并交换位置即可.</p>
<hr />
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/heapSort/上浮.jpg">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="上浮" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/heapSort/上浮.jpg" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">上浮</div>
    </a>
</center>

<h4 id="代码">代码</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">swim</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">,</span> <span class="kt">int</span> <span class="n">k</span><span class="o">){</span>
    <span class="k">while</span><span class="o">(</span><span class="n">k</span><span class="o">&gt;</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">/</span><span class="mi">2</span><span class="o">]&lt;</span><span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">]){</span>
        <span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">/</span><span class="mi">2</span><span class="o">];</span>
        <span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">/</span><span class="mi">2</span><span class="o">]</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">];</span>
        <span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">;</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">/</span><span class="mi">2</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<hr />
<blockquote>
  <p>下沉:由上至下的堆有序化</p>
</blockquote>

<p>如果堆的有序状态因为某个节点变的比它的两个子节点或者其中之一更小而打破了,那么我们可以通过将它和它的两个子节点中的较大者交换来恢复堆,交换知道它的子节点都比他更小或达到堆的底部.<br />
若节点的位置为k,那么它的左右子节点的位置为 <strong>2×k+1</strong> 和 <strong>2×k+2</strong>,不断和这两个节点比较并交换即可.</p>
<hr />
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/heapSort/下沉.jpg">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="下沉" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/heapSort/下沉.jpg" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">下沉</div>
    </a>
</center>

<h4 id="代码-1">代码</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">sink</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">,</span> <span class="kt">int</span> <span class="n">k</span><span class="o">,</span> <span class="kt">int</span> <span class="no">N</span><span class="o">){</span>
    <span class="k">while</span><span class="o">(</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="o">&lt;</span><span class="no">N</span><span class="o">){</span>
        <span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="o">;</span>
        <span class="k">if</span><span class="o">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="o">&lt;</span><span class="no">N</span> <span class="o">&amp;&amp;</span> <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="o">]&gt;</span><span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">]){</span>
            <span class="n">j</span><span class="o">++;</span>
        <span class="o">}</span>
        <span class="k">if</span><span class="o">(</span><span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">&lt;</span> <span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">]){</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">];</span>
        <span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">];</span>
        <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">;</span>
        <span class="n">k</span><span class="o">=</span><span class="n">j</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="基本思想">基本思想</h3>
<hr />
<p>主要就是构建堆,利用大顶堆或小顶堆的性质排序</p>
<hr />

<h3 id="思路">思路</h3>
<hr />
<p>堆排序其实就是两步</p>
<ol>
  <li>建堆:利用上浮和下沉构建大顶堆或小顶堆,上浮下沉图解见上方</li>
  <li>排序：
    <ul>
      <li>若为升序排序,那么应该建立大顶堆,然后将根节点和堆的最后一个节点交换,并将新的根节点下沉到合适位置即调整堆为大顶堆,此时数组最后即为最大元素,重复以上步骤,直到处理的数组长度为1.</li>
      <li>若为降序排序,那么就应该建立小顶堆,重复上面的交换流程,整个数据交换后数组有序.</li>
    </ul>
  </li>
</ol>

<hr />

<h3 id="图解">图解</h3>
<hr />
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/heapSort/堆排序.jpg">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="堆排序" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/heapSort/堆排序.jpg" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">HeapSort</div>
    </a>
</center>

<h4 id="代码-2">代码</h4>
<blockquote>
  <p>java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">int</span><span class="o">[]</span> <span class="nf">heapSort</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">){</span>
    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">nums</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
    <span class="c1">//1.利用下沉建立大顶堆</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="n">len</span><span class="o">/</span><span class="mi">2</span><span class="o">;</span><span class="n">i</span><span class="o">&gt;=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">--){</span>
        <span class="n">sink</span><span class="o">(</span><span class="n">nums</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">len</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//2.排序</span>
    <span class="k">while</span><span class="o">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">){</span>
        <span class="n">swap</span><span class="o">(</span><span class="n">nums</span><span class="o">,</span> <span class="mi">0</span> <span class="o">,--</span><span class="n">len</span><span class="o">);</span>
        <span class="n">sink</span><span class="o">(</span><span class="n">nums</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">len</span><span class="o">);</span> 
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">nums</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">//下沉</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">sink</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">,</span> <span class="kt">int</span> <span class="n">k</span><span class="o">,</span> <span class="kt">int</span> <span class="n">len</span><span class="o">){</span>
    <span class="k">while</span><span class="o">(</span><span class="n">k</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="o">&lt;</span><span class="n">len</span><span class="o">){</span>
        <span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="o">;</span>
        <span class="k">while</span><span class="o">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="o">&lt;</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="o">]&gt;</span><span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">]){</span>
            <span class="n">j</span><span class="o">++;</span>
        <span class="o">}</span>
        <span class="k">if</span><span class="o">(</span><span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">]&lt;</span><span class="n">nums</span><span class="o">[</span><span class="n">k</span><span class="o">]){</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">swap</span><span class="o">(</span><span class="n">nums</span><span class="o">,</span> <span class="n">k</span><span class="o">,</span> <span class="n">j</span><span class="o">);</span>
        <span class="n">k</span><span class="o">=</span><span class="n">j</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">swap</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">j</span><span class="o">){</span>
    <span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
    <span class="n">nums</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">];</span>
    <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>时间复杂度:O(n*logn)</p>

  <p>空间复杂度:O(1)</p>
</blockquote>

<h3 id="扩展点">扩展点</h3>
<hr />
<ol>
  <li>常使用大小堆维护中位数, 左边使用大顶堆, 右边使用小顶堆, 这样左边取最大值右边取最小值即可. 见算法题<a href="https://leetcode-cn.com/problems/find-median-from-data-stream/">数据流的中位数</a>
    <hr />
  </li>
</ol>

<h3 id="其他语言">其他语言</h3>
<hr />
<blockquote>
  <p>C++</p>
</blockquote>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Solution</span> <span class="p">{</span>
<span class="nl">public:</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">heapSort</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">nums</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">nums</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
		<span class="c1">//建堆</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">len</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">sink</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="c1">//排序</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">swap</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">--</span><span class="n">len</span><span class="p">);</span>
			<span class="n">sink</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">nums</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="kt">void</span> <span class="n">sink</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">nums</span><span class="p">,</span> <span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="o">&lt;</span><span class="n">len</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="o">&lt;</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
			<span class="p">{</span>
				<span class="n">j</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">&lt;</span><span class="n">nums</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
			<span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">swap</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>
			<span class="n">k</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="kt">void</span> <span class="n">swap</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">nums</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">j</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">};</span>

</code></pre></div></div>
<blockquote>
  <p>python3</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Solution</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">heapSort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nums</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">length</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">length</span><span class="o">-=</span><span class="mi">1</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">sink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nums</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">k</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="nb">len</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span>
        <span class="k">while</span> <span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">while</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="o">&lt;</span><span class="nb">len</span> <span class="ow">and</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">nums</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="n">k</span><span class="o">=</span><span class="n">j</span>

    <span class="k">def</span> <span class="nf">swap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nums</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">j</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>
</code></pre></div></div>
<blockquote>
  <p>go</p>
</blockquote>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">heapSort</span><span class="p">(</span><span class="n">nums</span> <span class="p">[]</span><span class="kt">int</span><span class="p">)</span> <span class="p">[]</span><span class="kt">int</span> <span class="p">{</span>
	<span class="nb">len</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">i</span><span class="o">:=</span><span class="nb">len</span><span class="o">/</span><span class="m">2</span><span class="p">;</span><span class="n">i</span><span class="o">&gt;=</span><span class="m">0</span><span class="p">;</span><span class="n">i</span><span class="o">--</span> <span class="p">{</span>
		<span class="n">sink</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="nb">len</span><span class="o">&gt;</span><span class="m">1</span> <span class="p">{</span>
		<span class="nb">len</span> <span class="o">-=</span><span class="m">1</span>
		<span class="n">swap</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">)</span>
		<span class="n">sink</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="m">0</span> <span class="p">,</span><span class="nb">len</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nums</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">sink</span><span class="p">(</span><span class="n">nums</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">k</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">len</span> <span class="kt">int</span><span class="p">)</span>  <span class="p">{</span>
	<span class="k">for</span> <span class="m">2</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="m">1</span><span class="o">&lt;</span><span class="nb">len</span> <span class="p">{</span>
		<span class="n">j</span><span class="o">:=</span><span class="m">2</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="m">1</span>
		<span class="k">for</span> <span class="n">j</span><span class="o">+</span><span class="m">1</span><span class="o">&lt;</span><span class="nb">len</span> <span class="o">&amp;&amp;</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="m">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">{</span>
			<span class="n">j</span><span class="o">++</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="n">nums</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">{</span>
			<span class="k">break</span>
		<span class="p">}</span>
		<span class="n">swap</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
		<span class="n">k</span><span class="o">=</span><span class="n">j</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">Start Bootstrap</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">April 2021</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">algorithm</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-10000002" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2>QuickSort</h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/pexels-jo-jesus-4198220.jpg" class="img-responsive img-centered" alt="quickSort">

                            
                                <h3>快速排序</h3>
                            
                            </div>

                            <p><h3 id="基本思想">基本思想</h3>
<hr />
<p>是一种分治的排序算法,他将一个数组分成两个子数组,将两部分独立的排序.</p>
<hr />

<h3 id="思路">思路</h3>
<hr />
<ol>
  <li>首先以 <strong>left=0,right=nums.len-1</strong> 进行排序,最外层需要保证 <strong>left&lt;right</strong></li>
  <li>排序首先以 <strong>nums[left]</strong> 为基准值base</li>
  <li>然后将右指针从右往左遍历,当 <strong>left&lt;right且nums[right]&gt;=base</strong> 时,将右指针右移,否则就将右指针的值替换到左指针处 (此步的意义就是找到最右侧小于基准值base并将右侧值赋值到左指针的值)</li>
  <li>接着将左指针从左往右遍历,当 <strong>left&lt;right且nums[left]&lt;=base</strong> 时,将左指针左移,否则将左指针的值赋值给右指针 (此步同步骤三相反,即找到最左侧大于基准值base的值,并将此值赋值给右指针的值)</li>
  <li>最后当两个指针相交时,将base值赋值给nums[left],并同时将left返回作为下个区间的中间值</li>
  <li>接下来就是递归遍历 <strong>[left,temp-1]和[temp+1,right]</strong> ,遍历结束即数组有序</li>
</ol>

<hr />

<h3 id="图解">图解</h3>
<hr />
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/quickSort/quickSort1.jpg">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="quickSort1" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/quickSort/quickSort1.jpg" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
        display: inline-block;
        color: #999;
        padding: 2px;">第一层排序[0, 4]</div>
    </a>
</center>
<p><br /></p>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/quickSort/quickSort2.jpg">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="quickSort1" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/quickSort/quickSort2.jpg" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
        display: inline-block;
        color: #999;
        padding: 2px;">第二层排序[0,-1]和[1,4]</div>
    </a>
</center>
<p><br /></p>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/quickSort/quickSort3.jpg">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="quickSort1" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/quickSort/quickSort3.jpg" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
        display: inline-block;
        color: #999;
        padding: 2px;">第三轮排序[1,1]和[3,4]</div>
    </a>
</center>

<h4 id="代码">代码</h4>
<blockquote>
  <p>java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//解法一</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">quickSort1</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">,</span> <span class="kt">int</span> <span class="n">left</span><span class="o">,</span> <span class="kt">int</span> <span class="n">right</span><span class="o">){</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">right</span> <span class="o">&lt;=</span> <span class="n">left</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">base</span> <span class="o">=</span> <span class="n">division1</span><span class="o">(</span><span class="n">nums</span><span class="o">,</span> <span class="n">left</span><span class="o">,</span> <span class="n">right</span><span class="o">);</span>
    <span class="n">quickSort1</span><span class="o">(</span><span class="n">nums</span><span class="o">,</span> <span class="n">left</span><span class="o">,</span> <span class="n">base</span><span class="o">-</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">quickSort1</span><span class="o">(</span><span class="n">nums</span><span class="o">,</span> <span class="n">base</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span> <span class="n">right</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">division1</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">,</span> <span class="kt">int</span> <span class="n">left</span><span class="o">,</span> <span class="kt">int</span> <span class="n">right</span><span class="o">){</span>
    <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="n">left</span><span class="o">,</span> <span class="n">j</span><span class="o">=</span><span class="n">right</span><span class="o">+</span><span class="mi">1</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">base</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">base</span> <span class="o">&gt;=</span> <span class="n">nums</span><span class="o">[++</span><span class="n">i</span><span class="o">]){</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">i</span><span class="o">==</span><span class="n">right</span><span class="o">){</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">base</span> <span class="o">&lt;=</span> <span class="n">nums</span><span class="o">[--</span><span class="n">j</span><span class="o">]){</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">j</span><span class="o">==</span><span class="n">left</span><span class="o">){</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">i</span><span class="o">&gt;=</span><span class="n">j</span><span class="o">){</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">exchange</span><span class="o">(</span><span class="n">nums</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">j</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">exchange</span><span class="o">(</span><span class="n">nums</span><span class="o">,</span> <span class="n">left</span><span class="o">,</span> <span class="n">j</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">j</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">exchange</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">j</span><span class="o">){</span>
    <span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
    <span class="n">nums</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">];</span>
    <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">//解法二</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">quickSort</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">,</span> <span class="kt">int</span> <span class="n">left</span><span class="o">,</span> <span class="kt">int</span> <span class="n">right</span><span class="o">){</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">left</span><span class="o">&lt;</span> <span class="n">right</span><span class="o">){</span>
        <span class="kt">int</span> <span class="n">base</span> <span class="o">=</span> <span class="n">division</span><span class="o">(</span><span class="n">nums</span><span class="o">,</span> <span class="n">left</span><span class="o">,</span> <span class="n">right</span><span class="o">);</span>
        <span class="n">quickSort</span><span class="o">(</span><span class="n">nums</span><span class="o">,</span> <span class="n">left</span><span class="o">,</span> <span class="n">base</span><span class="o">-</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">quickSort</span><span class="o">(</span><span class="n">nums</span><span class="o">,</span> <span class="n">base</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span> <span class="n">right</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">division</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">,</span> <span class="kt">int</span> <span class="n">left</span><span class="o">,</span> <span class="kt">int</span> <span class="n">right</span><span class="o">){</span>
    <span class="kt">int</span> <span class="n">base</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">left</span><span class="o">];</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">left</span><span class="o">&lt;</span><span class="n">right</span><span class="o">){</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">left</span><span class="o">&lt;</span><span class="n">right</span> <span class="o">&amp;&amp;</span> <span class="n">nums</span><span class="o">[</span><span class="n">right</span><span class="o">]&gt;=</span><span class="n">base</span><span class="o">){</span>
            <span class="n">right</span><span class="o">--;</span>
        <span class="o">}</span>
        <span class="n">nums</span><span class="o">[</span><span class="n">left</span><span class="o">]</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">right</span><span class="o">];</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">left</span><span class="o">&lt;</span><span class="n">right</span> <span class="o">&amp;&amp;</span> <span class="n">nums</span><span class="o">[</span><span class="n">left</span><span class="o">]&lt;=</span><span class="n">base</span><span class="o">){</span>
            <span class="n">left</span><span class="o">++;</span>
        <span class="o">}</span>
        <span class="n">nums</span><span class="o">[</span><span class="n">right</span><span class="o">]</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">left</span><span class="o">];</span>
    <span class="o">}</span>
    <span class="n">nums</span><span class="o">[</span><span class="n">left</span><span class="o">]=</span><span class="n">base</span><span class="o">;</span>
    <span class="k">return</span> <span class="n">left</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<blockquote>
  <p>时间复杂度:O(nlogn)</p>

  <p>空间复杂度:O(1)</p>
</blockquote>

<h3 id="算法改进">算法改进</h3>
<hr />
<ol>
  <li>切换到插入排序
    <ul>
      <li>对于小数组,快速排序比插入排序慢</li>
      <li>因为递归,快速排序的sort()方法在小数组中也会调用自己</li>
    </ul>
  </li>
  <li>三取样切分
    <ul>
      <li>使用子数组的一小部分元素的中位数来切分数组</li>
    </ul>
  </li>
  <li>熵最优的排序
    <ul>
      <li>在有大量重复元素的情况下,快速排序的递归性会使元素全部重复的子数组经常出现,这就有很大的改进空间,将当前实现的线性对数级的性能提高到线性级别.</li>
    </ul>
  </li>
</ol>

<hr />

<h3 id="三项切分的快速排序">三项切分的快速排序</h3>
<h3 id="基本思想-1">基本思想</h3>
<hr />
<p>将数组切成三部分,分别对应小于、等于和大于切分元素的数组元素.</p>
<hr />

<h3 id="思路-1">思路</h3>
<hr />
<ol>
  <li>他从左到右遍历数组一次,维护一个指针 <strong>lt</strong> 使得 <strong>a[lo..lt-1]</strong> 中的元素都小于 <strong>v</strong> ,一个指针 <strong>gt</strong> 使得 <strong>a[gt+1..hi]</strong> 中的元素都大于 <strong>v</strong> ,一个指针 <strong>i</strong> 使得 <strong>a[lt..i-1]</strong> 中的元素都等于 <strong>v</strong> , <strong>a[i..gt]</strong> 中的元素都还未确定.</li>
  <li>一开始 <strong>i</strong> 和 <strong>lo</strong> 相等,我们使用Comparable接口对 <strong>a[i]</strong> 进行三向比较来处理以下情况:
    <ul>
      <li><strong>a[i]</strong> 小于 <strong>v</strong> ,将 <strong>a[lt]</strong> 和 <strong>a[i]</strong> 交换,将 <strong>lt</strong> 和 <strong>i</strong> 加一</li>
      <li><strong>a[i]</strong> 大于 <strong>v</strong> ,将 <strong>a[gt]</strong> 和 <strong>a[i]</strong> 交换,将 <strong>gt</strong> 减一</li>
      <li><strong>a[i]</strong> 等于 <strong>v</strong> ,将 <strong>i</strong> 加一</li>
    </ul>
  </li>
</ol>

<p>这些操作都会保证数组元素不变且缩小 <strong>gt-i</strong> 的值(这样循环才会结束).另外,除非和切分元素相等,其他元素都会被交换.</p>
<hr />

<h3 id="三向切分示意图">三向切分示意图</h3>

<center>
     <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/quickSort/三向切分示意图.jpg">
     <img style="border-radius: 0.3125em;
     box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="三向切分" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/quickSort/三向切分示意图.jpg" />
     <div style="color:orange; border-bottom: 1px solid #d9d9d9;
         display: inline-block;
         color: #999;
         padding: 2px;">三向切分示意图</div>
     </a>
 </center>

<h3 id="三向切分代码">三向切分代码</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">quick3way</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">,</span> <span class="kt">int</span> <span class="n">lo</span><span class="o">,</span> <span class="kt">int</span> <span class="n">hi</span><span class="o">){</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">hi</span><span class="o">&lt;=</span><span class="n">lo</span><span class="o">){</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">int</span> <span class="n">lt</span><span class="o">=</span><span class="n">lo</span><span class="o">,</span> <span class="n">i</span><span class="o">=</span><span class="n">lo</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span><span class="n">gt</span><span class="o">=</span><span class="n">hi</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">lo</span><span class="o">];</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">gt</span><span class="o">){</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">nums</span><span class="o">[</span><span class="n">i</span><span class="o">]&lt;</span><span class="n">v</span><span class="o">){</span>
            <span class="n">exchange</span><span class="o">(</span><span class="n">nums</span><span class="o">,</span> <span class="n">lt</span><span class="o">++,</span><span class="n">i</span><span class="o">++);</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">nums</span><span class="o">[</span><span class="n">i</span><span class="o">]&gt;</span><span class="n">v</span><span class="o">){</span>
            <span class="n">exchange</span><span class="o">(</span><span class="n">nums</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">gt</span><span class="o">--);</span>
        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
            <span class="n">i</span><span class="o">++;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">quick3way</span><span class="o">(</span><span class="n">nums</span><span class="o">,</span> <span class="n">lo</span><span class="o">,</span> <span class="n">lt</span><span class="o">-</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">quick3way</span><span class="o">(</span><span class="n">nums</span><span class="o">,</span><span class="n">gt</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span> <span class="n">hi</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">exchange</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">j</span><span class="o">){</span>
    <span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
    <span class="n">nums</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">];</span>
    <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="其他语言">其他语言</h3>
<hr />
<blockquote>
  <p>c++</p>
</blockquote>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Solution</span> <span class="p">{</span>
<span class="nl">public:</span>
	<span class="kt">void</span> <span class="n">quickSort</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">nums</span><span class="p">,</span> <span class="kt">int</span> <span class="n">left</span><span class="p">,</span> <span class="kt">int</span> <span class="n">right</span><span class="p">)</span> 
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">left</span><span class="o">&lt;</span><span class="n">right</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">division</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
			<span class="n">quickSort</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">temp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">quickSort</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">temp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="kt">int</span> <span class="n">division</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">nums</span><span class="p">,</span> <span class="kt">int</span> <span class="n">left</span><span class="p">,</span> <span class="kt">int</span> <span class="n">right</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">base</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">left</span><span class="p">];</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">left</span><span class="o">&lt;</span><span class="n">right</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">left</span> <span class="o">&lt;</span> <span class="n">right</span> <span class="o">&amp;&amp;</span> <span class="n">nums</span><span class="p">[</span><span class="n">right</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">base</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">right</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">nums</span><span class="p">[</span><span class="n">left</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">right</span><span class="p">];</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">left</span> <span class="o">&lt;</span> <span class="n">right</span> <span class="o">&amp;&amp;</span> <span class="n">nums</span><span class="p">[</span><span class="n">left</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">base</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">left</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">nums</span><span class="p">[</span><span class="n">right</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">left</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">nums</span><span class="p">[</span><span class="n">left</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">left</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>
<blockquote>
  <p>python3</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Solution</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">quickSort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nums</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">left</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">division</span><span class="p">(</span><span class="n">nums</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">left</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">int</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">left</span><span class="p">]</span>
            <span class="k">while</span> <span class="n">left</span><span class="o">&lt;</span><span class="n">right</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">left</span><span class="o">&lt;</span><span class="n">right</span> <span class="ow">and</span> <span class="n">nums</span><span class="p">[</span><span class="n">right</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">base</span><span class="p">:</span>
                    <span class="n">right</span><span class="o">-=</span><span class="mi">1</span>
                <span class="n">nums</span><span class="p">[</span><span class="n">left</span><span class="p">]</span><span class="o">=</span><span class="n">nums</span><span class="p">[</span><span class="n">right</span><span class="p">]</span>
                <span class="k">while</span> <span class="n">left</span><span class="o">&lt;</span><span class="n">right</span> <span class="ow">and</span> <span class="n">nums</span><span class="p">[</span><span class="n">left</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">base</span><span class="p">:</span>
                    <span class="n">left</span><span class="o">+=</span><span class="mi">1</span>
                <span class="n">nums</span><span class="p">[</span><span class="n">right</span><span class="p">]</span><span class="o">=</span><span class="n">nums</span><span class="p">[</span><span class="n">left</span><span class="p">]</span>
            <span class="n">nums</span><span class="p">[</span><span class="n">left</span><span class="p">]</span><span class="o">=</span><span class="n">base</span>
            <span class="k">return</span> <span class="n">left</span>
        <span class="k">if</span> <span class="n">left</span><span class="o">&lt;</span><span class="n">right</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">division</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">left</span> <span class="p">,</span><span class="n">right</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">quickSort</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">temp</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">quickSort</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">temp</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
</code></pre></div></div>
<blockquote>
  <p>go</p>
</blockquote>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">quickSort</span><span class="p">(</span><span class="n">nums</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">left</span> <span class="kt">int</span><span class="p">,</span> <span class="n">right</span> <span class="kt">int</span><span class="p">)</span>  <span class="p">{</span>
		<span class="k">var</span> <span class="n">division</span> <span class="k">func</span><span class="p">(</span><span class="n">nums</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">left</span> <span class="kt">int</span><span class="p">,</span> <span class="n">right</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span>
		<span class="n">division</span> <span class="o">=</span> <span class="k">func</span><span class="p">(</span><span class="n">nums</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="n">left</span> <span class="kt">int</span><span class="p">,</span> <span class="n">right</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
			<span class="n">base</span> <span class="o">:=</span> <span class="n">nums</span><span class="p">[</span><span class="n">left</span><span class="p">]</span>
			<span class="k">for</span> <span class="n">left</span><span class="o">&lt;</span><span class="n">right</span> <span class="p">{</span>
				<span class="k">for</span> <span class="n">left</span><span class="o">&lt;</span><span class="n">right</span> <span class="o">&amp;&amp;</span> <span class="n">nums</span><span class="p">[</span><span class="n">right</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">base</span> <span class="p">{</span>
					<span class="n">right</span><span class="o">--</span>
				<span class="p">}</span>
				<span class="n">nums</span><span class="p">[</span><span class="n">left</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">right</span><span class="p">]</span>
				<span class="k">for</span> <span class="n">left</span><span class="o">&lt;</span><span class="n">right</span> <span class="o">&amp;&amp;</span> <span class="n">nums</span><span class="p">[</span><span class="n">left</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">base</span> <span class="p">{</span>
					<span class="n">left</span><span class="o">++</span>
				<span class="p">}</span>
				<span class="n">nums</span><span class="p">[</span><span class="n">right</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">left</span><span class="p">]</span>
			<span class="p">}</span>
			<span class="n">nums</span><span class="p">[</span><span class="n">left</span><span class="p">]</span><span class="o">=</span><span class="n">base</span>
			<span class="k">return</span> <span class="n">left</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="n">left</span><span class="o">&lt;</span><span class="n">right</span> <span class="p">{</span>
			<span class="n">temp</span><span class="o">:=</span><span class="n">division</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
			<span class="n">quickSort</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">temp</span><span class="o">-</span><span class="m">1</span><span class="p">)</span>
			<span class="n">quickSort</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span> <span class="n">temp</span><span class="o">+</span><span class="m">1</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
		<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">Start Bootstrap</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">April 2021</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">algorithm</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-10000001" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2>BubbleSort</h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/pexels-rachel-claire-4846299.jpg" class="img-responsive img-centered" alt="bubbleSort">

                            
                                <h3>冒泡排序</h3>
                            
                            </div>

                            <p><h3 id="基本思想">基本思想</h3>
<hr />
<p>就是两两比较然后交换位置,将较小值不断向前移动</p>
<hr />

<h3 id="思路">思路</h3>
<hr />
<ol>
  <li>首先需要两层循环,外层从 <strong>i=0</strong> 开始</li>
  <li>内层循环的主要作用就根据遍历顺序保证最大值或最小值已经移动到数组的末尾或者开头</li>
</ol>

<p>内层有两者方式：</p>
<ul>
  <li>从前往后:j从0一直遍历到nums.len-1-i 处,同时比较 <strong>nums[j]</strong> 和 <strong>nums[j+1]</strong> 的值,只有 <strong>nums[j]&gt;nums[j+1]</strong> 时才将 <strong>nums[j]</strong> 向后移动,每次循环结束保证最大值在末尾</li>
  <li>从后往前:j从nums.len一直遍历到 i 处,同时比较 <strong>nums[j-1]和nums[j]</strong> 的值,只有 <strong>nums[j-1]&gt;nums[j]</strong> 时才将 <strong>nums[j]</strong> 向前移动,每次循环结束保证最小值在开头</li>
</ul>

<hr />

<h3 id="内层逆序图解">内层逆序图解</h3>
<hr />
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/bubbleSort/BubbleSort.jpg">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="BubbleSort" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/algorithm/bubbleSort/BubbleSort.jpg" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">bubbleSort</div>
    </a>
</center>

<h4 id="代码">代码</h4>
<blockquote>
  <p>java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//内层逆序遍历</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">bubbleSort</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">){</span>
     <span class="kt">int</span> <span class="n">temp</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="n">nums</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">){</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">nums</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="n">j</span><span class="o">&gt;</span><span class="n">i</span><span class="o">;</span> <span class="n">j</span><span class="o">--){</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="o">]&gt;</span> <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">]){</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="o">];</span>
                <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">];</span>
                <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">//内层正序遍历</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">bubbleSort</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">nums</span><span class="o">==</span><span class="kc">null</span> <span class="o">||</span> <span class="n">nums</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">){</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nums</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nums</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>   
                <span class="k">if</span> <span class="o">(</span><span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">&gt;</span> <span class="n">nums</span><span class="o">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="o">])</span> <span class="o">{</span>
                    <span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">];</span>
                    <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="o">];</span>
                    <span class="n">nums</span><span class="o">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p>时间复杂度:O(n^2)</p>

  <p>空间复杂度:O(1)</p>
</blockquote>

<h3 id="算法优化">算法优化</h3>
<hr />
<p>没有什么大的优化,主要是若一次遍历过后中间没有移动的动作说明数组已经有序,无需继续往后遍历,直接结束</p>
<hr />

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">bubbleSort</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">temp</span><span class="o">;</span>
    <span class="kt">boolean</span> <span class="n">flag</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="n">nums</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span><span class="o">++</span> <span class="o">){</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">nums</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="n">j</span><span class="o">&gt;</span><span class="n">i</span><span class="o">;</span> <span class="n">j</span><span class="o">--){</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="o">]&gt;</span> <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">]){</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="o">];</span>
                <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">];</span>
                <span class="n">nums</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">;</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">flag</span><span class="o">){</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="其他语言">其他语言</h3>
<hr />
<blockquote>
  <p>C++</p>
</blockquote>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Solution</span> <span class="p">{</span>
<span class="nl">public:</span>
	<span class="c1">//内部正序</span>
	<span class="kt">void</span> <span class="n">bubbleSort</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">nums</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">nums</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">len</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">nums</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
				<span class="p">{</span>
					<span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
					<span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
					<span class="n">nums</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="c1">//内部逆序</span>
	<span class="kt">void</span> <span class="n">bubbleSort1</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">nums</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">nums</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span>  <span class="n">j</span> <span class="o">=</span> <span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;</span><span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
				<span class="p">{</span>
					<span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
					<span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
					<span class="n">nums</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<blockquote>
  <p>python3</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Solution</span><span class="p">:</span>
    <span class="c1">#内部正序
</span>    <span class="k">def</span> <span class="nf">bubbleSort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nums</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>

    <span class="c1">#内部正序
</span>    <span class="k">def</span> <span class="nf">bubbleSort1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nums</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">(</span><span class="n">length</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>
</code></pre></div></div>
<blockquote>
  <p>go</p>
</blockquote>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//内部逆序</span>
<span class="k">func</span> <span class="n">bubbleSort</span><span class="p">(</span><span class="n">nums</span> <span class="p">[]</span><span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">len</span> <span class="o">:=</span><span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">i</span><span class="o">:=</span><span class="m">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="o">-</span><span class="m">1</span><span class="p">;</span><span class="n">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="k">for</span> <span class="n">j</span><span class="o">:=</span><span class="m">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="nb">len</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="m">1</span><span class="p">;</span><span class="n">j</span><span class="o">++</span> <span class="p">{</span>
			<span class="k">if</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="m">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">{</span>
				<span class="n">temp</span><span class="o">:=</span><span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
				<span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="m">1</span><span class="p">]</span>
				<span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="m">1</span><span class="p">]</span><span class="o">=</span><span class="n">temp</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">bubbleSort1</span><span class="p">(</span><span class="n">nums</span> <span class="p">[]</span><span class="kt">int</span><span class="p">){</span>
	<span class="nb">len</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">i</span><span class="o">:=</span><span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">;</span><span class="n">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="k">for</span> <span class="n">j</span><span class="o">:=</span><span class="nb">len</span><span class="o">-</span><span class="m">1</span><span class="p">;</span><span class="n">j</span><span class="o">&gt;</span><span class="n">i</span><span class="p">;</span><span class="n">j</span><span class="o">--</span> <span class="p">{</span>
			<span class="k">if</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="m">1</span><span class="p">]</span> <span class="p">{</span>
				<span class="n">temp</span><span class="o">:=</span><span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
				<span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="m">1</span><span class="p">]</span>
				<span class="n">nums</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="m">1</span><span class="p">]</span><span class="o">=</span><span class="n">temp</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">Start Bootstrap</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">April 2021</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">algorithm</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-20000001" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2>SpringBoot启动源码解析(一)</h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/pexels-david-selbert-6468061.jpg" class="img-responsive img-centered" alt="SpringBoot1">

                            
                                <h3>SpringBootApplication注解分析</h3>
                            
                            </div>

                            <p><h3 id="springbootapplication结构图">@SpringBootApplication结构图</h3>
<hr />
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/@SpringBootApplication注解.jpg">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="@SpringBootApplication注解" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/@SpringBootApplication注解.jpg" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">@SpringBootApplication注解</div>
    </a>
</center>

<h3 id="springbootapplication">@SpringBootApplication</h3>
<hr />
<blockquote>
  <p>源码如下</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Indicates a {@link Configuration configuration} class that declares one or more
 * {@link Bean @Bean} methods and also triggers {@link EnableAutoConfiguration
 * auto-configuration} and {@link ComponentScan component scanning}. This is a convenience
 * annotation that is equivalent to declaring {@code @Configuration},
 * {@code @EnableAutoConfiguration} and {@code @ComponentScan}.
 * 声明一个配置类,他声明一个或多个@Bean方法且触发 EnableAutoConfiguration自动配置和 ComponentScan组件扫描.
 * 这是一个便利的注解等同于声明 @Configuration、@EnableAutoConfiguration 和 @ComponentScan
 * @author Phillip Webb
 * @author Stephane Nicoll
 * @author Andy Wilkinson
 * @since 1.2.0
 */</span>
<span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Documented</span>
<span class="nd">@Inherited</span>
<span class="nd">@SpringBootConfiguration</span>
<span class="c1">//该注解的作用是开启自动配置</span>
<span class="nd">@EnableAutoConfiguration</span>
<span class="nd">@ComponentScan</span><span class="o">(</span><span class="n">excludeFilters</span> <span class="o">=</span> <span class="o">{</span> <span class="nd">@Filter</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="nc">FilterType</span><span class="o">.</span><span class="na">CUSTOM</span><span class="o">,</span> <span class="n">classes</span> <span class="o">=</span> <span class="nc">TypeExcludeFilter</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
		<span class="nd">@Filter</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="nc">FilterType</span><span class="o">.</span><span class="na">CUSTOM</span><span class="o">,</span> <span class="n">classes</span> <span class="o">=</span> <span class="nc">AutoConfigurationExcludeFilter</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">})</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">SpringBootApplication</span> <span class="o">{</span>

	<span class="nd">@AliasFor</span><span class="o">(</span><span class="n">annotation</span> <span class="o">=</span> <span class="nc">EnableAutoConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">exclude</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

	<span class="nd">@AliasFor</span><span class="o">(</span><span class="n">annotation</span> <span class="o">=</span> <span class="nc">EnableAutoConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="nc">String</span><span class="o">[]</span> <span class="nf">excludeName</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

	<span class="nd">@AliasFor</span><span class="o">(</span><span class="n">annotation</span> <span class="o">=</span> <span class="nc">ComponentScan</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">attribute</span> <span class="o">=</span> <span class="s">"basePackages"</span><span class="o">)</span>
	<span class="nc">String</span><span class="o">[]</span> <span class="nf">scanBasePackages</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

	<span class="nd">@AliasFor</span><span class="o">(</span><span class="n">annotation</span> <span class="o">=</span> <span class="nc">ComponentScan</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">attribute</span> <span class="o">=</span> <span class="s">"basePackageClasses"</span><span class="o">)</span>
	<span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">scanBasePackageClasses</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

	<span class="nd">@AliasFor</span><span class="o">(</span><span class="n">annotation</span> <span class="o">=</span> <span class="nc">Configuration</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="kt">boolean</span> <span class="nf">proxyBeanMethods</span><span class="o">()</span> <span class="k">default</span> <span class="kc">true</span><span class="o">;</span>

<span class="o">}</span>
</code></pre></div></div>
<p><strong>@SpringBootApplication</strong> 是最顶层注解,他主要由 <strong>@SpringBootConfiguration</strong> , <strong>@EnableAutoConfiguration</strong> , <strong>@Component</strong> 这个三个注解组合而成. <br />
接下来我们仔细分析下这三个注解分别做了什么事情.</p>
<hr />

<h3 id="springbootconfiguration">@SpringBootConfiguration</h3>
<hr />
<blockquote>
  <p>源码如下</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Indicates that a class provides Spring Boot application
 * {@link Configuration @Configuration}. Can be used as an alternative to the Spring's
 * standard {@code @Configuration} annotation so that configuration can be found
 * automatically (for example in tests).
 * 表明一个类提供Springboot应用的@Configuration.用来替代Spring标准的@Configuration注解，可以自动发现配置

 * &lt;p&gt;
 * Application should only ever include &lt;em&gt;one&lt;/em&gt; {@code @SpringBootConfiguration} and
 * most idiomatic Spring Boot applications will inherit it from
 * {@code @SpringBootApplication}.
 * 应用应该包含一个@SpringBootConfiguration注解并且大多数惯用的SpringBoot应用将继承@SpringBootConfiguration
 * @author Phillip Webb
 * @author Andy Wilkinson
 * @since 1.4.0
 */</span>
<span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Documented</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">SpringBootConfiguration</span> <span class="o">{</span>

	<span class="nd">@AliasFor</span><span class="o">(</span><span class="n">annotation</span> <span class="o">=</span> <span class="nc">Configuration</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="kt">boolean</span> <span class="nf">proxyBeanMethods</span><span class="o">()</span> <span class="k">default</span> <span class="kc">true</span><span class="o">;</span>

<span class="o">}</span>

<span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Documented</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">Configuration</span> <span class="o">{</span>

	<span class="nd">@AliasFor</span><span class="o">(</span><span class="n">annotation</span> <span class="o">=</span> <span class="nc">Component</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="nc">String</span> <span class="nf">value</span><span class="o">()</span> <span class="k">default</span> <span class="s">""</span><span class="o">;</span>

	<span class="kt">boolean</span> <span class="nf">proxyBeanMethods</span><span class="o">()</span> <span class="k">default</span> <span class="kc">true</span><span class="o">;</span>

<span class="o">}</span>
</code></pre></div></div>

<p>可见 <strong>@SpringBootApplication</strong> 的底层注解就是 <strong>@Configuration</strong> , 而 <strong>@Component</strong> 的底层注解是 <strong>@Component</strong> . <br />
<strong>@SpringBootApplication</strong> 的主要作用就是将目标类标记为配置类,交由Spring管理.在SpingBoot中就对应我们的启动函数.  <br />
下面我们看下这个配置主要用于哪里?</p>
<ul>
  <li>首先用于将主函数添加到 <strong>DefaultListableBeanFactory</strong> 中的 <strong>beanDefinitionMap</strong> 和 <strong>beanDefinitionNames</strong> 中,即将主函数注册为上下文中bean工厂的bean定义.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//代码位置</span>
<span class="o">-&gt;</span>  <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">boot</span><span class="o">.</span><span class="na">SpringApplication</span><span class="err">#</span><span class="n">prepareContext</span>   
<span class="o">-&gt;</span>  <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">boot</span><span class="o">.</span><span class="na">SpringApplication</span><span class="err">#</span><span class="n">load</span> 
<span class="o">-&gt;</span>  <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">boot</span><span class="o">.</span><span class="na">BeanDefinitionLoader</span><span class="err">#</span><span class="n">load</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Class</span><span class="o">&lt;?&gt;)</span>

<span class="kd">private</span> <span class="kt">int</span> <span class="nf">load</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isGroovyPresent</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="nc">GroovyBeanDefinitionSource</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">source</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">// Any GroovyLoaders added in beans{} DSL can contribute beans here</span>
        <span class="nc">GroovyBeanDefinitionSource</span> <span class="n">loader</span> <span class="o">=</span> <span class="nc">BeanUtils</span><span class="o">.</span><span class="na">instantiateClass</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="nc">GroovyBeanDefinitionSource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">load</span><span class="o">(</span><span class="n">loader</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 这里判断source(即主函数)是否被@Component修饰</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isComponent</span><span class="o">(</span><span class="n">source</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">annotatedReader</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isComponent</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// This has to be a bit of a guess. The only way to be sure that this type is</span>
    <span class="c1">// eligible is to make a bean definition out of it and try to instantiate it.</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">MergedAnnotations</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="nc">SearchStrategy</span><span class="o">.</span><span class="na">TYPE_HIERARCHY</span><span class="o">).</span><span class="na">isPresent</span><span class="o">(</span><span class="nc">Component</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// Nested anonymous classes are not eligible for registration, nor are groovy</span>
    <span class="c1">// closures</span>
    <span class="k">return</span> <span class="o">!</span><span class="n">type</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">matches</span><span class="o">(</span><span class="s">".*\\$_.*closure.*"</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">type</span><span class="o">.</span><span class="na">isAnonymousClass</span><span class="o">()</span>
            <span class="o">&amp;&amp;</span> <span class="n">type</span><span class="o">.</span><span class="na">getConstructors</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">type</span><span class="o">.</span><span class="na">getConstructors</span><span class="o">().</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>最后就是将main方法对应的类解析为配置类, 通过 <strong>ConfigurationClassPostProcessor</strong> 配置类后置处理器解析bean工厂中所有被 <strong>@Configuration</strong> 修饰的bean</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//代码位置</span>
<span class="o">-&gt;</span>  <span class="mi">1</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">boot</span><span class="o">.</span><span class="na">SpringApplication</span><span class="err">#</span><span class="n">refreshContext</span>
<span class="o">-&gt;</span>  <span class="mi">2</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">AbstractApplicationContext</span><span class="err">#</span><span class="n">invokeBeanFactoryPostProcessors</span>
<span class="o">-&gt;</span>  <span class="mi">3</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">PostProcessorRegistrationDelegate</span><span class="err">#</span><span class="n">invokeBeanDefinitionRegistryPostProcessors</span>
<span class="o">-&gt;</span>  <span class="mi">4</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ConfigurationClassPostProcessor</span><span class="err">#</span><span class="n">processConfigBeanDefinitions</span>

<span class="cm">/**
 * Build and validate a configuration model based on the registry of
 * {@link Configuration} classes.
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">processConfigBeanDefinitions</span><span class="o">(</span><span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="n">configCandidates</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="n">candidateNames</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getBeanDefinitionNames</span><span class="o">();</span>

    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span> <span class="o">:</span> <span class="n">candidateNames</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">BeanDefinition</span> <span class="n">beanDef</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">beanDef</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">CONFIGURATION_CLASS_ATTRIBUTE</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Bean definition has already been processed as a configuration class: "</span> <span class="o">+</span> <span class="n">beanDef</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">//此步就是判断当前类是否</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">checkConfigurationClassCandidate</span><span class="o">(</span><span class="n">beanDef</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">configCandidates</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">BeanDefinitionHolder</span><span class="o">(</span><span class="n">beanDef</span><span class="o">,</span> <span class="n">beanName</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// Return immediately if no @Configuration classes were found</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">configCandidates</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>
<p>综上所述, <strong>@SpringBootApplication</strong> 的作用就是将主函数对应类声明为可以被Spring处理的bean,并解析该bean交由Spring管理.</p>

<hr />

<h3 id="enableautoconfiguration">@EnableAutoConfiguration</h3>
<hr />
<blockquote>
  <p>源码如下</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Documented</span>
<span class="nd">@Inherited</span>
<span class="c1">//将主配置类所在的包及子包里面所有的组件扫描加载到Spring容器中</span>
<span class="nd">@AutoConfigurationPackage</span>
<span class="c1">//通过selectImports将自动配置类xxxAutoConfiguration导入到容器中</span>
<span class="nd">@Import</span><span class="o">(</span><span class="nc">AutoConfigurationImportSelector</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">EnableAutoConfiguration</span> <span class="o">{</span>

	<span class="c1">//	 * 当自动配置开启时可以用于重写的环境属性</span>
	<span class="nc">String</span> <span class="no">ENABLED_OVERRIDE_PROPERTY</span> <span class="o">=</span> <span class="s">"spring.boot.enableautoconfiguration"</span><span class="o">;</span>

	<span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">exclude</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

	<span class="nc">String</span><span class="o">[]</span> <span class="nf">excludeName</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

<span class="o">}</span>

<span class="cm">/**
 * Indicates that the package containing the annotated class should be registered with
 * {@link AutoConfigurationPackages}.
 * 使用AutoConfigurationPackages注册。如果未指定基础包或基础包的类，使用注解的类将被注册
 * @author Phillip Webb
 * @since 1.3.0
 * @see AutoConfigurationPackages
 */</span>
<span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Documented</span>
<span class="nd">@Inherited</span>
<span class="nd">@Import</span><span class="o">(</span><span class="nc">AutoConfigurationPackages</span><span class="o">.</span><span class="na">Registrar</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">AutoConfigurationPackage</span> <span class="o">{</span>

<span class="o">}</span>
</code></pre></div></div>

<p>可见 <strong>@EnableAutoConfiguration</strong> 是由 <strong>@AutoConfigurationPackage</strong> 和 <strong>@Import(AutoConfigurationImportSelector.class)</strong> 组成, 而 <strong>@AutoConfigurationPackage</strong> 又是由 <strong>@Import(AutoConfigurationPackages.Registrar.class)</strong> 组成.<br />
所以 <strong>@EnableAutoConfiguration</strong> 其实就是由两个 <strong>@Import</strong> 注解组成的, 顾名思义它的作用就是导入指定类的,即 <strong>AutoConfigurationImportSelector.class</strong> 和 <strong>AutoConfigurationPackages.Registrar.class</strong> . <br />
接下来我们看下这两个类的作用是什么,具体在哪里生效的?  <br />
首先看下这个两个类的类图,供后面使用</p>
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/AutoConfigurationImportSelector.jpg">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="AutoConfigurationImportSelector类图" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/AutoConfigurationImportSelector.jpg" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">AutoConfigurationImportSelector类图</div>
    </a>
</center>

<p>主要看实现的 <strong>DeferredImportSelector</strong> 及其父接口 <strong>ImportSelector</strong> .  <br />
<strong>ImportSelector</strong> :主要作用就是通过 <strong>selectImports</strong> 方法确定要导入的类,在启动过程中对应导入 <strong>/META_INF/factories</strong> 中的 <strong>EnableAutoConfiguration.class</strong> 的子类.<br />
<strong>DeferredImportSelector</strong> :主要作用就是筛选根据父类 <strong>ImportSelector</strong> 中 <strong>selectImports</strong> 方法确定要导入的类.</p>

<hr />
<center>
    <a href="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/Registrar.jpg">
    <img style="border-radius: 0.3125em;
    box-shadow: 0 2px 4px 0 rgba(34,36,38,.12),0 2px 10px 0 rgba(34,36,38,.08);" class="img-responsive img-centered" alt="Registrar类图" src="https://cdn.jsdelivr.net/gh/BiggerYellow/BiggerYellow.github.io/img/springboot/Registrar.jpg" />
    <div style="color:orange; border-bottom: 1px solid #d9d9d9;
    display: inline-block;
    color: #999;
    padding: 2px;">Registrar类图</div>
    </a>
</center>

<p>主要看下是实现的 <strong>ImportBeanDefinitionRegistrar</strong> 和 <strong>DeterminableImports</strong> 两个类.<br />
<strong>ImportBeanDefinitionRegistrar</strong> :主要作用是在解析 <strong>@Configuration</strong> 类时,注册额外的bean定义,在启动中对应 <strong>AutoConfigurationPackages.class</strong> .<br />
<strong>DeterminableImports</strong> :主要作用确定要导入对象的集合.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//调用路径</span>
<span class="o">-&gt;</span>  <span class="mi">1</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">boot</span><span class="o">.</span><span class="na">SpringApplication</span><span class="err">#</span><span class="n">run</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">...)</span>
<span class="o">-&gt;</span>  <span class="mi">2</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">boot</span><span class="o">.</span><span class="na">SpringApplication</span><span class="err">#</span><span class="n">refreshContext</span>
<span class="o">-&gt;</span>  <span class="mi">3</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">AbstractApplicationContext</span><span class="err">#</span><span class="n">refresh</span>
<span class="o">-&gt;</span>  <span class="mi">4</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">AbstractApplicationContext</span><span class="err">#</span><span class="n">invokeBeanFactoryPostProcessors</span>
<span class="o">-&gt;</span>  <span class="mi">5</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">PostProcessorRegistrationDelegate</span><span class="err">#</span><span class="n">invokeBeanDefinitionRegistryPostProcessors</span>
<span class="o">-&gt;</span>  <span class="mi">6</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ConfigurationClassPostProcessor</span><span class="err">#</span><span class="n">postProcessBeanDefinitionRegistry</span>
<span class="o">-&gt;</span>  <span class="mi">7</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ConfigurationClassPostProcessor</span><span class="err">#</span><span class="n">processConfigBeanDefinitions</span>
<span class="o">-&gt;</span>  <span class="mi">8</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ConfigurationClassParser</span><span class="err">#</span><span class="n">parse</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">type</span><span class="o">.</span><span class="na">AnnotationMetadata</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span>
<span class="o">-&gt;</span>  <span class="mi">9</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ConfigurationClassParser</span><span class="err">#</span><span class="n">doProcessConfigurationClass</span>
<span class="o">-&gt;</span>  <span class="mi">10</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ConfigurationClassParser</span><span class="err">#</span><span class="n">processImports</span>  <span class="c1">//核心调用点 获取spring.factories中所有的EnableAutoConfiguration的子类</span>
<span class="o">-&gt;</span>  <span class="mi">11</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ConfigurationClassParser</span><span class="o">.</span><span class="na">DeferredImportSelectorHandler</span><span class="err">#</span><span class="n">process</span>
<span class="o">-&gt;</span>  <span class="mi">12</span><span class="o">.</span><span class="na">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">ConfigurationClassParser</span><span class="o">.</span><span class="na">DeferredImportSelectorGroupingHandler</span><span class="err">#</span><span class="n">processGroupImports</span> <span class="c1">//将所有满足条件的EnableAutoConfiguration的子类注册为bean</span>

<span class="c1">//关键代码分析</span>
<span class="nd">@Nullable</span>
<span class="kd">protected</span> <span class="kd">final</span> <span class="nc">SourceClass</span> <span class="nf">doProcessConfigurationClass</span><span class="o">(</span>
        <span class="nc">ConfigurationClass</span> <span class="n">configClass</span><span class="o">,</span> <span class="nc">SourceClass</span> <span class="n">sourceClass</span><span class="o">,</span> <span class="nc">Predicate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">filter</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="o">...</span>

    <span class="c1">// Process any @Import annotations</span>
    <span class="n">processImports</span><span class="o">(</span><span class="n">configClass</span><span class="o">,</span> <span class="n">sourceClass</span><span class="o">,</span> <span class="n">getImports</span><span class="o">(</span><span class="n">sourceClass</span><span class="o">),</span> <span class="n">filter</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
    
    <span class="o">...</span>

<span class="o">}</span>

<span class="cm">/**
 * Returns {@code @Import} class, considering all meta-annotations.
 * 返回所有@Import的类, 考虑所有元注解
 */</span>
<span class="kd">private</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">SourceClass</span><span class="o">&gt;</span> <span class="nf">getImports</span><span class="o">(</span><span class="nc">SourceClass</span> <span class="n">sourceClass</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">SourceClass</span><span class="o">&gt;</span> <span class="n">imports</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;();</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">SourceClass</span><span class="o">&gt;</span> <span class="n">visited</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;();</span>
    <span class="n">collectImports</span><span class="o">(</span><span class="n">sourceClass</span><span class="o">,</span> <span class="n">imports</span><span class="o">,</span> <span class="n">visited</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">imports</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">//这个方法就是处理所有@Import的类</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">processImports</span><span class="o">(</span><span class="nc">ConfigurationClass</span> <span class="n">configClass</span><span class="o">,</span> <span class="nc">SourceClass</span> <span class="n">currentSourceClass</span><span class="o">,</span>
        <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">SourceClass</span><span class="o">&gt;</span> <span class="n">importCandidates</span><span class="o">,</span> <span class="nc">Predicate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">exclusionFilter</span><span class="o">,</span>
        <span class="kt">boolean</span> <span class="n">checkForCircularImports</span><span class="o">)</span> <span class="o">{</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">importCandidates</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">checkForCircularImports</span> <span class="o">&amp;&amp;</span> <span class="n">isChainedImportOnStack</span><span class="o">(</span><span class="n">configClass</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">problemReporter</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="k">new</span> <span class="nc">CircularImportProblem</span><span class="o">(</span><span class="n">configClass</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">importStack</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">importStack</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">configClass</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">SourceClass</span> <span class="n">candidate</span> <span class="o">:</span> <span class="n">importCandidates</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//候选类是否属于ImportSelector 主要针对AutoConfigurationImportSelector.class</span>
                <span class="c1">//核心流程:</span>
                <span class="c1">//1.this.deferredImportSelectorHandler.handle(configClass, (DeferredImportSelector) selector);</span>
                <span class="c1">//2.org.springframework.context.annotation.ConfigurationClassParser.DeferredImportSelectorGroupingHandler#processGroupImports</span>
                <span class="c1">//3.org.springframework.context.annotation.ConfigurationClassParser.DeferredImportSelectorGrouping#getImports</span>
                <span class="c1">//4.org.springframework.boot.autoconfigure.AutoConfigurationImportSelector.AutoConfigurationGroup#process</span>
                <span class="c1">//5.org.springframework.boot.autoconfigure.AutoConfigurationImportSelector#getAutoConfigurationEntry</span>
                <span class="c1">//6.org.springframework.boot.autoconfigure.AutoConfigurationImportSelector#getCandidateConfigurations 最重要的就是这里获得EnableAutoConfiguration的所有子类</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">candidate</span><span class="o">.</span><span class="na">isAssignable</span><span class="o">(</span><span class="nc">ImportSelector</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
                    <span class="c1">// Candidate class is an ImportSelector -&gt; delegate to it to determine imports</span>
                    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">candidateClass</span> <span class="o">=</span> <span class="n">candidate</span><span class="o">.</span><span class="na">loadClass</span><span class="o">();</span>
                    <span class="nc">ImportSelector</span> <span class="n">selector</span> <span class="o">=</span> <span class="nc">ParserStrategyUtils</span><span class="o">.</span><span class="na">instantiateClass</span><span class="o">(</span><span class="n">candidateClass</span><span class="o">,</span> <span class="nc">ImportSelector</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                            <span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">);</span>
                    <span class="nc">Predicate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">selectorFilter</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">getExclusionFilter</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">selectorFilter</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">exclusionFilter</span> <span class="o">=</span> <span class="n">exclusionFilter</span><span class="o">.</span><span class="na">or</span><span class="o">(</span><span class="n">selectorFilter</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">selector</span> <span class="k">instanceof</span> <span class="nc">DeferredImportSelector</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">this</span><span class="o">.</span><span class="na">deferredImportSelectorHandler</span><span class="o">.</span><span class="na">handle</span><span class="o">(</span><span class="n">configClass</span><span class="o">,</span> <span class="o">(</span><span class="nc">DeferredImportSelector</span><span class="o">)</span> <span class="n">selector</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="k">else</span> <span class="o">{</span>
                        <span class="nc">String</span><span class="o">[]</span> <span class="n">importClassNames</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectImports</span><span class="o">(</span><span class="n">currentSourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">());</span>
                        <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">SourceClass</span><span class="o">&gt;</span> <span class="n">importSourceClasses</span> <span class="o">=</span> <span class="n">asSourceClasses</span><span class="o">(</span><span class="n">importClassNames</span><span class="o">,</span> <span class="n">exclusionFilter</span><span class="o">);</span>
                        <span class="n">processImports</span><span class="o">(</span><span class="n">configClass</span><span class="o">,</span> <span class="n">currentSourceClass</span><span class="o">,</span> <span class="n">importSourceClasses</span><span class="o">,</span> <span class="n">exclusionFilter</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="c1">//候选类是否属于ImportBeanDefinitionRegistrar  主要针对 AutoConfigurationPackages.Registrar.class</span>
                <span class="c1">//将AutoConfigurationPackages.Registrar.class实例化,并通过解析后的org.springframework.context.annotation.ConfigurationClassBeanDefinitionReader#loadBeanDefinitions方法</span>
                <span class="c1">//中的org.springframework.context.annotation.ConfigurationClassBeanDefinitionReader#loadBeanDefinitionsFromRegistrars方法注册为bean实例</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">candidate</span><span class="o">.</span><span class="na">isAssignable</span><span class="o">(</span><span class="nc">ImportBeanDefinitionRegistrar</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
                    <span class="c1">// Candidate class is an ImportBeanDefinitionRegistrar -&gt;</span>
                    <span class="c1">// delegate to it to register additional bean definitions</span>
                    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">candidateClass</span> <span class="o">=</span> <span class="n">candidate</span><span class="o">.</span><span class="na">loadClass</span><span class="o">();</span>
                    <span class="nc">ImportBeanDefinitionRegistrar</span> <span class="n">registrar</span> <span class="o">=</span>
                            <span class="nc">ParserStrategyUtils</span><span class="o">.</span><span class="na">instantiateClass</span><span class="o">(</span><span class="n">candidateClass</span><span class="o">,</span> <span class="nc">ImportBeanDefinitionRegistrar</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                                    <span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">);</span>
                    <span class="n">configClass</span><span class="o">.</span><span class="na">addImportBeanDefinitionRegistrar</span><span class="o">(</span><span class="n">registrar</span><span class="o">,</span> <span class="n">currentSourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">());</span>
                <span class="o">}</span>
                <span class="c1">//候选类不属于以上两个父类  直接进行配置类解析逻辑</span>
                <span class="k">else</span> <span class="o">{</span>
                    <span class="c1">// Candidate class not an ImportSelector or ImportBeanDefinitionRegistrar -&gt;</span>
                    <span class="c1">// process it as an @Configuration class</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">importStack</span><span class="o">.</span><span class="na">registerImport</span><span class="o">(</span>
                            <span class="n">currentSourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">(),</span> <span class="n">candidate</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getClassName</span><span class="o">());</span>
                    <span class="n">processConfigurationClass</span><span class="o">(</span><span class="n">candidate</span><span class="o">.</span><span class="na">asConfigClass</span><span class="o">(</span><span class="n">configClass</span><span class="o">),</span> <span class="n">exclusionFilter</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">catch</span> <span class="o">(</span><span class="nc">BeanDefinitionStoreException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span>
                    <span class="s">"Failed to process import candidates for configuration class ["</span> <span class="o">+</span>
                    <span class="n">configClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getClassName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">finally</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">importStack</span><span class="o">.</span><span class="na">pop</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>综上所述, <strong>AutoConfigurationImportSelector.class</strong> 的作用就是找到所有 <strong>EnableAutoConfiguration</strong> 的自动配置子类,并注册为bean定义.<br />
而 <strong>AutoConfigurationPackages.Registrar.class</strong> 的作用就是扫描主配置类同级目录以及子包将所有组件到Spring中</p>

<hr />

<h3 id="componentscan">@ComponentScan</h3>
<blockquote>
  <p>源码</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Nullable</span>
<span class="kd">protected</span> <span class="kd">final</span> <span class="nc">SourceClass</span> <span class="nf">doProcessConfigurationClass</span><span class="o">(</span>
        <span class="nc">ConfigurationClass</span> <span class="n">configClass</span><span class="o">,</span> <span class="nc">SourceClass</span> <span class="n">sourceClass</span><span class="o">,</span> <span class="nc">Predicate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">filter</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="o">...</span>

	    <span class="c1">// Process any @ComponentScan annotations</span>
        <span class="c1">//处理所有@ComponentScan注解  默认扫描主配置类同级目录及子包</span>
		<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">AnnotationAttributes</span><span class="o">&gt;</span> <span class="n">componentScans</span> <span class="o">=</span> <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">attributesForRepeatable</span><span class="o">(</span>
				<span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">(),</span> <span class="nc">ComponentScans</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">ComponentScan</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(!</span><span class="n">componentScans</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="k">this</span><span class="o">.</span><span class="na">conditionEvaluator</span><span class="o">.</span><span class="na">shouldSkip</span><span class="o">(</span><span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">(),</span> <span class="nc">ConfigurationPhase</span><span class="o">.</span><span class="na">REGISTER_BEAN</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">for</span> <span class="o">(</span><span class="nc">AnnotationAttributes</span> <span class="n">componentScan</span> <span class="o">:</span> <span class="n">componentScans</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// The config class is annotated with @ComponentScan -&gt; perform the scan immediately</span>
				<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="n">scannedBeanDefinitions</span> <span class="o">=</span>
						<span class="k">this</span><span class="o">.</span><span class="na">componentScanParser</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">componentScan</span><span class="o">,</span> <span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getClassName</span><span class="o">());</span>
				<span class="c1">// Check the set of scanned definitions for any further config classes and parse recursively if needed</span>
				<span class="k">for</span> <span class="o">(</span><span class="nc">BeanDefinitionHolder</span> <span class="n">holder</span> <span class="o">:</span> <span class="n">scannedBeanDefinitions</span><span class="o">)</span> <span class="o">{</span>
					<span class="nc">BeanDefinition</span> <span class="n">bdCand</span> <span class="o">=</span> <span class="n">holder</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">().</span><span class="na">getOriginatingBeanDefinition</span><span class="o">();</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">bdCand</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
						<span class="n">bdCand</span> <span class="o">=</span> <span class="n">holder</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">();</span>
					<span class="o">}</span>
					<span class="k">if</span> <span class="o">(</span><span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">checkConfigurationClassCandidate</span><span class="o">(</span><span class="n">bdCand</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span><span class="o">))</span> <span class="o">{</span>
						<span class="n">parse</span><span class="o">(</span><span class="n">bdCand</span><span class="o">.</span><span class="na">getBeanClassName</span><span class="o">(),</span> <span class="n">holder</span><span class="o">.</span><span class="na">getBeanName</span><span class="o">());</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>

        <span class="o">...</span>

<span class="o">}</span>
</code></pre></div></div>
<p>综上所述: <strong>@ComponentScan</strong> 的作用就是扫描主配置目录及子包,并将扫描到的配置类进行解析.</p>

<hr />

<h3 id="总结">总结</h3>
<ol>
  <li>@SpringBootApplication:将主函数声明为可以被Spring管理的bean,并交给Spring解析处理.</li>
  <li>@ComponentScan:扫描主配置目录及子包,并将扫描到的配置类进行解析</li>
  <li>@EnableAutoConfiguration:自动注册所有自动配置的配置类
    <ul>
      <li>@Import(AutoConfigurationImportSelector.class):找到spring.factories中所有EnableAutoConfiguration的子类并按条件过滤注册为bean</li>
      <li>@Import(AutoConfigurationPackages.Registrar.class):将主配置及子包下的所有组件扫描到Spring中</li>
    </ul>
  </li>
</ol>

</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">SpringBoot</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">July 2021</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">SpringBoot</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-9" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2></h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/pexels-8802433.jpg" class="img-responsive img-centered" alt="image-alt">

                            
                                <h3>spring</h3>
                            
                            </div>

                            <p><h1 id="spring2">spring2</h1>
<p>spring test2</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test2
</code></pre></div></div>
</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">Start Bootstrap</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">April 2021</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">spring</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-7" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2></h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/pexels-luizclas-556666.jpg" class="img-responsive img-centered" alt="image-alt">

                            
                                <h3>spring</h3>
                            
                            </div>

                            <p><h1 id="spring">spring</h1>
<p>spring test</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test
</code></pre></div></div>
</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">Start Bootstrap</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">April 2021</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">spring</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-1" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2></h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/cabin.png" class="img-responsive img-centered" alt="image-alt">

                            
                                <h3>Use this area of the page to describe your project. Lorem ipsum dolor sit amet, consectetur adipisicing elit. Mollitia neque assumenda ipsam nihil, molestias magnam, recusandae quos quis inventore quisquam velit asperiores, vitae? Reprehenderit soluta, eos quod consequuntur itaque. Nam.</h3>
                            
                            </div>

                            <p><p>###　test</p>
<ul>
  <li>
    <啊实打实>
</啊实打实>
  </li>
</ul>
</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">Start Bootstrap</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">April 2014</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">Web Development</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-2" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2></h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/cake.png" class="img-responsive img-centered" alt="image-alt">

                            
                                <h3>Use this area of the page to describe your project. Lorem ipsum dolor sit amet, consectetur adipisicing elit. Mollitia neque assumenda ipsam nihil, molestias magnam, recusandae quos quis inventore quisquam velit asperiores, vitae? Reprehenderit soluta, eos quod consequuntur itaque. Nam.</h3>
                            
                            </div>

                            <p><p>2</p>
</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">Start Bootstrap</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">April 2014</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">Web Development</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-3" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2></h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/circus.png" class="img-responsive img-centered" alt="image-alt">

                            
                                <h3>Use this area of the page to describe your project. Lorem ipsum dolor sit amet, consectetur adipisicing elit. Mollitia neque assumenda ipsam nihil, molestias magnam, recusandae quos quis inventore quisquam velit asperiores, vitae? Reprehenderit soluta, eos quod consequuntur itaque. Nam.</h3>
                            
                            </div>

                            <p><p>3</p>
</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">Start Bootstrap</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">April 2014</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">Web Development</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-4" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2></h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/game.png" class="img-responsive img-centered" alt="image-alt">

                            
                                <h3>Use this area of the page to describe your project. Lorem ipsum dolor sit amet, consectetur adipisicing elit. Mollitia neque assumenda ipsam nihil, molestias magnam, recusandae quos quis inventore quisquam velit asperiores, vitae? Reprehenderit soluta, eos quod consequuntur itaque. Nam.</h3>
                            
                            </div>

                            <p><h4 id="4">4</h4>
</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">Start Bootstrap</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">April 2014</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">Web Development</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-6" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2></h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/submarine.png" class="img-responsive img-centered" alt="image-alt">

                            
                                <h3>Use this area of the page to describe your project. Lorem ipsum dolor sit amet, consectetur adipisicing elit. Mollitia neque assumenda ipsam nihil, molestias magnam, recusandae quos quis inventore quisquam velit asperiores, vitae? Reprehenderit soluta, eos quod consequuntur itaque. Nam.</h3>
                            
                            </div>

                            <p><h4 id="6">6</h4>
</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">Start Bootstrap</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">April 2014</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">Web Development</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="portfolio-modal modal fade" id="portfolioModal-5" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-content">
            <div class="close-modal" data-dismiss="modal">
                <div class="lr">
                    <div class="rl">
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-lg-offset-2">
                        <div class="modal-body">
                            <div align="center">
                            <h2></h2>
                            <hr class="star-primary">
                            <img src="img/portfolio/safe.png" class="img-responsive img-centered" alt="image-alt">

                            
                                <h3>Use this area of the page to describe your project. Lorem ipsum dolor sit amet, consectetur adipisicing elit. Mollitia neque assumenda ipsam nihil, molestias magnam, recusandae quos quis inventore quisquam velit asperiores, vitae? Reprehenderit soluta, eos quod consequuntur itaque. Nam.</h3>
                            
                            </div>

                            <p><h4 id="5">5</h4>
</p>

                            <div align="center">
                            <ul class="list-inline item-details">
                                
                                    <li>Client:
                                        <strong><a href="http://startbootstrap.com">Start Bootstrap</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Date:
                                        <strong><a href="http://startbootstrap.com">April 2014</a>
                                        </strong>
                                    </li>
                                
                                
                                    <li>Service:
                                        <strong><a href="http://startbootstrap.com">Web Development</a>
                                        </strong>
                                    </li>
                                
                            </ul>
                            </div>
                            <div align="center">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

     <!-- jQuery Version 1.11.0 -->
    <script src="/js/jquery-1.11.0.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/js/bootstrap.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="/js/jquery.easing.min.js"></script>
    <script src="/js/classie.js"></script>
    <script src="/js/cbpAnimatedHeader.js"></script>

    <!-- Contact Form JavaScript -->
    <script src="/js/jqBootstrapValidation.js"></script>
    
    <script src="/js/contact_me_static.js"></script>
    

    <!-- Custom Theme JavaScript -->
    <script src="/js/freelancer.js"></script>

    

    </body>
</html>